/*
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
  MIT
 <a href="https://github.com/bitcoinjs/bitcoinjs-lib/blob/master/LICENSE">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
*/
(function(ka,t){"object"===typeof exports?module.exports.printStackTrace=t():"function"===typeof define&&define.amd?define(t):ka.printStackTrace=t()})(this,function(){function ka(t){t=t||{guess:!0};var J=t.e||null,S=!!t.guess,T=t.mode||null;t=new ka.implementation;J=t.run(J,T);return S?t.guessAnonymousFunctions(J):J}ka.implementation=function(){};ka.implementation.prototype={run:function(t,J){t=t||this.createException();J=J||this.mode(t);return"other"===J?this.other(arguments.callee):this[J](t)},
createException:function(){try{this.undef()}catch(t){return t}},mode:function(t){return"undefined"!==typeof window&&-1<window.navigator.userAgent.indexOf("PhantomJS")?"phantomjs":t.arguments&&t.stack?"chrome":t.stack&&t.sourceURL?"safari":t.stack&&t.number?"ie":t.stack&&t.fileName?"firefox":t.message&&t["opera#sourceloc"]?!t.stacktrace||-1<t.message.indexOf("\n")&&t.message.split("\n").length>t.stacktrace.split("\n").length?"opera9":"opera10a":t.message&&t.stack&&t.stacktrace?0>t.stacktrace.indexOf("called from line")?
"opera10b":"opera11":t.stack&&!t.fileName?"chrome":"other"},instrumentFunction:function(t,J,S){t=t||window;var T=t[J];t[J]=function(){S.call(this,ka().slice(4));return t[J]._instrumented.apply(this,arguments)};t[J]._instrumented=T},deinstrumentFunction:function(t,J){t[J].constructor===Function&&t[J]._instrumented&&t[J]._instrumented.constructor===Function&&(t[J]=t[J]._instrumented)},chrome:function(t){return(t.stack+"\n").replace(/^[\s\S]+?\s+at\s+/," at ").replace(/^\s+(at eval )?at\s+/gm,"").replace(/^([^\(]+?)([\n$])/gm,
"{anonymous}() ($1)$2").replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,"{anonymous}() ($1)").replace(/^(.+) \((.+)\)$/gm,"$1@$2").split("\n").slice(0,-1)},safari:function(t){return t.stack.replace(/\[native code\]\n/m,"").replace(/^(?=\w+Error\:).*$\n/m,"").replace(/^@/gm,"{anonymous}()@").split("\n")},ie:function(t){return t.stack.replace(/^\s*at\s+(.*)$/gm,"$1").replace(/^Anonymous function\s+/gm,"{anonymous}() ").replace(/^(.+)\s+\((.+)\)$/gm,"$1@$2").split("\n").slice(1)},firefox:function(t){return t.stack.replace(/(?:\n@:0)?\s+$/m,
"").replace(/^(?:\((\S*)\))?@/gm,"{anonymous}($1)@").split("\n")},opera11:function(t){var J=/^.*line (\d+), column (\d+)(?: in (.+))? in (\S+):$/;t=t.stacktrace.split("\n");for(var S=[],T=0,V=t.length;T<V;T+=2){var K=J.exec(t[T]);if(K){var A=K[4]+":"+K[1]+":"+K[2],K=K[3]||"global code",K=K.replace(/<anonymous function: (\S+)>/,"$1").replace(/<anonymous function>/,"{anonymous}");S.push(K+"@"+A+" -- "+t[T+1].replace(/^\s+/,""))}}return S},opera10b:function(t){var J=/^(.*)@(.+):(\d+)$/;t=t.stacktrace.split("\n");
for(var S=[],T=0,V=t.length;T<V;T++){var K=J.exec(t[T]);K&&S.push((K[1]?K[1]+"()":"global code")+"@"+K[2]+":"+K[3])}return S},opera10a:function(t){var J=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i;t=t.stacktrace.split("\n");for(var S=[],T=0,V=t.length;T<V;T+=2){var K=J.exec(t[T]);K&&S.push((K[3]||"{anonymous}")+"()@"+K[2]+":"+K[1]+" -- "+t[T+1].replace(/^\s+/,""))}return S},opera9:function(t){var J=/Line (\d+).*script (?:in )?(\S+)/i;t=t.message.split("\n");for(var S=[],T=2,V=t.length;T<
V;T+=2){var K=J.exec(t[T]);K&&S.push("{anonymous}()@"+K[2]+":"+K[1]+" -- "+t[T+1].replace(/^\s+/,""))}return S},phantomjs:function(t){var J=/(\S+) \((\S+)\)/i;t=t.stack.split("\n");for(var S=[],T=1,V=t.length;T<V;T++){t[T]=t[T].replace(/^\s+at\s+/gm,"");var K=J.exec(t[T]);K?S.push(K[1]+"()@"+K[2]):S.push("{anonymous}()@"+t[T])}return S},other:function(t){for(var J=/function(?:\s+([\w$]+))?\s*\(/,S=[],T,V,K=Array.prototype.slice;t&&10>S.length;){T=J.test(t.toString())?RegExp.$1||"{anonymous}":"{anonymous}";
try{V=K.call(t.arguments||[])}catch(A){V=["Cannot access arguments: "+A]}S[S.length]=T+"("+this.stringifyArguments(V)+")";try{t=t.caller}catch(ka){S[S.length]="Cannot access caller: "+ka;break}}return S},stringifyArguments:function(t){for(var J=[],S=Array.prototype.slice,T=0;T<t.length;++T){var V=t[T];void 0===V?J[T]="undefined":null===V?J[T]="null":V.constructor&&(J[T]=V.constructor===Array?3>V.length?"["+this.stringifyArguments(V)+"]":"["+this.stringifyArguments(S.call(V,0,1))+"..."+this.stringifyArguments(S.call(V,
-1))+"]":V.constructor===Object?"#object":V.constructor===Function?"#function":V.constructor===String?'"'+V+'"':V.constructor===Number?V:"?")}return J.join(",")},sourceCache:{},ajax:function(t){var J=this.createXMLHTTPObject();if(J)try{return J.open("GET",t,!1),J.send(null),J.responseText}catch(S){}return""},createXMLHTTPObject:function(){for(var t,J=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},
function(){return new ActiveXObject("Microsoft.XMLHTTP")}],S=0;S<J.length;S++)try{return t=J[S](),this.createXMLHTTPObject=J[S],t}catch(T){}},isSameDomain:function(t){return"undefined"!==typeof location&&-1!==t.indexOf(location.hostname)},getSource:function(t){t in this.sourceCache||(this.sourceCache[t]=this.ajax(t).split("\n"));return this.sourceCache[t]},guessAnonymousFunctions:function(t){for(var J=0;J<t.length;++J){var S=/^(.*?)(?::(\d+))(?::(\d+))?(?: -- .+)?$/,T=t[J],V=/\{anonymous\}\(.*\)@(.*)/.exec(T);
if(V){var K=S.exec(V[1]);K&&(S=K[1],V=K[2],K=K[3]||0,S&&this.isSameDomain(S)&&V&&(S=this.guessAnonymousFunction(S,V,K),t[J]=T.replace("{anonymous}",S)))}}return t},guessAnonymousFunction:function(t,J,S){var T;try{T=this.findFunctionName(this.getSource(t),J)}catch(V){T="getSource failed with url: "+t+", exception: "+V.toString()}return T},findFunctionName:function(t,J){for(var S=/function\s+([^(]*?)\s*\(([^)]*)\)/,T=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*function\b/,V=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*(?:eval|new Function)\b/,
K="",A,ka=Math.min(J,20),jd,zb=0;zb<ka;++zb)if(A=t[J-zb-1],jd=A.indexOf("//"),0<=jd&&(A=A.substr(0,jd)),A)if(K=A+K,(A=T.exec(K))&&A[1]||(A=S.exec(K))&&A[1]||(A=V.exec(K))&&A[1])return A[1];return"(?)"}};return ka});
(function(ka){function t(f){var h="",g,e=0,u,l;for(g=0;g<f.length&&f.charAt(g)!=vd;++g)l=Pb.indexOf(f.charAt(g)),0>l||(0==e?(h+=Qb.charAt(l>>2),u=l&3,e=1):1==e?(h+=Qb.charAt(u<<2|l>>4),u=l&15,e=2):2==e?(h+=Qb.charAt(u),h+=Qb.charAt(l>>2),u=l&3,e=3):(h+=Qb.charAt(u<<2|l>>4),h+=Qb.charAt(l&15),e=0));1==e&&(h+=Qb.charAt(u<<2));return h}function J(){this.j=this.i=0;this.S=[]}function S(){var f=(new Date).getTime();vb[Ka++]^=f&255;vb[Ka++]^=f>>8&255;vb[Ka++]^=f>>16&255;vb[Ka++]^=f>>24&255;Ka>=wd&&(Ka-=
wd)}function T(){}function V(f,h){return new z(f,h)}function K(f,h,g){for(var e="",u=0;e.length<h;)e+=g(String.fromCharCode.apply(String,f.concat([(u&4278190080)>>24,(u&16711680)>>16,(u&65280)>>8,u&255]))),u+=1;return e}function A(){this.n=null;this.e=0;this.coeff=this.dmq1=this.dmp1=this.q=this.p=this.d=null}function Gd(f,h,g){for(var e="",u=0;e.length<h;)e+=g(f+String.fromCharCode.apply(String,[(u&4278190080)>>24,(u&16711680)>>16,(u&65280)>>8,u&255])),u+=1;return e}function jd(f){var h=[],g=E.getStartPosOfV_AtObj(f,
0),e=E.getPosOfNextSibling_AtObj(f,g),u=E.getPosOfNextSibling_AtObj(f,e),l=E.getPosOfNextSibling_AtObj(f,u),a=E.getPosOfNextSibling_AtObj(f,l),b=E.getPosOfNextSibling_AtObj(f,a),c=E.getPosOfNextSibling_AtObj(f,b),d=E.getPosOfNextSibling_AtObj(f,c),k=E.getPosOfNextSibling_AtObj(f,d);h.push(g,e,u,l,a,b,c,d,k);g=E.getHexOfV_AtObj(f,h[0]);e=E.getHexOfV_AtObj(f,h[1]);u=E.getHexOfV_AtObj(f,h[2]);l=E.getHexOfV_AtObj(f,h[3]);a=E.getHexOfV_AtObj(f,h[4]);b=E.getHexOfV_AtObj(f,h[5]);c=E.getHexOfV_AtObj(f,h[6]);
d=E.getHexOfV_AtObj(f,h[7]);f=E.getHexOfV_AtObj(f,h[8]);h=[];h.push(g,e,u,l,a,b,c,d,f);return h}function zb(f,h){for(var g="",e=h/4-f.length,u=0;u<e;u++)g+="0";return g+f}function Hd(f,h){var g=N.crypto.Util.hashString(f,h);return this.signWithMessageHash(g,h)}function fe(f){return Hd.call(this,f,"sha1")}function ge(f){return Hd.call(this,f,"sha256")}function he(f,h,g){for(var e="",u=0;e.length<h;)e+=hextorstr(g(rstrtohex(f+String.fromCharCode.apply(String,[(u&4278190080)>>24,(u&16711680)>>16,(u&
65280)>>8,u&255])))),u+=1;return e}function ie(f,h,g){f=rstrtohex(f);f=N.crypto.Util.hashHex(f,h);void 0===g&&(g=-1);return this.signWithMessageHashPSS(f,h,g)}function Qd(f){for(var h in N.crypto.Util.DIGESTINFOHEAD){var g=N.crypto.Util.DIGESTINFOHEAD[h],e=g.length;if(f.substring(0,e)==g)return[h,f.substring(e)]}return[]}function kd(f,h){var g=V(f,16);var e=this.n.toString(16),u=this.e.toString(16),l=new A;l.setPublic(e,u);g=l.doPublic(g).toString(16).replace(/^1f+00/,"");e=Qd(g);0==e.length?g=!1:
(g=e[1],e=N.crypto.Util.hashString(h,e[0]),g=g==e);return g}function xd(f,h){h=h.replace(Id,"");h=h.replace(/[ \n]+/g,"");var g=V(h,16);if(g.bitLength()>this.n.bitLength())return 0;var g=this.doPublic(g).toString(16).replace(/^1f+00/,""),e=Qd(g);if(0==e.length)return!1;g=e[1];e=N.crypto.Util.hashString(f,e[0]);return g==e}function Rd(f,h,g,e){f=rstrtohex(f);f=N.crypto.Util.hashHex(f,g);void 0===e&&(e=-1);return this.verifyWithMessageHashPSS(f,h,g,e)}function aa(){this.hex=this.subjectPublicKeyRSA_hE=
this.subjectPublicKeyRSA_hN=this.subjectPublicKeyRSA=null;this.getSerialNumberHex=function(){return E.getDecendantHexVByNthList(this.hex,0,[0,1])};this.getIssuerHex=function(){return E.getDecendantHexTLVByNthList(this.hex,0,[0,3])};this.getIssuerString=function(){return aa.hex2dn(E.getDecendantHexTLVByNthList(this.hex,0,[0,3]))};this.getSubjectHex=function(){return E.getDecendantHexTLVByNthList(this.hex,0,[0,5])};this.getSubjectString=function(){return aa.hex2dn(E.getDecendantHexTLVByNthList(this.hex,
0,[0,5]))};this.getNotBefore=function(){var f=E.getDecendantHexVByNthList(this.hex,0,[0,4,0]),f=f.replace(/(..)/g,"%$1");return f=decodeURIComponent(f)};this.getNotAfter=function(){var f=E.getDecendantHexVByNthList(this.hex,0,[0,4,1]),f=f.replace(/(..)/g,"%$1");return f=decodeURIComponent(f)};this.readCertPEM=function(f){f=aa.pemToHex(f);var h=aa.getPublicKeyHexArrayFromCertHex(f),g=new A;g.setPublic(h[0],h[1]);this.subjectPublicKeyRSA=g;this.subjectPublicKeyRSA_hN=h[0];this.subjectPublicKeyRSA_hE=
h[1];this.hex=f};this.readCertPEMWithoutRSAInit=function(f){f=aa.pemToHex(f);var h=aa.getPublicKeyHexArrayFromCertHex(f);this.subjectPublicKeyRSA.setPublic(h[0],h[1]);this.subjectPublicKeyRSA_hN=h[0];this.subjectPublicKeyRSA_hE=h[1];this.hex=f}}function ga(){return new z(null)}function Eb(f,h,g,e,u,l){for(;0<=--l;){var a=h*this[f++]+g[e]+u;u=Math.floor(a/67108864);g[e++]=a&67108863}return u}function je(f,h,g,e,u,l){var a=h&32767;for(h>>=15;0<=--l;){var b=this[f]&32767,c=this[f++]>>15,d=h*b+c*a,b=
a*b+((d&32767)<<15)+g[e]+(u&1073741823);u=(b>>>30)+(d>>>15)+h*c+(u>>>30);g[e++]=b&1073741823}return u}function Sd(f,h,g,e,u,l){var a=h&16383;for(h>>=14;0<=--l;){var b=this[f]&16383,c=this[f++]>>14,d=h*b+c*a,b=a*b+((d&16383)<<14)+g[e]+u;u=(b>>28)+(d>>14)+h*c;g[e++]=b&268435455}return u}function Sc(f,h){var g=ke[f.charCodeAt(h)];return null==g?-1:g}function Dc(f){var h=ga();h.fromInt(f);return h}function yd(f){var h=1,g;0!=(g=f>>>16)&&(f=g,h+=16);0!=(g=f>>8)&&(f=g,h+=8);0!=(g=f>>4)&&(f=g,h+=4);0!=(g=
f>>2)&&(f=g,h+=2);0!=f>>1&&(h+=1);return h}function rc(f){this.m=f}function La(f){this.m=f;this.mp=f.invDigit();this.mpl=this.mp&32767;this.mph=this.mp>>15;this.um=(1<<f.DB-15)-1;this.mt2=2*f.t}function te(f,h){return f&h}function Jd(f,h){return f|h}function Kd(f,h){return f^h}function Tc(f,h){return f&~h}function Uc(){}function zd(f){return f}function Ec(f){this.r2=ga();this.q3=ga();z.ONE.dlShiftTo(2*f.t,this.r2);this.mu=this.r2.divide(f);this.m=f}function d(f,h,g){if(!(this instanceof d))return new d(f,
h,g);var e=typeof f;if("base64"===h&&"string"===e)for(f=d.stringtrim(f);0!==f.length%4;)f+="=";var u;if("number"===e)u=d.coerce(f);else if("string"===e)u=d.byteLength(f,h);else if("object"===e)u=d.coerce(f.length);else throw Error("First argument needs to be a number, array or string.");var l;d._useTypedArrays?l=d._augment(new Uint8Array(u)):(l=this,l.length=u,l._isBuffer=!0);if(d._useTypedArrays&&"number"===typeof f.byteLength)l._set(f);else if(d.isArrayish(f))if(d.isBuffer(f))for(h=0;h<u;h++)l[h]=
f.readUInt8(h);else for(h=0;h<u;h++)l[h]=(f[h]%256+256)%256;else if("string"===e)l.write(f,0,h);else if("number"===e&&!d._useTypedArrays&&!g)for(h=0;h<u;h++)l[h]=0;return l}function R(f){if(f)return f.__proto__=R.prototype,f}function sa(f){if(f)return f.__proto__=sa.prototype,f}function Fb(f){if(f)return f.__proto__=Fb.prototype,f}function x(f){if(f)return f.__proto__=x.prototype,f}function Fc(f){x.call(this,f)}function D(f){x.call(this,f)}function Xb(f){if(f)return f.__proto__=Xb.prototype,f}var a=
a||{},q=a;q.printStackTrace=ka.printStackTrace;var Gb=function(){var f=!1;if("undefined"!==typeof crypto&&crypto&&crypto.subtle){var h={name:"RSASSA-PKCS1-v1_5",modulusLength:2048,hash:{name:"SHA-256"},publicExponent:new Uint8Array([1,0,1])},g;crypto.subtle.generateKey(h,!0,["sign","verify"]).then(function(e){g=e;return crypto.subtle.sign(h,e.privateKey,new Uint8Array([1,2,3,4,5]))}).then(function(e){return crypto.subtle.verify(h,g.publicKey,e,new Uint8Array([1,2,3,4,5]))}).then(function(e){return crypto.subtle.exportKey("pkcs8",
g.privateKey)}).then(function(e){return crypto.subtle.importKey("pkcs8",e,h,!0,["sign"])}).then(function(e){return crypto.subtle.exportKey("spki",g.publicKey)}).then(function(e){return crypto.subtle.importKey("spki",e,h,!0,["verify"])}).then(function(e){e=new Uint8Array([1,2,3,4,5]);return crypto.subtle.digest({name:"SHA-256"},e.buffer)}).then(function(e){f=!0},function(e){console.log("DetectSubtleCrypto encountered error, not using crypto.subtle: ",e)})}return function(){return f}}();q.UseSubtleCrypto=
Gb;var Rb=Rb||function(f,h){var g={},e=g.lib={},u=e.Base=function(){function e(){}return{extend:function(f){e.prototype=this;var g=new e;f&&g.mixIn(f);g.hasOwnProperty("init")||(g.init=function(){g.$super.init.apply(this,arguments)});g.init.prototype=g;g.$super=this;return g},create:function(){var e=this.extend();e.init.apply(e,arguments);return e},init:function(){},mixIn:function(e){for(var f in e)e.hasOwnProperty(f)&&(this[f]=e[f]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),
l=e.WordArray=u.extend({init:function(e,f){e=this.words=e||[];this.sigBytes=f!=h?f:4*e.length},toString:function(e){return(e||b).stringify(this)},concat:function(e){var f=this.words,g=e.words,h=this.sigBytes;e=e.sigBytes;this.clamp();if(h%4)for(var l=0;l<e;l++)f[h+l>>>2]|=(g[l>>>2]>>>24-l%4*8&255)<<24-(h+l)%4*8;else for(l=0;l<e;l+=4)f[h+l>>>2]=g[l>>>2];this.sigBytes+=e;return this},clamp:function(){var e=this.words,g=this.sigBytes;e[g>>>2]&=4294967295<<32-g%4*8;e.length=f.ceil(g/4)},clone:function(){var e=
u.clone.call(this);e.words=this.words.slice(0);return e},random:function(e){for(var g=[],h=0;h<e;h+=4)g.push(4294967296*f.random()|0);return new l.init(g,e)}}),a=g.enc={},b=a.Hex={stringify:function(e){var f=e.words;e=e.sigBytes;for(var g=[],h=0;h<e;h++){var l=f[h>>>2]>>>24-h%4*8&255;g.push((l>>>4).toString(16));g.push((l&15).toString(16))}return g.join("")},parse:function(e){for(var f=e.length,g=[],h=0;h<f;h+=2)g[h>>>3]|=parseInt(e.substr(h,2),16)<<24-h%8*4;return new l.init(g,f/2)}},c=a.Latin1=
{stringify:function(e){var f=e.words;e=e.sigBytes;for(var g=[],h=0;h<e;h++)g.push(String.fromCharCode(f[h>>>2]>>>24-h%4*8&255));return g.join("")},parse:function(e){for(var f=e.length,g=[],h=0;h<f;h++)g[h>>>2]|=(e.charCodeAt(h)&255)<<24-h%4*8;return new l.init(g,f)}},d=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(f){throw Error("Malformed UTF-8 data");}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},k=e.BufferedBlockAlgorithm=u.extend({reset:function(){this._data=
new l.init;this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=d.parse(e));this._data.concat(e);this._nDataBytes+=e.sigBytes},_process:function(e){var g=this._data,h=g.words,u=g.sigBytes,a=this.blockSize,b=u/(4*a),b=e?f.ceil(b):f.max((b|0)-this._minBufferSize,0);e=b*a;u=f.min(4*e,u);if(e){for(var c=0;c<e;c+=a)this._doProcessBlock(h,c);c=h.splice(0,e);g.sigBytes-=u}return new l.init(c,u)},clone:function(){var e=u.clone.call(this);e._data=this._data.clone();return e},_minBufferSize:0});e.Hasher=
k.extend({cfg:u.extend(),init:function(e){this.cfg=this.cfg.extend(e);this.reset()},reset:function(){k.reset.call(this);this._doReset()},update:function(e){this._append(e);this._process();return this},finalize:function(e){e&&this._append(e);return this._doFinalize()},blockSize:16,_createHelper:function(e){return function(f,g){return(new e.init(g)).finalize(f)}},_createHmacHelper:function(e){return function(f,g){return(new m.HMAC.init(e,g)).finalize(f)}}});var m=g.algo={};return g}(Math);q.CryptoJS=
Rb;var Ad=a.CryptoJS;(function(f){var h=Ad.lib,g=h.WordArray,e=h.Hasher,h=Ad.algo,u=[],l=[];(function(){function e(g){for(var h=f.sqrt(g),l=2;l<=h;l++)if(!(g%l))return!1;return!0}function g(e){return 4294967296*(e-(e|0))|0}for(var h=2,a=0;64>a;)e(h)&&(8>a&&(u[a]=g(f.pow(h,0.5))),l[a]=g(f.pow(h,1/3)),a++),h++})();var a=[],h=h.SHA256=e.extend({_doReset:function(){this._hash=new g.init(u.slice(0))},_doProcessBlock:function(e,f){for(var g=this._hash.words,h=g[0],u=g[1],b=g[2],c=g[3],d=g[4],k=g[5],m=g[6],
n=g[7],p=0;64>p;p++){if(16>p)a[p]=e[f+p]|0;else{var s=a[p-15],q=a[p-2];a[p]=((s<<25|s>>>7)^(s<<14|s>>>18)^s>>>3)+a[p-7]+((q<<15|q>>>17)^(q<<13|q>>>19)^q>>>10)+a[p-16]}s=n+((d<<26|d>>>6)^(d<<21|d>>>11)^(d<<7|d>>>25))+(d&k^~d&m)+l[p]+a[p];q=((h<<30|h>>>2)^(h<<19|h>>>13)^(h<<10|h>>>22))+(h&u^h&b^u&b);n=m;m=k;k=d;d=c+s|0;c=b;b=u;u=h;h=s+q|0}g[0]=g[0]+h|0;g[1]=g[1]+u|0;g[2]=g[2]+b|0;g[3]=g[3]+c|0;g[4]=g[4]+d|0;g[5]=g[5]+k|0;g[6]=g[6]+m|0;g[7]=g[7]+n|0},_doFinalize:function(){var e=this._data,g=e.words,
h=8*this._nDataBytes,l=8*e.sigBytes;g[l>>>5]|=128<<24-l%32;g[(l+64>>>9<<4)+14]=f.floor(h/4294967296);g[(l+64>>>9<<4)+15]=h;e.sigBytes=4*g.length;this._process();return this._hash},clone:function(){var f=e.clone.call(this);f._hash=this._hash.clone();return f}});Ad.SHA256=e._createHelper(h);Ad.HmacSHA256=e._createHmacHelper(h)})(Math);q.CryptoJS=Ad;(function(){var f=Rb,h=f.enc.Utf8;f.algo.HMAC=f.lib.Base.extend({init:function(f,e){f=this._hasher=new f.init;"string"==typeof e&&(e=h.parse(e));var u=f.blockSize,
l=4*u;e.sigBytes>l&&(e=f.finalize(e));e.clamp();for(var a=this._oKey=e.clone(),b=this._iKey=e.clone(),c=a.words,d=b.words,k=0;k<u;k++)c[k]^=1549556828,d[k]^=909522486;a.sigBytes=b.sigBytes=l;this.reset()},reset:function(){var f=this._hasher;f.reset();f.update(this._iKey)},update:function(f){this._hasher.update(f);return this},finalize:function(f){var e=this._hasher;f=e.finalize(f);e.reset();return e.finalize(this._oKey.clone().concat(f))}})})();var Pb="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",
vd="=";q.b64tohex=t;q.b64toBA=function(f){f=t(f);var h,g=[];for(h=0;2*h<f.length;++h)g[h]=parseInt(f.substring(2*h,2*h+2),16);return g};q.hex2b64=function(f){var h,g,e="";for(h=0;h+3<=f.length;h+=3)g=parseInt(f.substring(h,h+3),16),e+=Pb.charAt(g>>6)+Pb.charAt(g&63);h+1==f.length?(g=parseInt(f.substring(h,h+1),16),e+=Pb.charAt(g<<2)):h+2==f.length&&(g=parseInt(f.substring(h,h+2),16),e+=Pb.charAt(g>>2)+Pb.charAt((g&3)<<4));if(vd)for(;0<(e.length&3);)e+=vd;return e};J.prototype.init=function(f){var h,
g,e;for(h=0;256>h;++h)this.S[h]=h;for(h=g=0;256>h;++h)g=g+this.S[h]+f[h%f.length]&255,e=this.S[h],this.S[h]=this.S[g],this.S[g]=e;this.j=this.i=0};J.prototype.next=function(){var f;this.i=this.i+1&255;this.j=this.j+this.S[this.i]&255;f=this.S[this.i];this.S[this.i]=this.S[this.j];this.S[this.j]=f;return this.S[f+this.S[this.i]&255]};var wd=256,sc,vb,Ka;if(null==vb){vb=[];Ka=0;var Vc;if("Netscape"==navigator.appName&&"5">navigator.appVersion&&window.crypto){var bc=window.crypto.random(32);for(Vc=0;Vc<
bc.length;++Vc)vb[Ka++]=bc.charCodeAt(Vc)&255}for(;Ka<wd;)Vc=Math.floor(65536*Math.random()),vb[Ka++]=Vc>>>8,vb[Ka++]=Vc&255;Ka=0;S()}T.prototype.nextBytes=function(f){var h;for(h=0;h<f.length;++h){var g=f,e=h,u;if(null==sc){S();sc=new J;sc.init(vb);for(Ka=0;Ka<vb.length;++Ka)vb[Ka]=0;Ka=0}u=sc.next();g[e]=u}};var cc=a,Hb=20;A.prototype.doPublic=function(f){return f.modPowInt(this.e,this.n)};A.prototype.setPublic=function(f,h){this.isPublic=!0;"string"!==typeof f?(this.n=f,this.e=h):null!=f&&null!=
h&&0<f.length&&0<h.length?(this.n=V(f,16),this.e=parseInt(h,16)):alert("Invalid RSA public key")};A.prototype.encrypt=function(f){var h;h=this.n.bitLength()+7>>3;if(h<f.length+11)alert("Message too long for RSA"),h=null;else{for(var g=[],e=f.length-1;0<=e&&0<h;){var u=f.charCodeAt(e--);128>u?g[--h]=u:127<u&&2048>u?(g[--h]=u&63|128,g[--h]=u>>6|192):(g[--h]=u&63|128,g[--h]=u>>6&63|128,g[--h]=u>>12|224)}g[--h]=0;f=new T;for(e=[];2<h;){for(e[0]=0;0==e[0];)f.nextBytes(e);g[--h]=e[0]}g[--h]=2;g[--h]=0;
h=new z(g)}if(null==h)return null;h=this.doPublic(h);if(null==h)return null;h=h.toString(16);return 0==(h.length&1)?h:"0"+h};A.prototype.encryptOAEP=function(f,h){var g,e=this.n.bitLength()+7>>3;if(f.length+2*Hb+2>e)throw"Message too long for RSA";var u="";for(g=0;g<e-f.length-2*Hb-2;g+=1)u+="\x00";var l=rstr_sha1("")+u+"\u0001"+f,e=Array(Hb);(new T).nextBytes(e);var a=K(e,l.length,h||rstr_sha1),u=[];for(g=0;g<l.length;g+=1)u[g]=l.charCodeAt(g)^a.charCodeAt(g);l=K(u,e.length,rstr_sha1);a=[0];for(g=
0;g<e.length;g+=1)a[g+1]=e[g]^l.charCodeAt(g);g=new z(a.concat(u));if(null==g)return null;g=this.doPublic(g);if(null==g)return null;g=g.toString(16);return 0==(g.length&1)?g:"0"+g};A.prototype.type="RSA";q.RSAKey=A;var cc=a,z=cc.BigInteger?cc.BigInteger:cc,A=a.RSAKey,Hb=20;A.prototype.doPrivate=function(f){if(null==this.p||null==this.q)return f.modPow(this.d,this.n);var h=f.mod(this.p).modPow(this.dmp1,this.p);for(f=f.mod(this.q).modPow(this.dmq1,this.q);0>h.compareTo(f);)h=h.add(this.p);return h.subtract(f).multiply(this.coeff).mod(this.p).multiply(this.q).add(f)};
A.prototype.setPrivate=function(f,h,g){this.isPrivate=!0;"string"!==typeof f?(this.n=f,this.e=h,this.d=g):null!=f&&null!=h&&0<f.length&&0<h.length?(this.n=V(f,16),this.e=parseInt(h,16),this.d=V(g,16)):alert("Invalid RSA private key")};A.prototype.setPrivateEx=function(f,h,g,e,u,l,a,b){this.isPrivate=!0;if(null==f)throw"RSASetPrivateEx N == null";if(null==h)throw"RSASetPrivateEx E == null";if(0==f.length)throw"RSASetPrivateEx N.length == 0";if(0==h.length)throw"RSASetPrivateEx E.length == 0";null!=
f&&null!=h&&0<f.length&&0<h.length?(this.n=V(f,16),this.e=parseInt(h,16),this.d=V(g,16),this.p=V(e,16),this.q=V(u,16),this.dmp1=V(l,16),this.dmq1=V(a,16),this.coeff=V(b,16)):alert("Invalid RSA private key in RSASetPrivateEx")};A.prototype.generate=function(f,h){var g=new T,e=f>>1;this.e=parseInt(h,16);for(var u=new z(h,16);;){for(;this.p=new z(f-e,1,g),0!=this.p.subtract(z.ONE).gcd(u).compareTo(z.ONE)||!this.p.isProbablePrime(10););for(;this.q=new z(e,1,g),0!=this.q.subtract(z.ONE).gcd(u).compareTo(z.ONE)||
!this.q.isProbablePrime(10););if(0>=this.p.compareTo(this.q)){var l=this.p;this.p=this.q;this.q=l}var l=this.p.subtract(z.ONE),a=this.q.subtract(z.ONE),b=l.multiply(a);if(0==b.gcd(u).compareTo(z.ONE)){this.n=this.p.multiply(this.q);this.d=u.modInverse(b);this.dmp1=this.d.mod(l);this.dmq1=this.d.mod(a);this.coeff=this.q.modInverse(this.p);break}}this.isPrivate=!0};A.prototype.decrypt=function(f){f=V(f,16);f=this.doPrivate(f);if(null==f)return null;a:{var h=this.n.bitLength()+7>>3;f=f.toByteArray();
for(var g=0;g<f.length&&0==f[g];)++g;if(f.length-g!=h-1||2!=f[g])f=null;else{for(++g;0!=f[g];)if(++g>=f.length){f=null;break a}for(h="";++g<f.length;){var e=f[g]&255;128>e?h+=String.fromCharCode(e):191<e&&224>e?(h+=String.fromCharCode((e&31)<<6|f[g+1]&63),++g):(h+=String.fromCharCode((e&15)<<12|(f[g+1]&63)<<6|f[g+2]&63),g+=2)}f=h}}return f};A.prototype.decryptOAEP=function(f,h){var g=V(f,16),g=this.doPrivate(g);if(null==g)return null;for(var e=g,u=this.n.bitLength()+7>>3,e=e.toByteArray(),g=0;g<e.length;g+=
1)e[g]&=255;for(;e.length<u;)e.unshift(0);e=String.fromCharCode.apply(String,e);if(e.length<2*Hb+2)throw"Cipher too short";for(var l=e.substr(1,Hb),u=e.substr(Hb+1),a=Gd(u,Hb,h||rstr_sha1),b=[],g=0;g<l.length;g+=1)b[g]=l.charCodeAt(g)^a.charCodeAt(g);l=Gd(String.fromCharCode.apply(String,b),e.length-Hb,rstr_sha1);e=[];for(g=0;g<u.length;g+=1)e[g]=u.charCodeAt(g)^l.charCodeAt(g);e=String.fromCharCode.apply(String,e);if(e.substr(0,Hb)!==rstr_sha1(""))throw"Hash mismatch";e=e.substr(Hb);g=e.indexOf("\u0001");
if((-1!=g?e.substr(0,g).lastIndexOf("\x00"):-1)+1!=g)throw"Malformed data";return e.substr(g+1)};q.RSAKey=A;Rb=a.CryptoJS;cc=a;"undefined"!=typeof N&&N||(N={});"undefined"!=typeof N.crypto&&N.crypto||(N.crypto={});N.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",
md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"};this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",
SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",
SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"};this.CRYPTOJSMESSAGEDIGESTNAME={md5:"CryptoJS.algo.MD5",sha1:"CryptoJS.algo.SHA1",sha224:"CryptoJS.algo.SHA224",sha256:"CryptoJS.algo.SHA256",sha384:"CryptoJS.algo.SHA384",sha512:"CryptoJS.algo.SHA512",ripemd160:"CryptoJS.algo.RIPEMD160"};this.getDigestInfoHex=function(f,h){if("undefined"==typeof this.DIGESTINFOHEAD[h])throw"alg not supported in Util.DIGESTINFOHEAD: "+
h;return this.DIGESTINFOHEAD[h]+f};this.getPaddedDigestInfoHex=function(f,h,g){var e=this.getDigestInfoHex(f,h);f=g/4;if(e.length+22>f)throw"key is too short for SigAlg: keylen="+g+","+h;h="00"+e;g="";f=f-4-h.length;for(e=0;e<f;e+=2)g+="ff";return"0001"+g+h};this.hashString=function(f,h){return(new N.crypto.MessageDigest({alg:h})).digestString(f)};this.hashHex=function(f,h){return(new N.crypto.MessageDigest({alg:h})).digestHex(f)};this.sha1=function(f){return(new N.crypto.MessageDigest({alg:"sha1",
prov:"cryptojs"})).digestString(f)};this.sha256=function(f){return(new N.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"})).digestString(f)};this.sha256Hex=function(f){return(new N.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"})).digestHex(f)};this.sha512=function(f){return(new N.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"})).digestString(f)};this.sha512Hex=function(f){return(new N.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"})).digestHex(f)};this.md5=function(f){return(new N.crypto.MessageDigest({alg:"md5",
prov:"cryptojs"})).digestString(f)};this.ripemd160=function(f){return(new N.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"})).digestString(f)};this.getCryptoJSMDByName=function(f){}};N.crypto.MessageDigest=function(f){this.setAlgAndProvider=function(f,g){null!=f&&void 0===g&&(g=N.crypto.Util.DEFAULTPROVIDER[f]);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(f)&&"cryptojs"==g){try{this.md=eval(N.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[f]).create()}catch(e){throw"setAlgAndProvider hash alg set fail alg="+
f+"/"+e;}this.updateString=function(e){this.md.update(e)};this.updateHex=function(e){e=Rb.enc.Hex.parse(e);this.md.update(e)};this.digest=function(){return this.md.finalize().toString(Rb.enc.Hex)};this.digestString=function(e){this.updateString(e);return this.digest()};this.digestHex=function(e){this.updateHex(e);return this.digest()}}if(-1!=":sha256:".indexOf(f)&&"sjcl"==g){try{this.md=new sjcl.hash.sha256}catch(u){throw"setAlgAndProvider hash alg set fail alg="+f+"/"+u;}this.updateString=function(e){this.md.update(e)};
this.updateHex=function(e){e=sjcl.codec.hex.toBits(e);this.md.update(e)};this.digest=function(){var e=this.md.finalize();return sjcl.codec.hex.fromBits(e)};this.digestString=function(e){this.updateString(e);return this.digest()};this.digestHex=function(e){this.updateHex(e);return this.digest()}}};this.updateString=function(f){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.updateHex=function(f){throw"updateHex(hex) not supported for this alg/prov: "+
this.algName+"/"+this.provName;};this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.digestString=function(f){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.digestHex=function(f){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName;};void 0!==f&&void 0!==f.alg&&(this.algName=f.alg,void 0===f.prov&&(this.provName=N.crypto.Util.DEFAULTPROVIDER[this.algName]),
this.setAlgAndProvider(this.algName,this.provName))};N.crypto.Mac=function(f){this.setAlgAndProvider=function(f,g){f=f.toLowerCase();null==f&&(f="hmacsha1");f=f.toLowerCase();if("hmac"!=f.substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+f;void 0===g&&(g=N.crypto.Util.DEFAULTPROVIDER[f]);this.algProv=f+"/"+g;var e=f.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(e)&&"cryptojs"==g){try{var u=eval(N.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[e]);this.mac=Rb.algo.HMAC.create(u,
this.pass)}catch(l){throw"setAlgAndProvider hash alg set fail hashAlg="+e+"/"+l;}this.updateString=function(e){this.mac.update(e)};this.updateHex=function(e){e=Rb.enc.Hex.parse(e);this.mac.update(e)};this.doFinal=function(){return this.mac.finalize().toString(Rb.enc.Hex)};this.doFinalString=function(e){this.updateString(e);return this.doFinal()};this.doFinalHex=function(e){this.updateHex(e);return this.doFinal()}}};this.updateString=function(f){throw"updateString(str) not supported for this alg/prov: "+
this.algProv;};this.updateHex=function(f){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv;};this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv;};this.doFinalString=function(f){throw"digestString(str) not supported for this alg/prov: "+this.algProv;};this.doFinalHex=function(f){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv;};this.setPassword=function(f){if("string"==typeof f){var g=f;1!=f.length%2&&f.match(/^[0-9A-Fa-f]+$/)||
(g=rstrtohex(f))}else{if("object"!=typeof f)throw"KJUR.crypto.Mac unsupported password type: "+f;g=null;if(void 0!==f.hex){if(0!=f.hex.length%2||!f.hex.match(/^[0-9A-Fa-f]+$/))throw"Mac: wrong hex password: "+f.hex;g=f.hex}void 0!==f.utf8&&(g=utf8tohex(f.utf8));void 0!==f.rstr&&(g=rstrtohex(f.rstr));void 0!==f.b64&&(g=t(f.b64));void 0!==f.b64u&&(g=b64utohex(f.b64u));if(null==g)throw"KJUR.crypto.Mac unsupported password type: "+f;}this.pass=Rb.enc.Hex.parse(g)};void 0!==f&&(void 0!==f.pass&&this.setPassword(f.pass),
void 0!==f.alg&&(this.algName=f.alg,void 0===f.prov&&(this.provName=N.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))};N.crypto.Signature=function(f){var h=null;this._setAlgNames=function(){this.algName.match(/^(.+)with(.+)$/)&&(this.mdAlgName=RegExp.$1.toLowerCase(),this.pubkeyAlgName=RegExp.$2.toLowerCase())};this._zeroPaddingOfSignature=function(e,f){for(var g="",h=f/4-e.length,a=0;a<h;a++)g+="0";return g+e};this.setAlgAndProvider=function(e,f){this._setAlgNames();
if("cryptojs/jsrsa"!=f)throw"provider not supported: "+f;if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new N.crypto.MessageDigest({alg:this.mdAlgName})}catch(g){throw"setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+g;}this.init=function(e,f){var g=null;try{g=void 0===f?KEYUTIL.getKey(e):KEYUTIL.getKey(e,f)}catch(h){throw"init failed:"+h;}if(!0===g.isPrivate)this.prvKey=g,this.state="SIGN";else if(!0===g.isPublic)this.pubKey=g,this.state=
"VERIFY";else throw"init failed.:"+g;};this.initSign=function(e){"string"==typeof e.ecprvhex&&"string"==typeof e.eccurvename?(this.ecprvhex=e.ecprvhex,this.eccurvename=e.eccurvename):this.prvKey=e;this.state="SIGN"};this.initVerifyByPublicKey=function(e){"string"==typeof e.ecpubhex&&"string"==typeof e.eccurvename?(this.ecpubhex=e.ecpubhex,this.eccurvename=e.eccurvename):e instanceof N.crypto.ECDSA?this.pubKey=e:e instanceof A&&(this.pubKey=e);this.state="VERIFY"};this.initVerifyByCertificatePEM=function(e){var f=
new aa;f.readCertPEM(e);this.pubKey=f.subjectPublicKeyRSA;this.state="VERIFY"};this.updateString=function(e){this.md.updateString(e)};this.updateHex=function(e){this.md.updateHex(e)};this.sign=function(){this.sHashHex=this.md.digest();if("undefined"!=typeof this.ecprvhex&&"undefined"!=typeof this.eccurvename)this.hSign=(new N.crypto.ECDSA({curve:this.eccurvename})).signHex(this.sHashHex,this.ecprvhex);else if(this.prvKey instanceof A&&"rsaandmgf1"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,
this.mdAlgName,this.pssSaltLen);else if(this.prvKey instanceof A&&"rsa"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof N.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else if(this.prvKey instanceof N.crypto.DSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else throw"Signature: unsupported public key alg: "+this.pubkeyAlgName;return this.hSign};this.signString=function(e){this.updateString(e);
return this.sign()};this.signHex=function(e){this.updateHex(e);return this.sign()};this.verify=function(e){this.sHashHex=this.md.digest();if("undefined"!=typeof this.ecpubhex&&"undefined"!=typeof this.eccurvename)return(new N.crypto.ECDSA({curve:this.eccurvename})).verifyHex(this.sHashHex,e,this.ecpubhex);if(this.pubKey instanceof A&&"rsaandmgf1"==this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,e,this.mdAlgName,this.pssSaltLen);if(this.pubKey instanceof A&&"rsa"==this.pubkeyAlgName||
this.pubKey instanceof N.crypto.ECDSA||this.pubKey instanceof N.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName;}}};this.init=function(e,f){throw"init(key, pass) not supported for this alg:prov="+this.algProvName;};this.initVerifyByPublicKey=function(e){throw"initVerifyByPublicKey(rsaPubKeyy) not supported for this alg:prov="+this.algProvName;};this.initVerifyByCertificatePEM=function(e){throw"initVerifyByCertificatePEM(certPEM) not supported for this alg:prov="+
this.algProvName;};this.initSign=function(e){throw"initSign(prvKey) not supported for this alg:prov="+this.algProvName;};this.updateString=function(e){throw"updateString(str) not supported for this alg:prov="+this.algProvName;};this.updateHex=function(e){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName;};this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName;};this.signString=function(e){throw"digestString(str) not supported for this alg:prov="+
this.algProvName;};this.signHex=function(e){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName;};this.verify=function(e){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName;};this.initParams=f;if(void 0!==f&&(void 0!==f.alg&&(this.algName=f.alg,this.provName=void 0===f.prov?N.crypto.Util.DEFAULTPROVIDER[this.algName]:f.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),void 0!==f.psssaltlen&&
(this.pssSaltLen=f.psssaltlen),void 0!==f.prvkeypem)){if(void 0!==f.prvkeypas)throw"both prvkeypem and prvkeypas parameters not supported";try{h=new A,h.readPrivateKeyFromPEMString(f.prvkeypem),this.initSign(h)}catch(g){throw"fatal error to load pem private key: "+g;}}};N.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1",
"2b81040023":"secp521r1","2b81040022":"secp384r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}};q.KJUR=N;var E=a.ASN1HEX,t=a.b64tohex,A=a.RSAKey;A.prototype.readPrivateKeyFromPEMString=function(f){f=f.replace("-----BEGIN RSA PRIVATE KEY-----","");f=f.replace("-----END RSA PRIVATE KEY-----","");f=f.replace(/[ \n]+/g,"");f=t(f);f=jd(f);this.setPrivateEx(f[1],f[2],f[3],f[4],f[5],f[6],f[7],f[8])};A.prototype.readPrivateKeyFromASN1HexString=
function(f){f=jd(f);this.setPrivateEx(f[1],f[2],f[3],f[4],f[5],f[6],f[7],f[8])};q.RSAKey=A;var cc=a,z=cc.BigInteger?cc.BigInteger:cc,A=a.RSAKey,Id=RegExp("");Id.compile("[^0-9a-f]","gi");A.prototype.signWithMessageHash=function(f,h){var g=N.crypto.Util.getPaddedDigestInfoHex(f,h,this.n.bitLength()),g=V(g,16),g=this.doPrivate(g).toString(16);return zb(g,this.n.bitLength())};A.prototype.signString=Hd;A.prototype.signStringWithSHA1=fe;A.prototype.signStringWithSHA256=ge;A.prototype.sign=Hd;A.prototype.signWithSHA1=
fe;A.prototype.signWithSHA256=ge;A.prototype.signWithMessageHashPSS=function(f,h,g){var e=hextorstr(f);f=e.length;var u=this.n.bitLength()-1,l=Math.ceil(u/8),a=function(e){return N.crypto.Util.hashHex(e,h)};if(-1===g||void 0===g)g=f;else if(-2===g)g=l-f-2;else if(-2>g)throw"invalid salt length";if(l<f+g+2)throw"data too long";var b="";0<g&&(b=Array(g),(new T).nextBytes(b),b=String.fromCharCode.apply(String,b));for(var c=hextorstr(a(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+e+b))),d=[],e=0;e<l-
g-f-2;e+=1)d[e]=0;g=String.fromCharCode.apply(String,d)+"\u0001"+b;a=he(c,g.length,a);b=[];for(e=0;e<g.length;e+=1)b[e]=g.charCodeAt(e)^a.charCodeAt(e);b[0]&=~(65280>>8*l-u&255);for(e=0;e<f;e++)b.push(c.charCodeAt(e));b.push(188);return zb(this.doPrivate(new z(b)).toString(16),this.n.bitLength())};A.prototype.signStringPSS=ie;A.prototype.signPSS=ie;A.SALT_LEN_HLEN=-1;A.SALT_LEN_MAX=-2;A.prototype.verifyWithMessageHash=function(f,h){h=h.replace(Id,"");h=h.replace(/[ \n]+/g,"");var g=V(h,16);if(g.bitLength()>
this.n.bitLength())return 0;g=this.doPublic(g).toString(16).replace(/^1f+00/,"");g=Qd(g);return 0==g.length?!1:g[1]==f};A.prototype.verifyString=xd;A.prototype.verifyHexSignatureForMessage=kd;A.prototype.verify=xd;A.prototype.verifyHexSignatureForByteArrayMessage=kd;A.prototype.verifyWithMessageHashPSS=function(f,h,g,e){var u=new z(h,16);if(u.bitLength()>this.n.bitLength())return!1;h=function(e){return N.crypto.Util.hashHex(e,g)};f=hextorstr(f);var l=f.length,a=this.n.bitLength()-1,b=Math.ceil(a/
8);if(-1===e||void 0===e)e=l;else if(-2===e)e=b-l-2;else if(-2>e)throw"invalid salt length";if(b<l+e+2)throw"data too long";for(var c=this.doPublic(u).toByteArray(),u=0;u<c.length;u+=1)c[u]&=255;for(;c.length<b;)c.unshift(0);if(188!==c[b-1])throw"encoded message does not end in 0xbc";var c=String.fromCharCode.apply(String,c),d=c.substr(0,b-l-1),c=c.substr(d.length,l),k=65280>>8*b-a&255;if(0!==(d.charCodeAt(0)&k))throw"bits beyond keysize not zero";for(var m=he(c,d.length,h),a=[],u=0;u<d.length;u+=
1)a[u]=d.charCodeAt(u)^m.charCodeAt(u);a[0]&=~k;l=b-l-e-2;for(u=0;u<l;u+=1)if(0!==a[u])throw"leftmost octets not zero";if(1!==a[l])throw"0x01 marker not found";return c===hextorstr(h(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+f+String.fromCharCode.apply(String,a.slice(-e)))))};A.prototype.verifyStringPSS=Rd;A.prototype.verifyPSS=Rd;A.SALT_LEN_RECOVER=-2;q.RSAKey=A;"undefined"!=typeof N&&N||(N={});"undefined"!=typeof N.crypto&&N.crypto||(N.crypto={});N.crypto.ECDSA=function(f){var h=new T;this.type=
"EC";this.getBigRandom=function(f){return(new z(f.bitLength(),h)).mod(f.subtract(z.ONE)).add(z.ONE)};this.setNamedCurve=function(f){this.ecparams=N.crypto.ECParameterDB.getByName(f);this.pubKeyHex=this.prvKeyHex=null;this.curveName=f};this.setPrivateKeyHex=function(f){this.isPrivate=!0;this.prvKeyHex=f};this.setPublicKeyHex=function(f){this.isPublic=!0;this.pubKeyHex=f};this.generateKeyPairHex=function(){var f=this.getBigRandom(this.ecparams.n),e=this.ecparams.G.multiply(f),h=e.getX().toBigInteger(),
e=e.getY().toBigInteger(),l=this.ecparams.keylen/4,f=("0000000000"+f.toString(16)).slice(-l),h=("0000000000"+h.toString(16)).slice(-l),e=("0000000000"+e.toString(16)).slice(-l),h="04"+h+e;this.setPrivateKeyHex(f);this.setPublicKeyHex(h);return{ecprvhex:f,ecpubhex:h}};this.signWithMessageHash=function(f){return this.signHex(f,this.prvKeyHex)};this.signHex=function(f,e){var h=new z(e,16),l=this.ecparams.n,a=new z(f,16);do var b=this.getBigRandom(l),c=this.ecparams.G.multiply(b).getX().toBigInteger().mod(l);
while(0>=c.compareTo(z.ZERO));h=b.modInverse(l).multiply(a.add(h.multiply(c))).mod(l);return N.crypto.ECDSA.biRSSigToASN1Sig(c,h)};this.sign=function(f,e){var h=this.ecparams.n,l=z.fromByteArrayUnsigned(f);do var a=this.getBigRandom(h),b=this.ecparams.G.multiply(a).getX().toBigInteger().mod(h);while(0>=b.compareTo(z.ZERO));h=a.modInverse(h).multiply(l.add(e.multiply(b))).mod(h);return this.serializeSig(b,h)};this.verifyWithMessageHash=function(f,e){return this.verifyHex(f,e,this.pubKeyHex)};this.verifyHex=
function(f,e,h){var l;l=N.crypto.ECDSA.parseSigHex(e);e=l.r;l=l.s;h=ECPointFp.decodeFromHex(this.ecparams.curve,h);f=new z(f,16);return this.verifyRaw(f,e,l,h)};this.verify=function(f,e,h){var l;if(Bitcoin.Util.isArray(e))e=this.parseSig(e),l=e.r,e=e.s;else if("object"===typeof e&&e.r&&e.s)l=e.r,e=e.s;else throw"Invalid value for signature";if(!(h instanceof ECPointFp))if(Bitcoin.Util.isArray(h))h=ECPointFp.decodeFrom(this.ecparams.curve,h);else throw"Invalid format for pubkey value, must be byte array or ECPointFp";
f=z.fromByteArrayUnsigned(f);return this.verifyRaw(f,l,e,h)};this.verifyRaw=function(f,e,h,l){var a=this.ecparams.n,b=this.ecparams.G;if(0>e.compareTo(z.ONE)||0<=e.compareTo(a)||0>h.compareTo(z.ONE)||0<=h.compareTo(a))return!1;h=h.modInverse(a);f=f.multiply(h).mod(a);h=e.multiply(h).mod(a);return b.multiply(f).add(l.multiply(h)).getX().toBigInteger().mod(a).equals(e)};this.serializeSig=function(f,e){var h=f.toByteArraySigned(),l=e.toByteArraySigned(),a=[];a.push(2);a.push(h.length);a=a.concat(h);
a.push(2);a.push(l.length);a=a.concat(l);a.unshift(a.length);a.unshift(48);return a};this.parseSig=function(f){var e;if(48!=f[0])throw Error("Signature not a valid DERSequence");e=2;if(2!=f[e])throw Error("First element in signature must be a DERInteger");var h=f.slice(e+2,e+2+f[e+1]);e+=2+f[e+1];if(2!=f[e])throw Error("Second element in signature must be a DERInteger");f=f.slice(e+2,e+2+f[e+1]);h=z.fromByteArrayUnsigned(h);f=z.fromByteArrayUnsigned(f);return{r:h,s:f}};this.parseSigCompact=function(f){if(65!==
f.length)throw"Signature has the wrong length";var e=f[0]-27;if(0>e||7<e)throw"Invalid signature type";var h=this.ecparams.n,l=z.fromByteArrayUnsigned(f.slice(1,33)).mod(h);f=z.fromByteArrayUnsigned(f.slice(33,65)).mod(h);return{r:l,s:f,i:e}};void 0!==f&&void 0!==f.curve&&(this.curveName=f.curve);void 0===this.curveName&&(this.curveName="secp256r1");this.setNamedCurve(this.curveName);void 0!==f&&(void 0!==f.prv&&this.setPrivateKeyHex(f.prv),void 0!==f.pub&&this.setPublicKeyHex(f.pub))};N.crypto.ECDSA.parseSigHex=
function(f){var h=N.crypto.ECDSA.parseSigHexInHexRS(f);f=new z(h.r,16);h=new z(h.s,16);return{r:f,s:h}};N.crypto.ECDSA.parseSigHexInHexRS=function(f){if("30"!=f.substr(0,2))throw"signature is not a ASN.1 sequence";var h=E.getPosArrayOfChildren_AtObj(f,0);if(2!=h.length)throw"number of signature ASN.1 sequence elements seem wrong";var g=h[0],h=h[1];if("02"!=f.substr(g,2))throw"1st item of sequene of signature is not ASN.1 integer";if("02"!=f.substr(h,2))throw"2nd item of sequene of signature is not ASN.1 integer";
g=E.getHexOfV_AtObj(f,g);f=E.getHexOfV_AtObj(f,h);return{r:g,s:f}};N.crypto.ECDSA.asn1SigToConcatSig=function(f){var h=N.crypto.ECDSA.parseSigHexInHexRS(f);f=h.r;h=h.s;"00"==f.substr(0,2)&&8==f.length/2*8%128&&(f=f.substr(2));"00"==h.substr(0,2)&&8==h.length/2*8%128&&(h=h.substr(2));if(0!=f.length/2*8%128)throw"unknown ECDSA sig r length error";if(0!=h.length/2*8%128)throw"unknown ECDSA sig s length error";return f+h};N.crypto.ECDSA.concatSigToASN1Sig=function(f){if(0!=f.length/2*8%128)throw"unknown ECDSA concatinated r-s sig  length error";
var h=f.substr(0,f.length/2);f=f.substr(f.length/2);return N.crypto.ECDSA.hexRSSigToASN1Sig(h,f)};N.crypto.ECDSA.hexRSSigToASN1Sig=function(f,h){var g=new z(f,16),e=new z(h,16);return N.crypto.ECDSA.biRSSigToASN1Sig(g,e)};N.crypto.ECDSA.biRSSigToASN1Sig=function(f,h){var g=new N.asn1.DERInteger({bigint:f}),e=new N.asn1.DERInteger({bigint:h});return(new N.asn1.DERSequence({array:[g,e]})).getEncodedHex()};cc=a;E=new function(){this.getByteLengthOfL_AtObj=function(f,h){if("8"!=f.substring(h+2,h+3))return 1;
var g=parseInt(f.substring(h+3,h+4));return 0==g?-1:0<g&&10>g?g+1:-2};this.getHexOfL_AtObj=function(f,h){var g=this.getByteLengthOfL_AtObj(f,h);return 1>g?"":f.substring(h+2,h+2+2*g)};this.getIntOfL_AtObj=function(f,h){var g=this.getHexOfL_AtObj(f,h);return""==g?-1:(8>parseInt(g.substring(0,1))?new z(g,16):new z(g.substring(2),16)).intValue()};this.getStartPosOfV_AtObj=function(f,h){var g=this.getByteLengthOfL_AtObj(f,h);return 0>g?g:h+2*(g+1)};this.getHexOfV_AtObj=function(f,h){var g=this.getStartPosOfV_AtObj(f,
h),e=this.getIntOfL_AtObj(f,h);return f.substring(g,g+2*e)};this.getHexOfTLV_AtObj=function(f,h){var g=f.substr(h,2),e=this.getHexOfL_AtObj(f,h),u=this.getHexOfV_AtObj(f,h);return g+e+u};this.getPosOfNextSibling_AtObj=function(f,h){var g=this.getStartPosOfV_AtObj(f,h),e=this.getIntOfL_AtObj(f,h);return g+2*e};this.getPosArrayOfChildren_AtObj=function(f,h){var g=[],e=this.getStartPosOfV_AtObj(f,h);g.push(e);for(var u=this.getIntOfL_AtObj(f,h),l=e,a=0;;){l=this.getPosOfNextSibling_AtObj(f,l);if(null==
l||l-e>=2*u)break;if(200<=a)break;g.push(l);a++}return g};this.getNthChildIndex_AtObj=function(f,h,g){return this.getPosArrayOfChildren_AtObj(f,h)[g]};this.getDecendantIndexByNthList=function(f,h,g){if(0==g.length)return h;var e=g.shift();h=this.getPosArrayOfChildren_AtObj(f,h);return this.getDecendantIndexByNthList(f,h[e],g)};this.getDecendantHexTLVByNthList=function(f,h,g){h=this.getDecendantIndexByNthList(f,h,g);return this.getHexOfTLV_AtObj(f,h)};this.getDecendantHexVByNthList=function(f,h,g){h=
this.getDecendantIndexByNthList(f,h,g);return this.getHexOfV_AtObj(f,h)}};E.getVbyList=function(f,h,g,e){h=this.getDecendantIndexByNthList(f,h,g);if(void 0===h)throw"can't find nthList object";if(void 0!==e&&f.substr(h,2)!=e)throw"checking tag doesn't match: "+f.substr(h,2)+"!="+e;return this.getHexOfV_AtObj(f,h)};E.hextooidstr=function(f){var h=function(e,f){return e.length>=f?e:Array(f-e.length+1).join("0")+e},g=[],e=f.substr(0,2),e=parseInt(e,16);g[0]=new String(Math.floor(e/40));g[1]=new String(e%
40);var u=f.substr(2);f=[];for(e=0;e<u.length/2;e++)f.push(parseInt(u.substr(2*e,2),16));for(var u=[],l="",e=0;e<f.length;e++)f[e]&128?l+=h((f[e]&127).toString(2),7):(l+=h((f[e]&127).toString(2),7),u.push(new String(parseInt(l,2))),l="");h=g.join(".");0<u.length&&(h=h+"."+u.join("."));return h};E.dump=function(f,h,g,e){var u=function(e,f){return e.length<=2*f?e:e.substr(0,f)+"..(total "+e.length/2+"bytes).."+e.substr(e.length-f,f)};void 0===h&&(h={ommit_long_octet:32});void 0===g&&(g=0);void 0===
e&&(e="");var l=h.ommit_long_octet;if("01"==f.substr(g,2))return f=E.getHexOfV_AtObj(f,g),"00"==f?e+"BOOLEAN FALSE\n":e+"BOOLEAN TRUE\n";if("02"==f.substr(g,2))return f=E.getHexOfV_AtObj(f,g),e+"INTEGER "+u(f,l)+"\n";if("03"==f.substr(g,2))return f=E.getHexOfV_AtObj(f,g),e+"BITSTRING "+u(f,l)+"\n";if("04"==f.substr(g,2))return f=E.getHexOfV_AtObj(f,g),E.isASN1HEX(f)?u=e+"OCTETSTRING, encapsulates\n"+E.dump(f,h,0,e+"  "):e+"OCTETSTRING "+u(f,l)+"\n";if("05"==f.substr(g,2))return e+"NULL\n";if("06"==
f.substr(g,2)){f=E.getHexOfV_AtObj(f,g);var a=N.asn1.ASN1Util.oidHexToInt(f),l=N.asn1.x509.OID.oid2name(a);f=a.replace(/\./g," ");return""!=l?e+"ObjectIdentifier "+l+" ("+f+")\n":e+"ObjectIdentifier ("+f+")\n"}if("0c"==f.substr(g,2))return e+"UTF8String '"+hextoutf8(E.getHexOfV_AtObj(f,g))+"'\n";if("13"==f.substr(g,2))return e+"PrintableString '"+hextoutf8(E.getHexOfV_AtObj(f,g))+"'\n";if("14"==f.substr(g,2))return e+"TeletexString '"+hextoutf8(E.getHexOfV_AtObj(f,g))+"'\n";if("16"==f.substr(g,2))return e+
"IA5String '"+hextoutf8(E.getHexOfV_AtObj(f,g))+"'\n";if("17"==f.substr(g,2))return e+"UTCTime "+hextoutf8(E.getHexOfV_AtObj(f,g))+"\n";if("18"==f.substr(g,2))return e+"GeneralizedTime "+hextoutf8(E.getHexOfV_AtObj(f,g))+"\n";if("30"==f.substr(g,2)){if("3000"==f.substr(g,4))return e+"SEQUENCE {}\n";u=e+"SEQUENCE\n";g=E.getPosArrayOfChildren_AtObj(f,g);l=h;2!=g.length&&3!=g.length||"06"!=f.substr(g[0],2)||"04"!=f.substr(g[g.length-1],2)||(l=E.getHexOfV_AtObj(f,g[0]),a=N.asn1.ASN1Util.oidHexToInt(l),
l=N.asn1.x509.OID.oid2name(a),h=JSON.parse(JSON.stringify(h)),h.x509ExtName=l,l=h);for(a=0;a<g.length;a++)u+=E.dump(f,l,g[a],e+"  ");return u}if("31"==f.substr(g,2)){u=e+"SET\n";g=E.getPosArrayOfChildren_AtObj(f,g);for(a=0;a<g.length;a++)u+=E.dump(f,h,g[a],e+"  ");return u}l=parseInt(f.substr(g,2),16);if(0!=(l&128)){u=l&31;if(0!=(l&32))for(u=e+"["+u+"]\n",g=E.getPosArrayOfChildren_AtObj(f,g),a=0;a<g.length;a++)u+=E.dump(f,h,g[a],e+"  ");else f=E.getHexOfV_AtObj(f,g),"68747470"==f.substr(0,8)&&(f=
hextoutf8(f)),"subjectAltName"===h.x509ExtName&&2==u&&(f=hextoutf8(f)),u=e+"["+u+"] "+f+"\n";return u}return e+"UNKNOWN("+f.substr(g,2)+") "+E.getHexOfV_AtObj(f,g)+"\n"};E.isASN1HEX=function(f){if(1==f.length%2)return!1;var h=E.getIntOfL_AtObj(f,0),g=f.substr(0,2),e=E.getHexOfL_AtObj(f,0);return f.length-g.length-e.length==2*h?!0:!1};q.ASN1HEX=E;t=a.b64tohex;A=a.RSAKey;E=a.ASN1HEX;aa.pemToBase64=function(f){f=f.replace("-----BEGIN CERTIFICATE-----","");f=f.replace("-----END CERTIFICATE-----","");
return f=f.replace(/[ \n]+/g,"")};aa.pemToHex=function(f){f=aa.pemToBase64(f);return t(f)};aa.getSubjectPublicKeyPosFromCertHex=function(f){var h=aa.getSubjectPublicKeyInfoPosFromCertHex(f);if(-1==h)return-1;h=E.getPosArrayOfChildren_AtObj(f,h);if(2!=h.length)return-1;h=h[1];if("03"!=f.substring(h,h+2))return-1;h=E.getStartPosOfV_AtObj(f,h);return"00"!=f.substring(h,h+2)?-1:h+2};aa.getSubjectPublicKeyInfoPosFromCertHex=function(f){var h=E.getStartPosOfV_AtObj(f,0),h=E.getPosArrayOfChildren_AtObj(f,
h);return 1>h.length?-1:"a003020102"==f.substring(h[0],h[0]+10)?6>h.length?-1:h[6]:5>h.length?-1:h[5]};aa.getPublicKeyHexArrayFromCertHex=function(f){var h=aa.getSubjectPublicKeyPosFromCertHex(f),g=E.getPosArrayOfChildren_AtObj(f,h);if(2!=g.length)return[];h=E.getHexOfV_AtObj(f,g[0]);f=E.getHexOfV_AtObj(f,g[1]);return null!=h&&null!=f?[h,f]:[]};aa.getHexTbsCertificateFromCert=function(f){return E.getStartPosOfV_AtObj(f,0)};aa.getPublicKeyHexArrayFromCertPEM=function(f){f=aa.pemToHex(f);return aa.getPublicKeyHexArrayFromCertHex(f)};
aa.hex2dn=function(f){for(var h="",g=E.getPosArrayOfChildren_AtObj(f,0),e=0;e<g.length;e++)var u=E.getHexOfTLV_AtObj(f,g[e]),h=h+"/"+aa.hex2rdn(u);return h};aa.hex2rdn=function(f){var h=E.getDecendantHexTLVByNthList(f,0,[0,0]),g=E.getDecendantHexVByNthList(f,0,[0,1]);f="";try{f=aa.DN_ATTRHEX[h]}catch(e){f=h}g=g.replace(/(..)/g,"%$1");h=decodeURIComponent(g);return f+"="+h};aa.DN_ATTRHEX={"0603550406":"C","060355040a":"O","060355040b":"OU","0603550403":"CN","0603550405":"SN","0603550408":"ST","0603550407":"L"};
aa.getPublicKeyFromCertPEM=function(f){var h=aa.getPublicKeyInfoPropOfCertPEM(f);if("2a864886f70d010101"==h.algoid){var g=KEYUTIL.parsePublicRawRSAKeyHex(h.keyhex);f=new A;f.setPublic(g.n,g.e);return f}if("2a8648ce3d0201"==h.algoid)return f=new N.crypto.ECDSA({curve:N.crypto.OID.oidhex2name[h.algparam],info:h.keyhex}),f.setPublicKeyHex(h.keyhex),f;if("2a8648ce380401"==h.algoid){var g=E.getVbyList(h.algparam,0,[0],"02"),e=E.getVbyList(h.algparam,0,[1],"02"),u=E.getVbyList(h.algparam,0,[2],"02"),h=
E.getHexOfV_AtObj(h.keyhex,0),h=h.substr(2);f=new N.crypto.DSA;f.setPublic(new z(g,16),new z(e,16),new z(u,16),new z(h,16));return f}throw"unsupported key";};aa.getPublicKeyInfoPropOfCertPEM=function(f){var h={algparam:null};f=aa.pemToHex(f);var g=E.getPosArrayOfChildren_AtObj(f,0);if(3!=g.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=f.substr(g[0],2))throw"malformed X.509 certificate PEM (code:002)";g=E.getPosArrayOfChildren_AtObj(f,g[0]);if(7>g.length)throw"malformed X.509 certificate PEM (code:003)";
g=E.getPosArrayOfChildren_AtObj(f,g[6]);if(2!=g.length)throw"malformed X.509 certificate PEM (code:004)";var e=E.getPosArrayOfChildren_AtObj(f,g[0]);if(2!=e.length)throw"malformed X.509 certificate PEM (code:005)";h.algoid=E.getHexOfV_AtObj(f,e[0]);"06"==f.substr(e[1],2)?h.algparam=E.getHexOfV_AtObj(f,e[1]):"30"==f.substr(e[1],2)&&(h.algparam=E.getHexOfTLV_AtObj(f,e[1]));if("03"!=f.substr(g[1],2))throw"malformed X.509 certificate PEM (code:006)";f=E.getHexOfV_AtObj(f,g[1]);h.keyhex=f.substr(2);return h};
aa.getPublicKeyInfoPosOfCertHEX=function(f){var h=E.getPosArrayOfChildren_AtObj(f,0);if(3!=h.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=f.substr(h[0],2))throw"malformed X.509 certificate PEM (code:002)";f=E.getPosArrayOfChildren_AtObj(f,h[0]);if(7>f.length)throw"malformed X.509 certificate PEM (code:003)";return f[6]};aa.getV3ExtInfoListOfCertHex=function(f){var h=E.getPosArrayOfChildren_AtObj(f,0);if(3!=h.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=f.substr(h[0],
2))throw"malformed X.509 certificate PEM (code:002)";h=E.getPosArrayOfChildren_AtObj(f,h[0]);if(8>h.length)throw"malformed X.509 certificate PEM (code:003)";if("a3"!=f.substr(h[7],2))throw"malformed X.509 certificate PEM (code:004)";h=E.getPosArrayOfChildren_AtObj(f,h[7]);if(1!=h.length)throw"malformed X.509 certificate PEM (code:005)";if("30"!=f.substr(h[0],2))throw"malformed X.509 certificate PEM (code:006)";for(var h=E.getPosArrayOfChildren_AtObj(f,h[0]),g=h.length,e=Array(g),u=0;u<g;u++)e[u]=
aa.getV3ExtItemInfo_AtObj(f,h[u]);return e};aa.getV3ExtItemInfo_AtObj=function(f,h){var g={};g.posTLV=h;var e=E.getPosArrayOfChildren_AtObj(f,h);if(2!=e.length&&3!=e.length)throw"malformed X.509v3 Ext (code:001)";if("06"!=f.substr(e[0],2))throw"malformed X.509v3 Ext (code:002)";var u=E.getHexOfV_AtObj(f,e[0]);g.oid=E.hextooidstr(u);g.critical=!1;3==e.length&&(g.critical=!0);e=e[e.length-1];if("04"!=f.substr(e,2))throw"malformed X.509v3 Ext (code:003)";g.posV=E.getStartPosOfV_AtObj(f,e);return g};
aa.getHexOfTLV_V3ExtValue=function(f,h){var g=aa.getPosOfTLV_V3ExtValue(f,h);return-1==g?"":E.getHexOfTLV_AtObj(f,g)};aa.getHexOfV_V3ExtValue=function(f,h){var g=aa.getPosOfTLV_V3ExtValue(f,h);return-1==g?"":E.getHexOfV_AtObj(f,g)};aa.getPosOfTLV_V3ExtValue=function(f,h){var g=h;h.match(/^[0-9.]+$/)||(g=N.asn1.x509.OID.name2oid(h));if(""==g)return-1;for(var e=aa.getV3ExtInfoListOfCertHex(f),u=0;u<e.length;u++){var l=e[u];if(l.oid==g)return l.posV}return-1};aa.KEYUSAGE_NAME="digitalSignature nonRepudiation keyEncipherment dataEncipherment keyAgreement keyCertSign cRLSign encipherOnly decipherOnly".split(" ");
aa.getExtKeyUsageBin=function(f){var h=aa.getHexOfV_V3ExtValue(f,"keyUsage");if(""==h)return"";if(0!=h.length%2||2>=h.length)throw"malformed key usage value";f=parseInt(h.substr(0,2));h=parseInt(h.substr(2),16).toString(2);return h.substr(0,h.length-f)};aa.getExtKeyUsageString=function(f){f=aa.getExtKeyUsageBin(f);for(var h=[],g=0;g<f.length;g++)"1"==f.substr(g,1)&&h.push(aa.KEYUSAGE_NAME[g]);return h.join(",")};aa.getExtAIAInfo=function(f){var h={ocsp:[],caissuer:[]},g=aa.getPosOfTLV_V3ExtValue(f,
"authorityInfoAccess");if(-1==g)return null;if("30"!=f.substr(g,2))throw"malformed AIA Extn Value";for(var g=E.getPosArrayOfChildren_AtObj(f,g),e=0;e<g.length;e++){var u=E.getPosArrayOfChildren_AtObj(f,g[e]);if(2!=u.length)throw"malformed AccessDescription of AIA Extn";var l=u[0],u=u[1];"2b06010505073001"==E.getHexOfV_AtObj(f,l)&&"86"==f.substr(u,2)&&h.ocsp.push(hextoutf8(E.getHexOfV_AtObj(f,u)));"2b06010505073002"==E.getHexOfV_AtObj(f,l)&&"86"==f.substr(u,2)&&h.caissuer.push(hextoutf8(E.getHexOfV_AtObj(f,
u)))}return h};q.X509=aa;var tc,z=function(f,h,g){null!=f&&("number"==typeof f?this.fromNumber(f,h,g):null==h&&"string"!=typeof f?this.fromString(f,256):this.fromString(f,h))};"Microsoft Internet Explorer"==navigator.appName?(z.prototype.am=je,tc=30):"Netscape"!=navigator.appName?(z.prototype.am=Eb,tc=26):(z.prototype.am=Sd,tc=28);z.prototype.DB=tc;z.prototype.DM=(1<<tc)-1;z.prototype.DV=1<<tc;z.prototype.FV=Math.pow(2,52);z.prototype.F1=52-tc;z.prototype.F2=2*tc-52;var Qb="0123456789abcdefghijklmnopqrstuvwxyz",
ke=[],Gc,Sb;Gc=48;for(Sb=0;9>=Sb;++Sb)ke[Gc++]=Sb;Gc=97;for(Sb=10;36>Sb;++Sb)ke[Gc++]=Sb;Gc=65;for(Sb=10;36>Sb;++Sb)ke[Gc++]=Sb;rc.prototype.convert=function(f){return 0>f.s||0<=f.compareTo(this.m)?f.mod(this.m):f};rc.prototype.revert=function(f){return f};rc.prototype.reduce=function(f){f.divRemTo(this.m,null,f)};rc.prototype.mulTo=function(f,h,g){f.multiplyTo(h,g);this.reduce(g)};rc.prototype.sqrTo=function(f,h){f.squareTo(h);this.reduce(h)};La.prototype.convert=function(f){var h=ga();f.abs().dlShiftTo(this.m.t,
h);h.divRemTo(this.m,null,h);0>f.s&&0<h.compareTo(z.ZERO)&&this.m.subTo(h,h);return h};La.prototype.revert=function(f){var h=ga();f.copyTo(h);this.reduce(h);return h};La.prototype.reduce=function(f){for(;f.t<=this.mt2;)f[f.t++]=0;for(var h=0;h<this.m.t;++h){var g=f[h]&32767,e=g*this.mpl+((g*this.mph+(f[h]>>15)*this.mpl&this.um)<<15)&f.DM,g=h+this.m.t;for(f[g]+=this.m.am(0,e,f,h,0,this.m.t);f[g]>=f.DV;)f[g]-=f.DV,f[++g]++}f.clamp();f.drShiftTo(this.m.t,f);0<=f.compareTo(this.m)&&f.subTo(this.m,f)};
La.prototype.mulTo=function(f,h,g){f.multiplyTo(h,g);this.reduce(g)};La.prototype.sqrTo=function(f,h){f.squareTo(h);this.reduce(h)};z.prototype.copyTo=function(f){for(var h=this.t-1;0<=h;--h)f[h]=this[h];f.t=this.t;f.s=this.s};z.prototype.fromInt=function(f){this.t=1;this.s=0>f?-1:0;0<f?this[0]=f:-1>f?this[0]=f+this.DV:this.t=0};z.prototype.fromString=function(f,h){var g;if(16==h)g=4;else if(8==h)g=3;else if(256==h)g=8;else if(2==h)g=1;else if(32==h)g=5;else if(4==h)g=2;else{this.fromRadix(f,h);return}this.s=
this.t=0;for(var e=f.length,u=!1,l=0;0<=--e;){var a=8==g?f[e]&255:Sc(f,e);0>a?"-"==f.charAt(e)&&(u=!0):(u=!1,0==l?this[this.t++]=a:l+g>this.DB?(this[this.t-1]|=(a&(1<<this.DB-l)-1)<<l,this[this.t++]=a>>this.DB-l):this[this.t-1]|=a<<l,l+=g,l>=this.DB&&(l-=this.DB))}8==g&&0!=(f[0]&128)&&(this.s=-1,0<l&&(this[this.t-1]|=(1<<this.DB-l)-1<<l));this.clamp();u&&z.ZERO.subTo(this,this)};z.prototype.clamp=function(){for(var f=this.s&this.DM;0<this.t&&this[this.t-1]==f;)--this.t};z.prototype.dlShiftTo=function(f,
h){var g;for(g=this.t-1;0<=g;--g)h[g+f]=this[g];for(g=f-1;0<=g;--g)h[g]=0;h.t=this.t+f;h.s=this.s};z.prototype.drShiftTo=function(f,h){for(var g=f;g<this.t;++g)h[g-f]=this[g];h.t=Math.max(this.t-f,0);h.s=this.s};z.prototype.lShiftTo=function(f,h){var g=f%this.DB,e=this.DB-g,u=(1<<e)-1,l=Math.floor(f/this.DB),a=this.s<<g&this.DM,b;for(b=this.t-1;0<=b;--b)h[b+l+1]=this[b]>>e|a,a=(this[b]&u)<<g;for(b=l-1;0<=b;--b)h[b]=0;h[l]=a;h.t=this.t+l+1;h.s=this.s;h.clamp()};z.prototype.rShiftTo=function(f,h){h.s=
this.s;var g=Math.floor(f/this.DB);if(g>=this.t)h.t=0;else{var e=f%this.DB,u=this.DB-e,l=(1<<e)-1;h[0]=this[g]>>e;for(var a=g+1;a<this.t;++a)h[a-g-1]|=(this[a]&l)<<u,h[a-g]=this[a]>>e;0<e&&(h[this.t-g-1]|=(this.s&l)<<u);h.t=this.t-g;h.clamp()}};z.prototype.subTo=function(f,h){for(var g=0,e=0,u=Math.min(f.t,this.t);g<u;)e+=this[g]-f[g],h[g++]=e&this.DM,e>>=this.DB;if(f.t<this.t){for(e-=f.s;g<this.t;)e+=this[g],h[g++]=e&this.DM,e>>=this.DB;e+=this.s}else{for(e+=this.s;g<f.t;)e-=f[g],h[g++]=e&this.DM,
e>>=this.DB;e-=f.s}h.s=0>e?-1:0;-1>e?h[g++]=this.DV+e:0<e&&(h[g++]=e);h.t=g;h.clamp()};z.prototype.multiplyTo=function(f,h){var g=this.abs(),e=f.abs(),u=g.t;for(h.t=u+e.t;0<=--u;)h[u]=0;for(u=0;u<e.t;++u)h[u+g.t]=g.am(0,e[u],h,u,0,g.t);h.s=0;h.clamp();this.s!=f.s&&z.ZERO.subTo(h,h)};z.prototype.squareTo=function(f){for(var h=this.abs(),g=f.t=2*h.t;0<=--g;)f[g]=0;for(g=0;g<h.t-1;++g){var e=h.am(g,h[g],f,2*g,0,1);(f[g+h.t]+=h.am(g+1,2*h[g],f,2*g+1,e,h.t-g-1))>=h.DV&&(f[g+h.t]-=h.DV,f[g+h.t+1]=1)}0<
f.t&&(f[f.t-1]+=h.am(g,h[g],f,2*g,0,1));f.s=0;f.clamp()};z.prototype.divRemTo=function(f,h,g){var e=f.abs();if(!(0>=e.t)){var u=this.abs();if(u.t<e.t)null!=h&&h.fromInt(0),null!=g&&this.copyTo(g);else{null==g&&(g=ga());var l=ga(),a=this.s;f=f.s;var b=this.DB-yd(e[e.t-1]);0<b?(e.lShiftTo(b,l),u.lShiftTo(b,g)):(e.copyTo(l),u.copyTo(g));e=l.t;u=l[e-1];if(0!=u){var c=u*(1<<this.F1)+(1<e?l[e-2]>>this.F2:0),d=this.FV/c,c=(1<<this.F1)/c,k=1<<this.F2,m=g.t,n=m-e,p=null==h?ga():h;l.dlShiftTo(n,p);0<=g.compareTo(p)&&
(g[g.t++]=1,g.subTo(p,g));z.ONE.dlShiftTo(e,p);for(p.subTo(l,l);l.t<e;)l[l.t++]=0;for(;0<=--n;){var s=g[--m]==u?this.DM:Math.floor(g[m]*d+(g[m-1]+k)*c);if((g[m]+=l.am(0,s,g,n,0,e))<s)for(l.dlShiftTo(n,p),g.subTo(p,g);g[m]<--s;)g.subTo(p,g)}null!=h&&(g.drShiftTo(e,h),a!=f&&z.ZERO.subTo(h,h));g.t=e;g.clamp();0<b&&g.rShiftTo(b,g);0>a&&z.ZERO.subTo(g,g)}}}};z.prototype.invDigit=function(){if(1>this.t)return 0;var f=this[0];if(0==(f&1))return 0;var h=f&3,h=h*(2-(f&15)*h)&15,h=h*(2-(f&255)*h)&255,h=h*(2-
((f&65535)*h&65535))&65535,h=h*(2-f*h%this.DV)%this.DV;return 0<h?this.DV-h:-h};z.prototype.isEven=function(){return 0==(0<this.t?this[0]&1:this.s)};z.prototype.exp=function(f,h){if(4294967295<f||1>f)return z.ONE;var g=ga(),e=ga(),u=h.convert(this),l=yd(f)-1;for(u.copyTo(g);0<=--l;)if(h.sqrTo(g,e),0<(f&1<<l))h.mulTo(e,u,g);else var a=g,g=e,e=a;return h.revert(g)};z.prototype.toString=function(f){if(0>this.s)return"-"+this.negate().toString(f);if(16==f)f=4;else if(8==f)f=3;else if(2==f)f=1;else if(32==
f)f=5;else if(4==f)f=2;else return this.toRadix(f);var h=(1<<f)-1,g,e=!1,u="",l=this.t,a=this.DB-l*this.DB%f;if(0<l--)for(a<this.DB&&0<(g=this[l]>>a)&&(e=!0,u=Qb.charAt(g));0<=l;)a<f?(g=(this[l]&(1<<a)-1)<<f-a,g|=this[--l]>>(a+=this.DB-f)):(g=this[l]>>(a-=f)&h,0>=a&&(a+=this.DB,--l)),0<g&&(e=!0),e&&(u+=Qb.charAt(g));return e?u:"0"};z.prototype.negate=function(){var f=ga();z.ZERO.subTo(this,f);return f};z.prototype.abs=function(){return 0>this.s?this.negate():this};z.prototype.compareTo=function(f){var h=
this.s-f.s;if(0!=h)return h;var g=this.t,h=g-f.t;if(0!=h)return 0>this.s?-h:h;for(;0<=--g;)if(0!=(h=this[g]-f[g]))return h;return 0};z.prototype.bitLength=function(){return 0>=this.t?0:this.DB*(this.t-1)+yd(this[this.t-1]^this.s&this.DM)};z.prototype.mod=function(f){var h=ga();this.abs().divRemTo(f,null,h);0>this.s&&0<h.compareTo(z.ZERO)&&f.subTo(h,h);return h};z.prototype.modPowInt=function(f,h){var g;g=256>f||h.isEven()?new rc(h):new La(h);return this.exp(f,g)};z.ZERO=Dc(0);z.ONE=Dc(1);Uc.prototype.convert=
zd;Uc.prototype.revert=zd;Uc.prototype.mulTo=function(f,h,g){f.multiplyTo(h,g)};Uc.prototype.sqrTo=function(f,h){f.squareTo(h)};Ec.prototype.convert=function(f){if(0>f.s||f.t>2*this.m.t)return f.mod(this.m);if(0>f.compareTo(this.m))return f;var h=ga();f.copyTo(h);this.reduce(h);return h};Ec.prototype.revert=function(f){return f};Ec.prototype.reduce=function(f){f.drShiftTo(this.m.t-1,this.r2);f.t>this.m.t+1&&(f.t=this.m.t+1,f.clamp());this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3);for(this.m.multiplyLowerTo(this.q3,
this.m.t+1,this.r2);0>f.compareTo(this.r2);)f.dAddOffset(1,this.m.t+1);for(f.subTo(this.r2,f);0<=f.compareTo(this.m);)f.subTo(this.m,f)};Ec.prototype.mulTo=function(f,h,g){f.multiplyTo(h,g);this.reduce(g)};Ec.prototype.sqrTo=function(f,h){f.squareTo(h);this.reduce(h)};var ob=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,
313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],Qe=67108864/ob[ob.length-1];z.prototype.chunkSize=function(f){return Math.floor(Math.LN2*
this.DB/Math.log(f))};z.prototype.toRadix=function(f){null==f&&(f=10);if(0==this.signum()||2>f||36<f)return"0";var h=this.chunkSize(f),h=Math.pow(f,h),g=Dc(h),e=ga(),u=ga(),l="";for(this.divRemTo(g,e,u);0<e.signum();)l=(h+u.intValue()).toString(f).substr(1)+l,e.divRemTo(g,e,u);return u.intValue().toString(f)+l};z.prototype.fromRadix=function(f,h){this.fromInt(0);null==h&&(h=10);for(var g=this.chunkSize(h),e=Math.pow(h,g),u=!1,l=0,a=0,b=0;b<f.length;++b){var c=Sc(f,b);0>c?"-"==f.charAt(b)&&0==this.signum()&&
(u=!0):(a=h*a+c,++l>=g&&(this.dMultiply(e),this.dAddOffset(a,0),a=l=0))}0<l&&(this.dMultiply(Math.pow(h,l)),this.dAddOffset(a,0));u&&z.ZERO.subTo(this,this)};z.prototype.fromNumber=function(f,h,g){if("number"==typeof h)if(2>f)this.fromInt(1);else for(this.fromNumber(f,g),this.testBit(f-1)||this.bitwiseTo(z.ONE.shiftLeft(f-1),Jd,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(h);)this.dAddOffset(2,0),this.bitLength()>f&&this.subTo(z.ONE.shiftLeft(f-1),this);else{g=[];var e=f&7;g.length=
(f>>3)+1;h.nextBytes(g);g[0]=0<e?g[0]&(1<<e)-1:0;this.fromString(g,256)}};z.prototype.bitwiseTo=function(f,h,g){var e,u,l=Math.min(f.t,this.t);for(e=0;e<l;++e)g[e]=h(this[e],f[e]);if(f.t<this.t){u=f.s&this.DM;for(e=l;e<this.t;++e)g[e]=h(this[e],u);g.t=this.t}else{u=this.s&this.DM;for(e=l;e<f.t;++e)g[e]=h(u,f[e]);g.t=f.t}g.s=h(this.s,f.s);g.clamp()};z.prototype.changeBit=function(f,h){var g=z.ONE.shiftLeft(f);this.bitwiseTo(g,h,g);return g};z.prototype.addTo=function(f,h){for(var g=0,e=0,u=Math.min(f.t,
this.t);g<u;)e+=this[g]+f[g],h[g++]=e&this.DM,e>>=this.DB;if(f.t<this.t){for(e+=f.s;g<this.t;)e+=this[g],h[g++]=e&this.DM,e>>=this.DB;e+=this.s}else{for(e+=this.s;g<f.t;)e+=f[g],h[g++]=e&this.DM,e>>=this.DB;e+=f.s}h.s=0>e?-1:0;0<e?h[g++]=e:-1>e&&(h[g++]=this.DV+e);h.t=g;h.clamp()};z.prototype.dMultiply=function(f){this[this.t]=this.am(0,f-1,this,0,0,this.t);++this.t;this.clamp()};z.prototype.dAddOffset=function(f,h){if(0!=f){for(;this.t<=h;)this[this.t++]=0;for(this[h]+=f;this[h]>=this.DV;)this[h]-=
this.DV,++h>=this.t&&(this[this.t++]=0),++this[h]}};z.prototype.multiplyLowerTo=function(f,h,g){var e=Math.min(this.t+f.t,h);g.s=0;for(g.t=e;0<e;)g[--e]=0;var u;for(u=g.t-this.t;e<u;++e)g[e+this.t]=this.am(0,f[e],g,e,0,this.t);for(u=Math.min(f.t,h);e<u;++e)this.am(0,f[e],g,e,0,h-e);g.clamp()};z.prototype.multiplyUpperTo=function(f,h,g){--h;var e=g.t=this.t+f.t-h;for(g.s=0;0<=--e;)g[e]=0;for(e=Math.max(h-this.t,0);e<f.t;++e)g[this.t+e-h]=this.am(h-e,f[e],g,0,0,this.t+e-h);g.clamp();g.drShiftTo(1,g)};
z.prototype.modInt=function(f){if(0>=f)return 0;var h=this.DV%f,g=0>this.s?f-1:0;if(0<this.t)if(0==h)g=this[0]%f;else for(var e=this.t-1;0<=e;--e)g=(h*g+this[e])%f;return g};z.prototype.millerRabin=function(f){var h=this.subtract(z.ONE),g=h.getLowestSetBit();if(0>=g)return!1;var e=h.shiftRight(g);f=f+1>>1;f>ob.length&&(f=ob.length);for(var u=ga(),l=0;l<f;++l){u.fromInt(ob[Math.floor(Math.random()*ob.length)]);var a=u.modPow(e,this);if(0!=a.compareTo(z.ONE)&&0!=a.compareTo(h)){for(var b=1;b++<g&&0!=
a.compareTo(h);)if(a=a.modPowInt(2,this),0==a.compareTo(z.ONE))return!1;if(0!=a.compareTo(h))return!1}}return!0};z.prototype.clone=function(){var f=ga();this.copyTo(f);return f};z.prototype.intValue=function(){if(0>this.s){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]};z.prototype.byteValue=function(){return 0==this.t?this.s:this[0]<<24>>24};z.prototype.shortValue=function(){return 0==
this.t?this.s:this[0]<<16>>16};z.prototype.signum=function(){return 0>this.s?-1:0>=this.t||1==this.t&&0>=this[0]?0:1};z.prototype.toByteArray=function(){var f=this.t,h=[];h[0]=this.s;var g=this.DB-f*this.DB%8,e,u=0;if(0<f--)for(g<this.DB&&(e=this[f]>>g)!=(this.s&this.DM)>>g&&(h[u++]=e|this.s<<this.DB-g);0<=f;)if(8>g?(e=(this[f]&(1<<g)-1)<<8-g,e|=this[--f]>>(g+=this.DB-8)):(e=this[f]>>(g-=8)&255,0>=g&&(g+=this.DB,--f)),0!=(e&128)&&(e|=-256),0==u&&(this.s&128)!=(e&128)&&++u,0<u||e!=this.s)h[u++]=e;
return h};z.prototype.equals=function(f){return 0==this.compareTo(f)};z.prototype.min=function(f){return 0>this.compareTo(f)?this:f};z.prototype.max=function(f){return 0<this.compareTo(f)?this:f};z.prototype.and=function(f){var h=ga();this.bitwiseTo(f,te,h);return h};z.prototype.or=function(f){var h=ga();this.bitwiseTo(f,Jd,h);return h};z.prototype.xor=function(f){var h=ga();this.bitwiseTo(f,Kd,h);return h};z.prototype.andNot=function(f){var h=ga();this.bitwiseTo(f,Tc,h);return h};z.prototype.not=
function(){for(var f=ga(),h=0;h<this.t;++h)f[h]=this.DM&~this[h];f.t=this.t;f.s=~this.s;return f};z.prototype.shiftLeft=function(f){var h=ga();0>f?this.rShiftTo(-f,h):this.lShiftTo(f,h);return h};z.prototype.shiftRight=function(f){var h=ga();0>f?this.lShiftTo(-f,h):this.rShiftTo(f,h);return h};z.prototype.getLowestSetBit=function(){for(var f=0;f<this.t;++f)if(0!=this[f]){var h=f*this.DB;f=this[f];if(0==f)f=-1;else{var g=0;0==(f&65535)&&(f>>=16,g+=16);0==(f&255)&&(f>>=8,g+=8);0==(f&15)&&(f>>=4,g+=
4);0==(f&3)&&(f>>=2,g+=2);0==(f&1)&&++g;f=g}return h+f}return 0>this.s?this.t*this.DB:-1};z.prototype.bitCount=function(){for(var f=0,h=this.s&this.DM,g=0;g<this.t;++g){for(var e=this[g]^h,u=0;0!=e;)e&=e-1,++u;f+=u}return f};z.prototype.testBit=function(f){var h=Math.floor(f/this.DB);return h>=this.t?0!=this.s:0!=(this[h]&1<<f%this.DB)};z.prototype.setBit=function(f){return this.changeBit(f,Jd)};z.prototype.clearBit=function(f){return this.changeBit(f,Tc)};z.prototype.flipBit=function(f){return this.changeBit(f,
Kd)};z.prototype.add=function(f){var h=ga();this.addTo(f,h);return h};z.prototype.subtract=function(f){var h=ga();this.subTo(f,h);return h};z.prototype.multiply=function(f){var h=ga();this.multiplyTo(f,h);return h};z.prototype.divide=function(f){var h=ga();this.divRemTo(f,h,null);return h};z.prototype.remainder=function(f){var h=ga();this.divRemTo(f,null,h);return h};z.prototype.divideAndRemainder=function(f){var h=ga(),g=ga();this.divRemTo(f,h,g);return[h,g]};z.prototype.modPow=function(f,h){var g=
f.bitLength(),e,u=Dc(1),l;if(0>=g)return u;e=18>g?1:48>g?3:144>g?4:768>g?5:6;l=8>g?new rc(h):h.isEven()?new Ec(h):new La(h);var a=[],b=3,c=e-1,d=(1<<e)-1;a[1]=l.convert(this);if(1<e)for(g=ga(),l.sqrTo(a[1],g);b<=d;)a[b]=ga(),l.mulTo(g,a[b-2],a[b]),b+=2;for(var k=f.t-1,m,n=!0,p=ga(),g=yd(f[k])-1;0<=k;){g>=c?m=f[k]>>g-c&d:(m=(f[k]&(1<<g+1)-1)<<c-g,0<k&&(m|=f[k-1]>>this.DB+g-c));for(b=e;0==(m&1);)m>>=1,--b;0>(g-=b)&&(g+=this.DB,--k);if(n)a[m].copyTo(u),n=!1;else{for(;1<b;)l.sqrTo(u,p),l.sqrTo(p,u),b-=
2;0<b?l.sqrTo(u,p):(b=u,u=p,p=b);l.mulTo(p,a[m],u)}for(;0<=k&&0==(f[k]&1<<g);)l.sqrTo(u,p),b=u,u=p,p=b,0>--g&&(g=this.DB-1,--k)}return l.revert(u)};z.prototype.modInverse=function(f){var h=f.isEven();if(this.isEven()&&h||0==f.signum())return z.ZERO;for(var g=f.clone(),e=this.clone(),u=Dc(1),l=Dc(0),a=Dc(0),b=Dc(1);0!=g.signum();){for(;g.isEven();)g.rShiftTo(1,g),h?(u.isEven()&&l.isEven()||(u.addTo(this,u),l.subTo(f,l)),u.rShiftTo(1,u)):l.isEven()||l.subTo(f,l),l.rShiftTo(1,l);for(;e.isEven();)e.rShiftTo(1,
e),h?(a.isEven()&&b.isEven()||(a.addTo(this,a),b.subTo(f,b)),a.rShiftTo(1,a)):b.isEven()||b.subTo(f,b),b.rShiftTo(1,b);0<=g.compareTo(e)?(g.subTo(e,g),h&&u.subTo(a,u),l.subTo(b,l)):(e.subTo(g,e),h&&a.subTo(u,a),b.subTo(l,b))}if(0!=e.compareTo(z.ONE))return z.ZERO;if(0<=b.compareTo(f))return b.subtract(f);if(0>b.signum())b.addTo(f,b);else return b;return 0>b.signum()?b.add(f):b};z.prototype.pow=function(f){return this.exp(f,new Uc)};z.prototype.gcd=function(f){var h=0>this.s?this.negate():this.clone();
f=0>f.s?f.negate():f.clone();if(0>h.compareTo(f)){var g=h,h=f;f=g}var g=h.getLowestSetBit(),e=f.getLowestSetBit();if(0>e)return h;g<e&&(e=g);0<e&&(h.rShiftTo(e,h),f.rShiftTo(e,f));for(;0<h.signum();)0<(g=h.getLowestSetBit())&&h.rShiftTo(g,h),0<(g=f.getLowestSetBit())&&f.rShiftTo(g,f),0<=h.compareTo(f)?(h.subTo(f,h),h.rShiftTo(1,h)):(f.subTo(h,f),f.rShiftTo(1,f));0<e&&f.lShiftTo(e,f);return f};z.prototype.isProbablePrime=function(f){var h,g=this.abs();if(1==g.t&&g[0]<=ob[ob.length-1]){for(h=0;h<ob.length;++h)if(g[0]==
ob[h])return!0;return!1}if(g.isEven())return!1;for(h=1;h<ob.length;){for(var e=ob[h],a=h+1;a<ob.length&&e<Qe;)e*=ob[a++];for(e=g.modInt(e);h<a;)if(0==e%ob[h++])return!1}return g.millerRabin(f)};z.prototype.square=function(){var f=ga();this.squareTo(f);return f};q.BigInteger=z;var E=a.ASN1HEX,N=a.KJUR,A=a.RSAKey,t=a.b64tohex,q=a=a||{};q.createHash=function(f){if("sha256"!=f)throw Error("createHash: unsupported algorithm.");f={};f.md=new N.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"});f.update=
function(f){this.md.updateHex(f.toString("hex"))};f.digest=function(f){var g=this.md.digest();return"hex"==f?g:"base64"==f?(new d(g,"hex")).toString("base64"):new d(g,"hex")};return f};q.createHmac=function(f,h){if("sha256"!==f)throw Error("createHmac: unsupported algorithm.");var g={};g.md=new N.crypto.Mac({alg:"HmacSHA256",pass:{hex:h.toString("hex")}});g.update=function(e){this.md.updateHex(e.toString("hex"))};g.digest=function(e){var f=this.md.doFinal();return"hex"==e?f:"base64"==e?(new d(f,"hex")).toString("base64"):
new d(f,"hex")};return g};q.createSign=function(f){if("RSA-SHA256"!=f)throw Error("createSign: unsupported algorithm.");return{arr:[],update:function(f){this.arr.push(f)},sign:function(f){var g=new A;g.readPrivateKeyFromPEMString(f);f=new N.crypto.Signature({alg:"SHA256withRSA",prov:"cryptojs/jsrsa"});f.initSign(g);for(g=0;g<this.arr.length;++g)f.updateHex(this.arr[g].toString("hex"));return new d(f.sign(),"hex")}}};q.createVerify=function(f){if("RSA-SHA256"!=f)throw Error("createSign: unsupported algorithm.");
return{arr:[],update:function(f){this.arr.push(f)},verify:function(f,g){for(var e=f.split("\n"),a="",l=1;l<e.length-1;l++)a+=e[l];e=(new d(a,"base64")).toString("hex");a=E.getPosArrayOfChildren_AtObj(e,0);2!=a.length?a=-1:(a=a[1],"03"!=e.substring(a,a+2)?a=-1:(a=E.getStartPosOfV_AtObj(e,a),a="00"!=e.substring(a,a+2)?-1:a+2));l=E.getPosArrayOfChildren_AtObj(e,a);2!=l.length?a=null:(a=E.getHexOfV_AtObj(e,l[0]),e=E.getHexOfV_AtObj(e,l[1]),l=new A,l.setPublic(a,e),a=l);e=new N.crypto.Signature({alg:"SHA256withRSA",
prov:"cryptojs/jsrsa"});e.initVerifyByPublicKey(a);for(a=0;a<this.arr.length;a++)e.updateHex(this.arr[a].toString("hex"));a=g.toString("hex");return e.verify(a)}}};q.randomBytes=function(f){for(var h=new d(f),g=0;g<f;++g)h[g]=Math.floor(256*Math.random());return h};q.toByteArray=function(f){var h=[];t(f).replace(/(..)/g,function(f){h.push(parseInt(f,16))});return h};var Wc={};(function(f){function h(f){f=f.charCodeAt(0);if(f===e)return 62;if(f===a)return 63;if(f<l)return-1;if(f<l+10)return f-l+52;
if(f<c+26)return f-c;if(f<b+26)return f-b+26}var g="undefined"!==typeof Uint8Array?Uint8Array:Array,e=43,a=47,l=48,b=97,c=65;f.toByteArray=function(e){function f(e){c[d++]=e}var l,a,u,b,c;if(0<e.length%4)throw Error("Invalid string. Length must be a multiple of 4");l=e.length;b="="===e.charAt(l-2)?2:"="===e.charAt(l-1)?1:0;c=new g(3*e.length/4-b);a=0<b?e.length-4:e.length;var d=0;for(l=0;l<a;l+=4)u=h(e.charAt(l))<<18|h(e.charAt(l+1))<<12|h(e.charAt(l+2))<<6|h(e.charAt(l+3)),f((u&16711680)>>16),f((u&
65280)>>8),f(u&255);2===b?(u=h(e.charAt(l))<<2|h(e.charAt(l+1))>>4,f(u&255)):1===b&&(u=h(e.charAt(l))<<10|h(e.charAt(l+1))<<4|h(e.charAt(l+2))>>2,f(u>>8&255),f(u&255));return c};f.fromByteArray=function(e){var f,g=e.length%3,h="",l,a;f=0;for(a=e.length-g;f<a;f+=3)l=(e[f]<<16)+(e[f+1]<<8)+e[f+2],l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>18&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>12&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>
6&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l&63),h+=l;switch(g){case 1:l=e[e.length-1];h+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>2);h+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l<<4&63);h+="==";break;case 2:l=(e[e.length-2]<<8)+e[e.length-1],h+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>10),h+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>
4&63),h+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l<<2&63),h+="="}return h}})(Wc);q.ieee={read:function(f,h,g,e,a){var l;l=8*a-e-1;var b=(1<<l)-1,c=b>>1,d=-7;a=g?a-1:0;var k=g?-1:1,m=f[h+a];a+=k;g=m&(1<<-d)-1;m>>=-d;for(d+=l;0<d;g=256*g+f[h+a],a+=k,d-=8);l=g&(1<<-d)-1;g>>=-d;for(d+=e;0<d;l=256*l+f[h+a],a+=k,d-=8);if(0===g)g=1-c;else{if(g===b)return l?NaN:Infinity*(m?-1:1);l+=Math.pow(2,e);g-=c}return(m?-1:1)*l*Math.pow(2,g-e)},write:function(f,h,g,e,a,l){var b,c=8*
l-a-1,d=(1<<c)-1,k=d>>1,m=23===a?Math.pow(2,-24)-Math.pow(2,-77):0;l=e?0:l-1;var n=e?1:-1,p=0>h||0===h&&0>1/h?1:0;h=Math.abs(h);isNaN(h)||Infinity===h?(h=isNaN(h)?1:0,e=d):(e=Math.floor(Math.log(h)/Math.LN2),1>h*(b=Math.pow(2,-e))&&(e--,b*=2),h=1<=e+k?h+m/b:h+m*Math.pow(2,1-k),2<=h*b&&(e++,b/=2),e+k>=d?(h=0,e=d):1<=e+k?(h=(h*b-1)*Math.pow(2,a),e+=k):(h=h*Math.pow(2,k-1)*Math.pow(2,a),e=0));for(;8<=a;f[g+l]=h&255,l+=n,h/=256,a-=8);e=e<<a|h;for(c+=a;0<c;f[g+l]=e&255,l+=n,e/=256,c-=8);f[g+l-n]|=128*
p}};var Ha=a.ieee;q.Buffer=d;q.SlowBuffer=d;q.INSPECT_MAX_BYTES=50;d.poolSize=8192;d._useTypedArrays=function(){try{var f=new ArrayBuffer(0),h=new Uint8Array(f);h.foo=function(){return 42};return 42===h.foo()&&"function"===typeof h.subarray}catch(g){return!1}}();d.isEncoding=function(f){switch(String(f).toLowerCase()){case "hex":case "utf8":case "utf-8":case "ascii":case "binary":case "base64":case "raw":case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":return!0;default:return!1}};d.isBuffer=
function(f){return!(null===f||void 0===f||!f._isBuffer)};d.byteLength=function(f,h){var g;f=f.toString();switch(h||"utf8"){case "hex":g=f.length/2;break;case "utf8":case "utf-8":g=d.utf8ToBytes(f).length;break;case "ascii":case "binary":case "raw":g=f.length;break;case "base64":g=d.base64ToBytes(f).length;break;case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":g=2*f.length;break;default:throw Error("Unknown encoding");}return g};d.concat=function(f,h){d.assert(d.isArray(f),"Usage: Buffer.concat(list[, length])");
if(0===f.length)return new d(0);if(1===f.length)return f[0];var g;if(void 0===h)for(g=h=0;g<f.length;g++)h+=f[g].length;var e=new d(h),a=0;for(g=0;g<f.length;g++){var l=f[g];l.copy(e,a);a+=l.length}return e};d.compare=function(f,h){d.assert(d.isBuffer(f)&&d.isBuffer(h),"Arguments must be Buffers");for(var g=f.length,e=h.length,a=0,l=Math.min(g,e);a<l&&f[a]===h[a];a++);a!==l&&(g=f[a],e=h[a]);return g<e?-1:e<g?1:0};d.hexWrite=function(f,h,g,e){g=Number(g)||0;var a=f.length-g;e?(e=Number(e),e>a&&(e=
a)):e=a;a=h.length;d.assert(0===a%2,"Invalid hex string");e>a/2&&(e=a/2);for(a=0;a<e;a++){var l=parseInt(h.substr(2*a,2),16);d.assert(!isNaN(l),"Invalid hex string");f[g+a]=l}return a};d.utf8Write=function(f,h,g,e){return d.blitBuffer(d.utf8ToBytes(h),f,g,e)};d.asciiWrite=function(f,h,g,e){return d.blitBuffer(d.asciiToBytes(h),f,g,e)};d.binaryWrite=function(f,h,g,e){return d.asciiWrite(f,h,g,e)};d.base64Write=function(f,h,g,e){return d.blitBuffer(d.base64ToBytes(h),f,g,e)};d.utf16leWrite=function(f,
h,g,e){return d.blitBuffer(d.utf16leToBytes(h),f,g,e)};d.prototype.write=function(f,h,g,e){if(isFinite(h))isFinite(g)||(e=g,g=void 0);else{var a=e;e=h;h=g;g=a}h=Number(h)||0;a=this.length-h;g?(g=Number(g),g>a&&(g=a)):g=a;e=String(e||"utf8").toLowerCase();switch(e){case "hex":f=d.hexWrite(this,f,h,g);break;case "utf8":case "utf-8":f=d.utf8Write(this,f,h,g);break;case "ascii":f=d.asciiWrite(this,f,h,g);break;case "binary":f=d.binaryWrite(this,f,h,g);break;case "base64":f=d.base64Write(this,f,h,g);break;
case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":f=d.utf16leWrite(this,f,h,g);break;default:throw Error("Unknown encoding");}return f};d.prototype.toString=function(f,h,g){f=String(f||"utf8").toLowerCase();h=Number(h)||0;g=void 0===g?this.length:Number(g);if(g===h)return"";switch(f){case "hex":f=d.hexSlice(this,h,g);break;case "utf8":case "utf-8":f=d.utf8Slice(this,h,g);break;case "ascii":f=d.asciiSlice(this,h,g);break;case "binary":f=d.binarySlice(this,h,g);break;case "base64":f=d.base64Slice(this,
h,g);break;case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":f=this.slice(h,g);h="";for(g=0;g<f.length;g+=2)h+=String.fromCharCode(f[g]+256*f[g+1]);f=h;break;default:throw Error("Unknown encoding");}return f};d.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};d.prototype.equals=function(f){d.assert(d.isBuffer(f),"Argument must be a Buffer");return 0===d.compare(this,f)};d.prototype.compare=function(f){d.assert(d.isBuffer(f),"Argument must be a Buffer");
return d.compare(this,f)};d.prototype.copy=function(f,h,g,e){g||(g=0);e||0===e||(e=this.length);h||(h=0);if(e!==g&&0!==f.length&&0!==this.length)if(d.assert(e>=g,"sourceEnd < sourceStart"),d.assert(0<=h&&h<f.length,"targetStart out of bounds"),d.assert(0<=g&&g<this.length,"sourceStart out of bounds"),d.assert(0<=e&&e<=this.length,"sourceEnd out of bounds"),e>this.length&&(e=this.length),f.length-h<e-g&&(e=f.length-h+g),e-=g,100>e||!d._useTypedArrays)for(var a=0;a<e;a++)f[a+h]=this[a+g];else f._set(this.subarray(g,
g+e),h)};d.base64Slice=function(f,h,g){return 0===h&&g===f.length?Wc.fromByteArray(f):Wc.fromByteArray(f.slice(h,g))};d.utf8Slice=function(f,h,g){var e="",a="";for(g=Math.min(f.length,g);h<g;h++)127>=f[h]?(e+=d.decodeUtf8Char(a)+String.fromCharCode(f[h]),a=""):a+="%"+f[h].toString(16);return e+d.decodeUtf8Char(a)};d.asciiSlice=function(f,h,g){var e="";for(g=Math.min(f.length,g);h<g;h++)e+=String.fromCharCode(f[h]);return e};d.binarySlice=function(f,h,g){return d.asciiSlice(f,h,g)};d.hexSlice=function(f,
h,g){var e=f.length;if(!h||0>h)h=0;if(!g||0>g||g>e)g=e;for(e="";h<g;h++)e+=d.toHex(f[h]);return e};d.prototype.slice=function(f,h){var g=this.length;f=d.clamp(f,g,0);h=d.clamp(h,g,g);if(d._useTypedArrays)return d._augment(this.subarray(f,h));for(var g=h-f,e=new d(g,void 0,!0),a=0;a<g;a++)e[a]=this[a+f];return e};d.prototype.get=function(f){console.log(".get() is deprecated. Access using array indexes instead.");return this.readUInt8(f)};d.prototype.set=function(f,h){console.log(".set() is deprecated. Access using array indexes instead.");
return this.writeUInt8(f,h)};d.prototype.readUInt8=function(f,h){h||(d.assert(void 0!==f&&null!==f,"missing offset"),d.assert(f<this.length,"Trying to read beyond buffer length"));if(!(f>=this.length))return this[f]};d.readUInt16=function(f,h,g,e){e||(d.assert("boolean"===typeof g,"missing or invalid endian"),d.assert(void 0!==h&&null!==h,"missing offset"),d.assert(h+1<f.length,"Trying to read beyond buffer length"));e=f.length;if(!(h>=e))return g?(g=f[h],h+1<e&&(g|=f[h+1]<<8)):(g=f[h]<<8,h+1<e&&
(g|=f[h+1])),g};d.prototype.readUInt16LE=function(f,h){return d.readUInt16(this,f,!0,h)};d.prototype.readUInt16BE=function(f,h){return d.readUInt16(this,f,!1,h)};d.readUInt32=function(f,h,g,e){e||(d.assert("boolean"===typeof g,"missing or invalid endian"),d.assert(void 0!==h&&null!==h,"missing offset"),d.assert(h+3<f.length,"Trying to read beyond buffer length"));e=f.length;if(!(h>=e)){var a;g?(h+2<e&&(a=f[h+2]<<16),h+1<e&&(a|=f[h+1]<<8),a|=f[h],h+3<e&&(a+=f[h+3]<<24>>>0)):(h+1<e&&(a=f[h+1]<<16),
h+2<e&&(a|=f[h+2]<<8),h+3<e&&(a|=f[h+3]),a+=f[h]<<24>>>0);return a}};d.prototype.readUInt32LE=function(f,h){return d.readUInt32(this,f,!0,h)};d.prototype.readUInt32BE=function(f,h){return d.readUInt32(this,f,!1,h)};d.prototype.readInt8=function(f,h){h||(d.assert(void 0!==f&&null!==f,"missing offset"),d.assert(f<this.length,"Trying to read beyond buffer length"));if(!(f>=this.length))return this[f]&128?-1*(255-this[f]+1):this[f]};d.readInt16=function(f,h,g,e){e||(d.assert("boolean"===typeof g,"missing or invalid endian"),
d.assert(void 0!==h&&null!==h,"missing offset"),d.assert(h+1<f.length,"Trying to read beyond buffer length"));if(!(h>=f.length))return f=d.readUInt16(f,h,g,!0),f&32768?-1*(65535-f+1):f};d.prototype.readInt16LE=function(f,h){return d.readInt16(this,f,!0,h)};d.prototype.readInt16BE=function(f,h){return d.readInt16(this,f,!1,h)};d.readInt32=function(f,h,g,e){e||(d.assert("boolean"===typeof g,"missing or invalid endian"),d.assert(void 0!==h&&null!==h,"missing offset"),d.assert(h+3<f.length,"Trying to read beyond buffer length"));
if(!(h>=f.length))return f=d.readUInt32(f,h,g,!0),f&2147483648?-1*(4294967295-f+1):f};d.prototype.readInt32LE=function(f,h){return d.readInt32(this,f,!0,h)};d.prototype.readInt32BE=function(f,h){return d.readInt32(this,f,!1,h)};d.readFloat=function(f,h,g,e){e||(d.assert("boolean"===typeof g,"missing or invalid endian"),d.assert(h+3<f.length,"Trying to read beyond buffer length"));return Ha.read(f,h,g,23,4)};d.prototype.readFloatLE=function(f,h){return d.readFloat(this,f,!0,h)};d.prototype.readFloatBE=
function(f,h){return d.readFloat(this,f,!1,h)};d.readDouble=function(f,h,g,e){e||(d.assert("boolean"===typeof g,"missing or invalid endian"),d.assert(h+7<f.length,"Trying to read beyond buffer length"));return Ha.read(f,h,g,52,8)};d.prototype.readDoubleLE=function(f,h){return d.readDouble(this,f,!0,h)};d.prototype.readDoubleBE=function(f,h){return d.readDouble(this,f,!1,h)};d.prototype.writeUInt8=function(f,h,g){g||(d.assert(void 0!==f&&null!==f,"missing value"),d.assert(void 0!==h&&null!==h,"missing offset"),
d.assert(h<this.length,"trying to write beyond buffer length"),d.verifuint(f,255));if(!(h>=this.length))return this[h]=f,h+1};d.writeUInt16=function(f,h,g,e,a){a||(d.assert(void 0!==h&&null!==h,"missing value"),d.assert("boolean"===typeof e,"missing or invalid endian"),d.assert(void 0!==g&&null!==g,"missing offset"),d.assert(g+1<f.length,"trying to write beyond buffer length"),d.verifuint(h,65535));var l=f.length;if(!(g>=l)){a=0;for(l=Math.min(l-g,2);a<l;a++)f[g+a]=(h&255<<8*(e?a:1-a))>>>8*(e?a:1-
a);return g+2}};d.prototype.writeUInt16LE=function(f,h,g){return d.writeUInt16(this,f,h,!0,g)};d.prototype.writeUInt16BE=function(f,h,g){return d.writeUInt16(this,f,h,!1,g)};d.writeUInt32=function(f,h,g,e,a){a||(d.assert(void 0!==h&&null!==h,"missing value"),d.assert("boolean"===typeof e,"missing or invalid endian"),d.assert(void 0!==g&&null!==g,"missing offset"),d.assert(g+3<f.length,"trying to write beyond buffer length"),d.verifuint(h,4294967295));var l=f.length;if(!(g>=l)){a=0;for(l=Math.min(l-
g,4);a<l;a++)f[g+a]=h>>>8*(e?a:3-a)&255;return g+4}};d.prototype.writeUInt32LE=function(f,h,g){return d.writeUInt32(this,f,h,!0,g)};d.prototype.writeUInt32BE=function(f,h,g){return d.writeUInt32(this,f,h,!1,g)};d.prototype.writeInt8=function(f,h,g){g||(d.assert(void 0!==f&&null!==f,"missing value"),d.assert(void 0!==h&&null!==h,"missing offset"),d.assert(h<this.length,"Trying to write beyond buffer length"),d.verifsint(f,127,-128));if(!(h>=this.length))return 0<=f?this.writeUInt8(f,h,g):this.writeUInt8(255+
f+1,h,g),h+1};d.writeInt16=function(f,h,g,e,a){a||(d.assert(void 0!==h&&null!==h,"missing value"),d.assert("boolean"===typeof e,"missing or invalid endian"),d.assert(void 0!==g&&null!==g,"missing offset"),d.assert(g+1<f.length,"Trying to write beyond buffer length"),d.verifsint(h,32767,-32768));if(!(g>=f.length))return 0<=h?d.writeUInt16(f,h,g,e,a):d.writeUInt16(f,65535+h+1,g,e,a),g+2};d.prototype.writeInt16LE=function(f,h,g){return d.writeInt16(this,f,h,!0,g)};d.prototype.writeInt16BE=function(f,
h,g){return d.writeInt16(this,f,h,!1,g)};d.writeInt32=function(f,h,g,e,a){a||(d.assert(void 0!==h&&null!==h,"missing value"),d.assert("boolean"===typeof e,"missing or invalid endian"),d.assert(void 0!==g&&null!==g,"missing offset"),d.assert(g+3<f.length,"Trying to write beyond buffer length"),d.verifsint(h,2147483647,-2147483648));if(!(g>=f.length))return 0<=h?d.writeUInt32(f,h,g,e,a):d.writeUInt32(f,4294967295+h+1,g,e,a),g+4};d.prototype.writeInt32LE=function(f,h,g){return d.writeInt32(this,f,h,
!0,g)};d.prototype.writeInt32BE=function(f,h,g){return d.writeInt32(this,f,h,!1,g)};d.writeFloat=function(f,h,g,e,a){a||(d.assert(void 0!==h&&null!==h,"missing value"),d.assert("boolean"===typeof e,"missing or invalid endian"),d.assert(void 0!==g&&null!==g,"missing offset"),d.assert(g+3<f.length,"Trying to write beyond buffer length"),d.verifIEEE754(h,3.4028234663852886E38,-3.4028234663852886E38));if(!(g>=f.length))return Ha.write(f,h,g,e,23,4),g+4};d.prototype.writeFloatLE=function(f,h,g){return d.writeFloat(this,
f,h,!0,g)};d.prototype.writeFloatBE=function(f,h,g){return d.writeFloat(this,f,h,!1,g)};d.writeDouble=function(f,h,g,e,a){a||(d.assert(void 0!==h&&null!==h,"missing value"),d.assert("boolean"===typeof e,"missing or invalid endian"),d.assert(void 0!==g&&null!==g,"missing offset"),d.assert(g+7<f.length,"Trying to write beyond buffer length"),d.verifIEEE754(h,1.7976931348623157E308,-1.7976931348623157E308));if(!(g>=f.length))return Ha.write(f,h,g,e,52,8),g+8};d.prototype.writeDoubleLE=function(f,h,g){return d.writeDouble(this,
f,h,!0,g)};d.prototype.writeDoubleBE=function(f,h,g){return d.writeDouble(this,f,h,!1,g)};d.prototype.fill=function(f,h,g){f||(f=0);h||(h=0);g||(g=this.length);d.assert(g>=h,"end < start");if(g!==h&&0!==this.length){d.assert(0<=h&&h<this.length,"start out of bounds");d.assert(0<=g&&g<=this.length,"end out of bounds");if("number"===typeof f)for(;h<g;h++)this[h]=f;else{f=d.utf8ToBytes(f.toString());for(var e=f.length;h<g;h++)this[h]=f[h%e]}return this}};d.prototype.inspect=function(){for(var f=[],h=
this.length,g=0;g<h;g++)if(f[g]=d.toHex(this[g]),g===q.INSPECT_MAX_BYTES){f[g+1]="...";break}return"<Buffer "+f.join(" ")+">"};d.prototype.toArrayBuffer=function(){if("undefined"!==typeof Uint8Array){if(d._useTypedArrays)return(new d(this)).buffer;for(var f=new Uint8Array(this.length),h=0,g=f.length;h<g;h+=1)f[h]=this[h];return f.buffer}throw Error("Buffer.toArrayBuffer not supported in this browser");};var $=d.prototype;d._augment=function(f){f._isBuffer=!0;f._get=f.get;f._set=f.set;f.get=$.get;
f.set=$.set;f.write=$.write;f.toString=$.toString;f.toLocaleString=$.toString;f.toJSON=$.toJSON;f.equals=$.equals;f.compare=$.compare;f.copy=$.copy;f.slice=$.slice;f.readUInt8=$.readUInt8;f.readUInt16LE=$.readUInt16LE;f.readUInt16BE=$.readUInt16BE;f.readUInt32LE=$.readUInt32LE;f.readUInt32BE=$.readUInt32BE;f.readInt8=$.readInt8;f.readInt16LE=$.readInt16LE;f.readInt16BE=$.readInt16BE;f.readInt32LE=$.readInt32LE;f.readInt32BE=$.readInt32BE;f.readFloatLE=$.readFloatLE;f.readFloatBE=$.readFloatBE;f.readDoubleLE=
$.readDoubleLE;f.readDoubleBE=$.readDoubleBE;f.writeUInt8=$.writeUInt8;f.writeUInt16LE=$.writeUInt16LE;f.writeUInt16BE=$.writeUInt16BE;f.writeUInt32LE=$.writeUInt32LE;f.writeUInt32BE=$.writeUInt32BE;f.writeInt8=$.writeInt8;f.writeInt16LE=$.writeInt16LE;f.writeInt16BE=$.writeInt16BE;f.writeInt32LE=$.writeInt32LE;f.writeInt32BE=$.writeInt32BE;f.writeFloatLE=$.writeFloatLE;f.writeFloatBE=$.writeFloatBE;f.writeDoubleLE=$.writeDoubleLE;f.writeDoubleBE=$.writeDoubleBE;f.fill=$.fill;f.inspect=$.inspect;
f.toArrayBuffer=$.toArrayBuffer;return f};d.stringtrim=function(f){return f.trim?f.trim():f.replace(/^\s+|\s+$/g,"")};d.clamp=function(f,h,g){if("number"!==typeof f)return g;f=~~f;if(f>=h)return h;if(0<=f)return f;f+=h;return 0<=f?f:0};d.coerce=function(f){f=~~Math.ceil(+f);return 0>f?0:f};d.isArray=function(f){return(Array.isArray||function(f){return"[object Array]"===Object.prototype.toString.call(f)})(f)};d.isArrayish=function(f){return d.isArray(f)||d.isBuffer(f)||f&&"object"===typeof f&&"number"===
typeof f.length};d.toHex=function(f){return 16>f?"0"+f.toString(16):f.toString(16)};d.utf8ToBytes=function(f){for(var h=[],g=0;g<f.length;g++){var e=f.charCodeAt(g);if(127>=e)h.push(e);else{var a=g;55296<=e&&57343>=e&&g++;e=encodeURIComponent(f.slice(a,g+1)).substr(1).split("%");for(a=0;a<e.length;a++)h.push(parseInt(e[a],16))}}return h};d.asciiToBytes=function(f){for(var h=[],g=0;g<f.length;g++)h.push(f.charCodeAt(g)&255);return h};d.utf16leToBytes=function(f){for(var h,g,e=[],a=0;a<f.length;a++)h=
f.charCodeAt(a),g=h>>8,h%=256,e.push(h),e.push(g);return e};d.base64ToBytes=function(f){return Wc.toByteArray(f)};d.blitBuffer=function(f,h,g,e){for(var a=0;a<e&&!(a+g>=h.length||a>=f.length);a++)h[a+g]=f[a];return a};d.decodeUtf8Char=function(f){try{return decodeURIComponent(f)}catch(h){return String.fromCharCode(65533)}};d.verifuint=function(f,h){d.assert("number"===typeof f,"cannot write a non-number as a number");d.assert(0<=f,"specified a negative value for writing an unsigned value");d.assert(f<=
h,"value is larger than maximum value for type");d.assert(Math.floor(f)===f,"value has a fractional component")};d.verifsint=function(f,h,g){d.assert("number"===typeof f,"cannot write a non-number as a number");d.assert(f<=h,"value larger than maximum allowed value");d.assert(f>=g,"value smaller than minimum allowed value");d.assert(Math.floor(f)===f,"value has a fractional component")};d.verifIEEE754=function(f,h,g){d.assert("number"===typeof f,"cannot write a non-number as a number");d.assert(f<=
h,"value larger than maximum allowed value");d.assert(f>=g,"value smaller than minimum allowed value")};d.assert=function(f,h){if(!f)throw Error(h||"Failed assertion");};var Hc=function(){};q.Log=Hc;Hc.LOG=0;var Xc=a.printStackTrace,O={};q.NdnCommon=O;O.MAX_NDN_PACKET_SIZE=8800;O.getErrorWithStackTrace=function(f){return f+"\n"+Xc({e:f}).join("\n")};O.checkIndexedDb=function(f){try{var h=new Dexie("test-Dexie-support");h.version(1).stores({});h.open();setTimeout(function(){try{f(h.isOpen())}catch(e){f(!1)}},
200)}catch(g){f(!1)}};var O=a.NdnCommon,ld=function(f,h,g,e){e=e||{};this.face=f;this.callerOnData=h;this.callerOnTimeout=g;this.maxInterestLifetime=e.maxInterestLifetime||16E3};q.ExponentialReExpress=ld;ld.makeOnTimeout=function(f,h,g,e){var a=new ld(f,h,g,e);return function(e){a.onTimeout(e)}};ld.prototype.onTimeout=function(f){var h=f.getInterestLifetimeMilliseconds();if(null==h){if(this.callerOnTimeout)try{this.callerOnTimeout(f)}catch(g){console.log("Error in onTimeout: "+O.getErrorWithStackTrace(g))}}else if(h*=
2,h>this.maxInterestLifetime){if(this.callerOnTimeout)try{this.callerOnTimeout(f)}catch(e){console.log("Error in onTimeout: "+O.getErrorWithStackTrace(e))}}else{f=f.clone();f.setInterestLifetimeMilliseconds(h);var a=this;this.face.expressInterest(f,this.callerOnData,function(e){a.onTimeout(e)})}};var p=function h(g,e){null==e&&(e=!0);null==g?this.buffer=null:"object"===typeof g&&g instanceof h?this.buffer=g.buffer:"string"===typeof g?this.buffer=new d(g,"utf8"):e?this.buffer=new d(g):d.isBuffer(g)?
this.buffer=g:this.buffer=new d(g);this.length=null!=this.buffer?this.buffer.length:0};q.Blob=p;p.prototype.size=function(){return null!=this.buffer?this.buffer.length:0};p.prototype.buf=function(){return this.buffer};p.prototype.isNull=function(){return null==this.buffer};p.prototype.toHex=function(){return null==this.buffer?"":this.buffer.toString("hex")};p.prototype.toString=function(){return null==this.buffer?"":this.buffer.toString("utf8")};p.prototype.equals=function(h){if(this.isNull())return h.isNull();
if(h.isNull()||this.buffer.length!=h.buffer.length)return!1;for(var g=0;g<this.buffer.length;++g)if(this.buffer[g]!=h.buffer[g])return!1;return!0};var p=a.Blob,Wa=function g(e,a,l){p.call(this,e);null==this.buffer?this.signedPortionEndOffset=this.signedPortionBeginOffset=0:"object"===typeof e&&e instanceof g?(this.signedPortionBeginOffset=null==a?e.signedPortionBeginOffset:a,this.signedPortionEndOffset=null==l?e.signedPortionEndOffset:l):(this.signedPortionBeginOffset=a||0,this.signedPortionEndOffset=
l||0);this.signedBuffer=null==this.buffer?null:this.buffer.slice(this.signedPortionBeginOffset,this.signedPortionEndOffset)};Wa.prototype=new p;Wa.prototype.name="SignedBlob";q.SignedBlob=Wa;Wa.prototype.signedSize=function(){return null!=this.signedBuffer?this.signedBuffer.length:0};Wa.prototype.signedBuf=function(){return this.signedBuffer};Wa.prototype.getSignedPortionBeginOffset=function(){return this.signedPortionBeginOffset};Wa.prototype.getSignedPortionEndOffset=function(){return this.signedPortionEndOffset};
var Xa=function(g){g||(g=16);this.array=new d(g)};q.DynamicBuffer=Xa;Xa.prototype.ensureLength=function(g){if(!(this.array.length>=g)){var e=2*this.array.length;g>e&&(e=g);g=new d(e);this.array.copy(g);this.array=g}};Xa.prototype.copy=function(g,e){this.ensureLength(g.length+e);d.isBuffer(g)?g.copy(this.array,e):(new d(g)).copy(this.array,e);return e+g.length};Xa.prototype.ensureLengthFromBack=function(g){if(!(this.array.length>=g)){var e=2*this.array.length;g>e&&(e=g);g=new d(e);this.array.copy(g,
g.length-this.array.length);this.array=g}};Xa.prototype.copyFromBack=function(g,e){this.ensureLengthFromBack(e);d.isBuffer(g)?g.copy(this.array,this.array.length-e):(new d(g)).copy(this.array,this.array.length-e)};Xa.prototype.slice=function(g,e){return void 0==e?this.array.slice(g):this.array.slice(g,e)};var ma=function(g){this.target=g;this.changeCount=null==g?0:g.getChangeCount()};q.ChangeCounter=ma;ma.prototype.get=function(){return this.target};ma.prototype.set=function(g){this.target=g;this.changeCount=
null==g?0:g.getChangeCount()};ma.prototype.checkChanged=function(){if(null==this.target)return!1;var g=this.target.getChangeCount();return this.changeCount!=g?(this.changeCount=g,!0):!1};var O=a.NdnCommon,b=function(g,e){this.value=g;this.isRejected=e};q.SyncPromise=b;b.prototype.then=function(g,e){if(this.isRejected)if(e)try{return e(this.value)}catch(a){return new b(a,!0)}else return this;else if(g)try{return g(this.value)}catch(l){return new b(l,!0)}else return this};b.prototype.catch=function(g){return this.then(void 0,
g)};b.resolve=function(g){return new b(g,!1)};b.reject=function(g){return new b(g,!0)};b.getValue=function(g){if(g instanceof b){if(g.isRejected)throw g.value;return g.value}throw Error("Cannot return immediately because promise is not a SyncPromise");};b.complete=function(g,e,a){var l;a?l=e:(a=e,l=null);if(g)a.then(function(e){try{g(e)}catch(a){console.log("Error in onComplete: "+O.getErrorWithStackTrace(a))}},function(e){if(l)try{l(e)}catch(g){console.log("Error in onError: "+O.getErrorWithStackTrace(g))}else{if(a instanceof
b)throw e;console.log("Uncaught exception from a Promise: "+O.getErrorWithStackTrace(e))}});else return b.getValue(a)};var M={};q.DataUtils=M;M.keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";M.stringtoBase64=function(g){var e="",a,l,b="",c,d,k="",m=0;do a=g.charCodeAt(m++),l=g.charCodeAt(m++),b=g.charCodeAt(m++),c=a>>2,a=(a&3)<<4|l>>4,d=(l&15)<<2|b>>6,k=b&63,isNaN(l)?d=k=64:isNaN(b)&&(k=64),e=e+M.keyStr.charAt(c)+M.keyStr.charAt(a)+M.keyStr.charAt(d)+M.keyStr.charAt(k);
while(m<g.length);return e};M.base64toString=function(g){var e="",a,l,b="",c,d="",k=0;/[^A-Za-z0-9\+\/\=]/g.exec(g)&&alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding.");g=g.replace(/[^A-Za-z0-9\+\/\=]/g,"");do a=M.keyStr.indexOf(g.charAt(k++)),l=M.keyStr.indexOf(g.charAt(k++)),c=M.keyStr.indexOf(g.charAt(k++)),d=M.keyStr.indexOf(g.charAt(k++)),a=a<<2|l>>4,l=(l&15)<<4|c>>2,b=(c&3)<<6|d,e+=String.fromCharCode(a),
64!=c&&(e+=String.fromCharCode(l)),64!=d&&(e+=String.fromCharCode(b));while(k<g.length);return e};M.toHex=function(g){return g.toString("hex")};M.stringToHex=function(g){for(var e="",a=0;a<g.length;++a)var l=g.charCodeAt(a),e=e+((16>l?"0":"")+l.toString(16));return e};M.toString=function(g){return g.toString("binary")};M.toNumbers=function(g){return new d(g,"hex")};M.hexToRawString=function(g){if("string"==typeof g){var e="";g.replace(/(..)/g,function(g){e+=String.fromCharCode(parseInt(g,16))});return e}};
M.toNumbersFromString=function(g){return new d(g,"binary")};M.toNumbersIfString=function(g){return"string"===typeof g?new d(g,"binary"):g};M.stringToUtf8Array=function(g){return new d(g,"utf8")};M.concatArrays=function(g){return d.concat(g)};M.decodeUtf8=function(g){for(var e="",a=0,l=0,b=0;a<g.length;)if(l=g.charCodeAt(a),128>l)e+=String.fromCharCode(l),a++;else if(191<l&&224>l)b=g.charCodeAt(a+1),e+=String.fromCharCode((l&31)<<6|b&63),a+=2;else var b=g.charCodeAt(a+1),c=g.charCodeAt(a+2),e=e+String.fromCharCode((l&
15)<<12|(b&63)<<6|c&63),a=a+3;return e};M.arraysEqual=function(g,e){if(!g.slice)throw Error("DataUtils.arraysEqual: a1 is not an array");if(!e.slice)throw Error("DataUtils.arraysEqual: a2 is not an array");if(g.length!=e.length)return!1;for(var a=0;a<g.length;++a)if(g[a]!=e[a])return!1;return!0};M.bigEndianToUnsignedInt=function(g){for(var e=0,a=0;a<g.length;++a)e*=256,e+=g[a];return e};M.nonNegativeIntToBigEndian=function(g){g=Math.round(g);if(0>=g)return new d(0);for(var e=new d(8),a=0;0!=g;)++a,
e[8-a]=g&255,g=Math.floor(g/256);return e.slice(8-a,8)};M.shuffle=function(g){for(var e=g.length-1;1<=e;--e){var a=Math.floor(Math.random()*(e+1)),l=g[e];g[e]=g[a];g[a]=l}};M.privateKeyPemToDer=function(g){g=g.split("\n");for(var e="",a=1;a<g.length-1;a++)e+=g[a];return new d(e,"base64")};R.prototype=Error();R.prototype.name="DecodingException";q.DecodingException=R;var n=function(){};q.Tlv=n;n.Interest=5;n.Data=6;n.Name=7;n.ImplicitSha256DigestComponent=1;n.ParametersSha256DigestComponent=2;n.NameComponent=
8;n.Selectors=9;n.Nonce=10;n.InterestLifetime=12;n.MinSuffixComponents=13;n.MaxSuffixComponents=14;n.PublisherPublicKeyLocator=15;n.Exclude=16;n.ChildSelector=17;n.MustBeFresh=18;n.Any=19;n.MetaInfo=20;n.Content=21;n.SignatureInfo=22;n.SignatureValue=23;n.ContentType=24;n.FreshnessPeriod=25;n.FinalBlockId=26;n.SignatureType=27;n.KeyLocator=28;n.KeyLocatorDigest=29;n.ForwardingHint=30;n.SelectedDelegation=32;n.CanBePrefix=33;n.HopLimit=34;n.Parameters=35;n.FaceInstance=128;n.ForwardingEntry=129;n.StatusResponse=
130;n.Action=131;n.FaceID=132;n.IPProto=133;n.Host=134;n.Port=135;n.MulticastInterface=136;n.MulticastTTL=137;n.ForwardingFlags=138;n.StatusCode=139;n.StatusText=140;n.SignatureType_DigestSha256=0;n.SignatureType_SignatureSha256WithRsa=1;n.SignatureType_SignatureSha256WithEcdsa=3;n.SignatureType_SignatureHmacWithSha256=4;n.ContentType_Default=0;n.ContentType_Link=1;n.ContentType_Key=2;n.NfdCommand_ControlResponse=101;n.NfdCommand_StatusCode=102;n.NfdCommand_StatusText=103;n.ControlParameters_ControlParameters=
104;n.ControlParameters_FaceId=105;n.ControlParameters_Uri=114;n.ControlParameters_LocalUri=129;n.ControlParameters_LocalControlFeature=110;n.ControlParameters_Origin=111;n.ControlParameters_Cost=106;n.ControlParameters_Capacity=131;n.ControlParameters_Count=132;n.ControlParameters_BaseCongestionMarkingInterval=135;n.ControlParameters_DefaultCongestionThreshold=136;n.ControlParameters_Mtu=137;n.ControlParameters_Flags=108;n.ControlParameters_Mask=112;n.ControlParameters_Strategy=107;n.ControlParameters_ExpirationPeriod=
109;n.LpPacket_LpPacket=100;n.LpPacket_Fragment=80;n.LpPacket_Sequence=81;n.LpPacket_FragIndex=82;n.LpPacket_FragCount=83;n.LpPacket_Nack=800;n.LpPacket_NackReason=801;n.LpPacket_NextHopFaceId=816;n.LpPacket_IncomingFaceId=817;n.LpPacket_CachePolicy=820;n.LpPacket_CachePolicyType=821;n.LpPacket_CongestionMark=832;n.LpPacket_IGNORE_MIN=800;n.LpPacket_IGNORE_MAX=959;n.Link_Preference=30;n.Link_Delegation=31;n.Encrypt_EncryptedContent=130;n.Encrypt_EncryptionAlgorithm=131;n.Encrypt_EncryptedPayload=
132;n.Encrypt_InitialVector=133;n.Encrypt_StartDate=134;n.Encrypt_EndDate=135;n.Encrypt_IntervalStartHour=136;n.Encrypt_IntervalEndHour=137;n.Encrypt_NRepeats=138;n.Encrypt_RepeatUnit=139;n.Encrypt_RepetitiveInterval=140;n.Encrypt_WhiteIntervalList=141;n.Encrypt_BlackIntervalList=142;n.Encrypt_Schedule=143;n.ValidityPeriod_ValidityPeriod=253;n.ValidityPeriod_NotBefore=254;n.ValidityPeriod_NotAfter=255;n.getHighBytes=function(g){return(g-g%4294967296)/4294967296};var Xa=a.DynamicBuffer,n=a.Tlv,va=
function(g){this.output=new Xa(g||16);this.length=0};q.TlvEncoder=va;va.prototype.getLength=function(){return this.length};va.prototype.writeVarNumber=function(g){if(253>g)this.length+=1,this.output.ensureLengthFromBack(this.length),this.output.array[this.output.array.length-this.length]=g&255;else if(65535>=g){this.length+=3;this.output.ensureLengthFromBack(this.length);var e=this.output.array.length-this.length;this.output.array[e]=253;this.output.array[e+1]=g>>8&255;this.output.array[e+2]=g&255}else if(4294967295>=
g)this.length+=5,this.output.ensureLengthFromBack(this.length),e=this.output.array.length-this.length,this.output.array[e]=254,this.output.array[e+1]=g>>24&255,this.output.array[e+2]=g>>16&255,this.output.array[e+3]=g>>8&255,this.output.array[e+4]=g&255;else{this.length+=9;this.output.ensureLengthFromBack(this.length);e=this.output.array.length-this.length;this.output.array[e]=255;var a=n.getHighBytes(g);this.output.array[e+1]=a>>24&255;this.output.array[e+2]=a>>16&255;this.output.array[e+3]=a>>8&
255;this.output.array[e+4]=a&255;this.output.array[e+5]=g>>24&255;this.output.array[e+6]=g>>16&255;this.output.array[e+7]=g>>8&255;this.output.array[e+8]=g&255}};va.prototype.writeTypeAndLength=function(g,e){this.writeVarNumber(e);this.writeVarNumber(g)};va.prototype.writeNonNegativeInteger=function(g){if(0>g)throw Error("TLV integer value may not be negative");g=Math.round(g);if(255>=g)this.length+=1,this.output.ensureLengthFromBack(this.length),this.output.array[this.output.array.length-this.length]=
g&255;else if(65535>=g){this.length+=2;this.output.ensureLengthFromBack(this.length);var e=this.output.array.length-this.length;this.output.array[e]=g>>8&255;this.output.array[e+1]=g&255}else if(4294967295>=g)this.length+=4,this.output.ensureLengthFromBack(this.length),e=this.output.array.length-this.length,this.output.array[e]=g>>24&255,this.output.array[e+1]=g>>16&255,this.output.array[e+2]=g>>8&255,this.output.array[e+3]=g&255;else{this.length+=8;this.output.ensureLengthFromBack(this.length);var e=
this.output.array.length-this.length,a=n.getHighBytes(g);this.output.array[e]=a>>24&255;this.output.array[e+1]=a>>16&255;this.output.array[e+2]=a>>8&255;this.output.array[e+3]=a&255;this.output.array[e+4]=g>>24&255;this.output.array[e+5]=g>>16&255;this.output.array[e+6]=g>>8&255;this.output.array[e+7]=g&255}};va.prototype.writeNonNegativeIntegerTlv=function(g,e){var a=this.length;this.writeNonNegativeInteger(e);this.writeTypeAndLength(g,this.length-a)};va.prototype.writeOptionalNonNegativeIntegerTlv=
function(g,e){null!=e&&0<=e&&this.writeNonNegativeIntegerTlv(g,e)};va.prototype.writeBuffer=function(g){null!=g&&(this.length+=g.length,this.output.copyFromBack(g,this.length))};va.prototype.writeBlobTlv=function(g,e){null==e?this.writeTypeAndLength(g,0):(this.writeBuffer(e),this.writeTypeAndLength(g,e.length))};va.prototype.writeOptionalBlobTlv=function(g,e){null!=e&&0<e.length&&this.writeBlobTlv(g,e)};va.prototype.getOutput=function(){return this.output.array.slice(this.output.array.length-this.length)};
var R=a.DecodingException,oa=function(g){this.input=g;this.offset=0};q.TlvDecoder=oa;oa.prototype.readVarNumber=function(){var g=this.input[this.offset];this.offset+=1;return 253>g?g:this.readExtendedVarNumber(g)};oa.prototype.readExtendedVarNumber=function(g){253==g?(g=(this.input[this.offset]<<8)+this.input[this.offset+1],this.offset+=2):254==g?(g=Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<8)+this.input[this.offset+3],this.offset+=4):(g=4294967296*
(Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<8)+this.input[this.offset+3])+(this.input[this.offset+4]<<24)+(this.input[this.offset+5]<<16)+(this.input[this.offset+6]<<8)+this.input[this.offset+7],this.offset+=8);return g};oa.prototype.readTypeAndLength=function(g){if(this.readVarNumber()!=g)throw new R(Error("Did not get the expected TLV type"));g=this.readVarNumber();if(this.offset+g>this.input.length)throw new R(Error("TLV length exceeds the buffer length"));
return g};oa.prototype.readNestedTlvsStart=function(g){return this.readTypeAndLength(g)+this.offset};oa.prototype.finishNestedTlvs=function(g,e){if(this.offset!=g){for(void 0==e&&(e=!1);this.offset<g;){var a=this.readVarNumber();if((31>=a||1==(a&1))&&!e)throw new R(Error("Unrecognized critical type code "+a));a=this.readVarNumber();this.offset+=a;if(this.offset>this.input.length)throw new R(Error("TLV length exceeds the buffer length"));}if(this.offset!=g)throw new R(Error("TLV length does not equal the total length of the nested TLVs"));
}};oa.prototype.peekType=function(g,e){if(this.offset>=e)return!1;var a=this.offset,l=this.readVarNumber();this.offset=a;return l==g};oa.prototype.readNonNegativeInteger=function(g){var e;if(1==g)e=this.input[this.offset];else if(2==g)e=(this.input[this.offset]<<8)+this.input[this.offset+1];else if(4==g)e=Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<8)+this.input[this.offset+3];else if(8==g)e=4294967296*(Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+
1]<<16)+(this.input[this.offset+2]<<8)+this.input[this.offset+3])+Math.abs(this.input[this.offset+4]<<24)+(this.input[this.offset+5]<<16)+(this.input[this.offset+6]<<8)+this.input[this.offset+7];else throw new R(Error("Invalid length for a TLV nonNegativeInteger"));this.offset+=g;return e};oa.prototype.readNonNegativeIntegerTlv=function(g){g=this.readTypeAndLength(g);return this.readNonNegativeInteger(g)};oa.prototype.readOptionalNonNegativeIntegerTlv=function(g,e){return this.peekType(g,e)?this.readNonNegativeIntegerTlv(g):
null};oa.prototype.readBlobTlv=function(g){g=this.readTypeAndLength(g);var e=this.input.slice(this.offset,this.offset+g);this.offset+=g;return e};oa.prototype.readOptionalBlobTlv=function(g,e){return this.peekType(g,e)?this.readBlobTlv(g):null};oa.prototype.readBooleanTlv=function(g,e){if(this.peekType(g,e)){var a=this.readTypeAndLength(g);this.offset+=a;return!0}return!1};oa.prototype.skipTlv=function(g){g=this.readTypeAndLength(g);this.offset+=g};oa.prototype.skipOptionalTlv=function(g,e){this.peekType(g,
e)&&this.skipTlv(g)};oa.prototype.getOffset=function(){return this.offset};oa.prototype.seek=function(g){this.offset=g};oa.prototype.getSlice=function(g,e){return this.input.slice(g,e)};var oa=a.TlvDecoder,H=function e(){this.gotElementEnd_=!1;this.offset_=0;this.state_=e.READ_TYPE;this.headerLength_=0;this.useHeaderBuffer_=!1;this.headerBuffer_=new d(8);this.nBytesToRead_=0};q.TlvStructureDecoder=H;H.READ_TYPE=0;H.READ_TYPE_BYTES=1;H.READ_LENGTH=2;H.READ_LENGTH_BYTES=3;H.READ_VALUE_BYTES=4;H.prototype.findElementEnd=
function(e){if(this.gotElementEnd_)return!0;for(var a=new oa(e);;){if(this.offset_>=e.length)return!1;if(this.state_==H.READ_TYPE){var l=e[this.offset_];this.offset_+=1;253>l?this.state_=H.READ_LENGTH:(this.nBytesToRead_=253==l?2:254==l?4:8,this.state_=H.READ_TYPE_BYTES)}else if(this.state_==H.READ_TYPE_BYTES){l=e.length-this.offset_;if(l<this.nBytesToRead_)return this.offset_+=l,this.nBytesToRead_-=l,!1;this.offset_+=this.nBytesToRead_;this.state_=H.READ_LENGTH}else if(this.state_==H.READ_LENGTH)if(l=
e[this.offset_],this.offset_+=1,253>l){this.nBytesToRead_=l;if(0==this.nBytesToRead_)return this.gotElementEnd_=!0;this.state_=H.READ_VALUE_BYTES}else this.nBytesToRead_=253==l?2:254==l?4:8,this.firstOctet_=l,this.state_=H.READ_LENGTH_BYTES;else if(this.state_==H.READ_LENGTH_BYTES){l=e.length-this.offset_;if(!this.useHeaderBuffer_&&l>=this.nBytesToRead_)a.seek(this.offset_),this.nBytesToRead_=a.readExtendedVarNumber(this.firstOctet_),this.offset_=a.getOffset();else{this.useHeaderBuffer_=!0;var b=
this.nBytesToRead_-this.headerLength_;if(b>l){if(this.headerLength_+l>this.headerBuffer_.length)throw Error("Cannot store more header bytes than the size of headerBuffer");e.slice(this.offset_,this.offset_+l).copy(this.headerBuffer_,this.headerLength_);this.offset_+=l;this.headerLength_+=l;return!1}if(this.headerLength_+b>this.headerBuffer_.length)throw Error("Cannot store more header bytes than the size of headerBuffer");e.slice(this.offset_,this.offset_+b).copy(this.headerBuffer_,this.headerLength_);
this.offset_+=b;this.nBytesToRead_=(new oa(this.headerBuffer_)).readExtendedVarNumber(this.firstOctet_)}if(0==this.nBytesToRead_)return this.gotElementEnd_=!0;this.state_=H.READ_VALUE_BYTES}else{if(this.state_==H.READ_VALUE_BYTES){l=e.length-this.offset_;if(l<this.nBytesToRead_)return this.offset_+=l,this.nBytesToRead_-=l,!1;this.offset_+=this.nBytesToRead_;return this.gotElementEnd_=!0}throw Error("findElementEnd: unrecognized state");}}};H.prototype.getOffset=function(){return this.offset_};H.prototype.seek=
function(e){this.offset_=e};var va=a.TlvEncoder,oa=a.TlvDecoder,p=a.Blob,c=a.Name,db=function(){};q.ProtobufTlv=db;db._Field=null;db.establishField=function(){if(null===db._Field)try{db._Field=dcodeIO.ProtoBuf.Reflect.Message.Field}catch(e){db._Field=a.Reflect.Message.Field}};db.encode=function(e,a){db.establishField();e.encodeAB();var l=new va;db._encodeMessageValue(e,a,l);return new p(l.getOutput(),!1)};db.decode=function(e,a,l){db.establishField();l="object"===typeof l&&l instanceof p?l.buf():
l;var b=new oa(l);db._decodeMessageValue(e,a,b,l.length)};db._encodeMessageValue=function(e,a,l){a=a.getChildren(db._Field);for(var b=a.length-1;0<=b;--b){var c=a[b],k=c.id,m;if(c.repeated)m=e[c.name];else if(null!=e[c.name])m=[e[c.name]];else continue;for(var n=m.length-1;0<=n;--n){var s=m[n];if("message"==c.type.name){var q=l.getLength();db._encodeMessageValue(s,c.resolvedType,l);l.writeTypeAndLength(k,l.getLength()-q)}else if("uint32"==c.type.name||"uint64"==c.type.name)l.writeNonNegativeIntegerTlv(k,
s);else if("enum"==c.type.name){if(0>s)throw Error("ProtobufTlv.encode: ENUM value may not be negative");l.writeNonNegativeIntegerTlv(k,s)}else if("bytes"==c.type.name)q=s.toBuffer(),void 0==q.length&&(q=new Uint8Array(s.toArrayBuffer())),l.writeBlobTlv(k,q);else if("string"==c.type.name)l.writeBlobTlv(k,(new p(s,!1)).buf());else if("bool"==c.type.name)s&&l.writeTypeAndLength(k,0);else if("double"==c.type.name)q=new d(8),q.writeDoubleLE(s,0),l.writeBlobTlv(k,q);else throw Error("ProtobufTlv.encode: Unknown field type");
}}};db._decodeMessageValue=function(e,a,l,b){a=a.getChildren(db._Field);for(var c=0;c<a.length;++c){var d=a[c],k=d.id;if(d.required||l.peekType(k,b))if(d.repeated)for(;l.peekType(k,b);)if("message"==d.type.name){var m=l.readNestedTlvsStart(k),n=new (d.resolvedType.build());e.add(d.name,n);db._decodeMessageValue(n,d.resolvedType,l,m);l.finishNestedTlvs(m)}else e.add(d.name,db._decodeFieldValue(d,k,l,b));else"message"==d.type.name?(m=l.readNestedTlvsStart(k),n=new (d.resolvedType.build()),e.set(d.name,
n),db._decodeMessageValue(n,d.resolvedType,l,m),l.finishNestedTlvs(m)):e.set(d.name,db._decodeFieldValue(d,k,l,b))}};db._decodeFieldValue=function(e,a,l,b){if("uint32"==e.type.name||"uint64"==e.type.name||"enum"==e.type.name)return l.readNonNegativeIntegerTlv(a);if("bytes"==e.type.name)return l.readBlobTlv(a);if("string"==e.type.name)return l.readBlobTlv(a).toString();if("bool"==e.type.name)return l.readBooleanTlv(a,b);if("double"==e.type.name)return l.readBlobTlv(a).readDoubleLE(0);throw Error("ProtobufTlv.decode: Unknown field type");
};db.toName=function(e){for(var a=new c,l=0;l<e.length;++l)a.append(new p(new d(e[l].toBinary(),"binary"),!1));return a};var eb=function(e){if("string"===typeof e){e=e.split(".");this.oid=[];for(var a=0;a<e.length;++a)this.oid.push(parseInt(e[a]))}else this.oid=e.slice(0,e.length)};q.OID=eb;eb.prototype.getIntegerList=function(){return this.oid};eb.prototype.setIntegerList=function(e){this.oid=e.slice(0,e.length)};eb.prototype.toString=function(){for(var e="",a=0;a<this.oid.length;++a)0!==a&&(e+=
"."),e+=this.oid[a];return e};eb.prototype.equals=function(e){if(!(e instanceof eb)||this.oid.length!==e.oid.length)return!1;for(var a=0;a<this.oid.length;++a)if(this.oid[a]!=e.oid[a])return!1;return!0};var s=function(){};q.WireFormat=s;s.prototype.encodeName=function(e){throw Error("encodeName is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeName=function(e,a,l){throw Error("decodeName is unimplemented in the base WireFormat class.  You should use a derived class.");
};s.prototype.encodeInterest=function(e){throw Error("encodeInterest is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeInterest=function(e,a,l){throw Error("decodeInterest is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.encodeData=function(e){throw Error("encodeData is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeData=function(e,a,l){throw Error("decodeData is unimplemented in the base WireFormat class.  You should use a derived class.");
};s.prototype.encodeControlParameters=function(e){throw Error("encodeControlParameters is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeControlParameters=function(e,a,l){throw Error("decodeControlParameters is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.encodeControlResponse=function(e){throw Error("encodeControlResponse is unimplemented in the base WireFormat class.  You should use a derived class.");
};s.prototype.decodeControlResponse=function(e,a,l){throw Error("decodeControlResponse is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.encodeSignatureInfo=function(e){throw Error("encodeSignatureInfo is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeSignatureInfoAndValue=function(e,a,l){throw Error("decodeSignatureInfoAndValue is unimplemented in the base WireFormat class.  You should use a derived class.");
};s.prototype.encodeSignatureValue=function(e){throw Error("encodeSignatureValue is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeLpPacket=function(e,a,l){throw Error("decodeLpPacket is unimplemented in the base WireFormat class. You should use a derived class.");};s.prototype.encodeDelegationSet=function(e){throw Error("encodeDelegationSet is unimplemented in the base WireFormat class. You should use a derived class.");};s.prototype.decodeDelegationSet=
function(e,a,l){throw Error("decodeDelegationSet is unimplemented in the base WireFormat class. You should use a derived class.");};s.prototype.encodeEncryptedContent=function(e){throw Error("encodeEncryptedContent is unimplemented in the base WireFormat class. You should use a derived class.");};s.prototype.decodeEncryptedContent=function(e,a,l){throw Error("decodeEncryptedContent is unimplemented in the base WireFormat class. You should use a derived class.");};s.setDefaultWireFormat=function(e){s.defaultWireFormat=
e};s.getDefaultWireFormat=function(){return s.defaultWireFormat};var hb=a.TlvWireFormat,M=a.DataUtils,n=a.Tlv,H=a.TlvStructureDecoder,R=a.DecodingException,O=a.NdnCommon,k=a.Log.LOG,Ld=function(e){this.elementListener_=e;this.dataParts_=[];this.tlvStructureDecoder_=new H};q.ElementReader=Ld;Ld.prototype.onReceivedData=function(e){for(;;){var a,l;try{if(0===this.dataParts_.length&&0>=e.length)break;this.tlvStructureDecoder_.seek(0);a=this.tlvStructureDecoder_.findElementEnd(e);l=this.tlvStructureDecoder_.getOffset()}catch(b){throw this.dataParts_=
[],this.tlvStructureDecoder_=new H,b;}if(a){var c;0===this.dataParts_.length?c=e.slice(0,l):(this.dataParts_.push(e.slice(0,l)),c=M.concatArrays(this.dataParts_),this.dataParts_=[]);e=e.slice(l,e.length);this.tlvStructureDecoder_=new H;this.elementListener_.onReceivedElement(c);if(0==e.length)break}else{a=e.length;for(l=0;l<this.dataParts_.length;++l)a+=this.dataParts_[l].length;if(a>O.MAX_NDN_PACKET_SIZE)throw this.dataParts_=[],this.tlvStructureDecoder_=new H,new R(Error("The incoming packet exceeds the maximum limit Face.getMaxNdnPacketSize()"));
this.dataParts_.push(new d(e));3<k&&console.log("Incomplete packet received. Length "+e.length+". Wait for more input.");break}}};sa.prototype=Error();sa.prototype.name="DerDecodingException";q.DerDecodingException=sa;Fb.prototype=Error();Fb.prototype.name="DerEncodingException";q.DerEncodingException=Fb;var P=function(){};q.DerNodeType=P;P.Eoc=0;P.Boolean=1;P.Integer=2;P.BitString=3;P.OctetString=4;P.Null=5;P.ObjectIdentifier=6;P.ObjectDescriptor=7;P.External=40;P.Real=9;P.Enumerated=10;P.EmbeddedPdv=
43;P.Utf8String=12;P.RelativeOid=13;P.Sequence=48;P.Set=49;P.NumericString=18;P.PrintableString=19;P.T61String=20;P.VideoTexString=21;P.Ia5String=22;P.UtcTime=23;P.GeneralizedTime=24;P.GraphicString=25;P.VisibleString=26;P.GeneralString=27;P.UniversalString=28;P.CharacterString=29;P.BmpString=30;var Xa=a.DynamicBuffer,p=a.Blob,sa=a.DerDecodingException,Fb=a.DerEncodingException,P=a.DerNodeType,m=function(e){this.nodeType_=e;this.parent_=null;this.header_=new d(0);this.payload_=new Xa(0);this.payloadPosition_=
0};q.DerNode=m;m.prototype.getSize=function(){return this.header_.length+this.payloadPosition_};m.prototype.encodeHeader=function(e){var a=new Xa(10),l=0;a.array[l++]=this.nodeType_;if(0>e)throw Error("encodeHeader: DER object has negative length");if(127>=e)a.array[l++]=e&255;else{var b=new Xa(10),c=e;for(e=0;0!=c;)++e,b.ensureLengthFromBack(e),b.array[b.array.length-e]=c&255,c>>=8;c=e+1;b.ensureLengthFromBack(c);b.array[b.array.length-c]=(128|e)&255;a.copy(b.slice(b.array.length-c),l);l+=c}this.header_=
a.slice(0,l)};m.prototype.decodeHeader=function(e,a){var l=a,b=e[l]&255,l=l+1;this.nodeType_=b;var c=e[l]&255,l=l+1,d=new Xa(10),k=0;d.array[k++]=b;b=d.array[k++]=c;if(0!=(c&128))for(c&=127,b=0;0<c;){if(e.length<=l)throw new sa("DerNode.decodeHeader: The input length is too small");var m=e[l],l=l+1;d.ensureLength(k+1);d.array[k++]=m;b=256*b+(m&255);c-=1}this.header_=d.slice(0,k);return b};m.prototype.encode=function(){var e=new d(this.getSize());this.header_.copy(e);this.payload_.slice(0,this.payloadPosition_).copy(e,
this.header_.length);return new p(e,!1)};m.prototype.decode=function(e,a){var l=a,b=this.decodeHeader(e,l),c=this.header_.length;0<b&&(l+=c,this.payloadAppend(e.slice(l,l+b)))};m.prototype.payloadAppend=function(e){this.payloadPosition_=this.payload_.copy(e,this.payloadPosition_)};m.parse=function(e,a){void 0==a&&(a=0);if(e.length<=a)throw new sa("DerNode.parse: The input length is too small");var l=e[a]&255;if(l===P.Boolean)l=new m.DerBoolean;else if(l===P.Integer)l=new m.DerInteger;else if(l===
P.BitString)l=new m.DerBitString;else if(l===P.OctetString)l=new m.DerOctetString;else if(l===P.Null)l=new m.DerNull;else if(l===P.ObjectIdentifier)l=new m.DerOid;else if(l===P.Sequence)l=new m.DerSequence;else if(l===P.PrintableString)l=new m.DerPrintableString;else if(l===P.GeneralizedTime)l=new m.DerGeneralizedTime;else throw new sa(Error("Unimplemented DER type "+l));l.decode(e,a);return l};m.prototype.toVal=function(){return this.encode()};m.prototype.getPayload=function(){return new p(this.payload_.slice(0,
this.payloadPosition_),!0)};m.prototype.getChildren=function(){throw new sa(Error("getChildren: This DerNode is not DerSequence"));};m.getSequence=function(e,a){if(0>a||a>=e.length)throw new sa(Error("getSequence: Child index is out of bounds"));if(!(e[a]instanceof m.DerSequence))throw new sa(Error("getSequence: Child DerNode is not a DerSequence"));return e[a]};m.DerStructure=function(e){m.call(this,e);this.childChanged_=!1;this.nodeList_=[];this.size_=0};m.DerStructure.prototype=new m;m.DerStructure.prototype.name=
"DerStructure";m.DerStructure.prototype.getSize=function(){this.childChanged_&&(this.updateSize(),this.childChanged_=!1);this.encodeHeader(this.size_);return this.size_+this.header_.length};m.DerStructure.prototype.getChildren=function(){return this.nodeList_};m.DerStructure.prototype.updateSize=function(){for(var e=0,a=0;a<this.nodeList_.length;++a)e+=this.nodeList_[a].getSize();this.size_=e;this.childChanged_=!1};m.DerStructure.prototype.addChild=function(e,a){e.parent_=this;this.nodeList_.push(e);
a&&null!=this.parent_&&this.parent_.setChildChanged();this.childChanged_=!0};m.DerStructure.prototype.setChildChanged=function(){null!=this.parent_&&this.parent_.setChildChanged();this.childChanged_=!0};m.DerStructure.prototype.encode=function(){var e=new Xa(10),a=0;this.updateSize();this.encodeHeader(this.size_);for(var a=e.copy(this.header_,a),l=0;l<this.nodeList_.length;++l)var b=this.nodeList_[l].encode(),a=e.copy(b.buf(),a);return new p(e.slice(0,a),!1)};m.DerStructure.prototype.decode=function(e,
a){var l=a;this.size_=this.decodeHeader(e,l);for(var l=l+this.header_.length,b=0;b<this.size_;){var c=m.parse(e,l),d=c.getSize(),l=l+d,b=b+d;this.addChild(c,!1)}};m.DerByteString=function(e,a){m.call(this,a);null!=e&&(this.payloadAppend(e),this.encodeHeader(e.length))};m.DerByteString.prototype=new m;m.DerByteString.prototype.name="DerByteString";m.DerByteString.prototype.toVal=function(){return this.getPayload()};m.DerBoolean=function(e){m.call(this,P.Boolean);void 0!=e&&(e=e?255:0,this.payload_.ensureLength(this.payloadPosition_+
1),this.payload_.array[this.payloadPosition_++]=e,this.encodeHeader(1))};m.DerBoolean.prototype=new m;m.DerBoolean.prototype.name="DerBoolean";m.DerBoolean.prototype.toVal=function(){return 0!=this.payload_.array[0]};m.DerInteger=function(e){m.call(this,P.Integer);if(void 0!=e){if(d.isBuffer(e)){if(0<e.length&&128<=e[0])throw new Fb(Error("DerInteger: Negative integers are not currently supported"));0==e.length?this.payloadAppend(new d([0])):this.payloadAppend(e)}else{e=Math.round(e);if(0>e)throw new Fb(Error("DerInteger: Negative integers are not currently supported"));
for(var a=new Xa(10),l=0;!(++l,a.ensureLengthFromBack(l),a.array[a.array.length-l]=e&255,e>>=8,0>=e););128<=a.array[a.array.length-l]&&(++l,a.ensureLengthFromBack(l),a.array[a.array.length-l]=0);this.payloadAppend(a.slice(a.array.length-l))}this.encodeHeader(this.payloadPosition_)}};m.DerInteger.prototype=new m;m.DerInteger.prototype.name="DerInteger";m.DerInteger.prototype.toVal=function(){if(0<this.payloadPosition_&&128<=this.payload_.array[0])throw new sa(Error("DerInteger: Negative integers are not currently supported"));
for(var e=0,a=0;a<this.payloadPosition_;++a)e<<=8,e+=this.payload_.array[a];return e};m.DerBitString=function(e,a){m.call(this,P.BitString);void 0!=e&&(this.payload_.ensureLength(this.payloadPosition_+1),this.payload_.array[this.payloadPosition_++]=a&255,this.payloadAppend(e),this.encodeHeader(this.payloadPosition_))};m.DerBitString.prototype=new m;m.DerBitString.prototype.name="DerBitString";m.DerOctetString=function(e){m.DerByteString.call(this,e,P.OctetString)};m.DerOctetString.prototype=new m.DerByteString;
m.DerOctetString.prototype.name="DerOctetString";m.DerNull=function(){m.call(this,P.Null);this.encodeHeader(0)};m.DerNull.prototype=new m;m.DerNull.prototype.name="DerNull";m.DerOid=function(e){m.call(this,P.ObjectIdentifier);if(void 0!=e)if("string"===typeof e){e=e.split(".");for(var a=[],l=0;l<e.length;++l)a.push(parseInt(e[l]));this.prepareEncoding(a)}else this.prepareEncoding(e.getIntegerList())};m.DerOid.prototype=new m;m.DerOid.prototype.name="DerOid";m.DerOid.prototype.prepareEncoding=function(e){var a;
if(0==e.length)throw new Fb(Error("No integer in OID"));if(0<=e[0]&&2>=e[0])a=40*e[0];else throw new Fb(Error("First integer in OID is out of range"));if(2<=e.length)if(0<=e[1]&&39>=e[1])a+=e[1];else throw new Fb(Error("Second integer in OID is out of range"));var l=new Xa(10),b=0,b=l.copy(m.DerOid.encode128(a),b);if(2<e.length)for(a=2;a<e.length;++a)b=l.copy(m.DerOid.encode128(e[a]),b);this.encodeHeader(b);this.payloadAppend(l.slice(0,b))};m.DerOid.encode128=function(e){var a=new Xa(10),l=0;if(128>
e)++l,a.array[a.array.length-l]=e&127;else for(++l,a.array[a.array.length-l]=e&127,e>>=7;0!=e;)++l,a.ensureLengthFromBack(l),a.array[a.array.length-l]=e&127|128,e>>=7;return a.slice(a.array.length-l)};m.DerOid.prototype.decode128=function(e,a){for(var l=0,b=e;0!=(this.payload_.array[e]&128);)l=128*l+(this.payload_.array[e]&255)-128,e+=1;l=128*l+(this.payload_.array[e]&255);a[0]=e-b+1;return l};m.DerOid.prototype.toVal=function(){for(var e=0,a=[];e<this.payloadPosition_;){var l=[0],b=this.decode128(e,
l),e=e+l[0];a.push(b)}e=a[0];e=Math.floor(e/40)+"."+e%40;for(l=1;l<a.length;++l)e+="."+a[l];return e};m.DerSequence=function(){m.DerStructure.call(this,P.Sequence)};m.DerSequence.prototype=new m.DerStructure;m.DerSequence.prototype.name="DerSequence";m.DerPrintableString=function(e){m.DerByteString.call(this,e,P.PrintableString)};m.DerPrintableString.prototype=new m.DerByteString;m.DerPrintableString.prototype.name="DerPrintableString";m.DerGeneralizedTime=function(e){m.call(this,P.GeneralizedTime);
void 0!=e&&(e=m.DerGeneralizedTime.toDerTimeString(e),this.payloadAppend((new p(e)).buf()),this.encodeHeader(this.payloadPosition_))};m.DerGeneralizedTime.prototype=new m;m.DerGeneralizedTime.prototype.name="DerGeneralizedTime";m.DerGeneralizedTime.toDerTimeString=function(e){e=new Date(Math.round(e));return e.getUTCFullYear()+m.DerGeneralizedTime.to2DigitString(e.getUTCMonth()+1)+m.DerGeneralizedTime.to2DigitString(e.getUTCDate())+m.DerGeneralizedTime.to2DigitString(e.getUTCHours())+m.DerGeneralizedTime.to2DigitString(e.getUTCMinutes())+
m.DerGeneralizedTime.to2DigitString(e.getUTCSeconds())+"Z"};m.DerGeneralizedTime.to2DigitString=function(e){e=e.toString();return 1===e.length?"0"+e:e};m.DerGeneralizedTime.prototype.toVal=function(){var e=this.payload_.slice(0,this.payloadPosition_).toString();return Date.UTC(parseInt(e.substr(0,4)),parseInt(e.substr(4,2)-1),parseInt(e.substr(6,2)),parseInt(e.substr(8,2)),parseInt(e.substr(10,2)),parseInt(e.substr(12,2)))};var Ib=a,Yb=function(e,a){this.subtrees=[];this.value=e;this.parent=a;this.lastChild=
null};Yb.prototype.addSubtree=function(e,a){var l=this.find(e);null!==l?l.push(a):this.subtrees.push({key:e,value:[a]});a.parent=this;this.lastChild=a};Yb.prototype.createSubtree=function(e,a){var l=new Yb(a,this);this.addSubtree(e,l);return l};Yb.prototype.get=function(e){e=e.replace(/^\/+/,"");if(0===e.length)return[this];var a=e.split("/");e=this.find(a[0]);if(null===e)return[];if(1==a.length)return e.slice(0);for(var a=a.slice(1).join("/"),l=[],b=0;b<e.length;++b)var c=e[b].get(a),l=l.concat(c);
return l};Yb.prototype.getFirstValue=function(e){e=this.get(e);return 1<=e.length?e[0].value:null};Yb.prototype.getValue=function(){return this.value};Yb.prototype.getParent=function(){return this.parent};Yb.prototype.getLastChild=function(){return this.lastChild};Yb.prototype.prettyPrint=function(e){e=e||1;var a=Array(e+1).join(" "),l="";null!=this.parent&&(this.value&&0<this.value.length&&(l+='"'+this.value+'"'),l+="\n");if(0<this.subtrees.length){this.parent&&(l+=a+"{\n");for(var b=Array(e+2+1).join(" "),
c=0;c<this.subtrees.length;++c)for(var d=0;d<this.subtrees[c].value.length;++d)l+=b+this.subtrees[c].key+" "+this.subtrees[c].value[d].prettyPrint(e+2);this.parent&&(l+=a+"}\n")}return l};Yb.prototype.toString=function(){return this.prettyPrint()};Yb.prototype.find=function(e){for(var a=0;a<this.subtrees.length;++a)if(this.subtrees[a].key==e)return this.subtrees[a].value;return null};var dc=function(){this.root=new Yb};q.BoostInfoParser=dc;q.BoostInfoTree=Yb;dc.prototype.read=function(e,a){var l;
"string"==typeof a?l=e:(a=e,l=Ib.readFileSync(e).toString());var b=this.root,c=this;l.split(/\r?\n/).forEach(function(e){b=c.parseLine(e.trim(),b)})};dc.prototype.write=function(e){Ib.writeFileSync(e,""+this.root)};dc.prototype.getRoot=function(){return this.root};dc.shlex_split=function(e){var a=[];if(""==e)return a;for(var l=0;;){for(;0<=" \t\n\r".indexOf(e[l]);)if(l+=1,l>=e.length)return a;for(var b=l,c=!1,d="";;){if("\\"==e[b]){if(d+=e.substring(l,b),b=l=b+1,b>=e.length)break}else if(c)'"'==e[b]&&
(d+=e.substring(l,b),l=b+1,c=!1);else if('"'==e[b])d+=e.substring(l,b),l=b+1,c=!0;else if(0<=" \t\n\r".indexOf(e[b]))break;b+=1;if(b>=e.length)break}d+=e.substring(l,b);a.push(d);if(b>=e.length)return a;l=b}};dc.prototype.parseLine=function(e,a){var l=e.indexOf(";");0<=l&&(e=e.substring(0,l).trim());if(0==e.length)return a;for(var l=dc.shlex_split(e),b=!1,c=!1,d=0;d<l.length;++d)b=b||"{"==l[d],c=c||"}"==l[d];if(!b&&!c){var b=l[0],k;1<l.length&&(k=l[1]);a.createSubtree(b,k);return a}l=e.indexOf("{");
if(0<l)return k=e.substring(0,l),l=e.substring(l),k=this.parseLine(k,a),this.parseLine(l,k);if("{"==e[0])return a=a.getLastChild();if("}"==e[0])return a=a.getParent();throw runtime_error("BoostInfoParser: input line is malformed");};var c=a.Name,uc=a.InterestFilter,Fa=a.ForwardingFlags,s=a.WireFormat,k=a.Log.LOG,Ma=function(e,a){a=a||1E3;this.face=e;this.cleanupIntervalMilliseconds=a;this.nextCleanupTime=(new Date).getTime()+a;this.onDataNotFoundForPrefix={};this.interestFilterIdList=[];this.registeredPrefixIdList=
[];this.noStaleTimeCache=[];this.staleTimeCache=[];this.emptyComponent=new c.Component;this.pendingInterestTable=[];this.minimumCacheLifetime_=0;var l=this;this.storePendingInterestCallback=function(e,a,b,c,u){l.storePendingInterest(a,b)}};q.MemoryContentCache=Ma;Ma.prototype.registerPrefix=function(e,a,l,b,c,d){var k=l,m=b,n=c;l="object"===typeof k&&1===k.length&&"function"===typeof k[0]?k[0]:null;b="function"===typeof k?k:"function"===typeof m?m:null;c=k instanceof Fa?k:m instanceof Fa?m:n instanceof
Fa?n:new Fa;d=k instanceof s?k:m instanceof s?m:n instanceof s?n:d instanceof s?d:s.getDefaultWireFormat();b&&(this.onDataNotFoundForPrefix[e.toUri()]=b);e=this.face.registerPrefix(e,this.onInterest.bind(this),a,l,c,d);this.registeredPrefixIdList.push(e)};Ma.prototype.setInterestFilter=function(e,a){if(a){var l;l="object"===typeof e&&e instanceof uc?e.getPrefix():e;this.onDataNotFoundForPrefix[l.toUri()]=a}l=this.face.setInterestFilter(e,this.onInterest.bind(this));this.interestFilterIdList.push(l)};
Ma.prototype.unregisterAll=function(){for(var e=0;e<this.interestFilterIdList.length;++e)this.face.unsetInterestFilter(this.interestFilterIdList[e]);this.interestFilterIdList=[];for(e=0;e<this.registeredPrefixIdList.length;++e)this.face.removeRegisteredPrefix(this.registeredPrefixIdList[e]);this.registeredPrefixIdList=[];this.onDataNotFoundForPrefix={}};Ma.prototype.add=function(e){var a=(new Date).getTime();this.doCleanup(a);if(null!=e.getMetaInfo().getFreshnessPeriod()&&0<=e.getMetaInfo().getFreshnessPeriod()){for(var l=
new Ma.StaleTimeContent(e,a,this.minimumCacheLifetime_),b=this.staleTimeCache.length-1;0<=b&&!(this.staleTimeCache[b].cacheRemovalTimeMilliseconds_<=l.cacheRemovalTimeMilliseconds_);)--b;this.staleTimeCache.splice(b+1,0,l)}else this.noStaleTimeCache.push(new Ma.Content(e));for(b=this.pendingInterestTable.length-1;0<=b;--b)if(this.pendingInterestTable[b].isTimedOut(a))this.pendingInterestTable.splice(b,1);else if(this.pendingInterestTable[b].getInterest().matchesName(e.getName())){try{this.pendingInterestTable[b].getFace().send(e.wireEncode().buf())}catch(c){0<
k&&console.log(""+c);break}this.pendingInterestTable.splice(b,1)}};Ma.prototype.storePendingInterest=function(e,a){this.pendingInterestTable.push(new Ma.PendingInterest(e,a))};Ma.prototype.getStorePendingInterest=function(){return this.storePendingInterestCallback};Ma.prototype.getMinimumCacheLifetime=function(){return this.minimumCacheLifetime_};Ma.prototype.setMinimumCacheLifetime=function(e){this.minimumCacheLifetime_=e};Ma.prototype.onInterest=function(e,a,l,b,c){var d=(new Date).getTime();this.doCleanup(d);
for(var k=null,m=null,n=this.staleTimeCache.length+this.noStaleTimeCache.length,p=0;p<n;++p){var s,q=!0;p<this.staleTimeCache.length?(s=this.staleTimeCache[p],q=s.isFresh(d)):s=this.noStaleTimeCache[p-this.staleTimeCache.length];if(a.matchesName(s.getName())&&(!a.getMustBeFresh()||q)){if(null==a.getChildSelector()){l.send(s.getDataEncoding());return}var q=s.getName().size()>a.getName().size()?s.getName().get(a.getName().size()):this.emptyComponent,x=!1;null===m?x=!0:0==a.getChildSelector()?0>q.compare(k)&&
(x=!0):0<q.compare(k)&&(x=!0);x&&(k=q,m=s.getDataEncoding())}}null!==m?l.send(m):(d=this.onDataNotFoundForPrefix[e.toUri()])&&d(e,a,l,b,c)};Ma.prototype.doCleanup=function(e){if(e>=this.nextCleanupTime){for(;0<this.staleTimeCache.length&&this.staleTimeCache[0].isPastRemovalTime(e);)this.staleTimeCache.shift();this.nextCleanupTime=e+this.cleanupIntervalMilliseconds}};Ma.Content=function(e){e&&(this.name=new c(e.getName()),this.dataEncoding=e.wireEncode().buf())};Ma.Content.prototype.getName=function(){return this.name};
Ma.Content.prototype.getDataEncoding=function(){return this.dataEncoding};Ma.StaleTimeContent=function(e,a,l){Ma.Content.call(this,e);this.cacheRemovalTimeMilliseconds_=a+Math.max(e.getMetaInfo().getFreshnessPeriod(),l);this.freshnessExpiryTimeMilliseconds_=a+e.getMetaInfo().getFreshnessPeriod()};Ma.StaleTimeContent.prototype=new Ma.Content;Ma.StaleTimeContent.prototype.name="StaleTimeContent";Ma.StaleTimeContent.prototype.isPastRemovalTime=function(e){return this.cacheRemovalTimeMilliseconds_<=e};
Ma.StaleTimeContent.prototype.isFresh=function(e){return this.freshnessExpiryTimeMilliseconds_>e};Ma.PendingInterest=function(e,a){this.interest=e;this.face=a;var l=this.interest.getInterestLifetimeMilliseconds();if(null==l||0>l)l=4E3;this.timeoutMilliseconds=(new Date).getTime()+l};Ma.PendingInterest.prototype.getInterest=function(){return this.interest};Ma.PendingInterest.prototype.getFace=function(){return this.face};Ma.PendingInterest.prototype.isTimedOut=function(e){return e>=this.timeoutTimeMilliseconds};
var F=a.Interest,p=a.Blob,C=a.KeyChain,O=a.NdnCommon,ib=function(e,a,l,b,c){this.face=e;this.validatorKeyChain=a;this.verifySegment=l;this.onComplete=b;this.onError=c;this.contentParts=[]};q.SegmentFetcher=ib;ib.ErrorCode={INTEREST_TIMEOUT:1,DATA_HAS_NO_SEGMENT:2,SEGMENT_VERIFICATION_FAILED:3};ib.DontVerifySegment=function(e){return!0};ib.fetch=function(e,a,l,b,c){null==l||l instanceof C?(new ib(e,l,ib.DontVerifySegment,b,c)).fetchFirstSegment(a):(new ib(e,null,l,b,c)).fetchFirstSegment(a)};ib.prototype.fetchFirstSegment=
function(e){e=new F(e);e.setChildSelector(1);e.setMustBeFresh(!0);var a=this;this.face.expressInterest(e,function(e,b){a.onData(e,b)},function(e){a.onTimeout(e)})};ib.prototype.fetchNextSegment=function(e,a,l){e=new F(e);e.setChildSelector(0);e.setMustBeFresh(!1);e.setName(a.getPrefix(-1).appendSegment(l));var b=this;this.face.expressInterest(e,function(e,a){b.onData(e,a)},function(e){b.onTimeout(e)})};ib.prototype.onData=function(e,a){if(null!=this.validatorKeyChain)try{var l=this;this.validatorKeyChain.verifyData(a,
function(a){l.onVerified(a,e)},this.onValidationFailed.bind(this))}catch(b){console.log("Error in KeyChain.verifyData: "+b)}else if(this.verifySegment(a))this.onVerified(a,e);else try{this.onError(ib.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Segment verification failed")}catch(c){console.log("Error in onError: "+O.getErrorWithStackTrace(c))}};ib.prototype.onVerified=function(e,a){if(ib.endsWithSegmentNumber(e.getName())){var l=0;try{l=e.getName().get(-1).toSegment()}catch(b){try{this.onError(ib.ErrorCode.DATA_HAS_NO_SEGMENT,
"Error decoding the name segment number "+e.getName().get(-1).toEscapedString()+": "+b)}catch(c){console.log("Error in onError: "+O.getErrorWithStackTrace(c))}return}var k=this.contentParts.length;if(l!=k)this.fetchNextSegment(a,e.getName(),k);else{this.contentParts.push(e.getContent().buf());if(0<e.getMetaInfo().getFinalBlockId().getValue().size()){var m=0;try{m=e.getMetaInfo().getFinalBlockId().toSegment()}catch(n){try{this.onError(ib.ErrorCode.DATA_HAS_NO_SEGMENT,"Error decoding the FinalBlockId segment number "+
e.getMetaInfo().getFinalBlockId().toEscapedString()+": "+n)}catch(s){console.log("Error in onError: "+O.getErrorWithStackTrace(s))}return}if(l==m){l=d.concat(this.contentParts);try{this.onComplete(new p(l,!1))}catch(q){console.log("Error in onComplete: "+O.getErrorWithStackTrace(q))}return}}this.fetchNextSegment(a,e.getName(),k+1)}}else try{this.onError(ib.ErrorCode.DATA_HAS_NO_SEGMENT,"Got an unexpected packet without a segment number: "+e.getName().toUri())}catch(x){console.log("Error in onError: "+
O.getErrorWithStackTrace(x))}};ib.prototype.onValidationFailed=function(e,a){try{this.onError(ib.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Segment verification failed for "+e.getName().toUri()+" . Reason: "+a)}catch(l){console.log("Error in onError: "+O.getErrorWithStackTrace(l))}};ib.prototype.onTimeout=function(e){try{this.onError(ib.ErrorCode.INTEREST_TIMEOUT,"Time out for interest "+e.getName().toUri())}catch(a){console.log("Error in onError: "+O.getErrorWithStackTrace(a))}};ib.endsWithSegmentNumber=
function(e){return 1<=e.size()&&e.get(-1).isSegment()};var Ic=function(){this.backrefs_=[]};q.NdnRegexBackrefManager=Ic;Ic.prototype.pushRef=function(e){last=this.backrefs_.length;this.backrefs_.push(e);return last};Ic.prototype.popRef=function(){this.backrefs_.pop()};Ic.prototype.size=function(){return this.backrefs_.length};Ic.prototype.getBackref=function(e){return this.backrefs_[e]};var Ic=a.NdnRegexBackrefManager,W=function(e,a,l){this.matchers_=[];this.matchResult_=[];this.expr_=e;this.type_=
a;void 0==l&&(l=new Ic);this.backrefManager_=l};q.NdnRegexMatcherBase=W;W.Error=function(e){if(e)return e.__proto__=W.Error.prototype,e};W.Error.prototype=Error();W.Error.prototype.name="NdnRegexMatcherBaseError";W.NdnRegexExprType={TOP:0,PATTERN_LIST:1,REPEAT_PATTERN:2,BACKREF:3,COMPONENT_SET:4,COMPONENT:5,PSEUDO:6};W.prototype.match=function(e,a,l){var b=!1;this.matchResult_=[];if(this.recursiveMatch_(0,e,a,l)){for(b=a;b<a+l;)this.matchResult_.push(e.get(b)),++b;b=!0}else b=!1;return b};W.prototype.getMatchResult=
function(){return this.matchResult_};W.prototype.getExpr=function(){return this.expr_};W.prototype.compile_=function(){throw Error("NdnRegexMatcherBase.compile is not implemented");};W.prototype.recursiveMatch_=function(e,a,l,b){var c=b;if(e>=this.matchers_.length)return 0==b;for(var d=this.matchers_[e];0<=c;){if(d.match(a,l,c)&&this.recursiveMatch_(e+1,a,l+c,b-c))return!0;--c}return!1};var W=a.NdnRegexMatcherBase,Yc=function(e,a){W.call(this,e,W.NdnRegexExprType.BACKREF,a)};Yc.prototype=new W;Yc.prototype.name=
"NdnRegexBackrefMatcher";q.NdnRegexBackrefMatcher=Yc;Yc.prototype.lateCompile=function(){this.compile_()};Yc.prototype.compile_=function(){if(2>this.expr_.length)throw new W.Error(Error("Unrecognized format: "+this.expr_));var e=this.expr_.length-1;if("("===this.expr_[0]&&")"===this.expr_[e])e=new ec(this.expr_.substring(1,e),this.backrefManager_),this.matchers_.push(e);else throw new W.Error(Error("Unrecognized format: "+this.expr_));};var ec=a.NdnRegexPatternListMatcher,W=a.NdnRegexMatcherBase,
Zc=a.NdnRegexPseudoMatcher,md=function(e,a,l){W.call(this,e,W.NdnRegexExprType.COMPONENT,a);void 0===l&&(l=!0);this.componentRegex_=null;this.pseudoMatchers_=[];this.isExactMatch_=l;this.compile_()};md.prototype=new W;md.prototype.name="NdnRegexComponentMatcher";q.NdnRegexComponentMatcher=md;md.prototype.match=function(e,a,l){this.matchResult_=[];if(""==this.expr_)return this.matchResult_.push(e.get(a)),!0;if(this.isExactMatch_){if(l=e.get(a).toEscapedString().match(this.componentRegex_),null!==l){for(var b=
1;b<l.length;++b)this.pseudoMatchers_[b].resetMatchResult(),this.pseudoMatchers_[b].setMatchResult(l[b]);this.matchResult_.push(e.get(a));return!0}}else throw new W.Error(Error("Non-exact component search is not supported yet"));return!1};md.prototype.compile_=function(){this.componentRegex_=new RegExp(this.expr_);this.pseudoMatchers_=[];this.pseudoMatchers_.push(new Zc);if(0<=this.expr_.indexOf("\\("))throw new W.Error(Error("Can't count subexpressions in regex with escaped parentheses: "+expr_));
for(var e=0,a=0;a<this.expr_.length;++a)"("===this.expr_[a]&&++e;for(a=1;a<=e;++a){var l=new Zc;this.pseudoMatchers_.push(l);this.backrefManager_.pushRef(l)}};var W=a.NdnRegexMatcherBase,Jc=function(e,a){W.call(this,e,W.NdnRegexExprType.COMPONENT_SET,a);this.components_=[];this.isInclusion_=!0;this.compile_()};Jc.prototype=new W;Jc.prototype.name="NdnRegexComponentSetMatcher";q.NdnRegexComponentSetMatcher=Jc;Jc.prototype.match=function(e,a,l){isMatched=!1;if(1!==l)return!1;for(var b=0;b<this.components_.length;++b)if(this.components_[b].match(e,
a,l)){isMatched=!0;break}this.matchResult_=[];return(this.isInclusion_?isMatched:!isMatched)?(this.matchResult_.push(e.get(a)),!0):!1};Jc.prototype.compile_=function(){if(2>this.expr_.length)throw new W.Error(Error("Regexp compile error (cannot parse "+this.expr_+")"));if("<"===this.expr_[0])this.compileSingleComponent_();else if("["===this.expr_[0]){var e=this.expr_.length-1;if("]"!==this.expr_[e])throw new W.Error(Error("Regexp compile error (no matching ']' in "+this.expr_+")"));"^"===this.expr_[1]?
(this.isInclusion_=!1,this.compileMultipleComponents_(2,e)):this.compileMultipleComponents_(1,e)}else throw new W.Error(Error("Regexp compile error (cannot parse "+this.expr_+")"));};Jc.prototype.extractComponent_=function(e){for(var a=1,l=0;a>l;){if(e>=this.expr_.length)throw new W.Error(Error("Error: angle brackets mismatch"));"<"===this.expr_[e]?a+=1:">"===this.expr_[e]&&(l+=1);e+=1}return e};Jc.prototype.compileSingleComponent_=function(){var e=this.extractComponent_(1);if(this.expr_.length!==
e)throw new W.Error(Error("Component expr error "+this.expr_));component=new md(this.expr_.substring(1,e-1),this.backrefManager_);this.components_.push(component)};Jc.prototype.compileMultipleComponents_=function(e,a){for(var l=e,b=e;l<a;){if("<"!==this.expr_[l])throw new W.Error(Error("Component expr error "+this.expr_));b=l+1;l=this.extractComponent_(b);component=new md(this.expr_.substring(b,l-1),this.backrefManager_);this.components_.push(component)}if(l!=a)throw new W.Error(Error("Not sufficient expr to parse "+
this.expr_));};md=a.NdnRegexComponentMatcher;W=a.NdnRegexMatcherBase;ec=function(e,a){W.call(this,e,W.NdnRegexExprType.PATTERN_LIST,a);this.compile_()};ec.prototype=new W;ec.prototype.name="NdnRegexPatternListMatcher";q.NdnRegexPatternListMatcher=ec;ec.prototype.compile_=function(){for(var e=this.expr_.length,a=[0],l=a[0];a[0]<e;)if(l=a[0],!this.extractPattern_(l,a))throw new W.Error(Error("Compile error"));};ec.prototype.extractPattern_=function(e,a){var l=e,b=e,c=e;if("("===this.expr_[e])c=e=this.extractSubPattern_("(",
")",e+1),b=this.extractRepetition_(e),c===b?(l=new Yc(this.expr_.substring(l,b),this.backrefManager_),this.backrefManager_.pushRef(l),l.lateCompile(),this.matchers_.push(l)):this.matchers_.push(new vc(this.expr_.substring(l,b),this.backrefManager_,c-l));else if("<"===this.expr_[e])e+=1,c=e=this.extractSubPattern_("<",">",e),b=this.extractRepetition_(e),this.matchers_.push(new vc(this.expr_.substring(l,b),this.backrefManager_,c-l));else if("["===this.expr_[e])e+=1,c=e=this.extractSubPattern_("[","]",
e),b=this.extractRepetition_(e),this.matchers_.push(new vc(this.expr_.substring(l,b),this.backrefManager_,c-l));else throw new W.Error(Error("Unexpected syntax"));a[0]=b;return!0};ec.prototype.extractSubPattern_=function(e,a,l){for(var b=1,c=0;b>c;){if(l>=this.expr_.length)throw new W.Error(Error("Parenthesis mismatch"));e==this.expr_[l]&&(b+=1);a==this.expr_[l]&&(c+=1);l+=1}return l};ec.prototype.extractRepetition_=function(e){var a=this.expr_.length;if(e===a)return e;if("+"==this.expr_[e]||"?"==
this.expr_[e]||"*"==this.expr_[e])return++e,e;if("{"==this.expr_[e]){for(;"}"!=this.expr_[e]&&(++e,e!==a););if(e===a)throw new W.Error(Error("Missing right brace bracket"));++e}return e};var Yc=a.NdnRegexBackrefMatcher,vc=a.NdnRegexRepeatMatcher,c=a.Name,W=a.NdnRegexMatcherBase,Zc=function(){W.call(this,"",W.NdnRegexExprType.PSEUDO)};Zc.prototype=new W;Zc.prototype.name="NdnRegexPseudoMatcher";q.NdnRegexPseudoMatcher=Zc;Zc.prototype.compile_=function(){};Zc.prototype.setMatchResult=function(e){this.matchResult_.push(new c.Component(e))};
Zc.prototype.resetMatchResult=function(){this.matchResult_=[]};W=a.NdnRegexMatcherBase;vc=function(e,a,l){W.call(this,e,W.NdnRegexExprType.REPEAT_PATTERN,a);this.repeatMax_=this.repeatMin_=0;this.indicator_=l;this.compile_()};vc.prototype=new W;vc.prototype.name="NdnRegexRepeatMatcher";q.NdnRegexRepeatMatcher=vc;vc.prototype.match=function(e,a,l){this.matchResult_=[];if(0===this.repeatMin_&&0===l)return!0;if(this.recursiveMatch2_(0,e,a,l)){for(var b=a;b<a+l;++b)this.matchResult_.push(e.get(b));return!0}return!1};
vc.prototype.compile_=function(){var e;"("==this.expr_[0]?(e=new Yc(this.expr_.substring(0,this.indicator_),this.backrefManager_),this.backrefManager_.pushRef(e),e.lateCompile()):e=new Jc(this.expr_.substring(0,this.indicator_),this.backrefManager_);this.matchers_.push(e);this.parseRepetition_()};vc.prototype.parseRepetition_=function(){var e=this.expr_.length;if(e===this.indicator_)return this.repeatMax_=this.repeatMin_=1,!0;if(e===this.indicator_+1){if("?"==this.expr_[this.indicator_])return this.repeatMin_=
0,this.repeatMax_=1,!0;if("+"==this.expr_[this.indicator_])return this.repeatMin_=1,this.repeatMax_=32767,!0;if("*"==this.expr_[this.indicator_])return this.repeatMin_=0,this.repeatMax_=32767,!0}else{var e=this.expr_.substring(this.indicator_,e),a=e.length,l=0,b=0;if(null!=e.match(/\{[0-9]+,[0-9]+\}/))separator=e.indexOf(","),l=parseInt(e.substring(1,separator)),b=parseInt(e.substring(separator+1,a-1));else if(null!=e.match(/\{,[0-9]+\}/))separator=e.indexOf(","),l=0,b=parseInt(e.substring(separator+
1,a-1));else if(null!=e.match(/\{[0-9]+,\}/))separator=e.indexOf(","),l=parseInt(e.substring(1,separator)),b=32767;else if(null!=e.match(/\{[0-9]+\}/))b=l=parseInt(e.substring(1,a-1));else throw new W.Error(Error("Error: RegexRepeatMatcher.ParseRepetition(): Unrecognized format "+this.expr_));if(32767<l||32767<b||l>b)throw new W.Error(Error("Error: RegexRepeatMatcher.ParseRepetition(): Wrong number "+this.expr_));this.repeatMin_=l;this.repeatMax_=b;return!0}return!1};vc.prototype.recursiveMatch2_=
function(e,a,l,b){var c=b,d=this.matchers_[0];if(0<b&&e>=this.repeatMax_||0===b&&e<this.repeatMin_)return!1;if(0==b&&e>=this.repeatMin_)return!0;for(;0<=c;){if(d.match(a,l,c)&&this.recursiveMatch2_(e+1,a,l+c,b-c))return!0;--c}return!1};var Yc=a.NdnRegexBackrefMatcher,Jc=a.NdnRegexComponentSetMatcher,c=a.Name,W=a.NdnRegexMatcherBase,Ic=a.NdnRegexBackrefManager,ec=a.NdnRegexPatternListMatcher,Ua=function(e,a){W.call(this,e,W.NdnRegexExprType.TOP);void 0==a&&(a="");this.secondaryMatcher_=this.primaryMatcher_=
null;this.primaryBackrefManager_=new Ic;this.secondaryBackrefManager_=new Ic;this.isSecondaryUsed_=!1;this.expand_=a;this.compile_()};Ua.prototype=new W;Ua.prototype.name="NdnRegexTopMatcher";q.NdnRegexTopMatcher=Ua;Ua.prototype.match=function(e,a,l){this.isSecondaryUsed_=!1;this.matchResult_=[];if(this.primaryMatcher_.match(e,0,e.size())){this.matchResult_=[];e=this.primaryMatcher_.getMatchResult();for(a=0;a<e.length;++a)this.matchResult_.push(e[a]);return!0}if(null!=this.secondaryMatcher_&&this.secondaryMatcher_.match(e,
0,e.size())){this.matchResult_=[];e=this.secondaryMatcher_.getMatchResult();for(a=0;a<e.length;++a)this.matchResult_.push(e[a]);return this.isSecondaryUsed_=!0}return!1};Ua.prototype.expand=function(e){void 0==e&&(e="");var a=new c,l=this.isSecondaryUsed_?this.secondaryBackrefManager_:this.primaryBackrefManager_,b=l.size();e=""!=e?e:this.expand_;for(var d=[0];d[0]<e.length;){var k=Ua.getItemFromExpand_(e,d);"<"==k[0]&&a.append(k.substring(1,k.length-1));if("\\"==k[0])if(k=parseInt(k.substring(1,k.length)),
0===k)for(k=0;k<this.matchResult_.length;++k)a.append(this.matchResult_[k]);else if(k<=b)for(var m=l.getBackref(k-1).getMatchResult(),k=0;k<m.length;++k)a.append(m[k]);else throw new W.Error(Error("Exceeded the range of back reference"));}return a};Ua.fromName=function(e,a){void 0==a&&(a=!1);for(var l="^",b=0;b<e.size();++b)l+="<",l+=Ua.convertSpecialChar_(e.get(b).toEscapedString()),l+=">";a&&(l+="$");return new Ua(l)};Ua.prototype.compile_=function(){var e=this.expr_,e="$"!=e[e.length-1]?e+"<.*>*":
e.substring(0,e.length-1);"^"!=e[0]?this.secondaryMatcher_=new ec("<.*>*"+e,this.secondaryBackrefManager_):e=e.substring(1);this.primaryMatcher_=new ec(e,this.primaryBackrefManager_)};Ua.getItemFromExpand_=function(e,a){var l=a[0];if("\\"==e[a[0]]){++a[0];if(a[0]>=e.length)throw new W.Error(Error("Wrong format of expand string!"));for(;a[0]<e.length&&"9">=e[a[0]]&&"0"<=e[a[0]];)if(++a[0],a[0]>e.length)throw new W.Error(Error("Wrong format of expand string!"));if(a[0]>l+1)return e.substring(l,a[0])}else if("<"==
e[a[0]]){++a[0];if(a[0]>=e.length)throw new W.Error(Error("Wrong format of expand string!"));for(var b=1,c=0;c<b;)if("<"==e[a[0]]&&++b,">"==e[a[0]]&&++c,++a[0],a[0]>=e.length)throw new W.Error(Error("Wrong format of expand string!"));return e.substring(l,a[0])}throw new W.Error(Error("Wrong format of expand string!"));};Ua.convertSpecialChar_=function(e){newStr="";for(var a=0;a<e.length;++a){var l=e[a];if("."==l||"["==l||"{"==l||"}"==l||"("==l||")"==l||"\\"==l||"*"==l||"+"==l||"?"==l||"|"==l||"^"==
l||"$"==l)newStr+="\\";newStr+=l}return newStr};var pb=function(){};q.Transport=pb;pb.ConnectionInfo=function(){};pb.prototype.isLocal=function(e,a,l){l("Transport.isLocal is not implemented")};var fc=function(){pb.call(this);this.onReceivedObject=this.connectionInfo=this.elementReader=null;var e=this;window.addEventListener("message",function(a){if(a.source==window&&a.data.type&&"FromMicroForwarderStub"==a.data.type)if(a=a.data.object,a.type&&"Buffer"==a.type){if(null!=e.elementReader)e.elementReader.onReceivedData(new d(a.data))}else if(e.onReceivedObject)e.onReceivedObject(a)},
!1)};fc.prototype=new pb;fc.prototype.name="MicroForwarderTransport";fc.ConnectionInfo=function(){pb.ConnectionInfo.call(this)};fc.ConnectionInfo.prototype=new pb.ConnectionInfo;fc.ConnectionInfo.prototype.name="MicroForwarderTransport.ConnectionInfo";fc.ConnectionInfo.prototype.equals=function(e){return null==e?!1:!0};fc.ConnectionInfo.prototype.toString=function(){return"{}"};fc.prototype.setOnReceivedObject=function(e){this.onReceivedObject=e};fc.prototype.isLocal=function(e,a,l){a(!0)};fc.prototype.connect=
function(e,a,l,b){this.elementReader=new Ld(a);this.connectionInfo=e;l()};fc.prototype.sendObject=function(e){window.postMessage({type:"FromMicroForwarderTransport",object:e},"*")};fc.prototype.send=function(e){null==this.connectionInfo?console.log("MicroForwarderTransport connection is not established."):this.sendObject(e.toJSON())};var gc=function(e){pb.call(this);this.connectionInfo=this.elementReader=null;this.onReceivedObject=e;this.port=null};gc.prototype=new pb;gc.prototype.name="RuntimePortTransport";
gc.ConnectionInfo=function(e){pb.ConnectionInfo.call(this);this.port=e};gc.ConnectionInfo.prototype=new pb.ConnectionInfo;gc.ConnectionInfo.prototype.name="RuntimePortTransport.ConnectionInfo";gc.ConnectionInfo.prototype.equals=function(e){return null==e||void 0==e.port?!1:this.port==e.port};gc.ConnectionInfo.prototype.toString=function(){return"{}"};gc.prototype.setOnReceivedObject=function(e){this.onReceivedObject=e};gc.prototype.isLocal=function(e,a,l){a(!0)};gc.prototype.connect=function(e,a,
l,b){this.elementReader=new Ld(a);this.connectionInfo=e;this.port=this.connectionInfo.port;var c=this;this.port.onMessage.addListener(function(e){if("Buffer"==e.type)c.elementReader.onReceivedData(d.isBuffer(e.data)?e.data:new d(e.data));else if(null!=c.onReceivedObject)c.onReceivedObject(e)});this.port.onDisconnect.addListener(function(){c.port=null;null!=b&&b()});l()};gc.prototype.sendObject=function(e){null==this.port?console.log("RuntimePortTransport connection is not established."):this.port.postMessage(e)};
gc.prototype.send=function(e){this.sendObject(e.toJSON())};var Ld=a.ElementReader,k=a.Log.LOG,pb=a.Transport,ca,Ab=function u(){pb.call(this);if(!WebSocket)throw Error("WebSocket support is not available on this platform.");this.elementReader=this.connectionInfo=this.ws=null;this.defaultGetConnectionInfo=ca.makeShuffledHostGetConnectionInfo("A.ws.ndn.ucla.edu B.ws.ndn.ucla.edu C.ws.ndn.ucla.edu D.ws.ndn.ucla.edu E.ws.ndn.ucla.edu F.ws.ndn.ucla.edu G.ws.ndn.ucla.edu H.ws.ndn.ucla.edu I.ws.ndn.ucla.edu J.ws.ndn.ucla.edu K.ws.ndn.ucla.edu L.ws.ndn.ucla.edu M.ws.ndn.ucla.edu N.ws.ndn.ucla.edu".split(" "),
9696,function(a,b){return new u.ConnectionInfo(a,b)})};Ab.prototype=new pb;Ab.prototype.name="WebSocketTransport";Ab.importFace=function(a){ca=a};q.WebSocketTransport=Ab;Ab.ConnectionInfo=function(a,l){pb.ConnectionInfo.call(this);this.host=a;this.port=void 0!==l?l:9696};Ab.ConnectionInfo.prototype=new pb.ConnectionInfo;Ab.ConnectionInfo.prototype.name="WebSocketTransport.ConnectionInfo";Ab.ConnectionInfo.prototype.equals=function(a){return null==a||void 0==a.host||void 0==a.port?!1:this.host==a.host&&
this.port==a.port};Ab.ConnectionInfo.prototype.toString=function(){return this.hostIsUri()?"{ uri: "+this.host+" }":"{ host: "+this.host+", port: "+this.port+" }"};Ab.ConnectionInfo.prototype.hostIsUri=function(){return"ws:"==this.host.substr(0,3)||"wss:"==this.host.substr(0,4)};Ab.prototype.isLocal=function(a,l,b){l(!1)};Ab.prototype.connect=function(a,l,b,c){this.close();var m=a.hostIsUri()?a.host:"ws://"+a.host+":"+a.port;this.ws=new WebSocket(m);0<k&&console.log("ws connection created.");this.connectionInfo=
a;this.ws.binaryType="arraybuffer";this.elementReader=new Ld(l);var n=this;this.ws.onmessage=function(a){a=a.data;if(null==a||void 0==a||""==a)console.log("INVALID ANSWER");else if(a instanceof ArrayBuffer){a=new d(new Uint8Array(a));3<k&&console.log("BINARY RESPONSE IS "+a.toString("hex"));try{n.elementReader.onReceivedData(a)}catch(l){console.log("NDN.ws.onmessage exception: "+l)}}};this.ws.onopen=function(a){3<k&&console.log(a);3<k&&console.log("ws.onopen: WebSocket connection opened.");3<k&&console.log("ws.onopen: ReadyState: "+
this.readyState);b()};this.ws.onerror=function(a){console.log("ws.onerror: ReadyState: "+this.readyState);console.log(a);console.log("ws.onerror: WebSocket error: "+a.data)};this.ws.onclose=function(a){console.log("ws.onclose: WebSocket connection closed.");n.ws=null;null!=c&&c()}};Ab.prototype.connectByFace=function(a,l){this.connect(a.connectionInfo,a,l,function(){a.closeByTransport()})};Ab.prototype.send=function(a){if(null!=this.ws){var l=new Uint8Array(a.length);l.set(a);this.ws.send(l.buffer);
3<k&&console.log("ws.send() returned.")}else console.log("WebSocket connection is not established.")};Ab.prototype.close=function(){null!=this.ws&&delete this.ws};q.TcpTransport=a.WebSocketTransport;var p=a.Blob,M=a.DataUtils,k=a.Log.LOG,R=a.DecodingException,c=function l(a){if("string"==typeof a)3<k&&console.log("Content Name String "+a),this.components=l.createNameArray(a);else if("object"===typeof a)if(this.components=[],a instanceof l)this.append(a);else for(var b=0;b<a.length;++b)this.append(a[b]);
else null==a?this.components=[]:1<k&&console.log("NO CONTENT NAME GIVEN");this.changeCount=0},bb={IMPLICIT_SHA256_DIGEST:1,PARAMETERS_SHA256_DIGEST:2,GENERIC:8,OTHER_CODE:32767};q.Name=c;q.ComponentType=bb;c.Component=function(a,b,k){if("object"===typeof a&&a instanceof c.Component)this.value_=a.value_,this.type_=a.type_,this.otherTypeCode_=a.otherTypeCode_;else{this.value_=a?"object"===typeof a&&"undefined"!==typeof ArrayBuffer&&a instanceof ArrayBuffer?new p(new d(new Uint8Array(a)),!1):"object"===
typeof a&&a instanceof p?a:new p(a):new p([]);if(b===bb.OTHER_CODE){if(void 0==k)throw Error("To use an other code, call Name.Component(value, ComponentType.OTHER_CODE, otherTypeCode)");if(0>k)throw Error("Name.Component other type code must be non-negative");this.otherTypeCode_=k}else this.otherTypeCode_=-1;this.type_=void 0==b?bb.GENERIC:b}};c.Component.prototype.getValue=function(){return this.value_};c.Component.prototype.getValueAsBuffer=function(){return this.value_.buf()};c.Component.prototype.getType=
function(){return this.type_};c.Component.prototype.getOtherTypeCode=function(){return this.otherTypeCode_};Object.defineProperty(c.Component.prototype,"value",{get:function(){return this.getValueAsBuffer()}});c.Component.prototype.toEscapedString=function(){return this.type_===bb.IMPLICIT_SHA256_DIGEST?"sha256digest="+this.value_.toHex():this.type_===bb.PARAMETERS_SHA256_DIGEST?"params-sha256="+this.value_.toHex():(this.type_===bb.GENERIC?"":(this.type_===bb.OTHER_CODE?this.otherTypeCode_:this.type_)+
"=")+c.toEscapedString(this.value_.buf())};c.Component.prototype.isSegment=function(){return 1<=this.value_.size()&&0==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isSegmentOffset=function(){return 1<=this.value_.size()&&251==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isVersion=function(){return 1<=this.value_.size()&&253==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isTimestamp=function(){return 1<=this.value_.size()&&252==this.value_.buf()[0]&&
this.isGeneric()};c.Component.prototype.isSequenceNumber=function(){return 1<=this.value_.size()&&254==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isGeneric=function(){return this.type_===bb.GENERIC};c.Component.prototype.isImplicitSha256Digest=function(){return this.type_===bb.IMPLICIT_SHA256_DIGEST};c.Component.prototype.isParametersSha256Digest=function(){return this.type_===bb.PARAMETERS_SHA256_DIGEST};c.Component.prototype.toNumber=function(){return M.bigEndianToUnsignedInt(this.value_.buf())};
c.Component.prototype.toNumberWithMarker=function(a){if(0==this.value_.size()||this.value_.buf()[0]!=a)throw Error("Name component does not begin with the expected marker");return M.bigEndianToUnsignedInt(this.value_.buf().slice(1))};c.Component.prototype.toSegment=function(){return this.toNumberWithMarker(0)};c.Component.prototype.toSegmentOffset=function(){return this.toNumberWithMarker(251)};c.Component.prototype.toVersion=function(){return this.toNumberWithMarker(253)};c.Component.prototype.toTimestamp=
function(){return this.toNumberWithMarker(252)};c.Component.prototype.toSequenceNumber=function(){return this.toNumberWithMarker(254)};c.Component.fromNumber=function(a,b,d){var k=new va(8);k.writeNonNegativeInteger(a);return new c.Component(new p(k.getOutput(),!1),b,d)};c.Component.fromNumberWithMarker=function(a,b){var d=new va(9);d.writeNonNegativeInteger(a);d.writeNonNegativeInteger(b);return new c.Component(new p(d.getOutput(),!1))};c.Component.fromSegment=function(a){return c.Component.fromNumberWithMarker(a,
0)};c.Component.fromSegmentOffset=function(a){return c.Component.fromNumberWithMarker(a,251)};c.Component.fromVersion=function(a){return c.Component.fromNumberWithMarker(a,253)};c.Component.fromTimestamp=function(a){return c.Component.fromNumberWithMarker(a,252)};c.Component.fromSequenceNumber=function(a){return c.Component.fromNumberWithMarker(a,254)};c.Component.fromImplicitSha256Digest=function(a){digestBlob="object"===typeof a&&a instanceof p?a:new p(a,!0);if(32!==digestBlob.size())throw new R("Name.Component.fromImplicitSha256Digest: The digest length must be 32 bytes");
a=new c.Component(digestBlob);a.type_=bb.IMPLICIT_SHA256_DIGEST;return a};c.Component.fromParametersSha256Digest=function(a){digestBlob="object"===typeof a&&a instanceof p?a:new p(a,!0);if(32!==digestBlob.size())throw new R("Name.Component.fromParametersSha256Digest: The digest length must be 32 bytes");a=new c.Component(digestBlob);a.type_=bb.PARAMETERS_SHA256_DIGEST;return a};c.Component.prototype.getSuccessor=function(){for(var a=new d(this.value_.size()+1),b=!0,k=this.value_.size()-1;0<=k;--k)b?
(a[k]=this.value_.buf()[k]+1&255,b=0===a[k]):a[k]=this.value_.buf()[k];b?a[a.length-1]=0:a=a.slice(0,this.value_.size());return new c.Component(new p(a,!1),this.type_,this.otherTypeCode_)};c.Component.prototype.equals=function(a){return"object"===typeof a&&a instanceof c.Component?this.type_===bb.OTHER_CODE?this.value_.equals(a.value_)&&a.type_===bb.OTHER_CODE&&this.otherTypeCode_==a.otherTypeCode_:this.value_.equals(a.value_)&&this.type_===a.type_:!1};c.Component.prototype.compare=function(a){var b=
this.type_===bb.OTHER_CODE?this.otherTypeCode_:this.type_,d=a.type_===bb.OTHER_CODE?a.otherTypeCode_:a.type_;return b<d?-1:b>d?1:c.Component.compareBuffers(this.value_.buf(),a.value_.buf())};c.Component.compareBuffers=function(a,b){if(a.length<b.length)return-1;if(a.length>b.length)return 1;for(var c=0;c<a.length;++c){if(a[c]<b[c])return-1;if(a[c]>b[c])return 1}return 0};c.prototype.getName=function(){return this.toUri()};c.createNameArray=function(a){a=a.trim();if(0>=a.length)return[];var b=a.indexOf(":");
if(0<=b){var k=a.indexOf("/");if(0>k||b<k)a=a.substr(b+1,a.length-b-1).trim()}if("/"==a[0])if(2<=a.length&&"/"==a[1]){b=a.indexOf("/",2);if(0>b)return[];a=a.substr(b+1,a.length-b-1).trim()}else a=a.substr(1,a.length-1).trim();b=a.split("/");for(k=0;k<b.length;++k){var m=b[k];if("sha256digest="==m.substr(0,13))m=m.substr(13).trim(),m=c.Component.fromImplicitSha256Digest(new p(new d(m,"hex")),!1);else if("params-sha256="==m.substr(0,14))m=m.substr(14).trim(),m=c.Component.fromParametersSha256Digest(new p(new d(m,
"hex")),!1);else{var n=bb.GENERIC,s=-1,q=m.indexOf("=");if(0<=q){n=m.substring(0,q);s=parseInt(n);if(NaN===s)throw Error("Can't parse decimal Name Component type: "+n+" in URI "+a);n=s==bb.GENERIC||s==bb.IMPLICIT_SHA256_DIGEST||s==bb.PARAMETERS_SHA256_DIGEST?s:bb.OTHER_CODE;m=m.substring(q+1)}m=new c.Component(c.fromEscapedString(m),n,s)}m.getValue().isNull()?(b.splice(k,1),--k):b[k]=m}return b};c.prototype.set=function(a){this.components=c.createNameArray(a);++this.changeCount};c.prototype.append=
function(a,b,d){if("object"==typeof a&&a instanceof c)for(a=a==this?this.components.slice(0,this.components.length):a.components,b=0;b<a.length;++b)this.components.push(new c.Component(a[b]));else"object"===typeof a&&a instanceof c.Component?this.components.push(a):this.components.push(new c.Component(a,b,d));++this.changeCount;return this};c.prototype.add=function(a){return this.append(a)};c.prototype.clear=function(){this.components=[];++this.changeCount};c.prototype.toUri=function(a){if(0==this.size())return a?
"ndn:/":"/";a=a?"ndn:":"";for(var b=0;b<this.size();++b)a+="/"+this.components[b].toEscapedString();return a};c.prototype.to_uri=function(){return this.toUri()};c.prototype.toString=function(){return this.toUri()};c.prototype.appendSegment=function(a){return this.append(c.Component.fromSegment(a))};c.prototype.appendSegmentOffset=function(a){return this.append(c.Component.fromSegmentOffset(a))};c.prototype.appendVersion=function(a){return this.append(c.Component.fromVersion(a))};c.prototype.appendTimestamp=
function(a){return this.append(c.Component.fromTimestamp(a))};c.prototype.appendSequenceNumber=function(a){return this.append(c.Component.fromSequenceNumber(a))};c.prototype.appendImplicitSha256Digest=function(a){return this.append(c.Component.fromImplicitSha256Digest(a))};c.prototype.appendParametersSha256Digest=function(a){return this.append(c.Component.fromParametersSha256Digest(a))};c.prototype.addSegment=function(a){return this.appendSegment(a)};c.prototype.getSubName=function(a,b){0>a&&(a=this.components.length-
-a);void 0==b&&(b=this.components.length-a);for(var d=new c,k=a+b,m=a;m<k&&m<this.components.length;++m)d.components.push(this.components[m]);return d};c.prototype.getPrefix=function(a){return 0>a?this.getSubName(0,this.components.length+a):this.getSubName(0,a)};c.prototype.cut=function(a){return new c(this.components.slice(0,this.components.length-a))};c.prototype.size=function(){return this.components.length};c.prototype.get=function(a){if(0<=a){if(a>=this.components.length)throw Error("Name.get: Index is out of bounds");
return this.components[a]}if(a<-this.components.length)throw Error("Name.get: Index is out of bounds");return this.components[this.components.length- -a]};c.prototype.getComponentCount=function(){return this.components.length};c.prototype.getComponent=function(a){return new d(this.components[a].getValue().buf())};c.prototype.indexOfFileName=function(){for(var a=this.size()-1;0<=a;--a){var b=this.components[a].getValue().buf();if(!(0>=b.length||0==b[0]||192==b[0]||193==b[0]||245<=b[0]&&255>=b[0]))return a}return-1};
c.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();return a.encodeName(this)};c.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeName(this,a.buf(),!1):b.decodeName(this,a,!0)};c.prototype.compare=function(a,b,d,k,m){a instanceof c&&(d=a,a=0,b=this.size());void 0==k&&(k=0);void 0==m&&(m=d.size());0>a&&(a=this.size()- -a);0>k&&(k=d.size()- -k);b=Math.min(b,this.size()-a);m=Math.min(m,d.size()-k);for(var n=Math.min(b,m),p=0;p<
n;++p){var s=this.components[a+p].compare(d.components[k+p]);if(0!=s)return s}return b<m?-1:b>m?1:0};c.prototype.equals=function(a){if(this.components.length!=a.components.length)return!1;for(var b=this.components.length-1;0<=b;--b)if(!this.components[b].equals(a.components[b]))return!1;return!0};c.prototype.equalsName=function(a){return this.equals(a)};c.prototype.getContentDigestValue=function(){for(var a=this.size()-1;0<=a;--a){var b=c.getComponentContentDigestValue(this.components[a]);if(null!=
b)return b}return null};c.getComponentContentDigestValue=function(a){"object"==typeof a&&a instanceof c.Component&&(a=a.getValue().buf());return a.length==c.ContentDigestPrefix.length+32+c.ContentDigestSuffix.length&&M.arraysEqual(a.slice(0,c.ContentDigestPrefix.length),c.ContentDigestPrefix)&&M.arraysEqual(a.slice(a.length-c.ContentDigestSuffix.length,a.length),c.ContentDigestSuffix)?a.slice(c.ContentDigestPrefix.length,c.ContentDigestPrefix.length+32):null};c.ContentDigestPrefix=new d([193,46,77,
46,71,193,1,170,2,133]);c.ContentDigestSuffix=new d([0]);c.toEscapedString=function(a){"object"==typeof a&&a instanceof c.Component?a=a.getValue().buf():"object"===typeof a&&a instanceof p&&(a=a.buf());for(var b="",d=!1,k=0;k<a.length;++k)if(46!=a[k]){d=!0;break}if(d)for(k=0;k<a.length;++k)d=a[k],b=48<=d&&57>=d||65<=d&&90>=d||97<=d&&122>=d||43==d||45==d||46==d||95==d?b+String.fromCharCode(d):b+("%"+(16>d?"0":"")+d.toString(16).toUpperCase());else for(b="...",k=0;k<a.length;++k)b+=".";return b};c.fromEscapedString=
function(a){a=unescape(a.trim());return null==a.match(/[^.]/)?2>=a.length?new p:new p(M.toNumbersFromString(a.substr(3,a.length-3)),!1):new p(M.toNumbersFromString(a),!1)};c.fromEscapedStringAsBuffer=function(a){return c.fromEscapedString(a).buf()};c.prototype.getSuccessor=function(){return 0==this.size()?new c("/sha256digest=0000000000000000000000000000000000000000000000000000000000000000"):this.getPrefix(-1).append(this.get(-1).getSuccessor())};c.prototype.match=function(a){var b=this.components;
a=a.components;if(b.length>a.length)return!1;for(var c=b.length-1;0<=c;--c)if(!b[c].equals(a[c]))return!1;return!0};c.prototype.isPrefixOf=function(a){return this.match(a)};c.prototype.getChangeCount=function(){return this.changeCount};var va=a.TlvEncoder,s=a.WireFormat,p=a.Blob,ma=a.ChangeCounter,c=a.Name,Ga={KEYNAME:1,KEY_LOCATOR_DIGEST:2};q.KeyLocatorType=Ga;var U=function Ge(a,b){"object"===typeof a&&a instanceof Ge?(this.type_=a.type_,this.keyName_=new ma(new c(a.getKeyName())),this.keyData_=
a.keyData_):(this.type_=b,this.keyName_=new ma(new c),this.keyData_=new p,b==Ga.KEYNAME?this.keyName_.set("object"===typeof a&&a instanceof c?new c(a):new c):b==Ga.KEY_LOCATOR_DIGEST&&(this.keyData_=new p(a)));this.changeCount_=0};q.KeyLocator=U;U.prototype.getType=function(){return this.type_};U.prototype.getKeyName=function(){return this.keyName_.get()};U.prototype.getKeyData=function(){return this.keyData_};U.prototype.getKeyDataAsBuffer=function(){return this.getKeyData().buf()};U.prototype.setType=
function(a){this.type_=a;++this.changeCount_};U.prototype.setKeyName=function(a){this.keyName_.set("object"===typeof a&&a instanceof c?new c(a):new c);++this.changeCount_};U.prototype.setKeyData=function(a){this.keyData_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};U.prototype.clear=function(){this.type_=null;this.keyName_.set(new c);this.keyData_=new p;++this.changeCount_};U.prototype.equals=function(a){if(this.type_!=a.type_)return!1;if(this.type_==Ga.KEYNAME){if(!this.getKeyName().equals(a.getKeyName()))return!1}else if(this.type_==
Ga.KEY_LOCATOR_DIGEST&&!this.getKeyData().equals(a.getKeyData()))return!1;return!0};U.canGetFromSignature=function(a){return a instanceof Da||a instanceof Sa||a instanceof jb};U.getFromSignature=function(a){if(a instanceof Da||a instanceof Sa||a instanceof jb)return a.getKeyLocator();throw Error("KeyLocator.getFromSignature: Signature type does not have a KeyLocator");};U.prototype.getChangeCount=function(){this.keyName_.checkChanged()&&++this.changeCount_;return this.changeCount_};Object.defineProperty(U.prototype,
"type",{get:function(){return this.getType()},set:function(a){this.setType(a)}});Object.defineProperty(U.prototype,"keyData",{get:function(){return this.getKeyDataAsBuffer()},set:function(a){this.setKeyData(a)}});var Da=a.Sha256WithRsaSignature,Sa=a.Sha256WithEcdsaSignature,jb=a.HmacWithSha256Signature,c=a.Name,ya={BLOB:0,LINK:1,KEY:2,NACK:3,OTHER_CODE:32767};q.ContentType=ya;var Ya=function He(a,b,c,d,k,m){if(b)throw Error("MetaInfo constructor: timestamp support has been removed.");if(d)throw Error("MetaInfo constructor: locator support has been removed.");
if("object"===typeof a&&a instanceof He)this.publisher_=a.publisher_,this.type_=a.type_,this.otherTypeCode_=a.otherTypeCode_,this.freshnessPeriod_=a.freshnessPeriod_,this.finalBlockId_=a.finalBlockId_;else{if(a)throw Error("MetaInfo constructor: publisher support has been removed.");this.type=null==c||0>c?ya.BLOB:c;this.otherTypeCode_=-1;this.freshnessSeconds=k;this.finalBlockID=m}this.changeCount_=0};q.MetaInfo=Ya;Ya.prototype.getType=function(){return this.type_};Ya.prototype.getOtherTypeCode=function(){return this.otherTypeCode_};
Ya.prototype.getFreshnessPeriod=function(){return this.freshnessPeriod_};Ya.prototype.getFinalBlockId=function(){return this.finalBlockId_};Ya.prototype.getFinalBlockID=function(){return this.getFinalBlockId()};Ya.prototype.getFinalBlockIDAsBuffer=function(){return this.finalBlockId_.getValue().buf()};Ya.prototype.setType=function(a){this.type_=null==a||0>a?ya.BLOB:a;++this.changeCount_};Ya.prototype.setOtherTypeCode=function(a){if(0>a)throw Error("MetaInfo other type code must be non-negative");
this.otherTypeCode_=a;++this.changeCount_};Ya.prototype.setFreshnessPeriod=function(a){this.freshnessPeriod_=null==a||0>a?null:a;++this.changeCount_};Ya.prototype.setFinalBlockId=function(a){this.finalBlockId_="object"===typeof a&&a instanceof c.Component?a:new c.Component(a);++this.changeCount_};Ya.prototype.setFinalBlockID=function(a){this.setFinalBlockId(a)};Ya.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(Ya.prototype,"type",{get:function(){return this.getType()},
set:function(a){this.setType(a)}});Object.defineProperty(Ya.prototype,"freshnessSeconds",{get:function(){return null==this.freshnessPeriod_||0>this.freshnessPeriod_?null:this.freshnessPeriod_/1E3},set:function(a){this.freshnessPeriod_=null==a||0>a?null:1E3*a;++this.changeCount_}});Object.defineProperty(Ya.prototype,"finalBlockID",{get:function(){return this.getFinalBlockIDAsBuffer()},set:function(a){this.setFinalBlockId(a)}});var p=a.Blob,ma=a.ChangeCounter,U=a.KeyLocator,za=a.ValidityPeriod,Sa=function Ie(a){"object"===
typeof a&&a instanceof Ie?(this.keyLocator_=new ma(new U(a.getKeyLocator())),this.validityPeriod_=new ma(new za(a.getValidityPeriod())),this.signature_=a.signature_):(this.keyLocator_=new ma(new U),this.validityPeriod_=new ma(new za),this.signature_=new p);this.changeCount_=0};q.Sha256WithEcdsaSignature=Sa;Sa.prototype.clone=function(){return new Sa(this)};Sa.prototype.getKeyLocator=function(){return this.keyLocator_.get()};Sa.prototype.getValidityPeriod=function(){return this.validityPeriod_.get()};
Sa.prototype.getSignature=function(){return this.signature_};Sa.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof U?new U(a):new U);++this.changeCount_};Sa.prototype.setValidityPeriod=function(a){this.validityPeriod_.set("object"===typeof a&&a instanceof za?new za(a):new za);++this.changeCount_};Sa.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};Sa.prototype.getChangeCount=function(){var a=
this.keyLocator_.checkChanged();(a=this.validityPeriod_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};p=a.Blob;ma=a.ChangeCounter;U=a.KeyLocator;za=a.ValidityPeriod;Da=function Je(a){"object"===typeof a&&a instanceof Je?(this.keyLocator_=new ma(new U(a.getKeyLocator())),this.validityPeriod_=new ma(new za(a.getValidityPeriod())),this.signature_=a.signature_):(this.keyLocator_=new ma(new U),this.validityPeriod_=new ma(new za),this.signature_=new p);this.changeCount_=0};q.Sha256WithRsaSignature=
Da;Da.prototype.clone=function(){return new Da(this)};Da.prototype.getKeyLocator=function(){return this.keyLocator_.get()};Da.prototype.getValidityPeriod=function(){return this.validityPeriod_.get()};Da.prototype.getSignature=function(){return this.signature_};Da.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};Da.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof U?new U(a):new U);++this.changeCount_};Da.prototype.setValidityPeriod=function(a){this.validityPeriod_.set("object"===
typeof a&&a instanceof za?new za(a):new za);++this.changeCount_};Da.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};Da.prototype.getChangeCount=function(){var a=this.keyLocator_.checkChanged();(a=this.validityPeriod_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};Object.defineProperty(Da.prototype,"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(Da.prototype,
"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});var p=a.Blob,Tb=function Ke(a){"object"===typeof a&&a instanceof Ke?(this.signature_=a.signature_,this.signatureInfoEncoding_=a.signatureInfoEncoding_,this.typeCode_=a.typeCode_):(this.signature_=new p,this.signatureInfoEncoding_=new p,this.typeCode_=null);this.changeCount_=0};q.GenericSignature=Tb;Tb.prototype.clone=function(){return new Tb(this)};Tb.prototype.getSignature=function(){return this.signature_};
Tb.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};Tb.prototype.getSignatureInfoEncoding=function(){return this.signatureInfoEncoding_};Tb.prototype.getTypeCode=function(){return this.typeCode_};Tb.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};Tb.prototype.setSignatureInfoEncoding=function(a,b){this.signatureInfoEncoding_="object"===typeof a&&a instanceof p?a:new p(a);this.typeCode_=b;++this.changeCount_};
Tb.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(Tb.prototype,"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});p=a.Blob;ma=a.ChangeCounter;U=a.KeyLocator;jb=function Oe(a){"object"===typeof a&&a instanceof Oe?(this.keyLocator_=new ma(new U(a.getKeyLocator())),this.signature_=a.signature_):(this.keyLocator_=new ma(new U),this.signature_=new p);this.changeCount_=0};q.HmacWithSha256Signature=jb;jb.prototype.clone=
function(){return new jb(this)};jb.prototype.getKeyLocator=function(){return this.keyLocator_.get()};jb.prototype.getSignature=function(){return this.signature_};jb.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};jb.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof U?new U(a):new U);++this.changeCount_};jb.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};jb.prototype.getChangeCount=
function(){this.keyLocator_.checkChanged()&&++this.changeCount_;return this.changeCount_};Object.defineProperty(jb.prototype,"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(jb.prototype,"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});var p=a.Blob,qb=function Le(a){this.signature_="object"===typeof a&&a instanceof Le?a.signature_:new p;this.changeCount_=0};q.DigestSha256Signature=
qb;qb.prototype.clone=function(){return new qb(this)};qb.prototype.getSignature=function(){return this.signature_};qb.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};qb.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(qb.prototype,"signature",{get:function(){return this.getSignature()},set:function(a){this.setSignature(a)}});var p=a.Blob,Wa=a.SignedBlob,ma=a.ChangeCounter,c=a.Name,Da=a.Sha256WithRsaSignature,
Ya=a.MetaInfo,wc=a.IncomingFaceId,$c=a.CongestionMark,s=a.WireFormat,ba=a,Q=function Me(a,b,d){a instanceof Me?(this.name_=new ma(new c(a.getName())),this.metaInfo_=new ma(new Ya(a.getMetaInfo())),this.signature_=new ma(a.getSignature().clone()),this.content_=a.content_,this.defaultWireEncoding_=a.getDefaultWireEncoding(),this.defaultFullName_=new c(a.defaultFullName_),this.defaultWireEncodingFormat_=a.defaultWireEncodingFormat_):(this.name_="string"===typeof a?new ma(new c(a)):new ma("object"===
typeof a&&a instanceof c?new c(a):new c),"object"===typeof b&&b instanceof Ya?(a=b,b=d):a=null,this.metaInfo_=new ma("object"===typeof a&&a instanceof Ya?new Ya(a):new Ya),this.content_="object"===typeof b&&b instanceof p?b:new p(b,!0),this.signature_=new ma(new Da),this.defaultWireEncoding_=new Wa,this.defaultFullName_=new c,this.defaultWireEncodingFormat_=null);this.changeCount_=this.getDefaultWireEncodingChangeCount_=0;this.lpPacket_=null};q.Data=Q;Q.prototype.getName=function(){return this.name_.get()};
Q.prototype.getMetaInfo=function(){return this.metaInfo_.get()};Q.prototype.getSignature=function(){return this.signature_.get()};Q.prototype.getContent=function(){return this.content_};Q.prototype.getContentAsBuffer=function(){return this.content_.buf()};Q.prototype.getDefaultWireEncoding=function(){this.getDefaultWireEncodingChangeCount_!=this.getChangeCount()&&(this.defaultWireEncoding_=new Wa,this.defaultWireEncodingFormat_=null,this.getDefaultWireEncodingChangeCount_=this.getChangeCount());return this.defaultWireEncoding_};
Q.prototype.getDefaultWireEncodingFormat=function(){return this.defaultWireEncodingFormat_};Q.prototype.getIncomingFaceId=function(){var a=null===this.lpPacket_?null:wc.getFirstHeader(this.lpPacket_);return null===a?null:a.getFaceId()};Q.prototype.getCongestionMark=function(){var a=null===this.lpPacket_?null:$c.getFirstHeader(this.lpPacket_);return null===a?0:a.getCongestionMark()};Q.prototype.getFullName=function(a){a=a||s.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&0<this.defaultFullName_.size()&&
this.getDefaultWireEncodingFormat()==a)return this.defaultFullName_;var b=new c(this.getName()),d=ba.createHash("sha256");d.update(this.wireEncode(a).buf());b.appendImplicitSha256Digest(new p(d.digest(),!1));a==s.getDefaultWireFormat()&&(this.defaultFullName_=b);return b};Q.prototype.setName=function(a){this.name_.set("object"===typeof a&&a instanceof c?new c(a):new c);++this.changeCount_;return this};Q.prototype.setMetaInfo=function(a){this.metaInfo_.set("object"===typeof a&&a instanceof Ya?new Ya(a):
new Ya);++this.changeCount_;return this};Q.prototype.setSignature=function(a){this.signature_.set(null==a?new Da:a.clone());++this.changeCount_;return this};Q.prototype.setContent=function(a){this.content_="object"===typeof a&&a instanceof p?a:new p(a,!0);++this.changeCount_;return this};Q.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&this.getDefaultWireEncodingFormat()==a)return this.getDefaultWireEncoding();var b=a.encodeData(this),b=
new Wa(b.encoding,b.signedPortionBeginOffset,b.signedPortionEndOffset);a==s.getDefaultWireFormat()&&this.setDefaultWireEncoding(b,s.getDefaultWireFormat());return b};Q.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();var c;c="object"===typeof a&&a instanceof p?b.decodeData(this,a.buf(),!1):b.decodeData(this,a,!0);b==s.getDefaultWireFormat()?this.setDefaultWireEncoding(new Wa(new p(a,!0),c.signedPortionBeginOffset,c.signedPortionEndOffset),s.getDefaultWireFormat()):this.setDefaultWireEncoding(new Wa,
null)};Q.prototype.setLpPacket=function(a){this.lpPacket_=a;return this};Q.prototype.getChangeCount=function(){var a=this.name_.checkChanged(),a=this.metaInfo_.checkChanged()||a;(a=this.signature_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};Q.prototype.setDefaultWireEncoding=function(a,b){this.defaultWireEncoding_=a;this.defaultWireEncodingFormat_=b;this.getDefaultWireEncodingChangeCount_=this.getChangeCount()};Object.defineProperty(Q.prototype,"name",{get:function(){return this.getName()},
set:function(a){this.setName(a)}});Object.defineProperty(Q.prototype,"metaInfo",{get:function(){return this.getMetaInfo()},set:function(a){this.setMetaInfo(a)}});Object.defineProperty(Q.prototype,"signature",{get:function(){return this.getSignature()},set:function(a){this.setSignature(a)}});Object.defineProperty(Q.prototype,"content",{get:function(){return this.getContentAsBuffer()},set:function(a){this.setContent(a)}});x.prototype=Error();x.prototype.name="SecurityException";q.SecurityException=
x;Fc.prototype=new x;Fc.prototype.name="UnrecognizedKeyFormatException";q.UnrecognizedKeyFormatException=Fc;D.prototype=new x;D.prototype.name="UnrecognizedDigestAlgorithmException";q.UnrecognizedDigestAlgorithmException=D;Xb.prototype=Error();Xb.prototype.name="InvalidArgumentException";q.InvalidArgumentException=Xb;var fa=function(){};q.KeyType=fa;fa.RSA=0;fa.EC=1;fa.ECDSA=1;fa.AES=128;var ad=function(){};q.KeyClass=ad;ad.PUBLIC=1;ad.PRIVATE=2;ad.SYMMETRIC=3;var Aa=function(){};q.DigestAlgorithm=
Aa;Aa.SHA256=1;var ba=a,F=a.Interest,s=a.WireFormat,va=a.TlvEncoder,p=a.Blob,bd=function(){this.lastUsedTimestamp_=Math.round((new Date).getTime());this.nowOffsetMilliseconds_=0};q.CommandInterestPreparer=bd;bd.prototype.prepareCommandInterestName=function(a,b){void 0==b&&s.getDefaultWireFormat();for(var c=(new Date).getTime()+this.nowOffsetMilliseconds_,c=Math.round(c);c<=this.lastUsedTimestamp_;)c+=1;this.lastUsedTimestamp_=c;var d=new va(8);d.writeNonNegativeInteger(c);a.getName().append(new p(d.getOutput(),
!1));a.getName().append(new p(ba.randomBytes(8),!1))};bd.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};var F=a.Interest,s=a.WireFormat,X=a.SigningInfo,bd=a.CommandInterestPreparer,hc=function(a){bd.call(this);this.keyChain_=a};hc.prototype=new bd;hc.prototype.name="CommandInterestSigner";q.CommandInterestSigner=hc;hc.POS_SIGNATURE_VALUE=-1;hc.POS_SIGNATURE_INFO=-2;hc.POS_NONCE=-3;hc.POS_TIMESTAMP=-4;hc.MINIMUM_SIZE=4;hc.prototype.makeCommandInterest=function(a,b,c,
d,k){var m=b,n=c,p=d;b=m instanceof X?m:void 0;c=m instanceof s?m:n instanceof s?n:void 0;"function"===typeof m?(d=m,k=n):"function"===typeof n?(d=n,k=p):"function"===typeof p?d=p:k=d=void 0;void 0==b&&(b=new X);void 0==c&&(c=s.getDefaultWireFormat());a=new F(a);this.prepareCommandInterestName(a,c);return this.keyChain_.sign(a,b,c,d,k)};var rb=function(){};q.KeyIdType=rb;rb.USER_SPECIFIED=0;rb.SHA256=1;rb.RANDOM=2;var c=a.Name,rb=a.KeyIdType,fa=a.KeyType,Bb=function(a,b){this.keyType_=a;if(b instanceof
c.Component){if(0==b.getValue().size())throw Error("KeyParams: keyId is empty");this.keyIdType_=rb.USER_SPECIFIED;this.keyId_=b}else{if(b==rb.USER_SPECIFIED)throw Error("KeyParams: KeyIdType is USER_SPECIFIED");this.keyIdType_=b;this.keyId_=new c.Component}};q.KeyParams=Bb;Bb.prototype.getKeyType=function(){return this.keyType_};Bb.prototype.getKeyIdType=function(){return this.keyIdType_};Bb.prototype.getKeyId=function(){return this.keyId_};Bb.prototype.setKeyId=function(a){this.keyId_=a};var Ub=
function Td(a,b){if(a instanceof c.Component)Bb.call(this,Td.getType(),a),this.size_=void 0==b?Td.getDefaultSize():b;else if(void 0!=a){var d=void 0!=b?b:rb.RANDOM;Bb.call(this,Td.getType(),d);this.size_=a}else Bb.call(this,Td.getType(),rb.RANDOM),this.size_=Td.getDefaultSize()};Ub.prototype=new Bb;Ub.prototype.name="RsaKeyParams";q.RsaKeyParams=Ub;Ub.prototype.getKeySize=function(){return this.size_};Ub.getDefaultSize=function(){return 2048};Ub.getType=function(){return fa.RSA};var Kc=function Ud(a,
b){if(a instanceof c.Component)Bb.call(this,Ud.getType(),a),this.size_=void 0==b?Ud.getDefaultSize():b;else if(void 0!=a){var d=void 0!=b?b:rb.RANDOM;Bb.call(this,Ud.getType(),d);this.size_=a}else Bb.call(this,Ud.getType(),rb.RANDOM),this.size_=Ud.getDefaultSize()};Kc.prototype=new Bb;Kc.prototype.name="EcKeyParams";q.EcKeyParams=Kc;Kc.prototype.getKeySize=function(){return this.size_};Kc.getDefaultSize=function(){return 256};Kc.getType=function(){return fa.EC};var Wd=function(a,b){Kc.call(this,a,
b)};Wd.prototype=new Kc;Wd.prototype.name="EcdsaKeyParams";q.EcdsaKeyParams=Wd;Wd.getDefaultSize=function(){return Kc.getDefaultSize()};Wd.getType=function(){return Kc.getType()};var nd=function Vd(a,b){if(a instanceof c.Component)Bb.call(this,Vd.getType(),a),this.size_=void 0==b?Vd.getDefaultSize():b;else if(void 0!=a){var d=void 0!=b?b:rb.RANDOM;Bb.call(this,Vd.getType(),d);this.size_=a}else Bb.call(this,Vd.getType(),rb.RANDOM),this.size_=Vd.getDefaultSize()};nd.prototype=new Bb;nd.prototype.name=
"AesKeyParams";q.AesKeyParams=nd;nd.prototype.getKeySize=function(){return this.size_};nd.getDefaultSize=function(){return 64};nd.getType=function(){return fa.AES};var c=a.Name,Q=a.Data,ya=a.ContentType,Da=a.Sha256WithRsaSignature,Sa=a.Sha256WithEcdsaSignature,U=a.KeyLocator,Ga=a.KeyLocatorType,s=a.WireFormat,Aa=a.DigestAlgorithm,fa=a.KeyType,za=a.ValidityPeriod,L=a.CertificateV2,b=a.SyncPromise,Za=a.Tpm,Vb=a.TpmBackEndMemory,Ba=a.PublicKey,le=function Ne(a,b,d,k,y,w){a instanceof c?(void 0==y&&(y=
Aa.SHA256),void 0==w&&(w=s.getDefaultWireFormat()),this.certificate_=Ne.makeSelfSignedCertificate_(a,b,d,k,y,w)):this.certificate_=new Q(a);this.privateKeyBag_=b};q.SafeBag=le;le.prototype.getCertificate=function(){return this.certificate_};le.prototype.getPrivateKeyBag=function(){return this.privateKeyBag_};le.makeSelfSignedCertificate_=function(a,d,k,m,n,y){var w=new L,r=(new Date).getTime(),pa=new c(a);pa.append("self").appendVersion(r);w.setName(pa);w.getMetaInfo().setType(ya.KEY);w.getMetaInfo().setFreshnessPeriod(36E5);
pa=new Ba(k);w.setContent(pa.getKeyDer());k=new Za("","",new Vb);b.complete(null,k.importPrivateKeyPromise_(a,d.buf(),m,!0));if(pa.getKeyType()==fa.RSA)w.setSignature(new Da);else if(pa.getKeyType()==fa.EC)w.setSignature(new Sa);else throw Error("Unsupported key type");d=w.getSignature();U.getFromSignature(d).setType(Ga.KEYNAME);U.getFromSignature(d).setKeyName(a);za.getFromSignature(d).setPeriod(r,r+63072E7);r=w.wireEncode(y);a=b.complete(null,k.signPromise(r.signedBuf(),a,n,!0));d.setSignature(a);
w.wireEncode(y);return w};var c=a.Name,Jb=a.PibIdentity,na=a.PibKey,Aa=a.DigestAlgorithm,za=a.ValidityPeriod,X=function ue(a,b){this.validityPeriod_=new za;if(void 0==a)this.reset(ue.SignerType.NULL),this.digestAlgorithm_=Aa.SHA256;else if("number"===typeof a)this.reset(a),void 0!=b&&(this.name_=new c(b)),this.digestAlgorithm_=Aa.SHA256;else if(a instanceof Jb)this.digestAlgorithm_=Aa.SHA256,this.setPibIdentity(a);else if(a instanceof na)this.digestAlgorithm_=Aa.SHA256,this.setPibKey(a);else if("string"===
typeof a){if(signingString=a,this.reset(ue.SignerType.NULL),this.digestAlgorithm_=Aa.SHA256,""!=signingString){var d=signingString.indexOf(":");if(0>d)throw Error("Invalid signing string cannot represent SigningInfo");var y=signingString.substring(0,d),d=signingString.substring(d+1);if("id"==y)d==ue.getDigestSha256Identity().toUri()?this.setSha256Signing():this.setSigningIdentity(new c(d));else if("key"==y)this.setSigningKeyName(new c(d));else if("cert"==y)this.setSigningCertificateName(new c(d));
else throw Error("Invalid signing string scheme");}}else throw Error("SigningInfo: Unrecognized type");};q.SigningInfo=X;X.SignerType=function(){};X.SignerType.NULL=0;X.SignerType.ID=1;X.SignerType.KEY=2;X.SignerType.CERT=3;X.SignerType.SHA256=4;X.prototype.setSigningIdentity=function(a){this.reset(X.SignerType.ID);this.name_=new c(a);return this};X.prototype.setSigningKeyName=function(a){this.reset(X.SignerType.KEY);this.name_=new c(a);return this};X.prototype.setSigningCertificateName=function(a){this.reset(X.SignerType.CERT);
this.name_=new c(a);return this};X.prototype.setSha256Signing=function(){this.reset(X.SignerType.SHA256);this.digestAlgorithm_=Aa.SHA256;return this};X.prototype.setPibIdentity=function(a){this.reset(X.SignerType.ID);null!=a&&(this.name_=a.getName());this.identity_=a;return this};X.prototype.setPibKey=function(a){this.reset(X.SignerType.KEY);null!=a&&(this.name_=a.getName());this.key_=a;return this};X.prototype.getSignerType=function(){return this.type_};X.prototype.getSignerName=function(){return this.name_};
X.prototype.getPibIdentity=function(){if(this.type_!=X.SignerType.ID)throw Error("getPibIdentity: The signer type is not SignerType.ID");return this.identity_};X.prototype.getPibKey=function(){if(this.type_!=X.SignerType.KEY)throw Error("getPibKey: The signer type is not SignerType.KEY");return this.key_};X.prototype.setDigestAlgorithm=function(a){this.digestAlgorithm_=a;return this};X.prototype.getDigestAlgorithm=function(){return this.digestAlgorithm_};X.prototype.setValidityPeriod=function(a){this.validityPeriod_=
new za(a);return this};X.prototype.getValidityPeriod=function(){return this.validityPeriod_};X.prototype.toString=function(){if(this.type_==X.SignerType.NULL)return"";if(this.type_==X.SignerType.ID)return"id:"+this.getSignerName().toUri();if(this.type_==X.SignerType.KEY)return"key:"+this.getSignerName().toUri();if(this.type_==X.SignerType.CERT)return"cert:"+this.getSignerName().toUri();if(this.type_==X.SignerType.SHA256)return"id:"+X.getDigestSha256Identity().toUri();throw Error("Unknown signer type");
};X.getDigestSha256Identity=function(){return new c("/localhost/identity/digest-sha256")};X.prototype.reset=function(a){if(a!=X.SignerType.NULL&&a!=X.SignerType.ID&&a!=X.SignerType.KEY&&a!=X.SignerType.CERT&&a!=X.SignerType.SHA256)throw Error("SigningInfo: The signerType is not valid");this.type_=a;this.name_=new c;this.key_=this.identity_=null;this.validityPeriod_=new za};za=function Pe(a,b){this.changeCount_=0;"object"===typeof a&&a instanceof Pe?(validityPeriod=a,this.notBefore_=validityPeriod.notBefore_,
this.notAfter_=validityPeriod.notAfter_):void 0!=b?(notBefore=a,this.setPeriod(notBefore,b)):this.clear()};q.ValidityPeriod=za;za.prototype.hasPeriod=function(){return!(this.notBefore_===Number.MAX_VALUE&&this.notAfter_===-Number.MAX_VALUE)};za.prototype.getNotBefore=function(){return this.notBefore_};za.prototype.getNotAfter=function(){return this.notAfter_};za.prototype.clear=function(){this.notBefore_=Number.MAX_VALUE;this.notAfter_=-Number.MAX_VALUE;++this.changeCount_};za.prototype.setPeriod=
function(a,b){this.notBefore_=Math.round(1E3*Math.ceil(Math.round(a)/1E3));this.notAfter_=Math.round(1E3*Math.floor(Math.round(b)/1E3));++this.changeCount_;return this};za.prototype.isValid=function(a){void 0==a&&(a=Math.round(1E3*Math.ceil(Math.round((new Date).getTime())/1E3)));return this.notBefore_<=a&&a<=this.notAfter_};za.canGetFromSignature=function(a){return void 0!=a.constructor&&("Sha256WithRsaSignature"===a.constructor.name||"Sha256WithEcdsaSignature"===a.constructor.name)};za.getFromSignature=
function(a){if(void 0==a.constructor||"Sha256WithRsaSignature"!==a.constructor.name&&"Sha256WithEcdsaSignature"!==a.constructor.name)throw Error("ValidityPeriod.getFromSignature: Signature type does not have a ValidityPeriod");return a.getValidityPeriod()};za.prototype.getChangeCount=function(){return this.changeCount_};var ba=a,b=a.SyncPromise,p=a.Blob,s=a.WireFormat,fa=a.KeyType,Aa=a.DigestAlgorithm,Gb=a.UseSubtleCrypto,L=a.CertificateV2,Ba=a.PublicKey,Na=function(){};q.VerificationHelpers=Na;Na.verifySignaturePromise=
function(a,c,d,y,w){"boolean"===typeof y&&(w=y,y=void 0);a instanceof p&&(a=a.buf());c instanceof p&&(c=c.buf());if(!(d instanceof Ba))try{d instanceof p||(d=new p(d)),d=new Ba(d)}catch(r){return b.reject(Error("verifySignaturePromise: Error decoding public key DER: "+r))}void 0==y&&(y=Aa.SHA256);if(y==Aa.SHA256)if(d.getKeyType()==fa.RSA){if(Gb()&&!w){var pa={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};return crypto.subtle.importKey("spki",d.getKeyDer().buf().buffer,pa,!0,["verify"]).then(function(y){return crypto.subtle.verify(pa,
y,c,a)})}try{null===Na.verifyUsesString_&&Na.setVerifyUsesString_();for(var v=d.getKeyDer().buf().toString("base64"),B="-----BEGIN PUBLIC KEY-----\n",k=0;k<v.length;k+=64)B+=v.substr(k,64)+"\n";var B=B+"-----END PUBLIC KEY-----",Zb=ba.createVerify("RSA-SHA256");Zb.update(a);var m=Na.verifyUsesString_?c.toString("binary"):c;return b.resolve(Zb.verify(B,m))}catch(n){return b.reject(Error("verifySignaturePromise: Error is RSA verify: "+n))}}else if(d.getKeyType()==fa.EC)try{null===Na.verifyUsesString_&&
Na.setVerifyUsesString_();v=d.getKeyDer().buf().toString("base64");B="-----BEGIN PUBLIC KEY-----\n";for(k=0;k<v.length;k+=64)B+=v.substr(k,64)+"\n";B+="-----END PUBLIC KEY-----";Zb=ba.createVerify("sha256");Zb.update(a);m=Na.verifyUsesString_?c.toString("binary"):c;return b.resolve(Zb.verify(B,m))}catch(s){return b.reject(Error("verifySignaturePromise: Error is ECDSA verify: "+s))}else return b.reject(Error("verifySignaturePromise: Invalid key type"));else return b.reject(Error("verifySignaturePromise: Invalid digest algorithm"))};
Na.verifySignature=function(a,c,d,y,w,r){"function"===typeof y&&(r=w,w=y,y=void 0);return b.complete(w,r,this.verifySignaturePromise(a,c,d,y,!w))};Na.verifyDataSignaturePromise=function(a,c,d,y,w){var r=d,pa=y;d="number"===typeof r?r:void 0;y=r instanceof s?r:pa instanceof s?pa:void 0;w="boolean"===typeof r?r:"boolean"===typeof pa?pa:"boolean"===typeof w?w:!1;var v;if(c instanceof L)try{v=c.getPublicKey()}catch(B){return b.resolve(!1)}else v=c;c=a.wireEncode(y);return Na.verifySignaturePromise(c.signedBuf(),
a.getSignature().getSignature(),v,d,w)};Na.verifyInterestSignaturePromise=function(a,c,d,y,w){var r=d,pa=y;d="number"===typeof r?r:void 0;y=r instanceof s?r:pa instanceof s?pa:void 0;w="boolean"===typeof r?r:"boolean"===typeof pa?pa:"boolean"===typeof w?w:!1;var v;if(c instanceof L)try{v=c.getPublicKey()}catch(B){return b.resolve(!1)}else v=c;void 0==y&&(y=s.getDefaultWireFormat());c=Na.extractSignature_(a,y);if(null==c)return b.resolve(!1);a=a.wireEncode(y);return Na.verifySignaturePromise(a.signedBuf(),
c.getSignature(),v,d,w)};Na.verifyDigest=function(a,b,c){a instanceof p&&(a=a.buf());b instanceof p&&(b=b.buf());if(c==Aa.SHA256){c=ba.createHash("sha256");c.update(a);a=c.digest();if(b.length!=a.length)return!1;for(c=0;c<b.length;++c)if(b[c]!=a[c])return!1;return!0}throw Error("verifyDigest: Invalid digest algorithm");};Na.extractSignature_=function(a,b){if(2>a.getName().size())return null;try{return b.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf(),
!1)}catch(c){return null}};Na.verifyUsesString_=null;Na.setVerifyUsesString_=function(){var a=ba.createHash("sha256").digest();Na.verifyUsesString_="string"===typeof a};var od=a,ba=a,p=a.Blob,m=a.DerNode,x=a.SecurityException,Fc=a.UnrecognizedKeyFormatException,fa=a.KeyType,ia=a.EncryptAlgorithmType,b=a.SyncPromise,Gb=a.UseSubtleCrypto,Aa=a.DigestAlgorithm,Ba=function ze(a){if(a){this.keyDer=a;var y=null;try{var b=m.parse(a.buf(),0).getChildren(),y=m.getSequence(b,0).getChildren()[0].toVal()}catch(r){throw new Fc(Error("PublicKey.decodeKeyType: Error decoding the public key: "+
r.message));}y==ze.RSA_ENCRYPTION_OID?this.keyType=fa.RSA:y==ze.EC_ENCRYPTION_OID&&(this.keyType=fa.EC)}else this.keyDer=new p,this.keyType=null};q.PublicKey=Ba;Ba.prototype.toDer=function(){return m.parse(this.keyDer.buf())};Ba.prototype.getKeyType=function(){return this.keyType};Ba.prototype.getDigest=function(a){void 0==a&&(a=Aa.SHA256);if(a==Aa.SHA256)return a=ba.createHash("sha256"),a.update(this.keyDer.buf()),new p(a.digest(),!1);throw new x(Error("Wrong format!"));};Ba.prototype.getKeyDer=
function(){return this.keyDer};Ba.prototype.encryptPromise=function(a,c,y){"object"===typeof a&&a instanceof p&&(a=a.buf());if(Gb()&&!y&&c!=ia.RsaPkcs)return c==ia.RsaOaep?this.keyType!=fa.RSA?Promise.reject(Error("The key type must be RSA")):crypto.subtle.importKey("spki",this.keyDer.buf(),{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["encrypt"]).then(function(y){return crypto.subtle.encrypt({name:"RSA-OAEP"},y,a)}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported padding scheme"));
var w=this.keyDer.buf().toString("base64");y="-----BEGIN PUBLIC KEY-----\n";for(var r=0;r<w.length;r+=64)y+=w.substr(r,64)+"\n";y+="-----END PUBLIC KEY-----";if(c==ia.RsaPkcs){if(this.keyType!=fa.RSA)return b.reject(Error("The key type must be RSA"));c=od.RSA_PKCS1_PADDING}else if(c==ia.RsaOaep){if(this.keyType!=fa.RSA)return b.reject(Error("The key type must be RSA"));c=od.RSA_PKCS1_OAEP_PADDING}else return b.reject(Error("unsupported padding scheme"));try{return b.resolve(new p(ba.publicEncrypt({key:y,
padding:c},a),!1))}catch(pa){return b.reject(pa)}};Ba.prototype.encrypt=function(a,c){return b.getValue(this.encryptPromise(a,c,!0))};Ba.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";Ba.EC_ENCRYPTION_OID="1.2.840.10045.2.1";var m=a.DerNode,eb=a.OID,pd=function(a,b,y){this.extensionId="string"===typeof a?new eb(a):a;this.isCritical=b;this.extensionValue=y};q.CertificateExtension=pd;pd.prototype.toDer=function(){var a=new m.DerSequence,b=new m.DerOid(this.extensionId),y=new m.DerBoolean(this.isCritical),
w=new m.DerOctetString(this.extensionValue.buf());a.addChild(b);a.addChild(y);a.addChild(w);a.getSize();return a};pd.prototype.toDerBlob=function(){return this.toDer().encode()};pd.prototype.getOid=function(){return this.extensionId};pd.prototype.getIsCritical=function(){return this.isCritical};pd.prototype.getValue=function(){return this.extensionValue};var p=a.Blob,eb=a.OID,m=a.DerNode,cd=function(a,b){this.oid="string"===typeof a?new eb(a):a;this.value=b};q.CertificateSubjectDescription=cd;cd.prototype.toDer=
function(){var a=new m.DerSequence,b=new m.DerOid(this.oid),y=new m.DerPrintableString((new p(this.value)).buf());a.addChild(b);a.addChild(y);return a};cd.prototype.getOidString=function(){return this.oid.toString()};cd.prototype.getValue=function(){return this.value};var Q=a.Data,ya=a.ContentType,s=a.WireFormat,m=a.DerNode,fa=a.KeyType,Ba=a.PublicKey,cd=a.CertificateSubjectDescription,pd=a.CertificateExtension,wa=function(a){void 0!=a?Q.call(this,a):Q.call(this);this.subjectDescriptionList=[];this.extensionList=
[];this.notBefore=Number.MAX_VALUE;this.notAfter=-Number.MAX_VALUE;this.key=new Ba;void 0!=a&&this.decode()};wa.prototype=new Q;wa.prototype.name="Certificate";q.Certificate=wa;wa.prototype.encode=function(){var a=this.toDer();this.setContent(a.encode());this.getMetaInfo().setType(ya.KEY)};wa.prototype.addSubjectDescription=function(a){this.subjectDescriptionList.push(a)};wa.prototype.getSubjectDescriptionList=function(){return this.subjectDescriptionList};wa.prototype.addExtension=function(a){this.extensionList.push(a)};
wa.prototype.getExtensionList=function(){return this.extensionList};wa.prototype.setNotBefore=function(a){this.notBefore=a};wa.prototype.getNotBefore=function(){return this.notBefore};wa.prototype.setNotAfter=function(a){this.notAfter=a};wa.prototype.getNotAfter=function(){return this.notAfter};wa.prototype.setPublicKeyInfo=function(a){this.key=a};wa.prototype.getPublicKeyInfo=function(){return this.key};wa.prototype.getPublicKeyDer=function(){if(this.key.getKeyDer().isNull())throw Error("The public key is not set");
return this.key.getKeyDer()};wa.prototype.isTooEarly=function(){return(new Date).getTime()<this.getNotBefore()};wa.prototype.isTooLate=function(){return(new Date).getTime()>this.getNotAfter()};wa.prototype.isInValidityPeriod=function(a){return this.getSignature().getValidityPeriod().isValid(a)};wa.prototype.toDer=function(){var a=new m.DerSequence,b=new m.DerSequence,y=new m.DerGeneralizedTime(this.getNotBefore()),w=new m.DerGeneralizedTime(this.getNotAfter());b.addChild(y);b.addChild(w);a.addChild(b);
y=new m.DerSequence;for(b=0;b<this.subjectDescriptionList.length;++b)y.addChild(this.subjectDescriptionList[b].toDer());a.addChild(y);a.addChild(this.key.toDer());if(0<this.extensionList.length){y=new m.DerSequence;for(b=0;b<this.extensionList.length;++b)y.addChild(this.extensionList[b].toDer());a.addChild(y)}return a};wa.prototype.decode=function(){var a=m.parse(this.getContent().buf()).getChildren(),b=m.getSequence(a,0).getChildren();this.notBefore=b[0].toVal();this.notAfter=b[1].toVal();for(var y=
m.getSequence(a,1).getChildren(),b=0;b<y.length;++b){var w=m.getSequence(y,b).getChildren(),r=w[0].toVal(),w=w[1].toVal().buf().toString("binary");this.addSubjectDescription(new cd(r,w))}b=a[2].encode();this.key=new Ba(b);if(3<a.length)for(a=m.getSequence(a,3).getChildren(),b=0;b<a.length;++b)w=m.getSequence(a,b).getChildren(),r=w[0].toVal(),y=w[1].toVal(),w=w[2].toVal(),this.addExtension(new pd(r,y,w))};wa.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();Q.prototype.wireDecode.call(this,
a,b);this.decode()};wa.prototype.toString=function(){var a;a="Certificate name:\n"+("  "+this.getName().toUri()+"\n");a+="Validity:\n";var b=wa.toIsoString(Math.round(this.getNotBefore())),y=wa.toIsoString(Math.round(this.getNotAfter()));a=a+("  NotBefore: "+b+"\n")+("  NotAfter: "+y+"\n");for(b=0;b<this.subjectDescriptionList.length;++b)y=this.subjectDescriptionList[b],a+="Subject Description:\n",a+="  "+y.getOidString()+": "+y.getValue()+"\n";a+="Public key bits:\n";y=this.getPublicKeyDer().buf().toString("base64");
for(b=0;b<y.length;b+=64)a+=y.substring(b,Math.min(b+64,y.length))+"\n";if(0<this.extensionList.length)for(a+="Extensions:\n",b=0;b<this.extensionList.length;++b)y=this.extensionList[b],a+="  OID: "+y.getOid()+"\n",a+="  Is critical: "+(y.getIsCritical()?"Y":"N")+"\n",a+="  Value: "+y.getValue().toHex()+"\n";return a};wa.toIsoString=function(a){a=new Date(Math.round(a));return a.getUTCFullYear()+wa.to2DigitString(a.getUTCMonth()+1)+wa.to2DigitString(a.getUTCDate())+"T"+wa.to2DigitString(a.getUTCHours())+
wa.to2DigitString(a.getUTCMinutes())+wa.to2DigitString(a.getUTCSeconds())};wa.to2DigitString=function(a){a=a.toString();return 1===a.length?"0"+a:a};var Q=a.Data,c=a.Name,x=a.SecurityException,wa=a.Certificate,s=a.WireFormat,Ia=function Ae(a){void 0!=a?wa.call(this,a):wa.call(this);this.publicKeyName=new c;if(a instanceof Ae)this.publicKeyName=new c(a.publicKeyName);else if(a instanceof Q){if(!Ae.isCorrectName(a.getName()))throw new x(Error("Wrong Identity Certificate Name!"));this.setPublicKeyName()}};
Ia.prototype=new wa;Ia.prototype.name="IdentityCertificate";q.IdentityCertificate=Ia;Ia.prototype.setName=function(a){if(!Ia.isCorrectName(a))throw new x(Error("Wrong Identity Certificate Name!"));wa.prototype.setName.call(this,a);this.setPublicKeyName();return this};Ia.prototype.wireDecode=function(a,y){y=y||s.getDefaultWireFormat();wa.prototype.wireDecode.call(this,a,y);this.setPublicKeyName()};Ia.prototype.getPublicKeyName=function(){return this.publicKeyName};Ia.isIdentityCertificate=function(a){return Ia.isCorrectName(a.getName())};
Ia.certificateNameToPublicKeyName=function(a){for(var y=!1,b=a.size()-1;0<b+1;--b)if("ID-CERT"==a.get(b).toEscapedString()){y=!0;break}if(!y)throw Error("Incorrect identity certificate name "+a.toUri());for(var y=a.getSubName(0,b),b=!1,r=0;r<y.size();r++)if("KEY"==y.get(r).toEscapedString()){b=!0;break}if(!b)throw Error("Incorrect identity certificate name "+a.toUri());return y.getSubName(0,r).append(y.getSubName(r+1,y.size()-r-1))};Ia.isCorrectName=function(a){for(var y=a.size()-1;0<=y&&"ID-CERT"!=
a.get(y).toEscapedString();y--);if(0>y)return!1;for(y=0;y<a.size()&&"KEY"!=a.get(y).toEscapedString();y++);return y>=a.size()?!1:!0};Ia.prototype.setPublicKeyName=function(){this.publicKeyName=Ia.certificateNameToPublicKeyName(this.getName())};var c=a.Name,x=a.SecurityException,b=a.SyncPromise,Y=function(){};q.IdentityStorage=Y;Y.prototype.doesIdentityExistPromise=function(a,y){return b.reject(Error("IdentityStorage.doesIdentityExistPromise is not implemented"))};Y.prototype.doesIdentityExist=function(a){return b.getValue(this.doesIdentityExistPromise(a,
!0))};Y.prototype.addIdentityPromise=function(a,y){return b.reject(Error("IdentityStorage.addIdentityPromise is not implemented"))};Y.prototype.addIdentity=function(a){return b.getValue(this.addIdentityPromise(a,!0))};Y.prototype.revokeIdentity=function(){return b.reject(Error("IdentityStorage.revokeIdentity is not implemented"))};Y.prototype.getNewKeyNamePromise=function(a,y,w){for(var r=Math.floor((new Date).getTime()/1E3);r<=Y.lastTimestamp;)r+=1;Y.lastTimestamp=r;r=""+r;y=y?"ksk-"+r:"dsk-"+r;
var pa=(new c(a)).append(y);return this.doesKeyExistPromise(pa,w).then(function(a){if(a)throw new x(Error("Key name already exists"));return b.resolve(pa)})};Y.prototype.getNewKeyName=function(a,y){return b.getValue(this.getNewKeyNamePromise(a,y,!0))};Y.prototype.doesKeyExistPromise=function(a,y){return b.reject(Error("IdentityStorage.doesKeyExistPromise is not implemented"))};Y.prototype.doesKeyExist=function(a){return b.getValue(this.doesKeyExistPromise(a,!0))};Y.prototype.addKeyPromise=function(a,
y,w,r){return b.reject(Error("IdentityStorage.addKeyPromise is not implemented"))};Y.prototype.addKey=function(a,y,w){return b.getValue(this.addKeyPromise(a,y,w,!0))};Y.prototype.getKeyPromise=function(a,y){return b.reject(Error("IdentityStorage.getKeyPromise is not implemented"))};Y.prototype.getKey=function(a){return b.getValue(this.getKeyPromise(a,!0))};Y.prototype.activateKey=function(a){throw Error("IdentityStorage.activateKey is not implemented");};Y.prototype.deactivateKey=function(a){throw Error("IdentityStorage.deactivateKey is not implemented");
};Y.prototype.doesCertificateExistPromise=function(a,y){return b.reject(Error("IdentityStorage.doesCertificateExistPromise is not implemented"))};Y.prototype.doesCertificateExist=function(a){return b.getValue(this.doesCertificateExistPromise(a,!0))};Y.prototype.addCertificatePromise=function(a,y){return b.reject(Error("IdentityStorage.addCertificatePromise is not implemented"))};Y.prototype.addCertificate=function(a){return b.getValue(this.addCertificatePromise(a,!0))};Y.prototype.getCertificatePromise=
function(a,y){return b.reject(Error("IdentityStorage.getCertificatePromise is not implemented"))};Y.prototype.getCertificate=function(a){return b.getValue(this.getValuePromise(a,!0))};Y.prototype.getTpmLocatorPromise=function(a){return b.reject(Error("IdentityStorage.getTpmLocatorPromise is not implemented"))};Y.prototype.getTpmLocator=function(){return b.getValue(this.getTpmLocatorPromise(!0))};Y.prototype.getDefaultIdentityPromise=function(a){return b.reject(Error("IdentityStorage.getDefaultIdentityPromise is not implemented"))};
Y.prototype.getDefaultIdentity=function(){return b.getValue(this.getDefaultIdentityPromise(!0))};Y.prototype.getDefaultKeyNameForIdentityPromise=function(a,y){return b.reject(Error("IdentityStorage.getDefaultKeyNameForIdentityPromise is not implemented"))};Y.prototype.getDefaultKeyNameForIdentity=function(a){return b.getValue(this.getDefaultKeyNameForIdentityPromise(a,!0))};Y.prototype.getDefaultCertificateNameForIdentityPromise=function(a,y){var b=this;return this.getDefaultKeyNameForIdentityPromise(a).then(function(a){return b.getDefaultCertificateNameForKeyPromise(a)})};
Y.prototype.getDefaultCertificateNameForIdentity=function(a){return b.getValue(this.getDefaultCertificateNameForIdentityPromise(a,!0))};Y.prototype.getDefaultCertificateNameForKeyPromise=function(a,y){return b.reject(Error("IdentityStorage.getDefaultCertificateNameForKeyPromise is not implemented"))};Y.prototype.getDefaultCertificateNameForKey=function(a){return b.getValue(this.getDefaultCertificateNameForKeyPromise(a,!0))};Y.prototype.getAllIdentitiesPromise=function(a,y,w){return b.reject(Error("IdentityStorage.getAllIdentitiesPromise is not implemented"))};
Y.prototype.getAllKeyNamesOfIdentityPromise=function(a,y,w,r){return b.reject(Error("IdentityStorage.getAllKeyNamesOfIdentityPromise is not implemented"))};Y.prototype.getAllCertificateNamesOfKeyPromise=function(a,y,w,r){return b.reject(Error("IdentityStorage.getAllCertificateNamesOfKeyPromise is not implemented"))};Y.prototype.getAllKeyNamesOfIdentity=function(a,y,w){return b.getValue(this.getAllKeyNamesOfIdentityPromise(a,y,w,!0))};Y.prototype.setDefaultIdentityPromise=function(a,y){return b.reject(Error("IdentityStorage.setDefaultIdentityPromise is not implemented"))};
Y.prototype.setDefaultIdentity=function(a){return b.getValue(this.setDefaultIdentityPromise(a,!0))};Y.prototype.setDefaultKeyNameForIdentityPromise=function(a,y,w){return b.reject(Error("IdentityStorage.setDefaultKeyNameForIdentityPromise is not implemented"))};Y.prototype.setDefaultKeyNameForIdentity=function(a,y){return b.getValue(this.setDefaultKeyNameForIdentityPromise(a,y,!0))};Y.prototype.setDefaultCertificateNameForKeyPromise=function(a,y,w){return b.reject(Error("IdentityStorage.setDefaultCertificateNameForKeyPromise is not implemented"))};
Y.prototype.setDefaultCertificateNameForKey=function(a,y){return b.getValue(this.setDefaultCertificateNameForKeyPromise(a,y,!0))};Y.prototype.getDefaultCertificatePromise=function(a){var y=this;return this.getDefaultIdentityPromise(a).then(function(b){return y.getDefaultCertificateNameForIdentityPromise(b,a)},function(a){return b.resolve(null)}).then(function(w){return null==w?b.resolve(null):y.getCertificatePromise(w,a)})};Y.prototype.getDefaultCertificate=function(){return b.getValue(this.getDefaultCertificatePromise(!0))};
Y.prototype.deleteCertificateInfoPromise=function(a,y){return b.reject(Error("IdentityStorage.deleteCertificateInfoPromise is not implemented"))};Y.prototype.deleteCertificateInfo=function(a){return b.getValue(this.deleteCertificateInfoPromise(a,!0))};Y.prototype.deletePublicKeyInfoPromise=function(a,y){return b.reject(Error("IdentityStorage.deletePublicKeyInfoPromise is not implemented"))};Y.prototype.deletePublicKeyInfo=function(a){return b.getValue(this.deletePublicKeyInfoPromise(a,!0))};Y.prototype.deleteIdentityInfoPromise=
function(a,y){return b.reject(Error("IdentityStorage.deleteIdentityInfoPromise is not implemented"))};Y.prototype.deleteIdentityInfo=function(a){return b.getValue(this.deleteIdentityInfoPromise(a,!0))};Y.lastTimestamp=Math.floor((new Date).getTime()/1E3);new Y;var c=a.Name,p=a.Blob,x=a.SecurityException,Ia=a.IdentityCertificate,b=a.SyncPromise,Y=a.IdentityStorage,sb=function(){Y.call(this);this.identityStore={};this.defaultIdentity="";this.keyStore={};this.certificateStore={}};sb.prototype=new Y;
sb.prototype.name="MemoryIdentityStorage";q.MemoryIdentityStorage=sb;sb.prototype.doesIdentityExistPromise=function(a){return b.resolve(void 0!==this.identityStore[a.toUri()])};sb.prototype.addIdentityPromise=function(a){a=a.toUri();void 0===this.identityStore[a]&&(this.identityStore[a]={defaultKey:null});return b.resolve()};sb.prototype.doesKeyExistPromise=function(a){return b.resolve(void 0!==this.keyStore[a.toUri()])};sb.prototype.addKeyPromise=function(a,y,w){if(0===a.size()||this.doesKeyExist(a))return b.resolve();
var r=a.getSubName(0,a.size()-1);this.addIdentity(r);this.keyStore[a.toUri()]={keyType:y,keyDer:new p(w),defaultCertificate:null};return b.resolve()};sb.prototype.getKeyPromise=function(a){if(0===a.size())return b.reject(new x(Error("MemoryIdentityStorage.getKeyPromise: Empty keyName")));a=a.toUri();a=this.keyStore[a];return void 0===a?b.reject(new x(Error("MemoryIdentityStorage.getKeyPromise: The key does not exist"))):b.resolve(a.keyDer)};sb.prototype.doesCertificateExistPromise=function(a){return b.resolve(void 0!==
this.certificateStore[a.toUri()])};sb.prototype.addCertificatePromise=function(a){var y=a.getName(),w=a.getPublicKeyName();this.addKey(w,a.getPublicKeyInfo().getKeyType(),a.getPublicKeyInfo().getKeyDer());if(this.doesCertificateExist(y))return b.resolve();this.certificateStore[y.toUri()]=a.wireEncode();return b.resolve()};sb.prototype.getCertificatePromise=function(a){a=a.toUri();if(void 0===this.certificateStore[a])return b.reject(new x(Error("MemoryIdentityStorage.getCertificatePromise: The certificate does not exist")));
var y=new Ia;try{y.wireDecode(this.certificateStore[a])}catch(w){return b.reject(new x(Error("MemoryIdentityStorage.getCertificatePromise: The certificate cannot be decoded")))}return b.resolve(y)};Y.prototype.getTpmLocatorPromise=function(a){return b.resolve("tpm-memory:")};sb.prototype.getDefaultIdentityPromise=function(){return 0===this.defaultIdentity.length?b.reject(new x(Error("MemoryIdentityStorage.getDefaultIdentity: The default identity is not defined"))):b.resolve(new c(this.defaultIdentity))};
sb.prototype.getDefaultKeyNameForIdentityPromise=function(a){a=a.toUri();return void 0!==this.identityStore[a]?null!=this.identityStore[a].defaultKey?b.resolve(this.identityStore[a].defaultKey):b.reject(new x(Error("No default key set."))):b.reject(new x(Error("Identity not found.")))};sb.prototype.getDefaultCertificateNameForKeyPromise=function(a){a=a.toUri();return void 0!==this.keyStore[a]?null!=this.keyStore[a].defaultCertificate?b.resolve(this.keyStore[a].defaultCertificate):b.reject(new x(Error("No default certificate set."))):
b.reject(new x(Error("Key not found.")))};sb.prototype.setDefaultIdentityPromise=function(a){a=a.toUri();this.defaultIdentity=void 0!==this.identityStore[a]?a:"";return b.resolve()};sb.prototype.setDefaultKeyNameForIdentityPromise=function(a,y){y=y instanceof c?y:null;var w=a.getPrefix(-1);if(null!=y&&0<y.size()&&!y.equals(w))return b.reject(new x(Error("The specified identity name does not match the key name")));w=w.toUri();void 0!==this.identityStore[w]&&(this.identityStore[w].defaultKey=new c(a));
return b.resolve()};sb.prototype.setDefaultCertificateNameForKeyPromise=function(a,y){var w=a.toUri();void 0!==this.keyStore[w]&&(this.keyStore[w].defaultCertificate=new c(y));return b.resolve()};sb.prototype.deleteCertificateInfoPromise=function(a){return b.reject(Error("MemoryIdentityStorage.deleteCertificateInfoPromise is not implemented"))};sb.prototype.deletePublicKeyInfoPromise=function(a){return b.reject(Error("MemoryIdentityStorage.deletePublicKeyInfoPromise is not implemented"))};sb.prototype.deleteIdentityInfoPromise=
function(a){return b.reject(Error("MemoryIdentityStorage.deleteIdentityInfoPromise is not implemented"))};var b=a.SyncPromise,m=a.DerNode,qa=function(){};q.PrivateKeyStorage=qa;qa.prototype.generateKeyPairPromise=function(a,y,w){return b.reject(Error("PrivateKeyStorage.generateKeyPairPromise is not implemented"))};qa.prototype.generateKeyPair=function(a,y){b.getValue(this.generateKeyPairPromise(a,y,!0))};qa.prototype.deleteKeyPairPromise=function(a,y){return b.reject(Error("PrivateKeyStorage.deleteKeyPairPromise is not implemented"))};
qa.prototype.deleteKeyPair=function(a){b.getValue(this.deleteKeyPairPromise(a,!0))};qa.prototype.getPublicKeyPromise=function(a,y){return b.reject(Error("PrivateKeyStorage.getPublicKeyPromise is not implemented"))};qa.prototype.getPublicKey=function(a){return b.getValue(this.getPublicKeyPromise(a,!0))};qa.prototype.signPromise=function(a,y,w,r){return b.reject(Error("PrivateKeyStorage.sign is not implemented"))};qa.prototype.sign=function(a,y,w){return b.getValue(this.signPromise(a,y,w,!0))};qa.prototype.decrypt=
function(a,y,b){throw Error("PrivateKeyStorage.decrypt is not implemented");};qa.prototype.encrypt=function(a,y,b){throw Error("PrivateKeyStorage.encrypt is not implemented");};qa.prototype.generateKey=function(a,y){throw Error("PrivateKeyStorage.generateKey is not implemented");};qa.prototype.doesKeyExistPromise=function(a,y,w){return b.reject(Error("PrivateKeyStorage.doesKeyExist is not implemented"))};qa.prototype.doesKeyExist=function(a,y){return b.getValue(this.doesKeyExistPromise(a,y,!0))};
qa.encodePkcs8PrivateKey=function(a,y,b){var r=new m.DerSequence;r.addChild(new m.DerOid(y));r.addChild(b);y=new m.DerSequence;y.addChild(new m.DerInteger(0));y.addChild(r);y.addChild(new m.DerOctetString(a));return y.encode()};qa.encodePkcs1PrivateKeyFromRSAKey=function(a){var y=new m.DerSequence;y.addChild(new m.DerInteger(0));y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.n)));y.addChild(new m.DerInteger(a.e));y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.d)));y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.p)));
y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.q)));y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.dmp1)));y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.dmq1)));y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.coeff)));return y.encode()};qa.encodePublicKeyFromRSAKey=function(a){var y=new m.DerSequence;y.addChild(new m.DerInteger(qa.bigIntegerToBuffer(a.n)));y.addChild(new m.DerInteger(a.e));a=new m.DerSequence;a.addChild(new m.DerOid(new eb(qa.RSA_ENCRYPTION_OID)));a.addChild(new m.DerNull);
var b=new m.DerSequence;b.addChild(a);b.addChild(new m.DerBitString(y.encode().buf(),0));return b.encode()};qa.bigIntegerToBuffer=function(a){a=a.toString(16);if("-"==a.substr(0,1))throw Error("PrivateKeyStorage.bigIntegerToBuffer: Negative integers are not currently supported");1==a.length%2?a="0"+a:a.match(/^[0-7]/)||(a="00"+a);return new d(a,"hex")};qa.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";qa.EC_ENCRYPTION_OID="1.2.840.10045.2.1";var ba=a,p=a.Blob,x=a.SecurityException,Ba=a.PublicKey,ad=a.KeyClass,
fa=a.KeyType,Aa=a.DigestAlgorithm,M=a.DataUtils,qa=a.PrivateKeyStorage,m=a.DerNode,eb=a.OID,b=a.SyncPromise,Gb=a.UseSubtleCrypto,xc=null;try{xc=a}catch($e){}var yc=function(){qa.call(this);this.publicKeyStore={};this.privateKeyStore={}};yc.prototype=new qa;yc.prototype.name="MemoryPrivateKeyStorage";q.MemoryPrivateKeyStorage=yc;yc.prototype.setPublicKeyForKeyName=function(a,y,b){this.publicKeyStore[a.toUri()]=new Ba(new p(b,!0))};yc.prototype.setPrivateKeyForKeyName=function(a,y,b){b=b.toString("base64");
var r;if(y===fa.RSA){r="-----BEGIN RSA PRIVATE KEY-----\n";for(var c=0;c<b.length;c+=64)r+=b.substr(c,64)+"\n";r+="-----END RSA PRIVATE KEY-----"}else if(y===fa.EC){r="-----BEGIN EC PRIVATE KEY-----\n";for(c=0;c<b.length;c+=64)r+=b.substr(c,64)+"\n";r+="-----END EC PRIVATE KEY-----"}else throw new x(Error("MemoryPrivateKeyStorage: KeyType is not supported"));this.privateKeyStore[a.toUri()]={keyType:y,privateKey:r}};yc.prototype.setKeyPairForKeyName=function(a,y,b,r){this.setPublicKeyForKeyName(a,
y,b);this.setPrivateKeyForKeyName(a,y,r)};yc.prototype.generateKeyPairPromise=function(a,y,w){if(this.doesKeyExist(a,ad.PUBLIC))return b.reject(new x(Error("Public key already exists")));if(this.doesKeyExist(a,ad.PRIVATE))return b.reject(new x(Error("Private key already exists")));var r=this;if(Gb()&&!w){if(y.getKeyType()===fa.RSA){var c=null,v=null;return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:y.getKeySize(),publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},
!0,["sign","verify"]).then(function(a){c=a.privateKey;return crypto.subtle.exportKey("spki",a.publicKey)}).then(function(a){v=(new p(new Uint8Array(a),!1)).buf();return crypto.subtle.exportKey("pkcs8",c)}).then(function(b){b=m.parse((new p(new Uint8Array(b),!1)).buf()).getChildren()[2].toVal();r.setKeyPairForKeyName(a,y.getKeyType(),v,b.buf());r.privateKeyStore[a.toUri()].subtleKey=c;return Promise.resolve()})}return b.reject(new x(Error("Only RSA key generation currently supported")))}return b.resolve().then(function(){if("undefined"!==
typeof A)if(y.getKeyType()===fa.RSA){var w=new A;w.generate(y.getKeySize(),"010001");r.setKeyPairForKeyName(a,y.getKeyType(),qa.encodePublicKeyFromRSAKey(w).buf(),qa.encodePkcs1PrivateKeyFromRSAKey(w).buf())}else return b.reject(new x(Error("Only RSA key generation currently supported")));else{var c;if(y.getKeyType()===fa.RSA){if(!xc)return b.reject(new x(Error("Need to install rsa-keygen: sudo npm install rsa-keygen")));c=xc.generate(y.getKeySize());w=c.public_key.toString().replace("-----BEGIN PUBLIC KEY-----",
"").replace("-----END PUBLIC KEY-----","");w=new d(w,"base64");c=c.private_key.toString()}else return b.reject(new x(Error("Only RSA key generation currently supported")));r.setPublicKeyForKeyName(a,y.getKeyType(),w);r.privateKeyStore[a.toUri()]={keyType:y.getKeyType(),privateKey:c}}return b.resolve()})};yc.prototype.deleteKeyPairPromise=function(a){a=a.toUri();delete this.publicKeyStore[a];delete this.privateKeyStore[a];return b.resolve()};yc.prototype.getPublicKeyPromise=function(a){var y=a.toUri(),
y=this.publicKeyStore[y];return void 0===y?b.reject(new x(Error("MemoryPrivateKeyStorage: Cannot find public key "+a.toUri()))):b.resolve(y)};yc.prototype.signPromise=function(a,y,w,r){r="boolean"===typeof w?w:r;w="boolean"!==typeof w&&w?w:Aa.SHA256;if(w!=Aa.SHA256)return b.reject(new x(Error("MemoryPrivateKeyStorage.sign: Unsupported digest algorithm")));y=y.toUri();var c=this.privateKeyStore[y];if(void 0===c)return b.reject(new x(Error("MemoryPrivateKeyStorage: Cannot find private key "+y)));if(Gb()&&
!r){var v={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};c.subtleKey?r=crypto.subtle.sign(v,c.subtleKey,a):(r=M.privateKeyPemToDer(c.privateKey),r=qa.encodePkcs8PrivateKey(r,new eb(qa.RSA_ENCRYPTION_OID),new m.DerNull).buf(),r=crypto.subtle.importKey("pkcs8",r.buffer,v,!0,["sign"]).then(function(b){c.subtleKey=b;return crypto.subtle.sign(v,b,a)}));return r.then(function(a){a=new p(new Uint8Array(a),!0);return Promise.resolve(a)})}if(c.keyType===fa.RSA)r=ba.createSign("RSA-SHA256");else if(c.keyType===
fa.EC)r=ba.createSign("sha256");else return b.reject(new x(Error("MemoryPrivateKeyStorage.sign: Unrecognized private key type")));r.update(a);r=new d(M.toNumbersIfString(r.sign(c.privateKey)));r=new p(r,!1);return b.resolve(r)};yc.prototype.doesKeyExistPromise=function(a,y){var w=a.toUri(),r=!1;y==ad.PUBLIC?r=void 0!==this.publicKeyStore[w]:y==ad.PRIVATE&&(r=void 0!==this.privateKeyStore[w]);return b.resolve(r)};ba=a;new qa;var ba=a,c=a.Name,Q=a.Data,p=a.Blob,qd=a.ConfigFile,qb=a.DigestSha256Signature,
Da=a.Sha256WithRsaSignature,Sa=a.Sha256WithEcdsaSignature,Ga=a.KeyLocatorType,s=a.WireFormat,x=a.SecurityException,Aa=a.DigestAlgorithm,fa=a.KeyType,Ub=a.RsaKeyParams,Ia=a.IdentityCertificate,Ba=a.PublicKey,cd=a.CertificateSubjectDescription,b=a.SyncPromise,ve=a.BasicIdentityStorage,De=a.FilePrivateKeyStorage,ha=function y(a,b){if(b){if(!a)throw Error("IdentityManager: A custom privateKeyStorage is supplied with a null identityStorage");this.identityStorage=a;this.privateKeyStorage=b}else{if(!qd)throw new x(Error("IdentityManager: If not in Node.js then you must supply identityStorage and privateKeyStorage."));
var c=new qd,v=[null],B=this;this.identityStorage=a?a:y.getDefaultIdentityStorage_(c,function(){return B.checkTpmPromise_(v[0])});this.privateKeyStorage=y.getDefaultPrivateKeyStorage_(c,v)}};q.IdentityManager=ha;ha.prototype.createIdentityAndCertificatePromise=function(a,w,r){var c=this,v=!0,B=null;return this.identityStorage.addIdentityPromise(a,r).then(function(){return c.identityStorage.getDefaultKeyNameForIdentityPromise(a,r).then(function(a){B=a;return c.identityStorage.getKeyPromise(B,r).then(function(a){(new Ba(a)).getKeyType()==
w.getKeyType()&&(v=!1);return b.resolve()})},function(a){if(!(a instanceof x))throw a;return b.resolve()})}).then(function(){return v?c.generateKeyPairPromise(a,!0,w,r).then(function(a){B=a;return c.identityStorage.setDefaultKeyNameForIdentityPromise(B,r)}):b.resolve()}).then(function(){return c.identityStorage.getDefaultCertificateNameForKeyPromise(B,r).then(function(a){return b.resolve(a)},function(a){if(!(a instanceof x))throw a;var y;return c.selfSignPromise(B,r).then(function(a){y=a.getName();
return c.addCertificateAsIdentityDefaultPromise(a,r)}).then(function(){return b.resolve(y)})})})};ha.prototype.createIdentityAndCertificate=function(a,w,r,c){return b.complete(r,c,this.createIdentityAndCertificatePromise(a,w,!r))};ha.prototype.createIdentity=function(a,b){return Ia.certificateNameToPublicKeyName(this.createIdentityAndCertificate(a,b))};ha.prototype.deleteIdentity=function(a,w,r){var c=this,v=!0,B=this.identityStorage.getDefaultIdentityPromise(!w).then(function(w){w.equals(a)&&(v=
!1);return b.resolve()},function(a){return b.resolve()}).then(function(){if(!v)return b.resolve();var w=[];return c.identityStorage.getAllKeyNamesOfIdentityPromise(a,w,!0).then(function(){return c.identityStorage.getAllKeyNamesOfIdentityPromise(a,w,!1)}).then(function(){return c.identityStorage.deleteIdentityInfoPromise(a)}).then(function(){function a(y){return y>=w.length?b.resolve():c.privateKeyStorage.deleteKeyPairPromise(w[y]).then(function(){return a(y+1)})}return a(0)})});return b.complete(w,
r,B)};ha.prototype.setDefaultIdentityPromise=function(a,b){return this.identityStorage.setDefaultIdentityPromise(a,b)};ha.prototype.setDefaultIdentity=function(a,w,r){return b.complete(w,r,this.identityStorage.setDefaultIdentityPromise(a,!w))};ha.prototype.getDefaultIdentityPromise=function(a){return this.identityStorage.getDefaultIdentityPromise(a)};ha.prototype.getDefaultIdentity=function(a,w){return b.complete(a,w,this.identityStorage.getDefaultIdentityPromise(!a))};ha.prototype.getDefaultCertificatePromise=
function(a){return this.identityStorage.getDefaultCertificatePromise(a)};ha.prototype.generateRSAKeyPair=function(a,w,r){return b.getValue(this.generateKeyPairPromise(a,w,new Ub(r),!0))};ha.prototype.setDefaultKeyForIdentity=function(a,w,r,pa){pa="function"===typeof w?r:pa;r="function"===typeof w?w:r;w="function"!==typeof w&&w?w:new c;return b.complete(r,pa,this.identityStorage.setDefaultKeyNameForIdentityPromise(a,w,!r))};ha.prototype.getDefaultKeyNameForIdentity=function(a,w,r){return b.complete(w,
r,this.identityStorage.getDefaultKeyNameForIdentityPromise(a,!w))};ha.prototype.generateRSAKeyPairAsDefaultPromise=function(a,w,r,c){var v,B=this;return this.generateKeyPairPromise(a,w,new Ub(r)).then(function(a){v=a;return B.identityStorage.setDefaultKeyNameForIdentityPromise(v)}).then(function(){return b.resolve(v)})};ha.prototype.generateRSAKeyPairAsDefault=function(a,w,r){return b.getValue(this.generateRSAKeyPairAsDefaultPromise(a,w,r,!0))};ha.prototype.getPublicKey=function(a,w,r){return b.complete(w,
r,this.identityStorage.getKeyPromise(a,!w).then(function(a){return b.resolve(new Ba(a))}))};ha.prototype.prepareUnsignedIdentityCertificate=function(a,w,r,pa,v,B,d,k,m){w instanceof Ba||(m=k,k=d,d=B,B=v,v=pa,pa=r,r=w,w=null);var n=d,p=k;d=n instanceof c?n:null;"function"===typeof n?(k=n,m=p):"function"===typeof p?k=p:m=k=null;a=null==w?this.prepareUnsignedIdentityCertificatePromise(a,r,pa,v,B,d,!k):this.prepareUnsignedIdentityCertificatePromise(a,w,r,pa,v,B,d,!k);return b.complete(k,m,a)};ha.prototype.prepareUnsignedIdentityCertificatePromise=
function(a,w,r,pa,v,B,d,k){w instanceof Ba||(k=d,d=B,B=v,v=pa,pa=r,r=w,w=null);var m=d;d=m instanceof c?m:null;return(null==w?this.identityStorage.getKeyPromise(a,"boolean"===typeof m?m:"boolean"===typeof k?k:!1).then(function(a){w=new Ba(a);return b.resolve()}):b.resolve()).then(function(){return b.resolve(ha.prepareUnsignedIdentityCertificateHelper_(a,w,r,pa,v,B,d))})};ha.prepareUnsignedIdentityCertificateHelper_=function(a,b,r,pa,v,B,d){if(1>a.size())return null;var k=a.get(-1).toEscapedString();
if(4>k.length)return null;keyIdPrefix=k.substr(0,4);if("ksk-"!=keyIdPrefix&&"dsk-"!=keyIdPrefix)return null;var k=new Ia,m=new c;if(null==d)r.match(a)?m.append(r).append("KEY").append(a.getSubName(r.size())).append("ID-CERT").appendVersion((new Date).getTime()):m.append(a.getPrefix(-1)).append("KEY").append(a.get(-1)).append("ID-CERT").appendVersion((new Date).getTime());else if(d.match(a)&&!d.equals(a))m.append(d).append("KEY").append(a.getSubName(d.size())).append("ID-CERT").appendVersion((new Date).getTime());
else return null;k.setName(m);k.setNotBefore(pa);k.setNotAfter(v);k.setPublicKeyInfo(b);if(null==B||0===B.length)k.addSubjectDescription(new cd("2.5.4.41",a.getPrefix(-1).toUri()));else for(a=0;a<B.length;++a)k.addSubjectDescription(B[a]);try{k.encode()}catch(n){throw x(Error("DerEncodingException: "+n));}return k};ha.prototype.addCertificate=function(a,w,r){return b.complete(w,r,this.identityStorage.addCertificatePromise(a,!w))};ha.prototype.setDefaultCertificateForKeyPromise=function(a,b){var r=
this,c=a.getPublicKeyName();return this.identityStorage.doesKeyExistPromise(c,b).then(function(v){if(!v)throw new x(Error("No corresponding Key record for certificate!"));return r.identityStorage.setDefaultCertificateNameForKeyPromise(c,a.getName(),b)})};ha.prototype.setDefaultCertificateForKey=function(a,w,r){return b.complete(w,r,this.setDefaultCertificateForKeyPromise(a,!w))};ha.prototype.addCertificateAsIdentityDefaultPromise=function(a,b){var r=this;return this.identityStorage.addCertificatePromise(a,
b).then(function(){var c=a.getPublicKeyName();return r.identityStorage.setDefaultKeyNameForIdentityPromise(c,b)}).then(function(){return r.setDefaultCertificateForKeyPromise(a,b)})};ha.prototype.addCertificateAsDefault=function(a,w,r){var c=!w,v=this;return b.complete(w,r,this.identityStorage.addCertificatePromise(a,c).then(function(){return v.setDefaultCertificateForKeyPromise(a,c)}))};ha.prototype.getCertificate=function(a,w,r){return b.complete(w,r,this.identityStorage.getCertificatePromise(a,
!1,!w))};ha.prototype.getDefaultCertificateNameForIdentityPromise=function(a,b){return this.identityStorage.getDefaultCertificateNameForIdentityPromise(a,b)};ha.prototype.getDefaultCertificateNameForIdentity=function(a,w,r){return b.complete(w,r,this.identityStorage.getDefaultCertificateNameForIdentityPromise(a,!w))};ha.prototype.getDefaultCertificateName=function(a,w){var r=!a,c=this;return b.complete(a,w,this.identityStorage.getDefaultIdentityPromise(r).then(function(a){return c.identityStorage.getDefaultCertificateNameForIdentityPromise(a,
r)}))};ha.prototype.getAllIdentities=function(a,w,r,c){return b.complete(r,c,this.identityStorage.getAllIdentitiesPromise(a,w,!r))};ha.prototype.getAllKeyNamesOfIdentity=function(a,w,r,c,v){return b.complete(c,v,this.identityStorage.getAllKeyNamesOfIdentityPromise(a,w,r,!c))};ha.prototype.getAllCertificateNamesOfKey=function(a,w,r,c,v){return b.complete(c,v,this.identityStorage.getAllCertificateNamesOfKeyPromise(a,w,r,!c))};ha.prototype.signByCertificatePromise=function(a,w,r,c){c="boolean"===typeof r?
r:c;r="boolean"!==typeof r&&r?r:s.getDefaultWireFormat();var v=ha.certificateNameToPublicKeyName(w),B=this;if(a instanceof Q){var d=[0];return this.makeSignatureByCertificatePromise(w,d,c).then(function(b){a.setSignature(b);b=a.wireEncode(r);return B.privateKeyStorage.signPromise(b.signedBuf(),v,d[0],c)}).then(function(w){a.getSignature().setSignature(w);a.wireEncode(r);return b.resolve(a)})}d=[0];return this.makeSignatureByCertificatePromise(w,d,c).then(function(b){return B.privateKeyStorage.signPromise(a,
v,d[0],c)}).then(function(a){signature.setSignature(a);return b.resolve(signature)})};ha.prototype.signByCertificate=function(a,w,r,c,v){v="function"===typeof r?c:v;c="function"===typeof r?r:c;r="function"!==typeof r&&r?r:s.getDefaultWireFormat();return b.complete(c,v,this.signByCertificatePromise(a,w,r,!c))};ha.prototype.signInterestByCertificatePromise=function(a,w,r,d){d="boolean"===typeof r?r:d;r="boolean"!==typeof r&&r?r:s.getDefaultWireFormat();var v=this,B,k=[0];return this.makeSignatureByCertificatePromise(w,
k,d).then(function(b){B=b;a.getName().append(r.encodeSignatureInfo(B));a.getName().append(new c.Component);b=a.wireEncode(r);var m=ha.certificateNameToPublicKeyName(w);return v.privateKeyStorage.signPromise(b.signedBuf(),m,k[0],d)}).then(function(w){B.setSignature(w);a.setName(a.getName().getPrefix(-1).append(r.encodeSignatureValue(B)));return b.resolve(a)})};ha.prototype.signInterestByCertificate=function(a,w,c,d,v){v="function"===typeof c?d:v;d="function"===typeof c?c:d;c="function"!==typeof c&&
c?c:s.getDefaultWireFormat();return b.complete(d,v,this.signInterestByCertificatePromise(a,w,c,!d))};ha.prototype.signWithSha256=function(a,b){b=b||s.getDefaultWireFormat();a.setSignature(new qb);var c=a.wireEncode(b),d=ba.createHash("sha256");d.update(c.signedBuf());a.getSignature().setSignature(new p(d.digest(),!1));a.wireEncode(b)};ha.prototype.signInterestWithSha256=function(a,b){b=b||s.getDefaultWireFormat();var r=new qb;a.getName().append(b.encodeSignatureInfo(r));a.getName().append(new c.Component);
var d=a.wireEncode(b),v=ba.createHash("sha256");v.update(d.signedBuf());r.setSignature(new p(v.digest(),!1));a.setName(a.getName().getPrefix(-1).append(b.encodeSignatureValue(r)))};ha.prototype.selfSignPromise=function(a,b){var c=new Ia,d=this;return this.identityStorage.getKeyPromise(a,b).then(function(v){v=new Ba(v);var B=(new Date).getTime(),k=B+63072E6;c.setNotBefore(B);c.setNotAfter(k);B=a.getPrefix(-1).append("KEY").append(a.get(-1)).append("ID-CERT").appendVersion(c.getNotBefore());c.setName(B);
c.setPublicKeyInfo(v);c.addSubjectDescription(new cd("2.5.4.41",a.toUri()));c.encode();return d.signByCertificatePromise(c,c.getName(),b)})};ha.prototype.selfSign=function(a,w,c){return b.complete(w,c,this.selfSignPromise(a,!w))};ha.certificateNameToPublicKeyName=function(a){for(var b=a.size()-1;0<=b&&"ID-CERT"!=a.get(b).toEscapedString();)--b;a=a.getSubName(0,b);for(b=0;b<a.size()&&"KEY"!=a.get(b).toEscapedString();)++b;return a.getSubName(0,b).append(a.getSubName(b+1,a.size()-b-1))};ha.prototype.makeSignatureByCertificatePromise=
function(a,w,c){var d=ha.certificateNameToPublicKeyName(a);return this.privateKeyStorage.getPublicKeyPromise(d,c).then(function(c){c=c.getKeyType();var r=null;if(c==fa.RSA)r=new Da,w[0]=Aa.SHA256,r.getKeyLocator().setType(Ga.KEYNAME),r.getKeyLocator().setKeyName(a.getPrefix(-1));else if(c==fa.EC)r=new Sa,w[0]=Aa.SHA256,r.getKeyLocator().setType(Ga.KEYNAME),r.getKeyLocator().setKeyName(a.getPrefix(-1));else throw new x(Error("Key type is not recognized"));return b.resolve(r)})};ha.prototype.generateKeyPairPromise=
function(a,w,c,d){var v,B=this;return this.identityStorage.getNewKeyNamePromise(a,w,d).then(function(a){v=a;return B.privateKeyStorage.generateKeyPairPromise(v,c,d)}).then(function(){return B.privateKeyStorage.getPublicKeyPromise(v,d)}).then(function(a){return B.identityStorage.addKeyPromise(v,c.getKeyType(),a.getKeyDer())}).then(function(){return b.resolve(v)})};ha.getDefaultIdentityStorage_=function(a,b){var c=a.get("pib","");if(""!==c&&"pib-sqlite3"!==c)throw new x(Error("Invalid config file pib value: "+
c));return new ve(b)};ha.getDefaultPrivateKeyStorage_=function(a,b){var c=a.get("tpm","");if(""===c){if("darwin"===process.platform)throw b[0]="tpm-osxkeychain:",new x(Error("IdentityManager: OS X key chain storage is not yet implemented. You must supply a privateKeyStorage."));b[0]="tpm-file:";return new De}if("tpm-osxkeychain"===c)throw b[0]="tpm-osxkeychain:",new x(Error("IdentityManager: tpm-osxkeychain is not yet implemented."));if("tpm-file"===c)return b[0]="tpm-file:",new De;throw new x(Error("Invalid config file tpm value: "+
c));};ha.prototype.checkTpmPromise_=function(a){return this.identityStorage.getTpmLocatorPromise().then(function(b){return""!==b&&b!==a?Promise.reject(new x(Error("The TPM locator supplied does not match the TPM locator in the PIB: "+b+" != "+a))):Promise.resolve()},function(a){return Promise.resolve()})};var c=a.Name,b=a.SyncPromise,L=a.CertificateV2,Lc=function(a,b,r){this.certificates_={};this.keyName_=new c(a);this.pibImpl_=b;if(null==b)throw Error("The pibImpl is null");this.certificateNameUris_=
[];for(var d in r)this.certificateNameUris_.push(r[d].toUri())};q.PibCertificateContainer=Lc;Lc.makePromise=function(a,w,c){return null==w?b.reject(Error("The pibImpl is null")):w.getCertificatesOfKeyPromise(a,c).then(function(c){return b.resolve(new Lc(a,w,c))})};Lc.prototype.size=function(){return this.certificateNameUris_.length};Lc.prototype.addPromise=function(a,w){if(!this.keyName_.equals(a.getKeyName()))return b.reject(Error("The certificate name `"+a.getKeyName().toUri()+"` does not match the key name"));
var c=a.getName().toUri();0>this.certificateNameUris_.indexOf(c)&&this.certificateNameUris_.push(c);this.certificates_[c]=new L(a);return this.pibImpl_.addCertificatePromise(a,w)};Lc.prototype.removePromise=function(a,w){if(!L.isValidName(a)||!L.extractKeyNameFromCertName(a).equals(this.keyName_))return b.reject(Error("Certificate name `"+a.toUri()+"` is invalid or does not match key name"));var c=a.toUri(),d=this.certificateNameUris_.indexOf(c);0<=d&&this.certificateNameUris_.splice(d,1);delete this.certificates_[c];
return this.pibImpl_.removeCertificatePromise(a,w)};Lc.prototype.getPromise=function(a,w){var c=a.toUri(),d=this.certificates_[c];if(void 0!=d)return b.resolve(new L(d));if(!L.isValidName(a)||!L.extractKeyNameFromCertName(a).equals(this.keyName_))return b.reject(Error("Certificate name `"+a.toUri()+"` is invalid or does not match key name"));var v=this;return this.pibImpl_.getCertificatePromise(a,w).then(function(a){v.certificates_[c]=a;return b.resolve(new L(a))})};var c=a.Name,Jb=a.PibIdentity,
ic=a.PibIdentityImpl,b=a.SyncPromise,zc=function(a,b){this.identities_={};this.pibImpl_=a;if(null==a)throw Error("The pibImpl is null");this.identityNameUris_=[];for(var c in b)this.identityNameUris_.push(b[c].toUri())};q.PibIdentityContainer=zc;zc.makePromise=function(a,w){return null==a?b.reject(Error("The pibImpl is null")):a.getIdentitiesPromise(w).then(function(w){return b.resolve(new zc(a,w))})};zc.prototype.size=function(){return this.identityNameUris_.length};zc.prototype.addPromise=function(a,
b){var c=a.toUri();if(0>this.identityNameUris_.indexOf(c)){var d=this;this.identityNameUris_.push(c);return ic.makePromise(a,this.pibImpl_,!0,b).then(function(v){d.identities_[c]=v;return d.getPromise(a,b)})}return this.getPromise(a,b)};zc.prototype.removePromise=function(a,b){var c=a.toUri(),d=this.identityNameUris_.indexOf(c);0<=d&&this.identityNameUris_.splice(d,1);delete this.identities_[c];return this.pibImpl_.removeIdentityPromise(a,b)};zc.prototype.getPromise=function(a,c){var r=a.toUri(),
d=this.identities_[r];if(void 0==d){var v=this;return ic.makePromise(a,this.pibImpl_,!1,c).then(function(a){v.identities_[r]=a;return b.resolve(new Jb(a))})}return b.resolve(new Jb(d))};zc.prototype.resetPromise=function(a){var c=this;this.identities_={};return this.pibImpl_.getIdentitiesPromise(a).then(function(a){c.identityNameUris_=[];for(var y in a)c.identityNameUris_.push(a[y].toUri());return b.resolve()})};b=a.SyncPromise;Jb=function(a){this.impl_=a};q.PibIdentity=Jb;Jb.prototype.getName=function(){return this.lock_().getName()};
Jb.prototype.getKeyPromise=function(a,c){try{return this.lock_().getKeyPromise(a,c)}catch(r){return b.reject(r)}};Jb.prototype.getKey=function(a,c,r){return b.complete(c,r,this.getKeyPromise(a,!c))};Jb.prototype.getDefaultKeyPromise=function(a){try{return this.lock_().getDefaultKeyPromise(a)}catch(c){return b.reject(c)}};Jb.prototype.getDefaultKey=function(a,c){return b.complete(a,c,this.getDefaultKeyPromise(!a))};Jb.prototype.addKeyPromise_=function(a,c,r){try{return this.lock_().addKeyPromise(a,
c,r)}catch(d){return b.reject(d)}};Jb.prototype.removeKeyPromise_=function(a,c){try{return this.lock_().removeKeyPromise(a,c)}catch(r){return b.reject(r)}};Jb.prototype.setDefaultKeyPromise_=function(a,c,r){try{return this.lock_().setDefaultKeyPromise(a,c,r)}catch(d){return b.reject(d)}};Jb.prototype.getKeys_=function(){return this.lock_().keys_};Jb.prototype.lock_=function(){if(null==this.impl_)throw Error("Invalid key instance");return this.impl_};var b=a.SyncPromise,Z=function(){};q.PibImpl=Z;
Z.Error=function(a){if(a)return a.__proto__=Z.Error.prototype,a};Z.Error.prototype=Error();Z.Error.prototype.name="PibImplError";Z.prototype.setTpmLocatorPromise=function(a,c){return b.reject(Error("PibImpl.setTpmLocatorPromise is not implemented"))};Z.prototype.getTpmLocatorPromise=function(a){return b.reject(Error("PibImpl.getTpmLocatorPromise is not implemented"))};Z.prototype.hasIdentityPromise=function(a,c){return b.reject(Error("PibImpl.hasIdentityPromise is not implemented"))};Z.prototype.addIdentityPromise=
function(a,c){return b.reject(Error("PibImpl.addIdentityPromise is not implemented"))};Z.prototype.removeIdentityPromise=function(a,c){return b.reject(Error("PibImpl.removeIdentityPromise is not implemented"))};Z.prototype.clearIdentitiesPromise=function(a){return b.reject(Error("PibImpl.clearIdentitiesPromise is not implemented"))};Z.prototype.getIdentitiesPromise=function(a){return b.reject(Error("PibImpl.getIdentitiesPromise is not implemented"))};Z.prototype.setDefaultIdentityPromise=function(a,
c){return b.reject(Error("PibImpl.setDefaultIdentityPromise is not implemented"))};Z.prototype.getDefaultIdentityPromise=function(a){return b.reject(Error("PibImpl.getDefaultIdentityPromise is not implemented"))};Z.prototype.hasKeyPromise=function(a,c){return b.reject(Error("PibImpl.hasKeyPromise is not implemented"))};Z.prototype.addKeyPromise=function(a,c,r,d){return b.reject(Error("PibImpl.addKeyPromise is not implemented"))};Z.prototype.removeKeyPromise=function(a,c){return b.reject(Error("PibImpl.removeKeyPromise is not implemented"))};
Z.prototype.getKeyBitsPromise=function(a,c){return b.reject(Error("PibImpl.getKeyBitsPromise is not implemented"))};Z.prototype.getKeysOfIdentityPromise=function(a,c){return b.reject(Error("PibImpl.getKeysOfIdentityPromise is not implemented"))};Z.prototype.setDefaultKeyOfIdentityPromise=function(a,c,r){return b.reject(Error("PibImpl.setDefaultKeyOfIdentityPromise is not implemented"))};Z.prototype.getDefaultKeyOfIdentityPromise=function(a,c){return b.reject(Error("PibImpl.getDefaultKeyOfIdentityPromise is not implemented"))};
Z.prototype.hasCertificatePromise=function(a,c){return b.reject(Error("PibImpl.hasCertificatePromise is not implemented"))};Z.prototype.addCertificatePromise=function(a,c){return b.reject(Error("PibImpl.addCertificatePromise is not implemented"))};Z.prototype.removeCertificatePromise=function(a,c){return b.reject(Error("PibImpl.removeCertificatePromise is not implemented"))};Z.prototype.getCertificatePromise=function(a,c){return b.reject(Error("PibImpl.getCertificatePromise is not implemented"))};
Z.prototype.getCertificatesOfKeyPromise=function(a,c){return b.reject(Error("PibImpl.getCertificatesOfKeyPromise is not implemented"))};Z.prototype.setDefaultCertificateOfKeyPromise=function(a,c,r){return b.reject(Error("PibImpl.setDefaultCertificateOfKeyPromise is not implemented"))};Z.prototype.getDefaultCertificateOfKeyPromise=function(a,c){return b.reject(Error("PibImpl.getDefaultCertificateOfKeyPromise is not implemented"))};var Va=function(){Z.call(this);this.database=new Dexie("pib");this.database.version(1).stores({globals:"key",
identities:"identityNameUri",keys:"keyNameUri",certificates:"certificateNameUri"});this.database.open()};Va.prototype=new Z;Va.prototype.name="PibIndexedDb";q.PibIndexedDb=Va;Va.getScheme=function(){return"pib-indexeddb"};Va.prototype.setTpmLocatorPromise=function(a,b){return b?Promise.reject(new Z.Error(Error("PibIndexedDb.setTpmLocatorPromise is only supported for async"))):this.database.globals.put({key:"tpmLocator",value:a})};Va.prototype.getTpmLocatorPromise=function(a){return a?Promise.reject(new Z.Error(Error("PibIndexedDb.getTpmLocatorPromise is only supported for async"))):
this.database.globals.get("tpmLocator").then(function(a){return a?Promise.resolve(a.value):Promise.resolve("")})};Va.prototype.hasIdentityPromise=function(a,b){return b?Promise.reject(new Z.Error(Error("PibIndexedDb.hasIdentityPromise is only supported for async"))):this.database.identities.where("identityNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};Va.prototype.addIdentityPromise=function(a,b){if(b)return Promise.reject(new Z.Error(Error("PibIndexedDb.addIdentityPromise is only supported for async")));
var c=this;return this.hasIdentityPromise(a).then(function(b){return b?Promise.resolve():c.database.identities.put({identityNameUri:a.toUri(),defaultKeyUri:null})}).then(function(){return c.database.globals.get("defaultIdentityUri")}).then(function(b){return b?Promise.resolve():c.setDefaultIdentityPromise(a)})};Va.prototype.removeIdentityPromise=function(a,b){if(b)return Promise.reject(new Z.Error(Error("PibIndexedDb.removeIdentityPromise is only supported for async")));var r=a.toUri(),d=this;return this.database.certificates.each(function(b){L.extractIdentityFromCertName(new c(b.certificateNameUri)).equals(a)&&
d.database.certificates.delete(b.certificateNameUri)}).then(function(){return d.database.keys.each(function(b){na.extractIdentityFromKeyName(new c(b.keyNameUri)).equals(a)&&d.database.keys.delete(b.keyNameUri)})}).then(function(){return d.database.identities.delete(r)}).then(function(){return d.database.globals.get("defaultIdentityUri")}).then(function(a){return a&&a.value==r?d.database.globals.delete("defaultIdentityUri"):Promise.resolve()})};Va.prototype.clearIdentitiesPromise=function(a){if(a)return Promise.reject(new Z.Error(Error("PibIndexedDb.clearIdentitiesPromise is only supported for async")));
var b=this;return this.database.globals.delete("defaultIdentityUri").then(function(){return b.database.certificates.clear()}).then(function(){return b.database.keys.clear()}).then(function(){return b.database.identities.clear()})};Va.prototype.getIdentitiesPromise=function(a){if(a)return Promise.reject(new Z.Error(Error("PibIndexedDb.getIdentitiesPromise is only supported for async")));var b=[];return this.database.identities.each(function(a){b.push(new c(a.identityNameUri))}).then(function(){return Promise.resolve(b)})};
Va.prototype.setDefaultIdentityPromise=function(a,b){if(b)return Promise.reject(new Z.Error(Error("PibIndexedDb.setDefaultIdentityPromise is only supported for async")));var c=this;return this.hasIdentityPromise(a).then(function(b){return b?Promise.resolve():c.database.identities.put({identityNameUri:a.toUri(),defaultKeyUri:null})}).then(function(){return c.database.globals.put({key:"defaultIdentityUri",value:a.toUri()})})};Va.prototype.getDefaultIdentityPromise=function(a){return a?Promise.reject(new Z.Error(Error("PibIndexedDb.getDefaultIdentityPromise is only supported for async"))):
this.database.globals.get("defaultIdentityUri").then(function(a){return a?Promise.resolve(new c(a.value)):Promise.reject(new la.Error(Error("No default identity")))})};Va.prototype.hasKeyPromise=function(a,b){return b?Promise.reject(new Z.Error(Error("PibIndexedDb.hasKeyPromise is only supported for async"))):this.database.keys.where("keyNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};Va.prototype.addKeyPromise=function(a,b,r,d){if(d)return Promise.reject(new Z.Error(Error("PibIndexedDb.addKeyPromise is only supported for async")));
var v=this;return this.addIdentityPromise(a).then(function(){return v.hasKeyPromise(b)}).then(function(a){return a?v.database.keys.update(b.toUri(),{keyDer:r}):v.database.keys.put({keyNameUri:b.toUri(),keyDer:r,defaultCertificateUri:null})}).then(function(){return v.database.identities.get(a.toUri())}).then(function(a){return a&&null!=a.defaultKeyUri?v.hasKeyPromise(new c(a.defaultKeyUri)):Promise.resolve(!1)}).then(function(c){return c?Promise.resolve():v.setDefaultKeyOfIdentityPromise(a,b)})};Va.prototype.removeKeyPromise=
function(a,b){if(b)return Promise.reject(new Z.Error(Error("PibIndexedDb.removeKeyPromise is only supported for async")));var r=this;return this.database.certificates.each(function(b){L.extractKeyNameFromCertName(new c(b.certificateNameUri)).equals(a)&&r.database.certificates.delete(b.certificateNameUri)}).then(function(){return r.database.keys.delete(a.toUri())})};Va.prototype.getKeyBitsPromise=function(a,b){return b?Promise.reject(new Z.Error(Error("PibIndexedDb.getKeyBitsPromise is only supported for async"))):
this.database.keys.get(a.toUri()).then(function(b){return b?Promise.resolve(new p(b.keyDer)):Promise.reject(new la.Error(Error("Key `"+a.toUri()+"` does not exist")))})};Va.prototype.getKeysOfIdentityPromise=function(a,b){if(b)return Promise.reject(new Z.Error(Error("PibIndexedDb.getKeysOfIdentityPromise is only supported for async")));var r=[];return this.database.keys.each(function(b){b=new c(b.keyNameUri);na.extractIdentityFromKeyName(b).equals(a)&&r.push(b)}).then(function(){return Promise.resolve(r)})};
Va.prototype.setDefaultKeyOfIdentityPromise=function(a,b,c){if(c)return Promise.reject(new Z.Error(Error("PibIndexedDb.setDefaultKeyOfIdentityPromise is only supported for async")));var d=this;return this.hasKeyPromise(b).then(function(a){return a?Promise.resolve():Promise.reject(new la.Error(Error("Key `"+b.toUri()+"` does not exist")))}).then(function(){return d.database.identities.update(a.toUri(),{defaultKeyUri:b.toUri()})})};Va.prototype.getDefaultKeyOfIdentityPromise=function(a,b){if(b)return Promise.reject(new Z.Error(Error("PibIndexedDb.getDefaultKeyOfIdentityPromise is only supported for async")));
var r=this;return this.database.identities.get(a.toUri()).then(function(b){if(b){if(null!=b.defaultKeyUri){var w=new c(b.defaultKeyUri);return r.hasKeyPromise(w).then(function(b){return b?Promise.resolve(w):Promise.reject(new la.Error(Error("No default key for identity `"+a.toUri()+"`")))})}return Promise.reject(new la.Error(Error("No default key for identity `"+a.toUri()+"`")))}return Promise.reject(new la.Error(Error("Identity `"+a.toUri()+"` does not exist")))})};Va.prototype.hasCertificatePromise=
function(a,b){return b?Promise.reject(new Z.Error(Error("PibIndexedDb.hasCertificatePromise is only supported for async"))):this.database.certificates.where("certificateNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};Va.prototype.addCertificatePromise=function(a,b){if(b)return Promise.reject(new Z.Error(Error("PibIndexedDb.addCertificatePromise is only supported for async")));var r=a.getKeyName(),d=r.toUri(),v=this,B=a.getContent();return this.addKeyPromise(a.getIdentity(),
r,B.buf()).then(function(){return v.database.certificates.put({certificateNameUri:a.getName().toUri(),encoding:a.wireEncode().buf()})}).then(function(){return v.database.keys.get(d)}).then(function(a){return a&&null!=a.defaultCertificateUri?v.hasCertificatePromise(new c(a.defaultCertificateUri)):Promise.resolve(!1)}).then(function(b){return b?Promise.resolve():v.setDefaultCertificateOfKeyPromise(r,a.getName())})};Va.prototype.removeCertificatePromise=function(a,b){return b?Promise.reject(new Z.Error(Error("PibIndexedDb.removeCertificatePromise is only supported for async"))):
this.database.certificates.delete(a.toUri())};Va.prototype.getCertificatePromise=function(a,b){return b?Promise.reject(new Z.Error(Error("PibIndexedDb.getCertificatePromise is only supported for async"))):this.database.certificates.get(a.toUri()).then(function(b){if(b){var c=new L;c.wireDecode(b.encoding);return Promise.resolve(c)}return Promise.reject(new la.Error(Error("Certificate `"+a.toUri()+"` does not exit")))})};Va.prototype.getCertificatesOfKeyPromise=function(a,b){if(b)return Promise.reject(new Z.Error(Error("PibIndexedDb.getCertificatesOfKeyPromise is only supported for async")));
var r=[];return this.database.certificates.each(function(b){b=new c(b.certificateNameUri);L.extractKeyNameFromCertName(b).equals(a)&&r.push(b)}).then(function(){return Promise.resolve(r)})};Va.prototype.setDefaultCertificateOfKeyPromise=function(a,b,c){if(c)return Promise.reject(new Z.Error(Error("PibIndexedDb.setDefaultCertificateOfKeyPromise is only supported for async")));var d=this;return this.hasCertificatePromise(b).then(function(a){return a?Promise.resolve():Promise.reject(new la.Error(Error("Certificate `"+
b.toUri()+"` does not exist")))}).then(function(){return d.database.keys.update(a.toUri(),{defaultCertificateUri:b.toUri()})})};Va.prototype.getDefaultCertificateOfKeyPromise=function(a,b){if(b)return Promise.reject(new Z.Error(Error("PibIndexedDb.getDefaultCertificateOfKeyPromise is only supported for async")));var r=this;return this.database.keys.get(a.toUri()).then(function(b){return b&&null!=b.defaultCertificateUri?r.getCertificatePromise(new c(b.defaultCertificateUri)):Promise.reject(new la.Error(Error("No default certificate for key `"+
a.toUri()+"`")))})};var c=a.Name,na=a.PibKey,Lb=a.PibKeyImpl,b=a.SyncPromise,Mc=function(a,b,r){this.keys_={};this.identityName_=new c(a);this.pibImpl_=b;if(null==b)throw Error("The pibImpl is null");this.keyNameUris_=[];for(var d in r)this.keyNameUris_.push(r[d].toUri())};q.PibKeyContainer=Mc;Mc.makePromise=function(a,c,r){return null==c?b.reject(Error("The pibImpl is null")):c.getKeysOfIdentityPromise(a,r).then(function(r){return b.resolve(new Mc(a,c,r))})};Mc.prototype.size=function(){return this.keyNameUris_.length};
Mc.prototype.addPromise=function(a,c,r){if(!this.identityName_.equals(na.extractIdentityFromKeyName(c)))return b.reject(Error("The key name `"+c.toUri()+"` does not match the identity name `"+this.identityName_.toUri()+"`"));var d=c.toUri();0>this.keyNameUris_.indexOf(d)&&this.keyNameUris_.push(d);var v=this;return Lb.makePromise(c,a,this.pibImpl_,r).then(function(a){v.keys_[d]=a;return v.getPromise(c,r)})};Mc.prototype.removePromise=function(a,c){if(!this.identityName_.equals(na.extractIdentityFromKeyName(a)))return b.reject(Error("Key name `"+
a.toUri()+"` does not match identity `"+this.identityName_.toUri()+"`"));var r=a.toUri(),d=this.keyNameUris_.indexOf(r);0<=d&&this.keyNameUris_.splice(d,1);delete this.keys_[r];return this.pibImpl_.removeKeyPromise(a,c)};Mc.prototype.getPromise=function(a,c){if(!this.identityName_.equals(na.extractIdentityFromKeyName(a)))return b.reject(Error("Key name `"+a.toUri()+"` does not match identity `"+this.identityName_.toUri()+"`"));var r=a.toUri(),d=this.keys_[r];if(void 0==d){var v=this;return Lb.makePromise(a,
this.pibImpl_,c).then(function(a){v.keys_[r]=a;return b.resolve(new na(a))})}return b.resolve(new na(d))};Mc.prototype.getKeyNames=function(){var a=[],b;for(b in this.keys_)a.push(new c(b));return a};c=a.Name;L=a.CertificateV2;b=a.SyncPromise;na=function(a){this.impl_=a};q.PibKey=na;na.prototype.getName=function(){return this.lock_().getName()};na.prototype.getIdentityName=function(){return this.lock_().getIdentityName()};na.prototype.getKeyType=function(){return this.lock_().getKeyType()};na.prototype.getPublicKey=
function(){return this.lock_().getPublicKey()};na.prototype.getCertificatePromise=function(a,c){try{return this.lock_().getCertificatePromise(a,c)}catch(r){return b.reject(r)}};na.prototype.getCertificate=function(a,c,r){return b.complete(c,r,this.getCertificatePromise(a,!c))};na.prototype.getDefaultCertificatePromise=function(a){try{return this.lock_().getDefaultCertificatePromise(a)}catch(c){return b.reject(c)}};na.prototype.getDefaultCertificate=function(a,c){return b.complete(a,c,this.getDefaultCertificatePromise(!a))};
na.constructKeyName=function(a,b){var r=new c(a);r.append(L.KEY_COMPONENT).append(b);return r};na.isValidKeyName=function(a){return a.size()>L.MIN_KEY_NAME_LENGTH&&a.get(-L.MIN_KEY_NAME_LENGTH).equals(L.KEY_COMPONENT)};na.extractIdentityFromKeyName=function(a){if(!na.isValidKeyName(a))throw Error("Key name `"+a.toUri()+"` does not follow the naming conventions");return a.getPrefix(-L.MIN_KEY_NAME_LENGTH)};na.prototype.addCertificatePromise_=function(a,b){return this.lock_().addCertificatePromise(a,
b)};na.prototype.removeCertificatePromise_=function(a,b){return this.lock_().removeCertificatePromise(a,b)};na.prototype.setDefaultCertificatePromise_=function(a,b){return this.lock_().setDefaultCertificatePromise(a,b)};na.prototype.getCertificates_=function(){return this.lock_().certificates_};na.prototype.lock_=function(){if(null==this.impl_)throw Error("Invalid key instance");return this.impl_};var c=a.Name,p=a.Blob,L=a.CertificateV2,la=a.Pib,na=a.PibKey,b=a.SyncPromise,Z=a.PibImpl,ta=function(){Z.call(this);
this.tpmLocator_="";this.defaultIdentityName_=null;this.identityNames_=[];this.defaultKeyNames_={};this.keys_={};this.defaultCertificateNames_={};this.certificates_={}};ta.prototype=new Z;ta.prototype.name="PibMemory";q.PibMemory=ta;ta.getScheme=function(){return"pib-memory"};ta.prototype.setTpmLocatorPromise=function(a){this.tpmLocator_=a;return b.resolve()};ta.prototype.getTpmLocatorPromise=function(){return b.resolve(this.tpmLocator_)};ta.prototype.hasIdentityPromise=function(a){return b.resolve(this.hasIdentity_(a))};
ta.prototype.hasIdentity_=function(a){for(var b in this.identityNames_)if(this.identityNames_[b].equals(a))return!0;return!1};ta.prototype.addIdentityPromise=function(a){this.addIdentity_(a);return b.resolve()};ta.prototype.addIdentity_=function(a){a=new c(a);this.hasIdentity_(a)||this.identityNames_.push(a);null===this.defaultIdentityName_&&(this.defaultIdentityName_=a)};ta.prototype.removeIdentityPromise=function(a){for(var c=this.identityNames_.length-1;0<=c;--c)this.identityNames_[c].equals(a)&&
this.identityNames_.splice(c,1);null!==this.defaultIdentityName_&&a.equals(this.defaultIdentityName_)&&(this.defaultIdentityName_=null);a=this.getKeysOfIdentity_(a);for(c in a)this.removeKey_(a[c]);return b.resolve()};ta.prototype.clearIdentitiesPromise=function(){this.defaultIdentityName_=null;this.identityNames_=[];this.defaultKeyNames_={};this.keys_={};this.defaultCertificateNames_={};this.certificates_={};return b.resolve()};ta.prototype.getIdentitiesPromise=function(){var a=[],w;for(w in this.identityNames_)a.push(new c(this.identityNames_[w]));
return b.resolve(a)};ta.prototype.setDefaultIdentityPromise=function(a){this.addIdentity_(a);this.defaultIdentityName_=new c(a);return b.resolve()};ta.prototype.getDefaultIdentityPromise=function(){return null!==this.defaultIdentityName_?b.resolve(new c(this.defaultIdentityName_)):b.reject(new la.Error(Error("No default identity")))};ta.prototype.hasKeyPromise=function(a){return b.resolve(this.hasKey_(a))};ta.prototype.hasKey_=function(a){return a.toUri()in this.keys_};ta.prototype.addKeyPromise=
function(a,c,r){this.addKey_(a,c,r);return b.resolve()};ta.prototype.addKey_=function(a,b,r){this.addIdentity_(a);b=new c(b);this.keys_[b.toUri()]=new p(r,!0);a=a.toUri();a in this.defaultKeyNames_||(this.defaultKeyNames_[a]=b)};ta.prototype.removeKeyPromise=function(a){this.removeKey_(a);return b.resolve()};ta.prototype.removeKey_=function(a){var b=na.extractIdentityFromKeyName(a);delete this.keys_[a.toUri()];delete this.defaultKeyNames_[b.toUri()];a=this.getCertificatesOfKey_(a);for(var c in a)this.removeCertificate_(a[c])};
ta.prototype.getKeyBitsPromise=function(a){if(!this.hasKey_(a))return b.reject(new la.Error(Error("Key `"+a.toUri()+"` not found")));a=this.keys_[a.toUri()];return b.resolve(a)};ta.prototype.getKeysOfIdentityPromise=function(a){return b.resolve(this.getKeysOfIdentity_(a))};ta.prototype.getKeysOfIdentity_=function(a){var b=[],r;for(r in this.keys_){var d=new c(r);a.equals(na.extractIdentityFromKeyName(d))&&b.push(d)}return b};ta.prototype.setDefaultKeyOfIdentityPromise=function(a,w){if(!this.hasKey_(w))return b.reject(new la.Error(Error("Key `"+
w.toUri()+"` not found")));this.defaultKeyNames_[a.toUri()]=new c(w);return b.resolve()};ta.prototype.getDefaultKeyOfIdentityPromise=function(a){var w=this.defaultKeyNames_[a.toUri()];return void 0==w?b.reject(new la.Error(Error("No default key for identity `"+a.toUri()+"`"))):b.resolve(new c(w))};ta.prototype.hasCertificatePromise=function(a){return b.resolve(this.hasCertificate_(a))};ta.prototype.hasCertificate_=function(a){return a.toUri()in this.certificates_};ta.prototype.addCertificatePromise=
function(a){var w=new c(a.getName()),r=a.getKeyName(),d=a.getIdentity();this.addKey_(d,r,a.getContent().buf());this.certificates_[w.toUri()]=new L(a);a=r.toUri();a in this.defaultCertificateNames_||(this.defaultCertificateNames_[a]=w);return b.resolve()};ta.prototype.removeCertificatePromise=function(a){this.removeCertificate_(a);return b.resolve()};ta.prototype.removeCertificate_=function(a){delete this.certificates_[a.toUri()];var b=L.extractKeyNameFromCertName(a).toUri(),c=this.defaultCertificateNames_[b];
void 0!=c&&c.equals(a)&&delete this.defaultCertificateNames_[b]};ta.prototype.getCertificatePromise=function(a){return this.hasCertificate_(a)?b.resolve(new L(this.certificates_[a.toUri()])):b.reject(new la.Error(Error("Certificate `"+a.toUri()+"` does not exist")))};ta.prototype.getCertificatesOfKeyPromise=function(a){return b.resolve(this.getCertificatesOfKey_(a))};ta.prototype.getCertificatesOfKey_=function(a){var b=[],r;for(r in this.certificates_)L.extractKeyNameFromCertName(this.certificates_[r].getName()).equals(a)&&
b.push(new c(r));return b};ta.prototype.setDefaultCertificateOfKeyPromise=function(a,w){if(!this.hasCertificate_(w))return b.reject(new la.Error(Error("Certificate `"+w.toUri()+"` does not exist")));this.defaultCertificateNames_[a.toUri()]=new c(w);return b.resolve()};ta.prototype.getDefaultCertificateOfKeyPromise=function(a){var c=this.defaultCertificateNames_[a.toUri()];if(void 0==c)return b.reject(new la.Error(Error("No default certificate for key `"+a.toUri()+"`")));a=this.certificates_[c.toUri()];
return b.resolve(new L(a))};qd=a.ConfigFile;b=a.SyncPromise;la=function(a,b,c){this.defaultIdentity_=null;this.scheme_=a;this.location_=b;this.identities_=null;this.pibImpl_=c;this.initializeTpmLocator_=this.initializePibLocator_=this.initializeTpm_=null;this.isInitialized_=this.initializeAllowReset_=!1;if(null==c)throw Error("The pibImpl is null");};q.Pib=la;la.Error=function(a){if(a)return a.__proto__=la.Error.prototype,a};la.Error.prototype=Error();la.Error.prototype.name="PibError";la.prototype.getScheme=
function(){return this.scheme_};la.prototype.getPibLocator=function(){return this.scheme_+":"+this.location_};la.prototype.setTpmLocatorPromise=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.doSetTpmLocatorPromise_(a,b)})};la.prototype.doSetTpmLocatorPromise_=function(a,c){var r=this;return this.pibImpl_.getTpmLocatorPromise(c).then(function(d){return a==d?b.resolve():r.resetPromise_(c).then(function(){return r.pibImpl_.setTpmLocatorPromise(a,c)})})};la.prototype.getTpmLocatorPromise=
function(a){var c=this;return this.initializePromise_(a).then(function(){return c.pibImpl_.getTpmLocatorPromise(a)}).then(function(a){return""==a?b.reject(new la.Error(Error("TPM info does not exist"))):b.resolve(a)})};la.prototype.getIdentityPromise=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.identities_.getPromise(a,b)})};la.prototype.getIdentity=function(a,c,r){return b.complete(c,r,this.getIdentityPromise(a,!c))};la.prototype.getDefaultIdentityPromise=function(a){if(null==
this.defaultIdentity_){var c=this;return this.initializePromise_(a).then(function(){return c.pibImpl_.getDefaultIdentityPromise(a)}).then(function(b){return c.identities_.getPromise(b,a)}).then(function(a){c.defaultIdentity_=a;return b.resolve(c.defaultIdentity_)})}return b.resolve(this.defaultIdentity_)};la.prototype.getDefaultIdentity=function(a,c){return b.complete(a,c,this.getDefaultIdentityPromise(!a))};la.prototype.resetPromise_=function(a){var b=this;return this.pibImpl_.clearIdentitiesPromise(a).then(function(){return b.pibImpl_.setTpmLocatorPromise("",
a)}).then(function(){b.defaultIdentity_=null;return zc.makePromise(b.pibImpl_,a)}).then(function(c){b.identities_=c;return b.identities_.resetPromise(a)})};la.prototype.addIdentityPromise_=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.identities_.addPromise(a,b)})};la.prototype.removeIdentityPromise_=function(a,b){null!=this.defaultIdentity_&&this.defaultIdentity_.getName().equals(a)&&(this.defaultIdentity_=null);var c=this;return this.initializePromise_(b).then(function(){return c.identities_.removePromise(a,
b)})};la.prototype.setDefaultIdentityPromise_=function(a,c){var r=this;return this.initializePromise_(c).then(function(){return r.identities_.addPromise(a,c)}).then(function(b){r.defaultIdentity_=b;return r.pibImpl_.setDefaultIdentityPromise(a)}).then(function(){return b.resolve(r.defaultIdentity_)})};la.prototype.initializePromise_=function(a){if(this.isInitialized_)return b.resolve();var c=this;return zc.makePromise(this.pibImpl_,a).then(function(r){c.identities_=r;return null!=c.initializeTpm_?
c.initializeFromLocatorsPromise_(a):b.resolve()}).then(function(){c.isInitialized_=!0;return b.resolve()})};la.prototype.initializeFromLocatorsPromise_=function(a){var c=[null],r=[null];C.parseAndCheckPibLocator_(this.initializePibLocator_,c,r);var d=c[0]+":"+r[0],v,B=this;return this.pibImpl_.getTpmLocatorPromise(a).then(function(c){var r=[null],w=[null];C.parseAndCheckTpmLocator_(B.initializeTpmLocator_,r,w);v=r[0]+":"+w[0];var r=!1,k;qd&&(k=new qd);if(qd&&d==C.getDefaultPibLocator_(k))""!=c&&c!=
C.getDefaultTpmLocator_(k)&&(r=!0,v=C.getDefaultTpmLocator_(k));else if(""!=c&&c!=v)if(B.initializeAllowReset_)r=!0;else return b.reject(new Xd(Error("The supplied TPM locator does not match the TPM locator in the PIB: "+c+" != "+v)));return r?B.resetPromise_(a):b.resolve()}).then(function(){C.setUpTpm_(B.initializeTpm_,v);B.initializeTpm_.isInitialized_=!0;return B.doSetTpmLocatorPromise_(v,a)})};var C=a.KeyChain,Xd=a.LocatorMismatchError,zc=a.PibIdentityContainer,c=a.Name,la=a.Pib,Mc=a.PibKeyContainer,
b=a.SyncPromise,ic=function(){};q.PibIdentityImpl=ic;ic.makePromise=function(a,w,r,d){var v=new ic;return Mc.makePromise(a,w,d).then(function(B){v.defaultKey_=null;v.identityName_=new c(a);v.keys_=B;v.pibImpl_=w;return null==w?b.reject(Error("The pibImpl is null")):r?w.addIdentityPromise(v.identityName_,d).then(function(){return b.resolve(v)}):w.hasIdentityPromise(v.identityName_,d).then(function(a){return a?b.resolve(v):b.reject(new la.Error(Error("Identity "+v.identityName_.toUri()+" does not exist")))})})};
ic.prototype.getName=function(){return this.identityName_};ic.prototype.addKeyPromise=function(a,b,c){return this.keys_.addPromise(a,b,c)};ic.prototype.removeKeyPromise=function(a,b){null!==this.defaultKey_&&this.defaultKey_.getName().equals(a)&&(this.defaultKey_=null);return this.keys_.removePromise(a,b)};ic.prototype.getKeyPromise=function(a,b){return this.keys_.getPromise(a,b)};ic.prototype.setDefaultKeyPromise=function(a,w,r){var d=this;if(a instanceof c){var v=a,B=w;return this.keys_.getPromise(v,
B).then(function(a){d.defaultKey_=a;return d.pibImpl_.setDefaultKeyOfIdentityPromise(d.identityName_,v,B)}).then(function(){return b.resolve(d.defaultKey_)})}v=w;B=r;return this.addKeyPromise(a,v,B).then(function(){return d.setDefaultKeyPromise(v,B)})};ic.prototype.getDefaultKeyPromise=function(a){var c=this;return null===this.defaultKey_?this.pibImpl_.getDefaultKeyOfIdentityPromise(this.identityName_,a).then(function(b){return c.keys_.getPromise(b,a)}).then(function(a){c.defaultKey_=a;return b.resolve(c.defaultKey_)}):
b.resolve(this.defaultKey_)};c=a.Name;Ba=a.PublicKey;p=a.Blob;la=a.Pib;na=a.PibKey;Z=a.PibImpl;Lc=a.PibCertificateContainer;b=a.SyncPromise;Lb=function(){};q.PibKeyImpl=Lb;Lb.makePromise=function(a,w,r,d){var v=new Lb;v.defaultCertificate_=null;if(w instanceof Z){var B=w,k=r;return null==B?b.reject(Error("The pibImpl is null")):Lc.makePromise(a,B,k).then(function(b){v.identityName_=na.extractIdentityFromKeyName(a);v.keyName_=new c(a);v.pibImpl_=B;v.certificates_=b;return v.pibImpl_.getKeyBitsPromise(v.keyName_,
k)}).then(function(a){v.keyEncoding_=a;try{publicKey=new Ba(v.keyEncoding_)}catch(c){return b.reject(new la.Error(Error("Error decoding public key")))}v.keyType_=publicKey.getKeyType();return b.resolve(v)})}B=r;k=d;return null==B?b.reject(Error("The pibImpl is null")):Lc.makePromise(a,B,k).then(function(r){v.identityName_=na.extractIdentityFromKeyName(a);v.keyName_=new c(a);v.keyEncoding_=new p(w,!0);v.pibImpl_=B;v.certificates_=r;try{publicKey=new Ba(v.keyEncoding_),v.keyType_=publicKey.getKeyType()}catch(d){return b.reject(Error("Invalid key encoding"))}return v.pibImpl_.addKeyPromise(v.identityName_,
v.keyName_,w,k)}).then(function(){return b.resolve(v)})};Lb.prototype.getName=function(){return this.keyName_};Lb.prototype.getIdentityName=function(){return this.identityName_};Lb.prototype.getKeyType=function(){return this.keyType_};Lb.prototype.getPublicKey=function(){return this.keyEncoding_};Lb.prototype.addCertificatePromise=function(a,b){return this.certificates_.addPromise(a,b)};Lb.prototype.removeCertificatePromise=function(a,b){null!==this.defaultCertificate_&&this.defaultCertificate_.getName().equals(a)&&
(this.defaultCertificate_=null);return this.certificates_.removePromise(a,b)};Lb.prototype.getCertificatePromise=function(a,b){return this.certificates_.getPromise(a,b)};Lb.prototype.setDefaultCertificatePromise=function(a,w){var r=this,d;return b.resolve().then(function(){return a instanceof c?b.resolve(a):r.addCertificatePromise(a).then(function(){return b.resolve(a.getName())})}).then(function(a){d=a;return r.certificates_.getPromise(d,w)}).then(function(a){r.defaultCertificate_=a;return r.pibImpl_.setDefaultCertificateOfKeyPromise(r.keyName_,
d,w)}).then(function(){return b.resolve(r.defaultCertificate_)})};Lb.prototype.getDefaultCertificatePromise=function(a){var c=this;return null===this.defaultCertificate_?this.pibImpl_.getDefaultCertificateOfKeyPromise(this.keyName_,a).then(function(a){c.defaultCertificate_=a;return b.resolve(c.defaultCertificate_)}):b.resolve(c.defaultCertificate_)};var we=function(a,b,c,d,v){this.interest=a;this.onVerified=b;this.onValidationFailed=c;this.retry=d;this.stepCount=v};q.ValidationRequest=we;var ba=a,
p=a.Blob,M=a.DataUtils,x=a.SecurityException,qb=a.DigestSha256Signature,Da=a.Sha256WithRsaSignature,Sa=a.Sha256WithEcdsaSignature,Na=a.VerificationHelpers,Aa=a.DigestAlgorithm,Ba=a.PublicKey,b=a.SyncPromise,fb=function(){};q.PolicyManager=fb;fb.prototype.skipVerifyAndTrust=function(a){throw Error("PolicyManager.skipVerifyAndTrust is not implemented");};fb.prototype.requireVerify=function(a){throw Error("PolicyManager.requireVerify is not implemented");};fb.prototype.checkVerificationPolicy=function(a,
b,c,d,v){throw Error("PolicyManager.checkVerificationPolicy is not implemented");};fb.prototype.checkSigningPolicy=function(a,b){throw Error("PolicyManager.checkSigningPolicy is not implemented");};fb.prototype.inferSigningIdentity=function(a){throw Error("PolicyManager.inferSigningIdentity is not implemented");};fb.verifyUsesString_=null;fb.setVerifyUsesString_=function(){var a=ba.createHash("sha256").digest();fb.verifyUsesString_="string"===typeof a};fb.verifySignature=function(a,c,r,d){if(a instanceof
Da||a instanceof Sa)if(r.isNull())d(!1);else{var v;try{v=new Ba(r)}catch(B){throw new x(Error("PolicyManager.verify: Error decoding public key: "+B));}b.complete(d,Na.verifySignaturePromise(c.signedBuf(),a.getSignature(),v,Aa.SHA256,!d))}else if(a instanceof qb)d(Na.verifyDigest(c.signedBuf(),a.getSignature(),Aa.SHA256));else throw new x(Error("PolicyManager.verify: Signature type is unknown"));};var Ia=a.IdentityCertificate,dd=function(){this.cache={}};q.CertificateCache=dd;dd.prototype.insertCertificate=
function(a){var b=a.getName().getPrefix(-1);this.cache[b.toUri()]=a.wireEncode()};dd.prototype.deleteCertificate=function(a){delete this.cache[a.toUri()]};dd.prototype.getCertificate=function(a){a=this.cache[a.toUri()];if(void 0===a)return null;var b=new Ia;b.wireDecode(a);return b};dd.prototype.reset=function(){this.cache={}};var Yd=Ib=a,c=a.Name,Q=a.Data,F=a.Interest,U=a.KeyLocator,Ga=a.KeyLocatorType,p=a.Blob,Ia=a.IdentityCertificate,L=a.CertificateV2,Wb=a.CertificateCacheV2,dc=a.BoostInfoParser,
Ua=a.NdnRegexTopMatcher,dd=a.CertificateCache,we=a.ValidationRequest,x=a.SecurityException,s=a.WireFormat,fb=a.PolicyManager,O=a.NdnCommon,ua=function(a,b,c,d,v,B){fb.call(this);void 0==b&&(b=null);void 0==c&&(c=5);void 0==d&&(d=3E3);void 0==v&&(v=36E5);void 0==B&&(B=1E3);null==b&&(b=new dd);b instanceof dd?(this.isSecurityV1_=!0,this.certificateCache_=b,this.certificateCacheV2_=null):(this.isSecurityV1_=!1,this.certificateCache_=null,this.certificateCacheV2_=b);this.maxDepth=c;this.keyGraceInterval=
d;this.keyTimestampTtl=v;this.maxTrackedKeys=B;this.reset();null!=a&&""!=a&&this.load(a)};ua.prototype=new fb;ua.prototype.name="ConfigPolicyManager";q.ConfigPolicyManager=ua;ua.prototype.reset=function(){this.isSecurityV1_?this.certificateCache_.reset():this.certificateCacheV2_.clear();this.fixedCertificateCache={};this.keyTimestamps={};this.requiresVerification=!0;this.config=new dc;this.refreshManager=new ua.TrustAnchorRefreshManager(this.isSecurityV1_)};ua.prototype.load=function(a,b){this.reset();
this.config.read(a,b);this.loadTrustAnchorCertificates()};ua.prototype.requireVerify=function(a){return this.requiresVerification};ua.prototype.checkSigningPolicy=function(a,b){return!0};ua.prototype.skipVerifyAndTrust=function(a){return!this.requiresVerification};ua.prototype.checkVerificationPolicy=function(a,b,c,d,v){var B=a.getName(),k="data";a instanceof F&&(B=B.getPrefix(-4),k="interest");v=ua.extractSignature(a,v);if(null==v){try{d(a,"Cannot extract the signature from "+a.getName().toUri())}catch(m){console.log("Error in onValidationFailed: "+
O.getErrorWithStackTrace(m))}return null}var n=["unknown"],B=this.getCertificateInterest_(b,k,B,v,n);if(null==B){try{d(a,n[0])}catch(p){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(p))}return null}if(0<B.getName().size()){var s=this;return new we(B,function(v){var B;if(s.isSecurityV1_){try{B=new Ia(v)}catch(k){try{d(a,"Cannot decode certificate "+v.getName().toUri())}catch(m){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(m))}return null}s.certificateCache_.insertCertificate(B)}else{try{B=
new L(v)}catch(Nc){try{d(a,"Cannot decode certificate "+v.getName().toUri())}catch(Zb){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(Zb))}return null}s.certificateCacheV2_.insert(B)}s.checkVerificationPolicy(a,b+1,c,d)},d,2,b+1)}if(a instanceof F){var B=U.getFromSignature(v).getKeyName(),q;q=this.isSecurityV1_?Ia.certificateNameToPublicKeyName(B):B;var x=a.getName().get(-4).toNumber();if(!this.interestTimestampIsFresh(q,x,n)){try{d(a,n[0])}catch(Nc){console.log("Error in onValidationFailed: "+
O.getErrorWithStackTrace(Nc))}return null}}s=this;this.verify(v,a.wireEncode(),function(b,w){if(b){try{c(a)}catch(v){console.log("Error in onVerified: "+O.getErrorWithStackTrace(v))}a instanceof F&&s.updateTimestampForKey(q,x)}else try{d(a,w)}catch(B){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(B))}})};ua.prototype.getCertificateInterest_=function(a,b,c,d,v){if(a>this.maxDepth)return v[0]="The verification stepCount "+a+" exceeded the maxDepth "+this.maxDepth,null;var B;try{B=
this.findMatchingRule(c,b)}catch(k){return null}if(null==B)return v[0]="No matching rule found for "+c.toUri(),null;if(!U.canGetFromSignature(d))return v[0]="The signature type does not support a KeyLocator",null;a=a=U.getFromSignature(d);a=a.getKeyName();if(0==a.size())return v[0]="The signature KeyLocator doesn't have a key name",null;if(!this.checkSignatureMatch(a,c,B,v))return null;this.refreshManager.refreshAnchors();this.isSecurityV1_?(c=this.refreshManager.getCertificate(a),null==c&&(c=this.certificateCache_.getCertificate(a))):
(c=this.refreshManager.getCertificateV2(a),null==c&&(c=this.certificateCacheV2_.find(a)));return null==c?new F(a):new F};ua.prototype.loadTrustAnchorCertificates=function(){for(var a=this.config.getRoot().get("validator/trust-anchor"),b=0;b<a.length;++b){var c=a[b],d=c.get("type")[0].getValue(),v=!1,B;if("file"==d)B=c.get("file-name")[0].getValue(),v=!0;else if("base64"==d)B=c.get("base64-string")[0].getValue(),v=!1;else if("dir"==d){d=c.get("dir")[0].getValue();v=0;c=c.get("refresh");1<=c.length&&
(c=c[0].getValue().match(/(\d+)([hms])/),null==c?v=0:(v=parseInt(c[1]),"s"!=c[2]&&(v*=60,"m"!=c[2]&&(v*=60))));this.refreshManager.addDirectory(d,1E3*v);continue}else if("any"==d){this.requiresVerification=!1;break}this.isSecurityV1_?this.lookupCertificate(B,v):this.lookupCertificateV2(B,v)}};ua.prototype.checkSignatureMatch=function(a,b,r,d){r=r.get("checker")[0];var v=r.get("type")[0].getValue();if("fixed-signer"==v){b=r.get("signer")[0];r=b.get("type")[0].getValue();if("file"==r){if(r=this.isSecurityV1_?
this.lookupCertificate(b.get("file-name")[0].getValue(),!0):this.lookupCertificateV2(b.get("file-name")[0].getValue(),!0),null==r)return d[0]="Can't find fixed-signer certificate file: "+b.get("file-name")[0].getValue(),!1}else if("base64"==r){if(r=this.isSecurityV1_?this.lookupCertificate(b.get("base64-string")[0].getValue(),!1):this.lookupCertificateV2(b.get("base64-string")[0].getValue(),!1),null==r)return d[0]="Can't find fixed-signer certificate base64: "+b.get("base64-string")[0].getValue(),
!1}else return d[0]="Unrecognized fixed-signer signerType: "+r,!1;if(r.getName().equals(a))return!0;d[0]='fixed-signer cert name "'+r.getName().toUri()+'" does not equal signatureName "'+a.toUri()+'"';return!1}if("hierarchical"==v){r=new Ua("^([^<KEY>]*)<KEY>(<>*)<ksk-.+><ID-CERT>");if(r.match(a)){a=r.expand("\\1").append(r.expand("\\2"));if(ua.matchesRelation(b,a,"is-prefix-of"))return!0;d[0]='The hierarchical objectName "'+b.toUri()+'" is not a prefix of "'+a.toUri()+'"';return!1}if(!this.isSecurityV1_&&
(r=new Ua("^(<>*)<KEY><>$"),r.match(a))){a=r.expand("\\1");if(ua.matchesRelation(b,a,"is-prefix-of"))return!0;d[0]='The hierarchical objectName "'+b.toUri()+'" is not a prefix of "'+a.toUri()+'"';return!1}d[0]='The hierarchical identityRegex "^([^<KEY>]*)<KEY>(<>*)<ksk-.+><ID-CERT>" does not match signatureName "'+a.toUri()+'"';return!1}if("customized"==v){var B=r.get("key-locator")[0];r=B.getFirstValue("relation");if(null!=r){b=new c(B.get("name")[0].getValue());if(ua.matchesRelation(a,b,r))return!0;
d[0]='The custom signatureName "'+a.toUri()+'" does not match matchName "'+b.toUri()+'" using relation '+r;return!1}var k=B.getFirstValue("regex");if(null!=k){if((new Ua(simpleKeyRegex)).match(a))return!0;d[0]='The custom signatureName "'+a.toUri()+'" does not regex match simpleKeyRegex "'+k+'"';return!1}r=B.get("hyper-relation");if(1<=r.length){r=r[0];var k=r.getFirstValue("k-regex"),m=r.getFirstValue("k-expand"),B=r.getFirstValue("p-regex"),n=r.getFirstValue("p-expand");r=r.getFirstValue("h-relation");
if(null!=k&&null!=m&&null!=B&&null!=n&&null!=r){v=new Ua(k);if(!v.match(a))return d[0]='The custom hyper-relation signatureName "'+a.toUri()+'" does not match the keyRegex "'+k+'"',!1;a=v.expand(m);v=new Ua(B);if(!v.match(b))return d[0]='The custom hyper-relation objectName "'+b.toUri()+'" does not match the nameRegex "'+B+'"',!1;b=v.expand(n);if(ua.matchesRelation(b,a,r))return!0;d[0]='The custom hyper-relation nameMatch "'+b.toUri()+'" does not match the keyMatchPrefix "'+a.toUri()+'" using relation '+
r;return!1}}}d[0]="Unrecognized checkerType: "+v;return!1};ua.prototype.lookupCertificate=function(a,b){if(!this.isSecurityV1_)throw new x(Error("lookupCertificate: For security v2, use lookupCertificateV2()"));var r;r=this.fixedCertificateCache[a];if(void 0===r){if(b)r=ua.TrustAnchorRefreshManager.loadIdentityCertificateFromFile(a);else{var k=new d(a,"base64");r=new Ia;r.wireDecode(k)}k=r.getName().getPrefix(-1).toUri();this.fixedCertificateCache[a]=k;this.certificateCache_.insertCertificate(r)}else r=
this.certificateCache_.getCertificate(new c(r));return r};ua.prototype.lookupCertificateV2=function(a,b){if(this.isSecurityV1_)throw new x(Error("lookupCertificateV2: For security v1, use lookupCertificate()"));var r;r=this.fixedCertificateCache[a];if(void 0===r){if(b)r=ua.TrustAnchorRefreshManager.loadCertificateV2FromFile(a);else{var k=new d(a,"base64");r=new L;r.wireDecode(k)}k=r.getName().getPrefix(-1).toUri();this.fixedCertificateCache[a]=k;this.certificateCacheV2_.insert(r)}else r=this.certificateCacheV2_.find(new c(r));
return r};ua.prototype.findMatchingRule=function(a,b){for(var r=this.config.getRoot().get("validator/rule"),d=0;d<r.length;++d){var v=r[d];if(v.get("for")[0].getValue()==b){var B=!0,k=v.get("filter");if(0==k.length)return v;for(var m=0;m<k.length;++m){var n=k[m],B=n.getFirstValue("regex");null===B?(B=n.get("relation")[0].getValue(),n=n.get("name")[0].getValue(),n=new c(n),B=ua.matchesRelation(a,n,B)):B=(new Ua(B)).match(a);if(!B)break}if(B)return v}}return null};ua.matchesRelation=function(a,b,c){var d=
!1;"is-strict-prefix-of"==c?b.size()==a.size()?d=!1:b.match(a)&&(d=!0):"is-prefix-of"==c?b.match(a)&&(d=!0):"equal"==c&&b.equals(a)&&(d=!0);return d};ua.extractSignature=function(a,b){if(a instanceof Q)return a.getSignature();if(a instanceof F){b=b||s.getDefaultWireFormat();try{var c=b.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf(),!1)}catch(d){return null}return c}return null};ua.prototype.interestTimestampIsFresh=function(a,b,c){a=this.keyTimestamps[a.toUri()];
if(void 0==a){a=(new Date).getTime();var d=a+this.keyGraceInterval;if(b>a-this.keyGraceInterval&&b<d)return!0;c[0]="The command interest timestamp is not within the first use grace period of "+this.keyGraceInterval+" milliseconds.";return!1}return b<=a?(c[0]="The command interest timestamp is not newer than the previous timestamp",!1):!0};ua.prototype.updateTimestampForKey=function(a,b){this.keyTimestamps[a.toUri()]=b;var c=0,d=[],v=(new Date).getTime(),k=v,m=null,n;for(n in this.keyTimestamps){++c;
var p=this.keyTimestamps[n];v-p>this.keyTimestampTtl?d.push(n):p<k&&(k=p,m=n)}if(c>=this.maxTrackedKeys){for(v=0;v<d.length;++v)delete this.keyTimestamps[d[v]],--c;c>this.maxTrackedKeys&&delete this.keyTimestamps[m]}};ua.prototype.verify=function(a,b,c){var d=U.getFromSignature(a);if(d.getType()==Ga.KEYNAME){var d=d.getKeyName(),v;if(this.isSecurityV1_){var k=this.refreshManager.getCertificate(d);null==k&&(k=this.certificateCache_.getCertificate(d));if(null==k){c(!1,"Cannot find a certificate with name "+
d.toUri());return}v=k.getPublicKeyInfo().getKeyDer();if(v.isNull()){c(!1,"There is no public key in the certificate with name "+k.getName().toUri());return}}else{k=this.refreshManager.getCertificateV2(d);null==k&&(k=this.certificateCacheV2_.find(d));if(null==k){c(!1,"Cannot find a certificate with name "+d.toUri());return}try{v=k.getPublicKey()}catch(m){c(!1,"There is no public key in the certificate with name "+k.getName().toUri());return}}fb.verifySignature(a,b,v,function(a){a?c(!0):c(!1,"The signature did not verify with the given public key")})}else c(!1,
"The KeyLocator does not have a key name")};ua.TrustAnchorRefreshManager=function(a){this.isSecurityV1_=a;this.certificateCache_=new dd;this.certificateCacheV2_=new Wb;this.refreshDirectories={}};ua.TrustAnchorRefreshManager.loadIdentityCertificateFromFile=function(a){a=Ib.readFileSync(a).toString();a=new d(a,"base64");var b=new Ia;b.wireDecode(new p(a,!1));return b};ua.TrustAnchorRefreshManager.loadCertificateV2FromFile=function(a){a=Ib.readFileSync(a).toString();a=new d(a,"base64");var b=new L;
b.wireDecode(new p(a,!1));return b};ua.TrustAnchorRefreshManager.prototype.getCertificate=function(a){if(!this.isSecurityV1_)throw new x(Error("getCertificate: For security v2, use getCertificateV2()"));return this.certificateCache_.getCertificate(a)};ua.TrustAnchorRefreshManager.prototype.getCertificateV2=function(a){if(this.isSecurityV1_)throw new x(Error("getCertificateV2: For security v1, use getCertificate()"));return this.certificateCacheV2_.find(a)};ua.TrustAnchorRefreshManager.prototype.addDirectory=
function(a,b){var c;try{c=Ib.readdirSync(a)}catch(d){throw new x(Error("Cannot list files in directory "+a));}for(var v=[],k=0;k<c.length;++k){if(this.isSecurityV1_){var m;try{var n=Yd.join(a,c[k]);m=ua.TrustAnchorRefreshManager.loadIdentityCertificateFromFile(n)}catch(p){continue}var s=m.getName().getPrefix(-1).toUri();this.certificateCache_.insertCertificate(m)}else{try{n=Yd.join(a,c[k]),m=ua.TrustAnchorRefreshManager.loadCertificateV2FromFile(n)}catch(q){continue}s=L.extractKeyNameFromCertName(m.getName()).toUri();
this.certificateCacheV2_.insert(m)}v.push(s)}this.refreshDirectories[a]={certificates:v,nextRefresh:(new Date).getTime()+b,refreshPeriod:b}};ua.TrustAnchorRefreshManager.prototype.refreshAnchors=function(){var a=(new Date).getTime(),b;for(b in this.refreshDirectories){var d=this.refreshDirectories[b];if(d.nextRefresh<=a){for(var k=d.certificates.slice(0),v=0;v<k.length;++v)try{if(this.isSecurityV1_)this.certificateCache_.deleteCertificate(new c(k[v]));else{var B=this.certificateCacheV2_.find(new c(k[v]));
null!=B&&this.certificateCacheV2_.deleteCertificate(B.getName())}}catch(m){}this.addDirectory(b,d.refreshPeriod)}}};var c=a.Name,fb=a.PolicyManager,O=a.NdnCommon,jc=function(){fb.call(this)};jc.prototype=new fb;jc.prototype.name="NoVerifyPolicyManager";q.NoVerifyPolicyManager=jc;jc.prototype.skipVerifyAndTrust=function(a){return!0};jc.prototype.requireVerify=function(a){return!1};jc.prototype.checkVerificationPolicy=function(a,b,c,d,v){try{c(a)}catch(k){console.log("Error in onVerified: "+O.getErrorWithStackTrace(k))}return null};
jc.prototype.checkSigningPolicy=function(a,b){return!0};jc.prototype.inferSigningIdentity=function(a){return new c};var c=a.Name,F=a.Interest,Q=a.Data,p=a.Blob,Ia=a.IdentityCertificate,U=a.KeyLocator,Ga=a.KeyLocatorType,x=a.SecurityException,s=a.WireFormat,b=a.SyncPromise,fb=a.PolicyManager,Y=a.IdentityStorage,O=a.NdnCommon,Oc=function(a){fb.call(this);a instanceof Y?(this.identityStorage_=a,this.pibImpl_=null):(this.identityStorage_=null,this.pibImpl_=a)};Oc.prototype=new fb;Oc.prototype.name="SelfVerifyPolicyManager";
q.SelfVerifyPolicyManager=Oc;Oc.prototype.skipVerifyAndTrust=function(a){return!1};Oc.prototype.requireVerify=function(a){return!0};Oc.prototype.checkVerificationPolicy=function(a,b,c,d,v){v=v||s.getDefaultWireFormat();if(a instanceof Q)this.verify(a.getSignature(),a.wireEncode(),function(b,v){if(b)try{c(a)}catch(w){console.log("Error in onVerified: "+O.getErrorWithStackTrace(w))}else try{d(a,v)}catch(k){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(k))}});else if(a instanceof
F){if(2>a.getName().size()){try{d(a,"The signed interest has less than 2 components: "+a.getName().toUri())}catch(k){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(k))}return}var m;try{m=v.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf(),!1)}catch(n){try{d(a,"Error decoding the signed interest signature: "+n)}catch(p){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(p))}return}this.verify(m,a.wireEncode(),
function(b,v){if(b)try{c(a)}catch(w){console.log("Error in onVerified: "+O.getErrorWithStackTrace(w))}else try{d(a,v)}catch(k){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(k))}})}else throw new x(Error("checkVerificationPolicy: unrecognized type for dataOrInterest"));return null};Oc.prototype.checkSigningPolicy=function(a,b){return!0};Oc.prototype.inferSigningIdentity=function(a){return new c};Oc.prototype.verify=function(a,b,c){if(U.canGetFromSignature(a))this.getPublicKeyDer(U.getFromSignature(a),
function(d,k){if(d.isNull())c(!1,k);else try{fb.verifySignature(a,b,d,function(a){a?c(!0):c(!1,"The signature did not verify with the given public key")})}catch(m){c(!1,"Error in verifySignature: "+m)}});else try{fb.verifySignature(a,b,null,function(a){a?c(!0):c(!1,"The signature did not verify with the given public key")})}catch(d){c(!1,"Error in verifySignature: "+d)}};Oc.prototype.getPublicKeyDer=function(a,c){if(a.getType()==Ga.KEYNAME&&null!=this.identityStorage_){var d;try{d=Ia.certificateNameToPublicKeyName(a.getKeyName())}catch(k){c(new p,
"Cannot get a public key name from the certificate named: "+a.getKeyName().toUri());return}b.complete(c,function(a){c(new p,"The identityStorage doesn't have the key named "+d.toUri())},this.identityStorage_.getKeyPromise(d,!c))}else a.getType()==Ga.KEYNAME&&null!=this.pibImpl_?b.complete(c,function(a){c(new p,"The identityStorage doesn't have the key named "+d.toUri())},this.pibImpl_.getKeyBitsPromise(a.getKeyName(),!c)):c(new p,"The signature KeyLocator doesn't have a key name")};var ba=a,c=a.Name,
p=a.Blob,rb=a.KeyIdType,na=a.PibKey,Za=a.Tpm,b=a.SyncPromise,Oa=function(){};q.TpmBackEnd=Oa;Oa.Error=function(a){if(a)return a.__proto__=Oa.Error.prototype,a};Oa.Error.prototype=Error();Oa.Error.prototype.name="TpmBackEndError";Oa.prototype.hasKeyPromise=function(a,b){return this.doHasKeyPromise_(a,b)};Oa.prototype.getKeyHandlePromise=function(a,b){return this.doGetKeyHandlePromise_(a,b)};Oa.prototype.createKeyPromise=function(a,d,r){var k=this;return b.resolve().then(function(){if(d.getKeyIdType()==
rb.USER_SPECIFIED){var v=na.constructKeyName(a,d.getKeyId());return k.hasKeyPromise(v,r).then(function(a){return a?b.reject(new Za.Error(Error("Key `"+v.toUri()+"` already exists"))):b.resolve()})}if(d.getKeyIdType()==rb.SHA256)return b.resolve();if(d.getKeyIdType()==rb.RANDOM){var B,m=function(){var d=ba.randomBytes(8);B=new c.Component(new p(d,!1));d=na.constructKeyName(a,B);return k.hasKeyPromise(d,r).then(function(a){return a?m():b.resolve()})};return m().then(function(){d.setKeyId(B);return b.resolve()})}return b.reject(new Za.Error(Error("Unsupported key id type")))}).then(function(){return k.doCreateKeyPromise_(a,
d,r)})};Oa.prototype.deleteKeyPromise=function(a,b){return this.doDeleteKeyPromise_(a,b)};Oa.prototype.importKeyPromise=function(a,c,d,k){var v=this;return this.hasKeyPromise(a,k).then(function(B){return B?b.reject(new Oa.Error(Error("Key `"+a.toUri()+"` already exists"))):v.doImportKeyPromise_(a,c,d,k)})};Oa.setKeyName=function(a,b,d){if(d.getKeyIdType()==rb.USER_SPECIFIED)d=d.getKeyId();else if(d.getKeyIdType()==rb.SHA256)d=ba.createHash("sha256"),d.update(a.derivePublicKey().buf()),d=c.Component(new p(d.digest(),
!1));else if(d.getKeyIdType()==rb.RANDOM){if(0==d.getKeyId().getValue().size())throw new Oa.Error(Error("setKeyName: The keyId is empty for type RANDOM"));d=d.getKeyId()}else throw new Oa.Error(Error("setKeyName: unrecognized params.getKeyIdType()"));a.setKeyName(na.constructKeyName(b,d))};Oa.prototype.doHasKeyPromise_=function(a,c){return b.reject(Error("TpmBackEnd.doHasKeyPromise_ is not implemented"))};Oa.prototype.doGetKeyHandlePromise_=function(a,c){return b.reject(Error("TpmBackEnd.doGetKeyHandlePromise_ is not implemented"))};
Oa.prototype.doCreateKeyPromise_=function(a,c,d){return b.reject(Error("TpmBackEnd.doCreateKeyPromise_ is not implemented"))};Oa.prototype.doDeleteKeyPromise_=function(a,c){return b.reject(Error("TpmBackEnd.doDeleteKeyPromise_ is not implemented"))};Oa.prototype.doImportKeyPromise_=function(a,c,d,k){return b.reject(Error("TpmBackEnd.doImportKeyPromise_ is not implemented"))};var b=a.SyncPromise,da=a.TpmPrivateKey,rd=a.TpmKeyHandleMemory,Oa=a.TpmBackEnd,Vb=function(){Oa.call(this);this.keys_={}};Vb.prototype=
new Oa;Vb.prototype.name="TpmBackEndMemory";q.TpmBackEndMemory=Vb;Vb.getScheme=function(){return"tpm-memory"};Vb.prototype.doHasKeyPromise_=function(a,c){return b.resolve(a.toUri()in this.keys_)};Vb.prototype.doGetKeyHandlePromise_=function(a,c){var d=this.keys_[a.toUri()];return void 0==d?b.resolve(null):b.resolve(new rd(d))};Vb.prototype.doCreateKeyPromise_=function(a,c,d){var k=this;return da.generatePrivateKeyPromise(c,d).then(function(d){var r=new rd(d);Oa.setKeyName(r,a,c);k.keys_[r.getKeyName().toUri()]=
d;return b.resolve(r)},function(a){return b.reject(new Oa.Error(Error("Error in TpmPrivateKey.generatePrivateKey: "+a)))})};Vb.prototype.doDeleteKeyPromise_=function(a,c){delete this.keys_[a.toUri()];return b.resolve()};Vb.prototype.doImportKeyPromise_=function(a,c,d,k){if(null!=d)return b.reject(new Oa.Error(Error("Private key password-encryption is not implemented")));try{var v=new da;v.loadPkcs8(c);this.keys_[a.toUri()]=v;return b.resolve()}catch(B){return b.reject(new Oa.Error(Error("Cannot import private key: "+
B)))}};var c=a.Name,b=a.SyncPromise,$b=function(){this.keyName_=new c};q.TpmKeyHandle=$b;$b.prototype.signPromise=function(a,b,c){return this.doSignPromise_(a,b,c)};$b.prototype.decryptPromise=function(a,b){return this.doDecryptPromise_(a,b)};$b.prototype.derivePublicKey=function(a){return this.doDerivePublicKey_(a)};$b.prototype.setKeyName=function(a){this.keyName_=new c(a)};$b.prototype.getKeyName=function(){return this.keyName_};$b.prototype.doSignPromise_=function(a,c,d){return b.reject(Error("TpmKeyHandle.doSignPromise_ is not implemented"))};
$b.prototype.doDecryptPromise_=function(a,c){return b.reject(Error("TpmKeyHandle.doDecryptPromise_ is not implemented"))};$b.prototype.doDerivePublicKey_=function(a){return b.reject(Error("TpmKeyHandle.doDerivePublicKey_ is not implemented"))};p=a.Blob;b=a.SyncPromise;Aa=a.DigestAlgorithm;da=a.TpmPrivateKey;Oa=a.TpmBackEnd;$b=a.TpmKeyHandle;rd=function(a){$b.call(this);if(null==a)throw Error("The key is null");this.key_=a};rd.prototype=new $b;rd.prototype.name="TpmKeyHandleMemory";q.TpmKeyHandleMemory=
rd;rd.prototype.doSignPromise_=function(a,c,d){return a==Aa.SHA256?this.key_.signPromise(c,a,d).catch(function(a){return b.reject(new Oa.Error(Error("Error in TpmPrivateKey.sign: "+a)))}):b.resolve(new p)};rd.prototype.doDecryptPromise_=function(a,c){return this.key_.decryptPromise(a,c).catch(function(a){return b.reject(new Oa.Error(Error("Error in TpmPrivateKey.decrypt: "+a)))})};$b.prototype.doDerivePublicKey_=function(){try{return this.key_.derivePublicKey()}catch(a){throw new Oa.Error(Error("Error in TpmPrivateKey.derivePublicKey: "+
a));}};var ba=od=a,fa=a.KeyType,ia=a.EncryptAlgorithmType,Aa=a.DigestAlgorithm,M=a.DataUtils,b=a.SyncPromise,m=a.DerNode,ed=a.DerNode.DerInteger,eb=a.OID,p=a.Blob,Gb=a.UseSubtleCrypto,xc=null;try{xc=a}catch(af){}da=function(){this.privateKey_=this.keyType_=null};q.TpmPrivateKey=da;da.Error=function(a){if(a)return a.__proto__=da.Error.prototype,a};da.Error.prototype=Error();da.Error.prototype.name="TpmPrivateKeyError";da.prototype.loadPkcs1=function(a,b){a instanceof p&&(a=a.buf());if(void 0==b)try{var c=
m.parse(a).getChildren();b=9==c.length&&c[0]instanceof ed&&0==c[0].toVal()&&c[1]instanceof ed&&c[2]instanceof ed&&c[3]instanceof ed&&c[4]instanceof ed&&c[5]instanceof ed&&c[6]instanceof ed&&c[7]instanceof ed&&c[8]instanceof ed?fa.RSA:fa.EC}catch(d){b=fa.EC}if(b==fa.EC){for(var c=a.toString("base64"),v="-----BEGIN EC PRIVATE KEY-----\n",k=0;k<c.length;k+=64)v+=c.substr(k,64)+"\n";this.privateKey_=v+"-----END EC PRIVATE KEY-----"}else if(b==fa.RSA){c=a.toString("base64");v="-----BEGIN RSA PRIVATE KEY-----\n";
for(k=0;k<c.length;k+=64)v+=c.substr(k,64)+"\n";this.privateKey_=v+="-----END RSA PRIVATE KEY-----"}else throw new da.Error(Error("loadPkcs1: Unrecognized keyType: "+b));this.keyType_=b};da.prototype.loadPkcs8=function(a,b){a instanceof p&&(a=a.buf());if(void 0==b){var c,d;try{var v=m.parse(a).getChildren();c=m.getSequence(v,1).getChildren()[0].toVal();d=v[2].toVal()}catch(k){try{this.loadPkcs1(a);return}catch(n){throw new da.Error(Error("loadPkcs8: Error decoding private key: "+n));}}if(c==da.EC_ENCRYPTION_OID)b=
fa.EC;else if(c==da.RSA_ENCRYPTION_OID)b=fa.RSA;else throw new da.Error(Error("loadPkcs8: Unrecognized private key OID: "+c));}this.loadPkcs1(d,b)};da.prototype.derivePublicKey=function(){if(this.keyType_!=fa.RSA)throw new da.Error(Error("derivePublicKey: The private key is not loaded"));try{var a=this.privateKey_.toString().replace("-----BEGIN RSA PRIVATE KEY-----","").replace("-----END RSA PRIVATE KEY-----",""),b=new d(a,"base64"),c=m.parse(b,0).getChildren(),k=c[1],v=c[2],B=new m.DerSequence;B.addChild(k);
B.addChild(v);var n=B.encode(),Zb=new m.DerSequence;Zb.addChild(new m.DerOid(new eb(da.RSA_ENCRYPTION_OID)));Zb.addChild(new m.DerNull);var p=new m.DerSequence;p.addChild(Zb);p.addChild(new m.DerBitString(n.buf(),0));return p.encode()}catch(s){throw new da.Error(Error("derivePublicKey: Error decoding private key "+s));}};da.prototype.decryptPromise=function(a,c,d){void 0==c&&(c=ia.RsaOaep);if(null==this.keyType_)return b.reject(new da.Error(Error("decrypt: The private key is not loaded")));if(c==
ia.RsaPkcs)c=od.RSA_PKCS1_PADDING;else if(c==ia.RsaOaep)c=od.RSA_PKCS1_OAEP_PADDING;else return b.reject(new da.Error(Error("unsupported padding scheme")));try{return b.resolve(new p(ba.privateDecrypt({key:this.privateKey_,padding:c},a),!1))}catch(k){return b.reject(new da.Error(k))}};da.prototype.signPromise=function(a,c,r){if(null==this.keyType_)return b.reject(new da.Error(Error("sign: The private key is not loaded")));if(c!=Aa.SHA256)return b.reject(new da.Error(Error("TpmPrivateKey.sign: Unsupported digest algorithm")));
if(Gb()&&!r){var k={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};if(this.privateKey_.subtleKey)c=crypto.subtle.sign(k,this.privateKey_.subtleKey,a);else{c=M.privateKeyPemToDer(this.privateKey_);c=da.encodePkcs8PrivateKey(c,new eb(da.RSA_ENCRYPTION_OID),new m.DerNull).buf();var v=this;c=crypto.subtle.importKey("pkcs8",c.buffer,k,!0,["sign"]).then(function(b){v.privateKey_.subtleKey=b;return crypto.subtle.sign(k,b,a)})}return c.then(function(a){a=new p(new Uint8Array(a),!0);return Promise.resolve(a)})}if(this.keyType_===
fa.RSA)c=ba.createSign("RSA-SHA256");else if(this.keyType===fa.EC)c=ba.createSign("sha256");else return b.resolve(new p);c.update(a);c=new d(M.toNumbersIfString(c.sign(this.privateKey_)));c=new p(c,!1);return b.resolve(c)};da.prototype.toPkcs1=function(){if(null==this.keyType_)throw new da.Error(Error("toPkcs1: The private key is not loaded"));var a=this.privateKey_.replace("-----BEGIN RSA PRIVATE KEY-----","").replace("-----END RSA PRIVATE KEY-----","");return new p(new d(a,"base64"))};da.prototype.toPkcs8=
function(){if(null==this.keyType_)throw new da.Error(Error("toPkcs8: The private key is not loaded"));var a;if(this.keyType_===fa.RSA)a=new eb(da.RSA_ENCRYPTION_OID);else if(this.keyType===fa.EC)a=new eb(da.EC_ENCRYPTION_OID);else throw new da.Error(Error("toPkcs8: Unrecognized key type "+this.keyType_));return da.encodePkcs8PrivateKey(this.toPkcs1().buf(),a,new m.DerNull)};da.generatePrivateKeyPromise=function(a,c){var d;if(a.getKeyType()===fa.RSA){if(!xc)return b.reject(new da.Error(Error("Need to install rsa-keygen: sudo npm install rsa-keygen")));
d=xc.generate(a.getKeySize()).private_key.toString()}else return b.reject(Error("Cannot generate a key pair of type "+a.getKeyType()));var k=new da;k.privateKey_=d;k.keyType_=a.getKeyType();return b.resolve(k)};da.encodePkcs8PrivateKey=function(a,b,c){var d=new m.DerSequence;d.addChild(new m.DerOid(b));d.addChild(c);b=new m.DerSequence;b.addChild(new m.DerInteger(0));b.addChild(d);b.addChild(new m.DerOctetString(a));return b.encode()};da.encodePkcs1PrivateKeyFromRSAKey=function(a){var b=new m.DerSequence;
b.addChild(new m.DerInteger(0));b.addChild(new m.DerInteger(da.bigIntegerToBuffer(a.n)));b.addChild(new m.DerInteger(a.e));b.addChild(new m.DerInteger(da.bigIntegerToBuffer(a.d)));b.addChild(new m.DerInteger(da.bigIntegerToBuffer(a.p)));b.addChild(new m.DerInteger(da.bigIntegerToBuffer(a.q)));b.addChild(new m.DerInteger(da.bigIntegerToBuffer(a.dmp1)));b.addChild(new m.DerInteger(da.bigIntegerToBuffer(a.dmq1)));b.addChild(new m.DerInteger(da.bigIntegerToBuffer(a.coeff)));return b.encode()};da.encodePublicKeyFromRSAKey=
function(a){var b=new m.DerSequence;b.addChild(new m.DerInteger(da.bigIntegerToBuffer(a.n)));b.addChild(new m.DerInteger(a.e));a=new m.DerSequence;a.addChild(new m.DerOid(new eb(da.RSA_ENCRYPTION_OID)));a.addChild(new m.DerNull);var c=new m.DerSequence;c.addChild(a);c.addChild(new m.DerBitString(b.encode().buf(),0));return c.encode()};da.bigIntegerToBuffer=function(a){a=a.toString(16);if("-"==a.substr(0,1))throw Error("TpmPrivateKey.bigIntegerToBuffer: Negative integers are not currently supported");
1==a.length%2?a="0"+a:a.match(/^[0-7]/)||(a="00"+a);return new d(a,"hex")};da.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";da.EC_ENCRYPTION_OID="1.2.840.10045.2.1";fa=a.KeyType;b=a.SyncPromise;Za=function(a,b,c){this.keys_={};this.scheme_=a;this.location_=b;this.backEnd_=c;this.initializePib_=null;this.isInitialized_=!1};q.Tpm=Za;Za.Error=function(a){if(a)return a.__proto__=Za.Error.prototype,a};Za.Error.prototype=Error();Za.Error.prototype.name="TpmError";Za.prototype.getTpmLocator=function(){if(!this.isInitialized_)throw new Za.Error(Error("getTpmLocator: The Tpm is not initialized"));
return this.scheme_+":"+this.location_};Za.prototype.hasKeyPromise=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.backEnd_.hasKeyPromise(a,b)})};Za.prototype.getPublicKeyPromise=function(a,c){var d=this;return this.initializePromise_(c).then(function(){return d.findKeyPromise_(a,c)}).then(function(a){return null==a?b.resolve(new p):b.resolve(a.derivePublicKey())})};Za.prototype.signPromise=function(a,c,d,k){var v=this;return this.initializePromise_(k).then(function(){return v.findKeyPromise_(c,
k)}).then(function(c){return null==c?b.resolve(new p):c.signPromise(d,a,k)})};Za.prototype.decryptPromise=function(a,c,d){var k=this;return this.initializePromise_(d).then(function(){return k.findKeyPromise_(c,d)}).then(function(c){return null==c?b.resolve(new p):c.decryptPromise(a,d)})};Za.prototype.createKeyPromise_=function(a,c,d){var k=this;return this.initializePromise_(d).then(function(){return c.getKeyType()==fa.RSA||c.getKeyType()==fa.EC?k.backEnd_.createKeyPromise(a,c,d).then(function(a){var c=
a.getKeyName();k.keys_[c.toUri()]=a;return b.resolve(c)}):b.resolve(new Za.Error(Error("createKey: Unsupported key type")))})};Za.prototype.deleteKeyPromise_=function(a,b){var c=this;return this.initializePromise_(b).then(function(){delete c.keys_[a.toUri()];return c.backEnd_.deleteKeyPromise(a,b)})};Za.prototype.importPrivateKeyPromise_=function(a,b,c,d){var v=this;return this.initializePromise_(d).then(function(){return v.backEnd_.importKeyPromise(a,b,c,d)})};Za.prototype.findKeyPromise_=function(a,
c){var d=this;return this.initializePromise_(c).then(function(){var k=a.toUri(),v=d.keys_[k];return void 0!=v?b.resolve(v):d.backEnd_.getKeyHandlePromise(a,c).then(function(a){return null!=a?(d.keys_[k]=a,b.resolve(a)):b.resolve(null)})})};Za.prototype.initializePromise_=function(a){return this.isInitialized_?b.resolve():null==this.initializePib_?(this.isInitialized_=!0,b.resolve()):this.initializePib_.initializePromise_(a)};var c=a.Name,na=a.PibKey,I=a.ValidationError,Ta=a.ConfigNameRelation,Ua=
a.NdnRegexTopMatcher,ra=a.ValidatorConfigError,ub=function(){};q.ConfigChecker=ub;ub.prototype.check=function(a,b,c,d){return a?2>b.size()?!1:this.checkNames(b.getPrefix(-2),c,d):this.checkNames(b,c,d)};ub.create=function(a){var b=a.getFirstValue("type");if(null==b)throw new ra(Error("Expected <checker.type>"));if("customized"==b.toLowerCase())return ub.createCustomizedChecker_(a);if("hierarchical"==b.toLowerCase())return ub.createHierarchicalChecker_(a);throw new ra(Error("Unsupported checker type: "+
b));};ub.prototype.checkNames=function(a,b,c){throw Error("ConfigChecker.checkNames is not implemented");};ub.createCustomizedChecker_=function(a){keyLocatorSection=a.get("key-locator");if(1!=keyLocatorSection.length)throw new ra(Error("Expected one <checker.key-locator>"));return ub.createKeyLocatorChecker_(keyLocatorSection[0])};ub.createHierarchicalChecker_=function(a){return new Md("^(<>*)$","\\1","^(<>*)<KEY><>$","\\1",Ta.Relation.IS_PREFIX_OF)};ub.createKeyLocatorChecker_=function(a){var b=
a.getFirstValue("type");if(null==b)throw new ra(Error("Expected <checker.key-locator.type>"));if("name"==b.toLowerCase())return ub.createKeyLocatorNameChecker_(a);throw new ra(Error("Unsupported checker.key-locator.type: "+b));};ub.createKeyLocatorNameChecker_=function(a){var b=a.getFirstValue("name");if(null!=b){b=new c(b);a=a.getFirstValue("relation");if(null==a)throw new ra(Error("Expected <checker.key-locator.relation>"));B=Ta.getNameRelationFromString(a);return new Zd(b,B)}b=a.getFirstValue("regex");
if(null!=b)try{return new $d(b)}catch(d){throw new ra(Error("Invalid checker.key-locator.regex: "+b));}a=a.get("hyper-relation");if(1==a.length){var k=a[0];a=k.getFirstValue("k-regex");if(null==a)throw new ra(Error("Expected <checker.key-locator.hyper-relation.k-regex>"));b=k.getFirstValue("k-expand");if(null==b)throw new ra(Error("Expected <checker.key-locator.hyper-relation.k-expand"));B=k.getFirstValue("h-relation");if(null==B)throw new ra(Error("Expected <checker.key-locator.hyper-relation.h-relation>"));
var v=k.getFirstValue("p-regex");if(null==v)throw new ra(Error("Expected <checker.key-locator.hyper-relation.p-regex>"));k=k.getFirstValue("p-expand");if(null==k)throw new ra(Error("Expected <checker.key-locator.hyper-relation.p-expand>"));var B=Ta.getNameRelationFromString(B);try{return new Md(v,k,a,b,B)}catch(m){throw new ra(Error("Invalid regex for key-locator.hyper-relation"));}}throw new ra(Error("Unsupported checker.key-locator"));};var Zd=function(a,b){ub.call(this);this.name_=a;this.relation_=
b};Zd.prototype=new ub;Zd.prototype.name="ConfigNameRelationChecker";q.ConfigNameRelationChecker=Zd;Zd.prototype.checkNames=function(a,b,c){var d=na.extractIdentityFromKeyName(b),v=Ta.checkNameRelation(this.relation_,this.name_,d);v||c.fail(new I(I.POLICY_ERROR,"KeyLocator check failed: name relation "+this.name_.toUri()+" "+Ta.toString(this.relation_)+" for packet "+a.toUri()+" is invalid (KeyLocator="+b.toUri()+", identity="+d.toUri()+")"));return v};var $d=function(a){ub.call(this);this.regex_=
new Ua(a)};$d.prototype=new ub;$d.prototype.name="ConfigRegexChecker";q.ConfigRegexChecker=$d;$d.prototype.checkNames=function(a,b,c){var d=this.regex_.match(b);d||c.fail(new I(I.POLICY_ERROR,"KeyLocator check failed: regex "+this.regex_.getExpr()+" for packet "+a.toUri()+" is invalid (KeyLocator="+b.toUri()+")"));return d};var Md=function(a,b,c,d,v){ub.call(this);this.packetNameRegex_=new Ua(a);this.packetNameExpansion_=b;this.keyNameRegex_=new Ua(c);this.keyNameExpansion_=d;this.hyperRelation_=
v};Md.prototype=new ub;Md.prototype.name="ConfigHyperRelationChecker";q.ConfigHyperRelationChecker=Md;Md.prototype.checkNames=function(a,b,c){if(!this.packetNameRegex_.match(a))return c.fail(new I(I.POLICY_ERROR,"The packet "+a.toUri()+" (KeyLocator="+b.toUri()+") does not match the hyper relation packet name regex "+this.packetNameRegex_.getExpr())),!1;if(!this.keyNameRegex_.match(b))return c.fail(new I(I.POLICY_ERROR,"The packet "+a.toUri()+" (KeyLocator="+b.toUri()+") does not match the hyper relation key name regex "+
this.keyNameRegex_.getExpr())),!1;var d=this.keyNameRegex_.expand(this.keyNameExpansion_),v=this.packetNameRegex_.expand(this.packetNameExpansion_),k=Ta.checkNameRelation(this.hyperRelation_,d,v);k||c.fail(new I(I.POLICY_ERROR,"KeyLocator check failed: hyper relation "+Ta.toString(this.hyperRelation_)+" packet name match="+v.toUri()+", key name match="+d.toUri()+" of packet "+a.toUri()+" (KeyLocator="+b.toUri()+") is invalid"));return k};var c=a.Name,Ta=a.ConfigNameRelation,Ua=a.NdnRegexTopMatcher,
ra=a.ValidatorConfigError,kc=function(){};q.ConfigFilter=kc;kc.prototype.match=function(a,b){return a?2>b.size()?!1:this.matchName(b.getPrefix(-2)):this.matchName(b)};kc.create=function(a){var b=a.getFirstValue("type");if(null==b)throw new ra(Error("Expected <filter.type>"));if("name"==b.toLowerCase())return kc.createNameFilter_(a);throw new ra(Error("Unsupported filter.type: "+b));};kc.prototype.matchName=function(a){throw Error("ConfigFilter.matchName is not implemented");};kc.createNameFilter_=
function(a){var b=a.getFirstValue("name");if(null!=b){b=new c(b);a=a.getFirstValue("relation");if(null==a)throw new ra(Error("Expected <filter.relation>"));a=Ta.getNameRelationFromString(a);return new ae(b,a)}b=a.getFirstValue("regex");if(null!=b)try{return new be(b)}catch(d){throw new ra(Error("Wrong filter.regex: "+b));}throw new ra(Error("Wrong filter(name) properties"));};var ae=function(a,b){kc.call(this);this.name_=new c(a);this.relation_=b};ae.prototype=new kc;ae.prototype.name="ConfigRelationNameFilter";
q.ConfigRelationNameFilter=ae;ae.prototype.matchName=function(a){return Ta.checkNameRelation(this.relation_,this.name_,a)};var be=function(a){kc.call(this);this.regex_=new Ua(a)};be.prototype=new kc;be.prototype.name="ConfigRegexNameFilter";q.ConfigRegexNameFilter=be;be.prototype.matchName=function(a){return this.regex_.match(a)};ra=a.ValidatorConfigError;Ta=function(){};q.ConfigNameRelation=Ta;Ta.Relation=function(){};Ta.Relation.EQUAL=0;Ta.Relation.IS_PREFIX_OF=1;Ta.Relation.IS_STRICT_PREFIX_OF=
2;Ta.toString=function(a){return a==Ta.Relation.EQUAL?"equal":a==Ta.Relation.IS_PREFIX_OF?"is-prefix-of":a==Ta.Relation.IS_STRICT_PREFIX_OF?"is-strict-prefix-of":""};Ta.checkNameRelation=function(a,b,c){return a==Ta.Relation.EQUAL?b.equals(c):a==Ta.Relation.IS_PREFIX_OF?b.isPrefixOf(c):a==Ta.Relation.IS_STRICT_PREFIX_OF?b.isPrefixOf(c)&&b.size()<c.size():!1};Ta.getNameRelationFromString=function(a){if("equal"==a.toLowerCase())return Ta.Relation.EQUAL;if("is-prefix-of"==a.toLowerCase())return Ta.Relation.IS_PREFIX_OF;
if("is-strict-prefix-of"==a.toLowerCase())return Ta.Relation.IS_STRICT_PREFIX_OF;throw new ra(Error("Unsupported relation: "+a));};var ub=a.ConfigChecker,kc=a.ConfigFilter,ra=a.ValidatorConfigError,k=a.Log.LOG,Ac=function(a,b){this.id_=a;this.isForInterest_=b;this.filters_=[];this.checkers_=[]};q.ConfigRule=Ac;Ac.prototype.getId=function(){return this.id_};Ac.prototype.getIsForInterest=function(){return this.isForInterest_};Ac.prototype.addFilter=function(a){this.filters_.push(a)};Ac.prototype.addChecker=
function(a){this.checkers_.push(a)};Ac.prototype.match=function(a,b){3<k&&console.log("Trying to match "+b.toUri());if(a!=this.isForInterest_)throw new ra(Error("Invalid packet type supplied ( "+(a?"interest":"data")+" != "+(this.isForInterest_?"interest":"data")+")"));if(0==this.filters_.length)return!0;for(var c=!1,d=0;d<this.filters_.length&&!(c=c||this.filters_[d].match(a,b));++d);return c};Ac.prototype.check=function(a,b,c,d){3<k&&console.log("Trying to check "+b.toUri()+" with keyLocator "+
c.toUri());if(a!=this.isForInterest_)throw new ra(Error("Invalid packet type supplied ( "+(a?"interest":"data")+" != "+(this.isForInterest_?"interest":"data")+")"));for(var v=!1,B=0;B<this.checkers_.length;++B){v=this.checkers_[B].check(a,b,c,d);if(!v)break;v=!0}return v};Ac.create=function(a){var b=a.getFirstValue("id");if(null==b)throw new ra(Error("Expecting <rule.id>"));var c=a.getFirstValue("for");if(null==c)throw new ra(Error("Expecting <rule.for> in rule: "+b));if("data"==c.toLowerCase())c=
!1;else if("interest"==c.toLowerCase())c=!0;else throw new ra(Error("Unrecognized <rule.for>: "+c+" in rule: "+b));for(var c=new Ac(b,c),d=a.get("filter"),v=0;v<d.length;++v)c.addFilter(kc.create(d[v]));a=a.get("checker");for(v=0;v<a.length;++v)c.addChecker(ub.create(a[v]));if(0==a.length)throw new ra(Error("No <rule.checker> is specified in rule: "+b));return c};var Ib=a,p=a.Blob,L=a.CertificateV2,lc=function(a,b){this.certificates_=a;this.id_=b;this.anchorNameUris_={}};q.TrustAnchorGroup=lc;lc.prototype.getId=
function(){return this.id_};lc.prototype.size=function(){return Object.keys(this.anchorNameUris_).length};lc.prototype.refresh=function(){};lc.readCertificate=function(a){try{var b=Ib.readFileSync(a).toString(),c=new d(b,"base64"),k=new L;k.wireDecode(new p(c,!1));return k}catch(v){return null}};var b=a.SyncPromise,I=a.ValidationError,k=a.Log.LOG,Na=a.VerificationHelpers,L=a.CertificateV2,yb=function(){this.certificateChain_=[];this.seenCertificateNameUris_={};this.outcome_=this.hasOutcome_=!1};q.ValidationState=
yb;yb.prototype.hasOutcome=function(){return this.hasOutcome_};yb.prototype.isOutcomeFailed=function(){return this.hasOutcome_&&!1==this.outcome_};yb.prototype.isOutcomeSuccess=function(){return this.hasOutcome_&&!0==this.outcome_};yb.prototype.fail=function(a){throw Error("ValidationState.fail is not implemented");};yb.prototype.getDepth=function(){return this.certificateChain_.length};yb.prototype.hasSeenCertificateName=function(a){a=a.toUri();if(void 0!==this.seenCertificateNameUris_[a])return!0;
this.seenCertificateNameUris_[a]=!0;return!1};yb.prototype.addCertificate=function(a){this.certificateChain_.unshift(new L(a))};yb.prototype.setOutcome=function(a){if(this.hasOutcome_)throw Error("The ValidationState already has an outcome");this.hasOutcome_=!0;this.outcome_=a};yb.prototype.verifyOriginalPacketPromise_=function(a){return b.reject(Error("ValidationState.verifyOriginalPacketPromise_ is not implemented"))};yb.prototype.bypassValidation_=function(){throw Error("ValidationState.bypassValidation_ is not implemented");
};yb.prototype.verifyCertificateChainPromise_=function(a){var c=a,d=this,m=function(a){if(a>=d.certificateChain_.length)return b.resolve(c);var B=d.certificateChain_[a];return Na.verifyDataSignaturePromise(B,c).then(function(n){if(n)3<k&&console.log("OK signature for certificate `"+B.getName().toUri()+"`"),c=B;else{for(d.fail(new I(I.INVALID_SIGNATURE,"Invalid signature of certificate `"+B.getName().toUri()+"`"));d.certificateChain_.length>a;)d.certificateChain_.splice(a,1);return b.resolve(null)}++a;
return m(a)})};return m(0)};var c=a.Name,ea=a.Schedule,L=a.CertificateV2,k=a.Log.LOG,Wb=function w(a){this.certificatesByName_=[];this.nextRefreshTime_=Number.MAX_VALUE;this.maxLifetimeMilliseconds_=void 0==a?w.getDefaultLifetime():a;this.nowOffsetMilliseconds_=0};q.CertificateCacheV2=Wb;Wb.prototype.insert=function(a){var b=a.getValidityPeriod().getNotAfter(),c=(new Date).getTime()+this.nowOffsetMilliseconds_;if(b<c)3<k&&console.log("Not adding "+a.getName().toUri()+": already expired at "+ea.toIsoString(b));
else{b=Math.min(b,c+this.maxLifetimeMilliseconds_);b<this.nextRefreshTime_&&(this.nextRefreshTime_=b);3<k&&console.log("Adding "+a.getName().toUri()+", will remove in "+(b-c)/36E5+" hours");a=new L(a);var c=a.getName(),d=this.findFirstByName_(c);if(0>d)d=this.certificatesByName_.length;else if(this.certificatesByName_[d].name.equals(c)){this.certificatesByName_[d].certificate=a;this.certificatesByName_[d].removalTime=b;return}this.certificatesByName_.splice(d,0,{name:c,certificate:a,removalTime:b})}};
Wb.prototype.find=function(a){if(a instanceof c){0<a.size()&&a.get(-1).isImplicitSha256Digest()&&console.log("Certificate search using a name with an implicit digest is not yet supported");this.refresh_();var b=this.findFirstByName_(a);if(0>b)return null;b=this.certificatesByName_[b];return a.isPrefixOf(b.certificate.getName())?b.certificate:null}null!=a.getChildSelector()&&console.log("Certificate search using a ChildSelector is not supported. Searching as if this selector not specified");0<a.getName().size()&&
a.getName().get(-1).isImplicitSha256Digest()&&console.log("Certificate search using a name with an implicit digest is not yet supported");this.refresh_();b=this.findFirstByName_(a.getName());if(0>b)return null;for(;b<this.certificatesByName_.length;++b){var d=this.certificatesByName_[b].certificate;if(!a.getName().isPrefixOf(d.getName()))break;if(a.matchesData(d))return d}return null};Wb.prototype.deleteCertificate=function(a){for(var b=0;b<this.certificatesByName_.length;++b)if(this.certificatesByName_[b].name.equals(a)){this.certificatesByName_.splice(b,
1);break}};Wb.prototype.clear=function(){this.certificatesByName_=[];this.nextRefreshTime_=Number.MAX_VALUE};Wb.getDefaultLifetime=function(){return 36E5};Wb.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};Wb.prototype.findFirstByName_=function(a){for(var b=0;b<this.certificatesByName_.length;++b)if(0<=this.certificatesByName_[b].name.compare(a))return b;return-1};Wb.prototype.refresh_=function(){var a=(new Date).getTime()+this.nowOffsetMilliseconds_;if(!(a<this.nextRefreshTime_)){for(var b=
Number.MAX_VALUE,c=this.certificatesByName_.length-1;0<=c;--c){var d=this.certificatesByName_[c];d.removalTime<=a?this.certificatesByName_.splice(c,1):b=Math.min(b,d.removalTime)}this.nextRefreshTime_=b}};var ce=function(){};q.CertificateContainerInterface=ce;ce.prototype.add=function(a){throw Error("CertificateContainerInterface.add is unimplemented");};ce.prototype.remove=function(a){throw Error("CertificateContainerInterface.remove is unimplemented");};var k=a.Log.LOG,mc=function(){this.certificateStorage_=
null};q.CertificateFetcher=mc;mc.prototype.setCertificateStorage=function(a){this.certificateStorage_=a};mc.prototype.fetch=function(a,b,c){if(null==this.certificateStorage_)throw Error("CertificateFetcher.fetch: You must first call setCertificateStorage");var d=this.certificateStorage_.getUnverifiedCertificateCache().find(a.interest_);if(null!=d)3<k&&console.log("Found certificate in **un**verified key cache "+d.getName().toUri()),c(d,b);else{var B=this;this.doFetch_(a,b,function(a,b){B.certificateStorage_.cacheUnverifiedCertificate(a);
c(a,b)})}};mc.prototype.doFetch_=function(a,b,c){throw Error("CertificateFetcher.doFetch_ is not implemented");};var k=a.Log.LOG,L=a.CertificateV2,I=a.ValidationError,mc=a.CertificateFetcher,Bd=function(a){mc.call(this);this.face_=a};Bd.prototype=new mc;Bd.prototype.name="CertificateFetcherFromNetwork";q.CertificateFetcherFromNetwork=Bd;Bd.prototype.doFetch_=function(a,b,c){var d=this;try{d.face_.expressInterest(a.interest_,function(a,d){3<k&&console.log("Fetched certificate from network "+d.getName().toUri());
var v;try{v=new L(d)}catch(B){b.fail(new I(I.MALFORMED_CERTIFICATE,"Fetched a malformed certificate `"+d.getName().toUri()+"` ("+B+")"));return}try{c(v,b)}catch(m){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Error in continueValidation: "+m))}},function(B){3<k&&console.log("Timeout while fetching certificate "+a.interest_.getName().toUri()+", retrying");--a.nRetriesLeft_;if(0<=a.nRetriesLeft_)try{d.fetch(a,b,c)}catch(m){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Error in fetch: "+m))}else b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,
"Cannot fetch certificate after all retries `"+a.interest_.getName().toUri()+"`"))},function(B,m){3<k&&console.log("NACK ("+m.getReason()+") while fetching certificate "+a.interest_.getName().toUri());--a.nRetriesLeft_;if(0<=a.nRetriesLeft_)try{d.fetch(a,b,c)}catch(n){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Error in fetch: "+n))}else b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot fetch certificate after all retries `"+a.interest_.getName().toUri()+"`"))})}catch(B){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,
"Error in expressInterest: "+B))}};var I=a.ValidationError,mc=a.CertificateFetcher,sd=function(){mc.call(this)};sd.prototype=new mc;sd.prototype.name="CertificateFetcherOffline";q.CertificateFetcherOffline=sd;sd.prototype.doFetch_=function(a,b,c){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot fetch certificate "+a.interest_.getName().toUri()+" in offline mode"))};var F=a.Interest,td=function(a){void 0!=a?(this.interest_=new F(a),this.nRetriesLeft_=3):(this.interest_=new F,this.nRetriesLeft_=0)};
q.CertificateRequest=td;var c=a.Name,cb=a.TrustAnchorContainer,L=a.CertificateV2,Wb=a.CertificateCacheV2,Mb=function(){this.trustAnchors_=new cb;this.verifiedCertificateCache_=new Wb(36E5);this.unverifiedCertificateCache_=new Wb(3E5)};q.CertificateStorage=Mb;Mb.prototype.findTrustedCertificate=function(a){var b=this.trustAnchors_.find(a);return null!=b?b:b=this.verifiedCertificateCache_.find(a)};Mb.prototype.isCertificateKnown=function(a){return null!=this.trustAnchors_.find(a)||null!=this.verifiedCertificateCache_.find(a)||
null!=this.unverifiedCertificateCache_.find(a)};Mb.prototype.cacheUnverifiedCertificate=function(a){this.unverifiedCertificateCache_.insert(a)};Mb.prototype.getTrustAnchors=function(){return this.trustAnchors_};Mb.prototype.getVerifiedCertificateCache=function(){return this.verifiedCertificateCache_};Mb.prototype.getUnverifiedCertificateCache=function(){return this.unverifiedCertificateCache_};Mb.prototype.loadAnchor=function(a,b,c,d){this.trustAnchors_.insert(a,b,c,d)};Mb.prototype.resetAnchors=
function(){this.trustAnchors_.clear()};Mb.prototype.cacheVerifiedCertificate=function(a){this.verifiedCertificateCache_.insert(a)};Mb.prototype.resetVerifiedCertificates=function(){this.verifiedCertificateCache_.clear()};Mb.prototype.setCacheNowOffsetMilliseconds_=function(a){this.verifiedCertificateCache_.setNowOffsetMilliseconds_(a);this.unverifiedCertificateCache_.setNowOffsetMilliseconds_(a)};c=a.Name;Q=a.Data;U=a.KeyLocator;Ga=a.KeyLocatorType;Da=a.Sha256WithRsaSignature;Sa=a.Sha256WithEcdsaSignature;
ya=a.ContentType;s=a.WireFormat;ea=a.Schedule;za=a.ValidityPeriod;Xb=a.InvalidArgumentException;L=function(a){void 0!=a?(Q.call(this,a),this.checkFormat_()):(Q.call(this),this.getMetaInfo().setType(ya.KEY))};L.prototype=new Q;L.prototype.name="CertificateV2";q.CertificateV2=L;L.Error=function(a){if(a)return a.__proto__=L.Error.prototype,a};L.Error.prototype=Error();L.Error.prototype.name="CertificateV2Error";L.prototype.checkFormat_=function(){if(!L.isValidName(this.getName()))throw new L.Error(Error("The Data Name does not follow the certificate naming convention"));
if(this.getMetaInfo().getType()!=ya.KEY)throw new L.Error(Error("The Data ContentType is not KEY"));if(0>this.getMetaInfo().getFreshnessPeriod())throw new L.Error(Error("The Data FreshnessPeriod is not set"));if(0==this.getContent().size())throw new L.Error(Error("The Data Content is empty"));};L.prototype.getKeyName=function(){return this.getName().getPrefix(L.KEY_ID_OFFSET+1)};L.prototype.getIdentity=function(){return this.getName().getPrefix(L.KEY_COMPONENT_OFFSET)};L.prototype.getKeyId=function(){return this.getName().get(L.KEY_ID_OFFSET)};
L.prototype.getIssuerId=function(){return this.getName().get(L.ISSUER_ID_OFFSET)};L.prototype.getPublicKey=function(){if(0==this.getContent().size())throw new L.Error(Error("The public key is not set (the Data content is empty)"));return this.getContent()};L.prototype.getValidityPeriod=function(){if(!za.canGetFromSignature(this.getSignature()))throw new Xb(Error("The SignatureInfo does not have a ValidityPeriod"));return za.getFromSignature(this.getSignature())};L.prototype.isValid=function(a){return this.getValidityPeriod().isValid(a)};
L.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();Q.prototype.wireDecode.call(this,a,b);this.checkFormat_()};L.prototype.toString=function(){var a;a="Certificate name:\n"+("  "+this.getName().toUri()+"\n");a+="Validity:\n";a+="  NotBefore: "+ea.toIsoString(this.getValidityPeriod().getNotBefore())+"\n";a+="  NotAfter: "+ea.toIsoString(this.getValidityPeriod().getNotAfter())+"\n";a+="Public key bits:\n";try{for(var b=this.getPublicKey().buf().toString("base64"),c=0;c<b.length;c+=64)a+=
b.substr(c,64)+"\n"}catch(d){}a+="Signature Information:\n";a+="  Signature Type: ";a=this.getSignature()instanceof Sa?a+"SignatureSha256WithEcdsa\n":this.getSignature()instanceof Da?a+"SignatureSha256WithRsa\n":a+"<unknown>\n";U.canGetFromSignature(this.getSignature())&&(a+="  Key Locator: ",b=U.getFromSignature(this.getSignature()),b.getType()==Ga.KEYNAME?(b.getKeyName().equals(this.getKeyName())&&(a+="Self-Signed "),a+="Name="+b.getKeyName().toUri()+"\n"):a+="<no KeyLocator key name>\n");return a};
L.isValidName=function(a){return a.size()>=L.MIN_CERT_NAME_LENGTH&&a.get(L.KEY_COMPONENT_OFFSET).equals(L.KEY_COMPONENT)};L.extractIdentityFromCertName=function(a){if(!L.isValidName(a))throw new Xb(Error("Certificate name `"+a.toUri()+"` does not follow the naming conventions"));return a.getPrefix(L.KEY_COMPONENT_OFFSET)};L.extractKeyNameFromCertName=function(a){if(!L.isValidName(a))throw new Xb(Error("Certificate name `"+a.toUri()+"` does not follow the naming conventions"));return a.getPrefix(L.KEY_ID_OFFSET+
1)};L.VERSION_OFFSET=-1;L.ISSUER_ID_OFFSET=-2;L.KEY_ID_OFFSET=-3;L.KEY_COMPONENT_OFFSET=-4;L.MIN_CERT_NAME_LENGTH=4;L.MIN_KEY_NAME_LENGTH=2;L.KEY_COMPONENT=new c.Component("KEY");var b=a.SyncPromise,Q=a.Data,k=a.Log.LOG,I=a.ValidationError,yb=a.ValidationState,Na=a.VerificationHelpers,O=a.NdnCommon,fd=function(a,b,c){yb.call(this);this.data_=new Q(a);this.successCallback_=b;this.failureCallback_=c;if(null==this.successCallback_)throw Error("The successCallback is null");if(null==this.failureCallback_)throw Error("The failureCallback is null");
};fd.prototype=new yb;fd.prototype.name="DataValidationState";q.DataValidationState=fd;fd.prototype.fail=function(a){3<k&&console.log(""+a);try{this.failureCallback_(this.data_,a)}catch(b){console.log("Error in failureCallback: "+O.getErrorWithStackTrace(b))}this.setOutcome(!1)};fd.prototype.getOriginalData=function(){return this.data_};fd.prototype.verifyOriginalPacketPromise_=function(a){var c=this;return Na.verifyDataSignaturePromise(this.data_,a).then(function(a){if(a){3<k&&console.log("OK signature for data `"+
c.data_.getName().toUri()+"`");try{c.successCallback_(c.data_)}catch(d){console.log("Error in successCallback: "+O.getErrorWithStackTrace(d))}c.setOutcome(!0)}else c.fail(new I(I.INVALID_SIGNATURE,"Invalid signature of data `"+c.data_.getName().toUri()+"`"));return b.resolve()})};fd.prototype.bypassValidation_=function(){3<k&&console.log("Signature verification bypassed for data `"+this.data_.getName().toUri()+"`");try{this.successCallback_(this.data_)}catch(a){console.log("Error in successCallback: "+
O.getErrorWithStackTrace(a))}this.setOutcome(!0)};var Yd=Ib=a,lc=a.TrustAnchorGroup,c=a.Name,k=a.Log.LOG,Cd=function(a,b,c,d,B){lc.call(this,a,b);this.isDirectory_=B;this.path_=c;this.refreshPeriod_=d;this.expireTime_=0;if(0>=d)throw Error("Refresh period for the dynamic group must be positive");0<k&&console.log("Create a dynamic trust anchor group "+b+" for file/dir "+c+" with refresh time "+d);this.refresh()};Cd.prototype=new lc;Cd.prototype.name="DynamicTrustAnchorGroup";q.DynamicTrustAnchorGroup=
Cd;Cd.prototype.refresh=function(){var a=(new Date).getTime();if(!(this.expireTime_>a)){this.expireTime_=a+this.refreshPeriod_;0<k&&console.log("Reloading the dynamic trust anchor group");var a={},b;for(b in this.anchorNameUris_)a[b]=!0;if(this.isDirectory_){var d;try{d=Ib.readdirSync(this.path_)}catch(v){throw Error("Cannot list files in directory "+this.path_);}for(var B=0;B<d.length;++B)this.loadCertificate_(Yd.join(this.path_,d[B]),a)}else this.loadCertificate_(this.path_,a);for(b in a)delete this.anchorNameUris_[b],
this.certificates_.remove(new c(b))}};Cd.prototype.loadCertificate_=function(a,b){var c=lc.readCertificate(a);if(null!=c){var d=c.getName().toUri();this.anchorNameUris_[d]?delete b[d]:(this.anchorNameUris_[d]=!0,this.certificates_.add(c))}};var b=a.SyncPromise,F=a.Interest,k=a.Log.LOG,I=a.ValidationError,yb=a.ValidationState,Na=a.VerificationHelpers,O=a.NdnCommon,Pc=function(a,b,c){yb.call(this);this.interest_=new F(a);this.successCallbacks_=[b];this.failureCallback_=c;if(null==b)throw Error("The successCallback is null");
if(null==this.failureCallback_)throw Error("The failureCallback is null");};Pc.prototype=new yb;Pc.prototype.name="InterestValidationState";q.InterestValidationState=Pc;Pc.prototype.fail=function(a){3<k&&console.log(""+a);try{this.failureCallback_(this.interest_,a)}catch(b){console.log("Error in failureCallback: "+O.getErrorWithStackTrace(b))}this.setOutcome(!1)};Pc.prototype.getOriginalInterest=function(){return this.interest_};Pc.prototype.addSuccessCallback=function(a){this.successCallbacks_.push(a)};
Pc.prototype.verifyOriginalPacketPromise_=function(a){var c=this;return Na.verifyInterestSignaturePromise(this.interest_,a).then(function(a){if(a){3<k&&console.log("OK signature for interest `"+c.interest_.getName().toUri()+"`");for(a=0;a<c.successCallbacks_.length;++a)try{c.successCallbacks_[a](c.interest_)}catch(d){console.log("Error in successCallback: "+O.getErrorWithStackTrace(d))}c.setOutcome(!0)}else c.fail(new I(I.INVALID_SIGNATURE,"Invalid signature of interest `"+c.interest_.getName().toUri()+
"`"));return b.resolve()})};Pc.prototype.bypassValidation_=function(){3<k&&console.log("Signature verification bypassed for interest `"+this.interest_.getName().toUri()+"`");for(var a=0;a<this.successCallbacks_.length;++a)try{this.successCallbacks_[a](this.interest_)}catch(b){console.log("Error in successCallback: "+O.getErrorWithStackTrace(b))}this.setOutcome(!0)};var lc=a.TrustAnchorGroup,ud=function(a,b){lc.call(this,a,b)};ud.prototype=new lc;ud.prototype.name="StaticTrustAnchorGroup";q.StaticTrustAnchorGroup=
ud;ud.prototype.add=function(a){var b=a.getName().toUri();this.anchorNameUris_[b]||(this.anchorNameUris_[b]=!0,this.certificates_.add(a))};ud.prototype.remove=function(a){delete this.anchorNameUris_[a.toUri()];this.certificates_.remove(a)};c=a.Name;ud=a.StaticTrustAnchorGroup;Cd=a.DynamicTrustAnchorGroup;L=a.CertificateV2;ce=a.CertificateContainerInterface;cb=function r(){this.groups_={};this.anchors_=new r.AnchorContainer_};q.TrustAnchorContainer=cb;cb.Error=function(a){if(a)return a.__proto__=cb.Error.prototype,
a};cb.Error.prototype=Error();cb.Error.prototype.name="TrustAnchorContainerError";cb.prototype.insert=function(a,b,c,d){if(b instanceof L){c=this.groups_[a];void 0===c&&(c=new ud(this.anchors_,a),this.groups_[a]=c);if(!(c instanceof ud))throw new cb.Error(Error("Cannot add a static anchor to the non-static anchor group "+a));c.add(b)}else{null==d&&(d=!1);if(void 0!==this.groups_[a])throw new cb.Error(Error("Cannot create the dynamic group, because group "+a+" already exists"));this.groups_[a]=new Cd(this.anchors_,
a,b,c,d)}};cb.prototype.clear=function(){this.groups_={};this.anchors_.clear()};cb.prototype.find=function(a){if(a instanceof c){this.refresh_();var b=this.anchors_.findFirstByName_(a);if(0>b)return null;var d=this.anchors_.anchorsByName_[b].certificate;return a.isPrefixOf(d.getName())?d:null}this.refresh_();b=this.anchors_.findFirstByName_(a.getName());if(0>b)return null;for(;b<this.anchors_.anchorsByName_.length;++b){d=this.anchors_.anchorsByName_[b].certificate;if(!a.getName().isPrefixOf(d.getName()))break;
if(a.matchesData(d))return d}return null};cb.prototype.getGroup=function(a){var b=this.groups_[a];if(void 0===b)throw new cb.Error(Error("Trust anchor group "+a+" does not exist"));return b};cb.prototype.size=function(){return this.anchors_.size()};cb.AnchorContainer_=function(){this.anchorsByName_=[]};cb.AnchorContainer_.prototype=new ce;cb.AnchorContainer_.prototype.name="TrustAnchorContainerAnchorContainer";cb.AnchorContainer_.prototype.add=function(a){a=new L(a);var b=a.getName(),c=this.findFirstByName_(b);
if(0>c)c=this.anchorsByName_.length;else if(this.anchorsByName_[c].name.equals(b)){this.anchorsByName_[c].certificate=a;return}this.anchorsByName_.splice(c,0,{name:b,certificate:a})};cb.AnchorContainer_.prototype.remove=function(a){for(var b=0;b<this.anchorsByName_.length;++b)if(this.anchorsByName_[b].name.equals(a)){this.anchorsByName_.splice(b,1);break}};cb.AnchorContainer_.prototype.clear=function(){this.anchorsByName_=[]};cb.AnchorContainer_.prototype.size=function(){return this.anchorsByName_.length};
cb.AnchorContainer_.prototype.findFirstByName_=function(a){for(var b=0;b<this.anchorsByName_.length;++b)if(0<=this.anchorsByName_[b].name.compare(a))return b;return-1};cb.prototype.refresh_=function(){for(var a in this.groups_)this.groups_[a].refresh()};I=function(a,b){this.code_=a;this.info_=void 0!=b?b:""};q.ValidationError=I;I.NO_ERROR=0;I.INVALID_SIGNATURE=1;I.NO_SIGNATURE=2;I.CANNOT_RETRIEVE_CERTIFICATE=3;I.EXPIRED_CERTIFICATE=4;I.LOOP_DETECTED=5;I.MALFORMED_CERTIFICATE=6;I.EXCEEDED_DEPTH_LIMIT=
7;I.INVALID_KEY_LOCATOR=8;I.POLICY_ERROR=9;I.IMPLEMENTATION_ERROR=255;I.USER_MIN=256;I.prototype.getCode=function(){return this.code_};I.prototype.getInfo=function(){return this.info_};I.prototype.toString=function(){var a;a=this.code_===I.NO_ERROR?"No error":this.code_===I.INVALID_SIGNATURE?"Invalid signature":this.code_===I.NO_SIGNATURE?"Missing signature":this.code_===I.CANNOT_RETRIEVE_CERTIFICATE?"Cannot retrieve certificate":this.code_===I.EXPIRED_CERTIFICATE?"Certificate expired":this.code_===
I.LOOP_DETECTED?"Loop detected in certification chain":this.code_===I.MALFORMED_CERTIFICATE?"Malformed certificate":this.code_===I.EXCEEDED_DEPTH_LIMIT?"Exceeded validation depth limit":this.code_===I.INVALID_KEY_LOCATOR?"Key locator violates validation policy":this.code_===I.POLICY_ERROR?"Validation policy error":this.code_===I.IMPLEMENTATION_ERROR?"Internal implementation error":this.code_>=I.USER_MIN?"Custom error code "+this.code_:"Unrecognized error code "+this.code_;0<this.info_.length&&(a+=
" ("+this.info_+")");return a};var c=a.Name,Q=a.Data,U=a.KeyLocator,Ga=a.KeyLocatorType,s=a.WireFormat,I=a.ValidationError,L=a.CertificateV2,Pa=function(){this.innerPolicy_=this.validator_=null};q.ValidationPolicy=Pa;Pa.prototype.setInnerPolicy=function(a){if(null==a)throw Error("The innerPolicy argument cannot be null");null!=this.validator_&&a.setValidator(this.validator_);null==this.innerPolicy_?this.innerPolicy_=a:this.innerPolicy_.setInnerPolicy(a)};Pa.prototype.hasInnerPolicy=function(){return null!=
this.innerPolicy_};Pa.prototype.getInnerPolicy=function(){return this.innerPolicy_};Pa.prototype.setValidator=function(a){this.validator_=a;null!=this.innerPolicy_&&this.innerPolicy_.setValidator(a)};Pa.prototype.checkPolicy=function(a,b,c){throw Error("ValidationPolicy.checkPolicy is not implemented");};Pa.prototype.checkCertificatePolicy=function(a,b,c){this.checkPolicy(a,b,c)};Pa.getKeyLocatorName=function(a,b){if(a instanceof Q)return Pa.getKeyLocatorNameFromSignature_(a.getSignature(),b);if(2>
a.getName().size())return b.fail(new I(I.INVALID_KEY_LOCATOR,"Invalid signed Interest: name too short")),new c;var d;try{d=s.getDefaultWireFormat().decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf())}catch(k){return b.fail(new I(I.INVALID_KEY_LOCATOR,"Invalid signed Interest: "+k)),new c}return Pa.getKeyLocatorNameFromSignature_(d,b)};Pa.getKeyLocatorNameFromSignature_=function(a,b){if(!U.canGetFromSignature(a))return b.fail(new I(I.INVALID_KEY_LOCATOR,
"KeyLocator is missing")),new c;var d=U.getFromSignature(a);return d.getType()!=Ga.KEYNAME?(b.fail(new I(I.INVALID_KEY_LOCATOR,"KeyLocator type is not Name")),new c):d.getKeyName()};var Pa=a.ValidationPolicy,Dd=function(){Pa.call(this)};Dd.prototype=new Pa;Dd.prototype.name="ValidationPolicyAcceptAll";q.ValidationPolicyAcceptAll=Dd;Dd.prototype.checkPolicy=function(a,b,c){c(null,b)};var c=a.Name,Q=a.Data,hc=a.CommandInterestSigner,I=a.ValidationError,Pa=a.ValidationPolicy,Nb=function pa(a,b){Pa.call(this);
this.options_=void 0==b?new pa.Options:new pa.Options(b);this.container_=[];this.nowOffsetMilliseconds_=0;if(null==a)throw Error("inner policy is missing");this.setInnerPolicy(a);0>this.options_.gracePeriod_&&(this.options_.gracePeriod_=0)};Nb.prototype=new Pa;Nb.prototype.name="ValidationPolicyCommandInterest";q.ValidationPolicyCommandInterest=Nb;Nb.Options=function(a,b,c){a instanceof Nb.Options?(this.gracePeriod_=a.gracePeriod_,this.maxRecords_=a.maxRecords_,this.recordLifetime_=a.recordLifetime_):
(void 0==a&&(a=12E4),void 0==b&&(b=1E3),void 0==c&&(c=36E5),this.gracePeriod_=a,this.maxRecords_=b,this.recordLifetime_=c)};Nb.prototype.checkPolicy=function(a,b,c){if(a instanceof Q)this.getInnerPolicy().checkPolicy(a,b,c);else{var d=[null],k=[0];Nb.parseCommandInterest_(a,b,d,k)&&this.checkTimestamp_(b,d[0],k[0])&&this.getInnerPolicy().checkPolicy(a,b,c)}};Nb.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};Nb.LastTimestampRecord=function(a,b,d){this.keyName_=new c(a);
this.timestamp_=b;this.lastRefreshed_=d};Nb.prototype.cleanUp_=function(){for(var a=(new Date).getTime()+this.nowOffsetMilliseconds_-this.options_.recordLifetime_;0<this.container_.length&&this.container_[0].lastRefreshed_<=a||0<=this.options_.maxRecords_&&this.container_.length>this.options_.maxRecords_;)this.container_.shift()};Nb.parseCommandInterest_=function(a,b,d,k){d[0]=new c;k[0]=0;var m=a.getName();if(m.size()<hc.MINIMUM_SIZE)return b.fail(new I(I.POLICY_ERROR,"Command interest name `"+a.getName().toUri()+
"` is too short")),!1;k[0]=m.get(hc.POS_TIMESTAMP).toNumber();d[0]=Pa.getKeyLocatorName(a,b);return b.isOutcomeFailed()?!1:!0};Nb.prototype.checkTimestamp_=function(a,b,c){this.cleanUp_();var d=(new Date).getTime()+this.nowOffsetMilliseconds_;if(c<d-this.options_.gracePeriod_||c>d+this.options_.gracePeriod_)return a.fail(new I(I.POLICY_ERROR,"Timestamp is outside the grace period for key "+b.toUri())),!1;d=this.findByKeyName_(b);if(0<=d&&c<=this.container_[d].timestamp_)return a.fail(new I(I.POLICY_ERROR,
"Timestamp is reordered for key "+b.toUri())),!1;var k=this;a.addSuccessCallback(function(a){k.insertNewRecord_(a,b,c)});return!0};Nb.prototype.insertNewRecord_=function(a,b,c){a=(new Date).getTime()+this.nowOffsetMilliseconds_;c=new Nb.LastTimestampRecord(b,c,a);b=this.findByKeyName_(b);0<=b&&this.container_.splice(b,1);this.container_.push(c)};Nb.prototype.findByKeyName_=function(a){for(var b=0;b<this.container_.length;++b)if(this.container_[b].keyName_.equals(a))return b;return-1};var dc=a.BoostInfoParser,
td=a.CertificateRequest,ra=a.ValidatorConfigError,I=a.ValidationError,L=a.CertificateV2,Ac=a.ConfigRule,Q=a.Data,F=a.Interest,Pa=a.ValidationPolicy,ac=function(){Pa.call(this);this.isConfigured_=this.shouldBypass_=!1;this.dataRules_=[];this.interestRules_=[]};ac.prototype=new Pa;ac.prototype.name="ValidationPolicyConfig";q.ValidationPolicyConfig=ac;ac.prototype.load=function(a,b){if("string"===typeof a&&void 0==b){var c=new dc;c.read(a);this.load(c.getRoot(),a)}else if("string"===typeof a&&"string"===
typeof b)c=new dc,c.read(a,b),this.load(c.getRoot(),b);else{this.isConfigured_&&(this.shouldBypass_=!1,this.dataRules_=[],this.interestRules_=[],this.validator_.resetAnchors(),this.validator_.resetVerifiedCertificates());this.isConfigured_=!0;c=a.get("validator");if(1!=c.length)throw new ra(Error("ValidationPolicyConfig: Expected one validator section"));for(var d=c[0],k=d.get("rule"),c=0;c<k.length;++c){var m=Ac.create(k[c]);m.getIsForInterest()?this.interestRules_.push(m):this.dataRules_.push(m)}d=
d.get("trust-anchor");for(c=0;c<d.length;++c)this.processConfigTrustAnchor_(d[c],b)}};ac.prototype.checkPolicy=function(a,b,c){if(this.hasInnerPolicy())throw new ra(Error("ValidationPolicyConfig must be a terminal inner policy"));if(this.shouldBypass_)c(null,b);else{var d=Pa.getKeyLocatorName(a,b);if(!b.isOutcomeFailed())if(a instanceof Q){for(var k=0;k<this.dataRules_.length;++k){var m=this.dataRules_[k];if(m.match(!1,a.getName())){m.check(!1,a.getName(),d,b)&&c(new td(new F(d)),b);return}}b.fail(new I(I.POLICY_ERROR,
"No rule matched for data `"+a.getName().toUri()+"`"))}else{for(k=0;k<this.interestRules_.length;++k)if(m=this.interestRules_[k],m.match(!0,a.getName())){m.check(!0,a.getName(),d,b)&&c(new td(new F(d)),b);return}b.fail(new I(I.POLICY_ERROR,"No rule matched for interest `"+a.getName().toUri()+"`"))}}};ac.prototype.processConfigTrustAnchor_=function(a,b){var c=a.getFirstValue("type");if(null==c)throw new ra(Error("Expected <trust-anchor.type>"));if("file"==c.toLowerCase()){var k=a.getFirstValue("file-name");
if(null==k)throw new ra(Error("Expected <trust-anchor.file-name>"));c=ac.getRefreshPeriod_(a);this.validator_.loadAnchor(k,k,c,!1)}else if("base64"==c.toLowerCase()){c=a.getFirstValue("base64-string");if(null==c)throw new ra(Error("Expected <trust-anchor.base64-string>"));c=new d(c,"base64");k=new L;try{k.wireDecode(c)}catch(m){throw new ra(Error("Cannot decode certificate from base64-string: "+m));}this.validator_.loadAnchor("",k)}else if("dir"==c.toLowerCase()){k=a.getFirstValue("dir");if(null==
k)throw new ra(Error("Expected <trust-anchor.dir>"));c=ac.getRefreshPeriod_(a);this.validator_.loadAnchor(k,k,c,!0)}else if("any"==c.toLowerCase())this.shouldBypass_=!0;else throw new ra(Error("Unsupported trust-anchor.type"));};ac.getRefreshPeriod_=function(a){var b=a.getFirstValue("refresh");if(null==b)return 1E14;a=0;b=b.match(/(\d+)([hms])/);null!=b&&(a=parseInt(b[1]),"s"!=b[2]&&(a*=60,"m"!=b[2]&&(a*=60)));return 0==a?36E5:1E3*a};var F=a.Interest,td=a.CertificateRequest,na=a.PibKey,I=a.ValidationError,
Pa=a.ValidationPolicy,de=function(a){Pa.call(this);this.pib_=a};de.prototype=new Pa;de.prototype.name="ValidationPolicyFromPib";q.ValidationPolicyFromPib=de;de.prototype.checkPolicy=function(a,b,c){a=Pa.getKeyLocatorName(a,b);b.isOutcomeFailed()||this.checkPolicyHelper_(a,b,c)};de.prototype.checkPolicyHelper_=function(a,b,c){var d;try{d=this.pib_.getIdentity(na.extractIdentityFromKeyName(a))}catch(k){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the PIB identity for key "+a.toUri()+": "+
k));return}var m;try{m=d.getKey(a)}catch(n){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the PIB key "+a.toUri()+": "+n));return}var p;try{p=m.getDefaultCertificate()}catch(s){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the default certificate for key "+a.toUri()+": "+s));return}this.validator_.resetAnchors();this.validator_.loadAnchor("",p);c(new td(new F(a)),b);this.validator_.resetAnchors()};var td=a.CertificateRequest,I=a.ValidationError,F=a.Interest,Pa=a.ValidationPolicy,
me=function(){Pa.call(this)};me.prototype=new Pa;me.prototype.name="ValidationPolicySimpleHierarchy";q.ValidationPolicySimpleHierarchy=me;me.prototype.checkPolicy=function(a,b,c){keyLocatorName=Pa.getKeyLocatorName(a,b);b.isOutcomeFailed()||(keyLocatorName.getPrefix(-2).isPrefixOf(a.getName())?c(new td(new F(keyLocatorName)),b):b.fail(new I(I.INVALID_KEY_LOCATOR,"Signing policy violation for "+a.getName().toUri()+" by "+keyLocatorName.toUri())))};var b=a.SyncPromise,I=a.ValidationError,sd=a.CertificateFetcherOffline,
Mb=a.CertificateStorage,fd=a.DataValidationState,Pc=a.InterestValidationState,Q=a.Data,k=a.Log.LOG,Cb=function(a,b){Mb.call(this);void 0==b&&(b=new sd);this.policy_=a;this.certificateFetcher_=b;this.maxDepth_=25;if(null==this.policy_)throw Error("The policy is null");if(null==this.certificateFetcher_)throw Error("The certificateFetcher is null");this.policy_.setValidator(this);this.certificateFetcher_.setCertificateStorage(this)};Cb.prototype=new Mb;Cb.prototype.name="Validator";q.Validator=Cb;Cb.prototype.getPolicy=
function(){return this.policy_};Cb.prototype.getFetcher=function(){return this.certificateFetcher_};Cb.prototype.setMaxDepth=function(a){this.maxDepth_=a};Cb.prototype.getMaxDepth=function(){return this.maxDepth_};Cb.prototype.validate=function(a,b,c){a instanceof Q?(b=new fd(a,b,c),3<k&&console.log("Start validating data "+a.getName().toUri())):(b=new Pc(a,b,c),3<k&&console.log("Start validating interest "+a.getName().toUri()));var d=this;this.policy_.checkPolicy(a,b,function(a,b){null==a?b.bypassValidation_():
d.requestCertificate_(a,b)})};Cb.prototype.validateCertificate_=function(a,b){3<k&&console.log("Start validating certificate "+a.getName().toUri());if(a.isValid()){var c=this;this.policy_.checkCertificatePolicy(a,b,function(b,d){null==b?d.fail(new I(I.POLICY_ERROR,"Validation policy is not allowed to designate `"+a.getName().toUri()+"` as a trust anchor")):(d.addCertificate(a),c.requestCertificate_(b,d))})}else b.fail(new I(I.EXPIRED_CERTIFICATE,"Retrieved certificate is not yet valid or expired `"+
a.getName().toUri()+"`"))};Cb.prototype.requestCertificate_=function(a,c){if(c.getDepth()>=this.maxDepth_)c.fail(new I(I.EXCEEDED_DEPTH_LIMIT,"Exceeded validation depth limit"));else if(c.hasSeenCertificateName(a.interest_.getName()))c.fail(new I(I.LOOP_DETECTED,"Validation loop detected for certificate `"+a.interest_.getName().toUri()+"`"));else{3<k&&console.log("Retrieving "+a.interest_.getName().toUri());var d=this,m=this.findTrustedCertificate(a.interest_);null!=m?(3<k&&console.log("Found trusted certificate "+
m.getName().toUri()),c.verifyCertificateChainPromise_(m).then(function(a){return null!=a?c.verifyOriginalPacketPromise_(a):b.resolve()}).then(function(){for(var a=0;a<c.certificateChain_.length;++a)d.cacheVerifiedCertificate(c.certificateChain_[a])})):this.certificateFetcher_.fetch(a,c,function(a,b){d.validateCertificate_(a,b)})}};var ba=Ib=Yd=a,k=a.Log.LOG,c=a.Name,F=a.Interest,Q=a.Data,ya=a.ContentType,p=a.Blob,qd=a.ConfigFile,s=a.WireFormat,x=a.SecurityException,Ub=a.RsaKeyParams,ve=a.BasicIdentityStorage,
Ia=a.IdentityCertificate,Za=a.Tpm,ne=a.TpmBackEndFile,Vb=a.TpmBackEndMemory,b=a.SyncPromise,O=a.NdnCommon,ha=a.IdentityManager,L=a.CertificateV2,X=a.SigningInfo,Da=a.Sha256WithRsaSignature,Sa=a.Sha256WithEcdsaSignature,qb=a.DigestSha256Signature,jb=a.HmacWithSha256Signature,U=a.KeyLocator,Ga=a.KeyLocatorType,Aa=a.DigestAlgorithm,fa=a.KeyType,za=a.ValidityPeriod,Na=a.VerificationHelpers,Ba=a.PublicKey,jc=a.NoVerifyPolicyManager,C=function v(a,b,c){this.tpm_=this.pib_=this.face_=this.policyManager_=
this.identityManager_=null;if(void 0==a){if(!qd)throw new x(Error("KeyChain: The default KeyChain constructor is not supported in the browser"));Ib.existsSync(ve.getDefaultDatabaseFilePath())&&!Ib.existsSync(ee.getDefaultDatabaseFilePath())?(a=new ha,b=new jc):b=a=""}if("string"===typeof a){void 0==c&&(c=!1);this.isSecurityV1_=!1;var d=[null],k=[null];v.parseAndCheckPibLocator_(a,d,k);this.pib_=v.createPib_(d[0]+":"+k[0]);this.tpm_=new Za("","",null);this.pib_.initializeTpm_=this.tpm_;this.pib_.initializePibLocator_=
a;this.pib_.initializeTpmLocator_=b;this.pib_.initializeAllowReset_=c;this.tpm_.initializePib_=this.pib_}else a instanceof Z?(void 0==c&&(c=new jc),this.isSecurityV1_=!1,this.policyManager_=c,this.pib_=new la("","",a),this.tpm_=new Za("","",b)):(c=b,this.isSecurityV1_=!0,void 0==a&&(a=new ha),void 0==c&&(c=new jc),this.identityManager_=a,this.policyManager_=c)};q.KeyChain=C;C.Error=function(a){if(a)return a.__proto__=C.Error.prototype,a};C.Error.prototype=Error();C.Error.prototype.name="KeyChainError";
C.prototype.getPib=function(){if(this.isSecurityV1_)throw new x(Error("getPib is not supported for security v1"));return this.pib_};C.prototype.getTpm=function(){if(this.isSecurityV1_)throw new x(Error("getTpm is not supported for security v1"));return this.tpm_};C.prototype.getIsSecurityV1=function(){return this.isSecurityV1_};C.prototype.createIdentityV2Promise=function(a,c,d){d="boolean"===typeof c?c:d;c="boolean"!==typeof c&&c?c:void 0;void 0==c&&(c=C.getDefaultKeyParams());var m=this,n;return this.pib_.addIdentityPromise_(a,
d).then(function(a){n=a;return n.getDefaultKeyPromise(d).catch(function(a){return a instanceof la.Error?m.createKeyPromise(n,c,d):b.reject(a)})}).then(function(a){return a.getDefaultCertificatePromise(d).catch(function(c){return c instanceof la.Error?(2<k&&console.log("No default cert for "+a.getName()+", requesting self-signing"),m.selfSignPromise(a,d)):b.reject(c)})}).then(function(){return b.resolve(n)})};C.prototype.createIdentityV2=function(a,c,d,k){k="function"===typeof c?d:k;d="function"===
typeof c?c:d;return b.complete(d,k,this.createIdentityV2Promise(a,"function"!==typeof c&&c?c:void 0,!d))};C.prototype.deleteIdentityPromise=function(a,d){function k(a){return a>=p.length?b.resolve():m.tpm_.deleteKeyPromise_(p[a],d).then(function(){return k(a+1)})}var m=this;if(a instanceof c)return this.isSecurityV1_?b.reject(new C.Error(Error("deleteIdentityPromise is not supported for security v1. Use deleteIdentity."))):this.pib_.getIdentityPromise(a,d).then(function(a){return m.deleteIdentityPromise(a,
d)}).catch(function(a){return b.resolve()});var n=a.getName(),p=a.getKeys_().getKeyNames();return k(0).then(function(){return m.pib_.removeIdentityPromise_(n,d)})};C.prototype.deleteIdentity=function(a,d,k){if(a instanceof c&&this.isSecurityV1_)this.identityManager_.deleteIdentity(a,d,k);else return b.complete(d,k,this.deleteIdentityPromise(a,!d))};C.prototype.setDefaultIdentityPromise=function(a,b){return this.pib_.setDefaultIdentityPromise_(a.getName(),b)};C.prototype.setDefaultIdentity=function(a,
c,d){return b.complete(c,d,this.setDefaultIdentityPromise(a,!c))};C.prototype.createKeyPromise=function(a,c,d){d="boolean"===typeof c?c:d;c="boolean"!==typeof c&&c?c:void 0;void 0==c&&(c=C.getDefaultKeyParams());var m=this,n,p;return this.tpm_.createKeyPromise_(a.getName(),c,d).then(function(a){p=a;return m.tpm_.getPublicKeyPromise(p,d)}).then(function(b){return a.addKeyPromise_(b.buf(),p,d)}).then(function(a){n=a;2<k&&console.log("Requesting self-signing for newly created key "+n.getName().toUri());
return m.selfSignPromise(n,d)}).then(function(){return b.resolve(n)})};C.prototype.createKey=function(a,c,d,k){k="function"===typeof c?d:k;d="function"===typeof c?c:d;return b.complete(d,k,this.createKeyPromise(a,"function"!==typeof c&&c?c:void 0,!d))};C.prototype.deleteKeyPromise=function(a,c,d){var k=c.getName();if(!a.getName().equals(c.getIdentityName()))return b.reject(Error("Identity `"+a.getName().toUri()+"` does not match key `"+k.toUri()+"`"));var m=this;return a.removeKeyPromise_(k,d).then(function(){return m.tpm_.deleteKeyPromise_(k,
d)})};C.prototype.deleteKey=function(a,c,d,k){return b.complete(d,k,this.deleteKeyPromise(a,c,!d))};C.prototype.setDefaultKeyPromise=function(a,c,d){return a.getName().equals(c.getIdentityName())?a.setDefaultKeyPromise_(c.getName(),d):b.reject(Error("Identity `"+a.getName().toUri()+"` does not match key `"+c.getName().toUri()+"`"))};C.prototype.setDefaultKey=function(a,c,d,k){return b.complete(d,k,this.setDefaultKeyPromise(a,c,!d))};C.prototype.addCertificatePromise=function(a,c,d){return a.getName().equals(c.getKeyName())&&
c.getContent().equals(a.getPublicKey())?a.addCertificatePromise_(c,d):b.reject(Error("Key `"+a.getName().toUri()+"` does not match certificate `"+c.getKeyName().toUri()+"`"))};C.prototype.addCertificate=function(a,c,d,k){return b.complete(d,k,this.addCertificatePromise(a,c,!d))};C.prototype.deleteCertificatePromise=function(a,c,d){return L.isValidName(c)?a.removeCertificatePromise_(c,d):b.reject(Error("Wrong certificate name `"+c.toUri()+"`"))};C.prototype.deleteCertificate=function(a,c,d,k){return b.complete(d,
k,this.deleteCertificatePromise(a,c,!d))};C.prototype.setDefaultCertificatePromise=function(a,b,c){return this.addCertificatePromise(a,b,c).then(function(){return a.setDefaultCertificatePromise_(b.getName(),c)})};C.prototype.setDefaultCertificate=function(a,c,d,k){return b.complete(d,k,this.setDefaultCertificatePromise(a,c,!d))};C.prototype.signPromise=function(a,d,k,m){var n=d,p=k,q=m;d=n instanceof X||n instanceof c?n:void 0;k=n instanceof s?n:p instanceof s?p:void 0;m="boolean"===typeof n?n:"boolean"===
typeof p?p:"boolean"===typeof q?q:!1;void 0==k&&(k=s.getDefaultWireFormat());var H=this;return b.resolve().then(function(){if(void 0==d){if(H.isSecurityV1_)return H.prepareDefaultCertificateNamePromise_(m).then(function(a){d=a;return b.resolve()});d=C.defaultSigningInfo_}return b.resolve()}).then(function(){if(d instanceof c){var n=d;if(H.isSecurityV1_)return a instanceof F?H.identityManager_.signInterestByCertificatePromise(a,n,k,m):a instanceof Q?H.identityManager_.signByCertificatePromise(a,n,
k,m):H.identityManager_.signByCertificatePromise(a,n,m);if(!(a instanceof F||a instanceof Q))return b.reject(new x(Error("sign(buffer, certificateName) is not supported for security v2. Use sign with SigningInfo.")));var Nc=new X;Nc.setSigningCertificateName(n);return H.signPromise(a,Nc,k,m).catch(function(a){return b.reject(new x(Error("Error in sign: "+a)))})}var tb=d;if(a instanceof Q){var p=[null];return H.prepareSignatureInfoPromise_(tb,p,m).then(function(b){a.setSignature(b);b=a.wireEncode(k);
return H.signBufferPromise_(b.signedBuf(),p[0],tb.getDigestAlgorithm(),m)}).then(function(c){a.getSignature().setSignature(c);a.wireEncode(k);return b.resolve(a)})}if(a instanceof F){var s,p=[null];return H.prepareSignatureInfoPromise_(tb,p,m).then(function(b){s=b;a.getName().append(k.encodeSignatureInfo(s));a.getName().append(new c.Component);b=a.wireEncode(k);return H.signBufferPromise_(b.signedBuf(),p[0],tb.getDigestAlgorithm(),m)}).then(function(c){s.setSignature(c);a.setName(a.getName().getPrefix(-1).append(k.encodeSignatureValue(s)));
return b.resolve(a)})}p=[null];return H.prepareSignatureInfoPromise_(tb,p,m).then(function(b){return H.signBufferPromise_(a,p[0],tb.getDigestAlgorithm(),m)})})};C.prototype.sign=function(a,d,k,m,n){var p=d,q=k,H=m;d=p instanceof X||p instanceof c?p:null;k=p instanceof s?p:q instanceof s?q:null;"function"===typeof p?(m=p,n=q):"function"===typeof q?(m=q,n=H):"function"===typeof H?m=H:n=m=null;return b.complete(m,n,this.signPromise(a,d,k,!m))};C.prototype.selfSignPromise=function(a,d,k){var m=d,n=k;
d=m instanceof s?m:void 0;k="boolean"===typeof m?m:"boolean"===typeof n?n:!1;void 0==d&&(d=s.getDefaultWireFormat());var p=new L,m=(new Date).getTime(),n=new c(a.getName());n.append("self").appendVersion(m);p.setName(n);p.getMetaInfo().setType(ya.KEY);p.getMetaInfo().setFreshnessPeriod(36E5);p.setContent(a.getPublicKey());signingInfo=new X(a);signingInfo.setValidityPeriod(new za(m,m+63072E7));return this.signPromise(p,signingInfo,d,k).then(function(){return a.addCertificatePromise_(p,k).catch(function(a){return b.reject(new C.Error(Error("Error encoding certificate: "+
a)))})}).then(function(){return b.resolve(p)})};C.prototype.selfSign=function(a,c,d,k){"function"===typeof c&&(k=d,d=c,c=void 0);void 0==c&&(c=s.getDefaultWireFormat());return b.complete(d,k,this.selfSignPromise(a,c,!d))};C.prototype.importSafeBagPromise=function(a,c,d){"boolean"===typeof c&&(d=c,c=void 0);var k;try{k=new L(a.getCertificate())}catch(m){return b.reject(Error("Error reading CertificateV2: "+m))}var n=k.getIdentity(),s=k.getKeyName(),q=k.getPublicKey(),H=new p([1,2,3,4]),Nc,tb=this;
return b.resolve().then(function(){return tb.tpm_.hasKeyPromise(s,d)}).then(function(a){return a?b.reject(new C.Error(Error("Private key `"+s.toUri()+"` already exists"))):tb.pib_.getIdentityPromise(n,d).then(function(a){return a.getKeyPromise(s,d)}).then(function(){return b.reject(new C.Error(Error("Public key `"+s.toUri()+"` already exists")))},function(a){return b.resolve()})}).then(function(){return tb.tpm_.importPrivateKeyPromise_(s,a.getPrivateKeyBag().buf(),c,d).catch(function(a){return b.reject(new C.Error(Error("Failed to import private key `"+
s.toUri()+"`: "+a)))})}).then(function(){return tb.tpm_.signPromise(H.buf(),s,Aa.SHA256,d).then(function(a){Nc=a;return b.resolve()},function(a){return tb.tpm_.deleteKeyPromise_(s,d).then(function(){return b.reject(new C.Error(Error("Invalid private key `"+s.toUri()+"`")))})})}).then(function(){var a;try{a=new Ba(q)}catch(c){return tb.tpm_.deleteKeyPromise_(s,d).then(function(){return b.reject(new C.Error(Error("Error decoding public key "+c)))})}return Na.verifySignaturePromise(H,Nc,a,d)}).then(function(a){return a?
tb.pib_.addIdentityPromise_(n,d):tb.tpm_.deleteKeyPromise_(s,d).then(function(){return b.reject(new C.Error(Error("Certificate `"+k.getName().toUri()+"` and private key `"+s.toUri()+"` do not match")))})}).then(function(a){return a.addKeyPromise_(k.getPublicKey().buf(),s,d)}).then(function(a){return a.addCertificatePromise_(k,d)})};C.prototype.importSafeBag=function(a,c,d,k){k="function"===typeof c?d:k;d="function"===typeof c?c:d;return b.complete(d,k,this.importSafeBagPromise(a,"function"===typeof c?
null:c,!d))};C.registerPibBackend=function(a,b){C.getPibFactories_()[a]=b};C.registerTpmBackend=function(a,b){C.getTpmFactories_()[a]=b};C.prototype.createIdentityAndCertificate=function(a,b,c,d){d="function"===typeof b?c:d;c="function"===typeof b?b:c;b="function"!==typeof b&&b?b:C.getDefaultKeyParams();return this.identityManager_.createIdentityAndCertificate(a,b,c,d)};C.prototype.createIdentity=function(a,b){return Ia.certificateNameToPublicKeyName(this.createIdentityAndCertificate(a,b))};C.prototype.getDefaultIdentity=
function(a,c){return this.isSecurityV1_?this.identityManager_.getDefaultIdentity(a,c):b.complete(a,c,this.pib_.getDefaultIdentityPromise(!a).then(function(a){return b.resolve(a.getName())}))};C.prototype.getDefaultCertificateName=function(a,c){return this.isSecurityV1_?this.identityManager_.getDefaultCertificateName(a,c):b.complete(a,c,this.pib_.getDefaultIdentityPromise(!a).then(function(b){return b.getDefaultKeyPromise(!a)}).then(function(b){return b.getDefaultCertificatePromise(!a)}).then(function(a){return b.resolve(a.getName())}))};
C.prototype.generateRSAKeyPair=function(a,b,c){if(!this.isSecurityV1_)throw new x(Error("generateRSAKeyPair is not supported for security v2. Use createIdentityV2."));(c="boolean"===typeof b?b:c)||(c=2048);return this.identityManager_.generateRSAKeyPair(a,"boolean"===typeof b?b:!1,c)};C.prototype.setDefaultKeyForIdentity=function(a,c,d,k){return this.isSecurityV1_?this.identityManager_.setDefaultKeyForIdentity(a,c,d,k):b.complete(d,k,b.reject(new x(Error("setDefaultKeyForIdentity is not supported for security v2. Use getPib() methods."))))};
C.prototype.generateRSAKeyPairAsDefault=function(a,b,c){if(!this.isSecurityV1_)throw new x(Error("generateRSAKeyPairAsDefault is not supported for security v2. Use createIdentityV2."));return this.identityManager_.generateRSAKeyPairAsDefault(a,b,c)};C.prototype.createSigningRequest=function(a){return this.isSecurityV1_?this.identityManager_.getPublicKey(a).getKeyDer():b.complete(null,null,this.pib_.getIdentityPromise(na.extractIdentityFromKeyName(a,!0)).then(function(b){return b.getKeyPromise(a,!0)}).then(function(a){return b.resolve(a.getPublicKey())}))};
C.prototype.installIdentityCertificate=function(a,c,d){if(!this.isSecurityV1_)return b.complete(c,d,b.reject(new x(Error("installIdentityCertificate is not supported for security v2. Use getPib() methods."))));this.identityManager_.addCertificate(a,c,d)};C.prototype.setDefaultCertificateForKey=function(a,c,d){if(!this.isSecurityV1_)return b.complete(c,d,b.reject(new x(Error("setDefaultCertificateForKey is not supported for security v2. Use getPib() methods."))));this.identityManager_.setDefaultCertificateForKey(a,
c,d)};C.prototype.getCertificate=function(a,c,d){return this.isSecurityV1_?this.identityManager_.getCertificate(a,c,d):b.complete(c,d,b.reject(new x(Error("getCertificate is not supported for security v2. Use getPib() methods."))))};C.prototype.getIdentityCertificate=function(a,c,d){return this.isSecurityV1_?this.identityManager_.getCertificate(a,c,d):b.complete(c,d,b.reject(new x(Error("getIdentityCertificate is not supported for security v2. Use getPib() methods."))))};C.prototype.revokeKey=function(a){};
C.prototype.revokeCertificate=function(a){};C.prototype.getIdentityManager=function(){if(!this.isSecurityV1_)throw new x(Error("getIdentityManager is not supported for security v2"));return this.identityManager_};C.prototype.getPolicyManager=function(){return this.policyManager_};C.prototype.signByIdentity=function(a,d,k,m,n){n="function"===typeof k?m:n;m="function"===typeof k?k:m;k="function"!==typeof k&&k?k:s.getDefaultWireFormat();if(!this.isSecurityV1_)return b.complete(m,n,b.reject(new x(Error("signByIdentity(buffer, identityName) is not supported for security v2. Use sign with SigningInfo."))));
var p=!m,q=this;null==d&&(d=new c);if(a instanceof Q){var H=b.resolve().then(function(){if(0==d.size()){var b=q.policyManager_.inferSigningIdentity(a.getName());return 0==b.size()?q.identityManager_.getDefaultCertificateNamePromise(p):q.identityManager_.getDefaultCertificateNameForIdentityPromise(b,p)}return q.identityManager_.getDefaultCertificateNameForIdentityPromise(d,p)}).then(function(b){if(0==b.size())throw new x(Error("No qualified certificate name found!"));if(!q.policyManager_.checkSigningPolicy(a.getName(),
b))throw new x(Error("Signing Cert name does not comply with signing policy"));return q.identityManager_.signByCertificatePromise(a,b,k,p)});return b.complete(m,n,H)}return b.complete(m,n,this.identityManager_.getDefaultCertificateNameForIdentityPromise(d,p).then(function(b){if(0==b.size())throw new x(Error("No qualified certificate name found!"));return q.identityManager_.signByCertificatePromise(a,b,k,p)}))};C.prototype.signWithSha256=function(a,b){if(this.isSecurityV1_)a instanceof F?this.identityManager_.signInterestWithSha256(a,
b):this.identityManager_.signWithSha256(a,b);else{var c=X();c.setSha256Signing();this.sign(a,c,b)}};C.prototype.verifyData=function(a,b,c,d){null==d&&(d=0);if(this.policyManager_.requireVerify(a)){var k=this.policyManager_.checkVerificationPolicy(a,d,b,c);if(null!=k){var m=this;this.face_.expressInterest(k.interest,function(a,b){m.onCertificateData(a,b,k)},function(b){m.onCertificateInterestTimeout(b,k.retry,c,a,k)})}}else if(this.policyManager_.skipVerifyAndTrust(a))try{b(a)}catch(n){console.log("Error in onVerified: "+
O.getErrorWithStackTrace(n))}else try{c(a,"The packet has no verify rule but skipVerifyAndTrust is false")}catch(p){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(p))}};C.prototype.verifyInterest=function(a,b,c,d,k){null==d&&(d=0);k=k||s.getDefaultWireFormat();if(this.policyManager_.requireVerify(a)){var m=this.policyManager_.checkVerificationPolicy(a,d,b,c,k);if(null!=m){var n=this;this.face_.expressInterest(m.interest,function(a,b){n.onCertificateData(a,b,m)},function(b){n.onCertificateInterestTimeout(b,
m.retry,c,a,m)})}}else if(this.policyManager_.skipVerifyAndTrust(a))try{b(a)}catch(p){console.log("Error in onVerified: "+O.getErrorWithStackTrace(p))}else try{c(a,"The packet has no verify rule but skipVerifyAndTrust is false")}catch(q){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(q))}};C.prototype.setFace=function(a){this.face_=a};C.signWithHmacWithSha256=function(a,b,d,k){d instanceof s&&(k=d,d=void 0);k=k||s.getDefaultWireFormat();if(a instanceof Q)d=a.wireEncode(k),b=
ba.createHmac("sha256",b.buf()),b.update(d.signedBuf()),a.getSignature().setSignature(new p(b.digest(),!1));else if(a instanceof F){if(null==d)throw new x(Error("signWithHmacWithSha256: keyName is required to sign an Interest"));var m=new jb;m.getKeyLocator().setType(Ga.KEYNAME);m.getKeyLocator().setKeyName(d);a.getName().append(k.encodeSignatureInfo(m));a.getName().append(new c.Component);d=a.wireEncode(k);b=ba.createHmac("sha256",b.buf());b.update(d.signedBuf());m.setSignature(new p(b.digest(),
!1));a.setName(a.getName().getPrefix(-1).append(k.encodeSignatureValue(m)))}else throw new x(Error("signWithHmacWithSha256: Unrecognized target type"));};C.verifyDataWithHmacWithSha256=function(a,b,c){c=c||s.getDefaultWireFormat();c=a.wireEncode(c);b=ba.createHmac("sha256",b.buf());b.update(c.signedBuf());return(new p(b.digest(),!1)).equals(a.getSignature().getSignature())};C.verifyInterestWithHmacWithSha256=function(a,b,c){c=c||s.getDefaultWireFormat();var d=c.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),
a.getName().get(-1).getValue().buf());a=a.wireEncode(c);b=ba.createHmac("sha256",b.buf());b.update(a.signedBuf());return(new p(b.digest(),!1)).equals(d.getSignature())};C.getDefaultKeyParams=function(){return C.defaultKeyParams_};C.DEFAULT_KEY_PARAMS=new Ub;C.getPibFactories_=function(){null==C.pibFactories_&&(C.pibFactories_={},ee&&(C.pibFactories_[ee.getScheme()]=function(a){return new ee(a)}),C.pibFactories_[ta.getScheme()]=function(a){return new ta});return C.pibFactories_};C.getTpmFactories_=
function(){null==C.tpmFactories_&&(C.tpmFactories_={},ne&&(C.tpmFactories_[ne.getScheme()]=function(a){return new ne(a)}),C.tpmFactories_[Vb.getScheme()]=function(a){return new Vb});return C.tpmFactories_};C.parseLocatorUri_=function(a,b,c){iColon=a.indexOf(":");0<=iColon?(b[0]=a.substring(0,iColon),c[0]=a.substring(iColon+1)):(b[0]=a,c[0]="")};C.parseAndCheckPibLocator_=function(a,b,c){C.parseLocatorUri_(a,b,c);""==b[0]&&(b[0]=C.getDefaultPibScheme_());if(void 0==C.getPibFactories_()[b[0]])throw new C.Error(Error("PIB scheme `"+
b[0]+"` is not supported"));};C.parseAndCheckTpmLocator_=function(a,b,c){C.parseLocatorUri_(a,b,c);""==b[0]&&(b[0]=C.getDefaultTpmScheme_());if(void 0==C.getTpmFactories_()[b[0]])throw new C.Error(Error("TPM scheme `"+b[0]+"` is not supported"));};C.getDefaultPibScheme_=function(){return ee.getScheme()};C.getDefaultTpmScheme_=function(){if("darwin"===process.platform)throw new C.Error(Error("TpmBackEndOsx is not implemented. You must use tpm-file."));return ne.getScheme()};C.createPib_=function(a){var b=
[null],c=[null];C.parseAndCheckPibLocator_(a,b,c);a=C.getPibFactories_()[b[0]];return new la(b[0],c[0],a(c[0]))};C.setUpTpm_=function(a,b){var c=[null],d=[null];C.parseAndCheckTpmLocator_(b,c,d);var k=C.getTpmFactories_()[c[0]];a.scheme_=c[0];a.location_=d[0];a.backEnd_=k(d[0])};C.getDefaultPibLocator_=function(a){if(null!=C.defaultPibLocator_)return C.defaultPibLocator_;var b=process.env.NDN_CLIENT_PIB;C.defaultPibLocator_=void 0!=b&&""!=b?b:a.get("pib",C.getDefaultPibScheme_()+":");return C.defaultPibLocator_};
C.getDefaultTpmLocator_=function(a){if(null!=C.defaultTpmLocator_)return C.defaultTpmLocator_;var b=process.env.NDN_CLIENT_TPM;C.defaultTpmLocator_=void 0!=b&&""!=b?b:a.get("tpm",C.getDefaultTpmScheme_()+":");return C.defaultTpmLocator_};C.prototype.prepareSignatureInfoPromise_=function(a,c,d){var k=null,m=null,n=this;return b.resolve().then(function(){if(a.getSignerType()==X.SignerType.NULL)return n.pib_.getDefaultIdentityPromise(d).then(function(a){k=a;return b.resolve(null)},function(a){c[0]=X.getDigestSha256Identity();
return b.resolve(new qb)});if(a.getSignerType()==X.SignerType.ID)return k=a.getPibIdentity(),null==k?n.pib_.getIdentityPromise(a.getSignerName(),d).then(function(a){k=a;return b.resolve(null)},function(c){return b.reject(new Qc(Error("Signing identity `"+a.getSignerName().toUri()+"` does not exist")))}):b.resolve(null);if(a.getSignerType()==X.SignerType.KEY)return m=a.getPibKey(),null==m?(p=na.extractIdentityFromKeyName(a.getSignerName()),n.pib_.getIdentityPromise(p,d).then(function(c){return c.getKeyPromise(a.getSignerName(),
d).then(function(a){m=a;k=null;return b.resolve(null)})},function(c){return b.reject(new Qc(Error("Signing key `"+a.getSignerName().toUri()+"` does not exist")))})):b.resolve(null);if(a.getSignerType()==X.SignerType.CERT){var p=L.extractIdentityFromCertName(a.getSignerName());return n.pib_.getIdentityPromise(p,d).then(function(c){k=c;return k.getKeyPromise(L.extractKeyNameFromCertName(a.getSignerName()),d).then(function(a){m=a;return b.resolve(null)})},function(c){return b.reject(new Qc(Error("Signing certificate `"+
a.getSignerName().toUri()+"` does not exist")))})}return a.getSignerType()==X.SignerType.SHA256?(c[0]=X.getDigestSha256Identity(),b.resolve(new qb)):b.reject(new Qc(Error("Unrecognized signer type")))}).then(function(n){return null!=n?b.resolve(n):null==k&&null==m?b.reject(new Qc(Error("Cannot determine signing parameters"))):b.resolve().then(function(){return null!=k&&null==m?k.getDefaultKeyPromise(d).then(function(a){m=a;return b.resolve(null)},function(a){return b.reject(new Qc(Error("Signing identity `"+
k.getName().toUri()+"` does not have default certificate")))}):b.resolve()}).then(function(){if(m.getKeyType()==fa.RSA&&a.getDigestAlgorithm()==Aa.SHA256)signatureInfo=new Da;else if(m.getKeyType()==fa.EC&&a.getDigestAlgorithm()==Aa.SHA256)signatureInfo=new Sa;else return b.reject(new C.Error(Error("Unsupported key type")));a.getValidityPeriod().hasPeriod()&&za.canGetFromSignature(signatureInfo)&&za.getFromSignature(signatureInfo).setPeriod(a.getValidityPeriod().getNotBefore(),a.getValidityPeriod().getNotAfter());
var d=U.getFromSignature(signatureInfo);d.setType(Ga.KEYNAME);d.setKeyName(m.getName());c[0]=m.getName();return b.resolve(signatureInfo)})})};C.prototype.signBufferPromise_=function(a,c,d,k){return c.equals(X.getDigestSha256Identity())?(c=ba.createHash("sha256"),c.update(a),b.resolve(new p(c.digest(),!1))):this.tpm_.signPromise(a,c,d,k)};C.prototype.onCertificateData=function(a,b,c){this.verifyData(b,c.onVerified,c.onValidationFailed,c.stepCount)};C.prototype.onCertificateInterestTimeout=function(a,
b,c,d,k){if(0<b){var m=this;this.face_.expressInterest(a,function(a,b){m.onCertificateData(a,b,k)},function(a){m.onCertificateInterestTimeout(a,b-1,c,d,k)})}else try{c(d,"The retry count is zero after timeout for fetching "+a.getName().toUri())}catch(n){console.log("Error in onValidationFailed: "+O.getErrorWithStackTrace(n))}};C.prototype.prepareDefaultCertificateNamePromise_=function(a){var c,d=this;return this.identityManager_.getDefaultCertificatePromise(a).then(function(k){c=k;return null!=c?
b.resolve():d.setDefaultCertificatePromise_(a).then(function(){return d.identityManager_.getDefaultCertificatePromise(a)}).then(function(a){c=a;return b.resolve()})}).then(function(){return b.resolve(c.getName())})};C.prototype.setDefaultCertificatePromise_=function(a){var d=this;return this.identityManager_.getDefaultCertificatePromise(a).then(function(k){if(null!=k)return b.resolve();var m;return d.identityManager_.getDefaultIdentityPromise(a).then(function(a){m=a;return b.resolve()},function(a){randomComponent=
ba.randomBytes(4);m=(new c).append("tmp-identity").append(new p(randomComponent,!1));return b.resolve()}).then(function(){return d.identityManager_.createIdentityAndCertificatePromise(m,C.getDefaultKeyParams(),a)}).then(function(){return d.identityManager_.setDefaultIdentityPromise(m,a)})})};C.defaultPibLocator_=null;C.defaultTpmLocator_=null;C.pibFactories_=null;C.tpmFactories_=null;C.defaultSigningInfo_=new X;C.defaultKeyParams_=new Ub;var Qc=function(a){C.Error.call(this,a)};Qc.prototype=new C.Error;
Qc.prototype.name="InvalidSigningInfoError";q.InvalidSigningInfoError=Qc;q.InvalidSigningInfoError=Qc;Xd=function(a){C.Error.call(this,a)};Xd.prototype=new C.Error;Xd.prototype.name="LocatorMismatchError";q.LocatorMismatchError=Xd;var la=a.Pib,Z=a.PibImpl,na=a.PibKey,ee=a.PibSqlite3,ta=a.PibMemory,ra=function B(a){if(a)return a.__proto__=B.prototype,a};ra.prototype=Error();ra.prototype.name="ValidatorConfigError";q.ValidatorConfigError=ra;var mc=a.CertificateFetcher,ac=a.ValidationPolicyConfig,Bd=
a.CertificateFetcherFromNetwork,Cb=a.Validator,oe=function(a){a instanceof mc?Cb.call(this,new ac,a):Cb.call(this,new ac,new Bd(a));this.policyConfig_=this.getPolicy()};oe.prototype=new Cb(new ac,new Bd(null));oe.prototype.name="ValidatorConfig";q.ValidatorConfig=oe;oe.prototype.load=function(a,b){this.policyConfig_.load(a,b)};var Dd=a.ValidationPolicyAcceptAll,sd=a.CertificateFetcherOffline,Cb=a.Validator,xe=function(){Cb.call(this,new Dd,new sd)};xe.prototype=new Cb(new Dd);xe.prototype.name="ValidatorNull";
q.ValidatorNull=xe;var c=a.Name,M=a.DataUtils,p=a.Blob,Ra=function Ce(a){this.values=[];if("object"===typeof a&&a instanceof Ce)this.values=a.values.slice(0);else if(a)for(var b=this.changeCount=0;b<a.length;++b)a[b]==Ce.ANY?this.appendAny():this.appendComponent(a[b]);this.changeCount=0};q.Exclude=Ra;Ra.ANY="*";Ra.prototype.size=function(){return this.values.length};Ra.prototype.get=function(a){return this.values[a]};Ra.prototype.appendAny=function(){this.values.push(Ra.ANY);++this.changeCount;return this};
Ra.prototype.appendComponent=function(a){this.values.push(new c.Component(a));++this.changeCount;return this};Ra.prototype.clear=function(){++this.changeCount;this.values=[]};Ra.prototype.toUri=function(){if(null==this.values||0==this.values.length)return"";for(var a="",b=0;b<this.values.length;++b)0<b&&(a+=","),a=this.values[b]==Ra.ANY?a+"*":a+this.values[b].toEscapedString();return a};Ra.prototype.matches=function(a){"object"==typeof a&&a instanceof c.Component||(a=new c.Component(a));for(var b=
0;b<this.values.length;++b)if(this.values[b]==Ra.ANY){var d=null;0<b&&(d=this.values[b-1]);var k,m=null;for(k=b+1;k<this.values.length;++k)if(this.values[k]!=Ra.ANY){m=this.values[k];break}if(null!=m){if(null!=d){if(0<a.compare(d)&&0>a.compare(m))return!0}else if(0>a.compare(m))return!0;b=k-1}else if(null!=d){if(0<a.compare(d))return!0}else return!0}else if(a.equals(this.values[b]))return!0;return!1};Ra.compareComponents=function(a,b){"object"==typeof a&&a instanceof c.Component&&(a=a.getValue().buf());
"object"==typeof b&&b instanceof c.Component&&(b=b.getValue().buf());return c.Component.compareBuffers(a,b)};Ra.prototype.getChangeCount=function(){return this.changeCount};var ba=a,p=a.Blob,Wa=a.SignedBlob,ma=a.ChangeCounter,c=a.Name,Ra=a.Exclude,wb=a.Link,U=a.KeyLocator,$a=a.DelegationSet,wc=a.IncomingFaceId,s=a.WireFormat,F=function Zb(a,b,d,k,m,n,tb,s,q,H){if(null!=k)throw Error("Interest constructor: PublisherPublicKeyDigest support has been removed.");if(null!=tb)throw Error("Interest constructor: answerOriginKind support has been removed. Use setMustBeFresh().");
if(null!=s)throw Error("Interest constructor: scope support has been removed.");if(null!=H)throw Error("Interest constructor: nonce support in the constructor has been removed.");null!=b&&console.log("Interest constructor: The minSuffixComponents param is deprecated. Use setMinSuffixComponents().");null!=d&&console.log("Interest constructor: The maxSuffixComponents param is deprecated. Use setMaxSuffixComponents().");null!=m&&console.log("Interest constructor: The exclude param is deprecated. Use setExclude().");
null!=n&&console.log("Interest constructor: The childSelector param is deprecated. Use setChildSelector().");null!=q&&console.log("Interest constructor: The interestLifetimeMilliseconds param is deprecated. Use setInterestLifetimeMilliseconds().");"object"===typeof a&&a instanceof Zb?(this.name_=new ma(new c(a.getName())),this.maxSuffixComponents_=a.maxSuffixComponents_,this.minSuffixComponents_=a.minSuffixComponents_,this.keyLocator_=new ma(new U(a.getKeyLocator())),this.exclude_=new ma(new Ra(a.getExclude())),
this.childSelector_=a.childSelector_,this.mustBeFresh_=a.mustBeFresh_,this.interestLifetimeMilliseconds_=a.interestLifetimeMilliseconds_,this.forwardingHint_=new ma(new $a(a.getForwardingHint())),this.nonce_=a.nonce_,this.linkWireEncoding_=a.linkWireEncoding_,this.linkWireEncodingFormat_=a.linkWireEncodingFormat_,this.link_=new ma(null),null!=a.link_.get()&&this.link_.set(new wb(a.link_.get())),this.selectedDelegationIndex_=a.selectedDelegationIndex_,this.defaultWireEncoding_=a.getDefaultWireEncoding(),
this.defaultWireEncodingFormat_=a.defaultWireEncodingFormat_):(this.name_=new ma("object"===typeof a&&a instanceof c?new c(a):new c),this.maxSuffixComponents_=d,this.minSuffixComponents_=b,this.keyLocator_=new ma(new U),this.exclude_=new ma("object"===typeof m&&m instanceof Ra?new Ra(m):new Ra),this.childSelector_=n,this.mustBeFresh_=!0,this.interestLifetimeMilliseconds_=q,this.forwardingHint_=new ma(new $a),this.nonce_=new p,this.linkWireEncoding_=new p,this.linkWireEncodingFormat_=null,this.link_=
new ma(null),this.selectedDelegationIndex_=null,this.defaultWireEncoding_=new Wa,this.defaultWireEncodingFormat_=null);this.changeCount_=this.getDefaultWireEncodingChangeCount_=this.getNonceChangeCount_=0;this.lpPacket_=null};q.Interest=F;F.RECURSIVE_POSTFIX="*";F.CHILD_SELECTOR_LEFT=0;F.CHILD_SELECTOR_RIGHT=1;F.prototype.matchesName=function(a){return!this.getName().match(a)||null!=this.minSuffixComponents_&&!(a.size()+1-this.getName().size()>=this.minSuffixComponents_)||null!=this.maxSuffixComponents_&&
!(a.size()+1-this.getName().size()<=this.maxSuffixComponents_)||null!=this.getExclude()&&a.size()>this.getName().size()&&this.getExclude().matches(a.get(this.getName().size()))?!1:!0};F.prototype.matches_name=function(a){return this.matchesName(a)};F.prototype.matchesData=function(a,b){b=b||s.getDefaultWireFormat();var c=this.getName().size(),d=a.getName(),k=d.size()+1,m=null!=this.getMinSuffixComponents()?this.getMinSuffixComponents():0;if(!(c+m<=k&&(null==this.getMaxSuffixComponents()||c+this.getMaxSuffixComponents()>=
k)))return!1;if(c===k)if(this.getName().get(-1).isImplicitSha256Digest()){if(!this.getName().equals(a.getFullName(b)))return!1}else return!1;else if(!this.getName().isPrefixOf(d))return!1;if(0<this.getExclude().size()&&k>c)if(c==k-1){if(this.getExclude().matches(a.getFullName(b).get(c)))return!1}else if(this.getExclude().matches(d.get(c)))return!1;c=this.getKeyLocator();return!c.getType()||(d=a.getSignature(),U.canGetFromSignature(d)&&c.equals(U.getFromSignature(d)))?!0:!1};F.prototype.clone=function(){return new F(this)};
F.prototype.getName=function(){return this.name_.get()};F.prototype.getMinSuffixComponents=function(){return this.minSuffixComponents_};F.prototype.getMaxSuffixComponents=function(){return this.maxSuffixComponents_};F.prototype.getCanBePrefix=function(){return 1!=this.maxSuffixComponents_};F.prototype.getKeyLocator=function(){return this.keyLocator_.get()};F.prototype.getExclude=function(){return this.exclude_.get()};F.prototype.getChildSelector=function(){return this.childSelector_};F.prototype.getMustBeFresh=
function(){return this.mustBeFresh_};F.prototype.getNonce=function(){this.getNonceChangeCount_!=this.getChangeCount()&&(this.nonce_=new p,this.getNonceChangeCount_=this.getChangeCount());return this.nonce_};F.prototype.getForwardingHint=function(){return this.forwardingHint_.get()};F.prototype.getNonceAsBuffer=function(){return this.getNonce().buf()};F.prototype.hasLink=function(){return null!=this.link_.get()||!this.linkWireEncoding_.isNull()};F.prototype.getLink=function(){if(null!=this.link_.get())return this.link_.get();
if(this.linkWireEncoding_.isNull())return null;var a=new wb;a.wireDecode(this.linkWireEncoding_,this.linkWireEncodingFormat_);this.link_.set(a);this.linkWireEncoding_=new p;this.linkWireEncodingFormat_=null;return a};F.prototype.getLinkWireEncoding=function(a){a=a||s.getDefaultWireFormat();if(!this.linkWireEncoding_.isNull()&&this.linkWireEncodingFormat_==a)return this.linkWireEncoding_;var b=this.getLink();return null!=b?b.wireEncode(a):new p};F.prototype.getSelectedDelegationIndex=function(){return this.selectedDelegationIndex_};
F.prototype.getInterestLifetimeMilliseconds=function(){return this.interestLifetimeMilliseconds_};F.prototype.getDefaultWireEncoding=function(){this.getDefaultWireEncodingChangeCount_!=this.getChangeCount()&&(this.defaultWireEncoding_=new Wa,this.defaultWireEncodingFormat_=null,this.getDefaultWireEncodingChangeCount_=this.getChangeCount());return this.defaultWireEncoding_};F.prototype.getDefaultWireEncodingFormat=function(){return this.defaultWireEncodingFormat_};F.prototype.getIncomingFaceId=function(){var a=
null===this.lpPacket_?null:wc.getFirstHeader(this.lpPacket_);return null===a?null:a.getFaceId()};F.prototype.setName=function(a){this.name_.set("object"===typeof a&&a instanceof c?new c(a):new c);++this.changeCount_;return this};F.prototype.setMinSuffixComponents=function(a){this.minSuffixComponents_=a;++this.changeCount_;return this};F.prototype.setMaxSuffixComponents=function(a){this.maxSuffixComponents_=a;++this.changeCount_;return this};F.prototype.setCanBePrefix=function(a){this.maxSuffixComponents_=
a?null:1;++this.changeCount_;return this};F.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof U?new U(a):new U);++this.changeCount_;return this};F.prototype.setExclude=function(a){this.exclude_.set("object"===typeof a&&a instanceof Ra?new Ra(a):new Ra);++this.changeCount_;return this};F.prototype.setForwardingHint=function(a){this.forwardingHint_.set("object"===typeof a&&a instanceof $a?new $a(a):new $a);++this.changeCount_;return this};F.prototype.setLinkWireEncoding=
function(a,b){b=b||s.getDefaultWireFormat();this.linkWireEncoding_=a;this.linkWireEncodingFormat_=b;this.link_.set(null);++this.changeCount_;return this};F.prototype.unsetLink=function(){return this.setLinkWireEncoding(new p,null)};F.prototype.setSelectedDelegationIndex=function(a){this.selectedDelegationIndex_=a;++this.changeCount_;return this};F.prototype.setChildSelector=function(a){this.childSelector_=a;++this.changeCount_;return this};F.prototype.setMustBeFresh=function(a){this.mustBeFresh_=
a?!0:!1;++this.changeCount_;return this};F.prototype.setInterestLifetimeMilliseconds=function(a){this.interestLifetimeMilliseconds_=a;++this.changeCount_;return this};F.prototype.setNonce=function(a){this.nonce_="object"===typeof a&&a instanceof p?a:new p(a,!0);++this.changeCount_;this.getNonceChangeCount_=this.getChangeCount();return this};F.prototype.toUri=function(){var a="";null!=this.minSuffixComponents_&&(a+="&ndn.MinSuffixComponents="+this.minSuffixComponents_);null!=this.maxSuffixComponents_&&
(a+="&ndn.MaxSuffixComponents="+this.maxSuffixComponents_);null!=this.childSelector_&&(a+="&ndn.ChildSelector="+this.childSelector_);a+="&ndn.MustBeFresh="+(this.mustBeFresh_?1:0);null!=this.interestLifetimeMilliseconds_&&(a+="&ndn.InterestLifetime="+this.interestLifetimeMilliseconds_);0<this.getNonce().size()&&(a+="&ndn.Nonce="+c.toEscapedString(this.getNonce().buf()));null!=this.getExclude()&&0<this.getExclude().size()&&(a+="&ndn.Exclude="+this.getExclude().toUri());var b=this.getName().toUri();
""!=a&&(b+="?"+a.substr(1));return b};F.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&this.getDefaultWireEncodingFormat()==a)return this.getDefaultWireEncoding();var b=a.encodeInterest(this),b=new Wa(b.encoding,b.signedPortionBeginOffset,b.signedPortionEndOffset);a==s.getDefaultWireFormat()&&this.setDefaultWireEncoding(b,s.getDefaultWireFormat());return b};F.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();var c;c="object"===
typeof a&&a instanceof p?b.decodeInterest(this,a.buf(),!1):b.decodeInterest(this,a,!0);b==s.getDefaultWireFormat()?this.setDefaultWireEncoding(new Wa(new p(a,!0),c.signedPortionBeginOffset,c.signedPortionEndOffset),s.getDefaultWireFormat()):this.setDefaultWireEncoding(new Wa,null)};F.prototype.refreshNonce=function(){var a=this.getNonce();if(0!==a.size()){for(var b;b=new p(ba.randomBytes(a.size()),!1),b.equals(a););this.nonce_=b;++this.changeCount_;this.getNonceChangeCount_=this.getChangeCount()}};
F.prototype.setLpPacket=function(a){this.lpPacket_=a;return this};F.prototype.getChangeCount=function(){var a=this.name_.checkChanged(),a=this.keyLocator_.checkChanged()||a,a=this.exclude_.checkChanged()||a;(a=this.forwardingHint_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};F.prototype.setDefaultWireEncoding=function(a,b){this.defaultWireEncoding_=a;this.defaultWireEncodingFormat_=b;this.getDefaultWireEncodingChangeCount_=this.getChangeCount()};Object.defineProperty(F.prototype,
"name",{get:function(){return this.getName()},set:function(a){this.setName(a)}});Object.defineProperty(F.prototype,"minSuffixComponents",{get:function(){return this.getMinSuffixComponents()},set:function(a){this.setMinSuffixComponents(a)}});Object.defineProperty(F.prototype,"maxSuffixComponents",{get:function(){return this.getMaxSuffixComponents()},set:function(a){this.setMaxSuffixComponents(a)}});Object.defineProperty(F.prototype,"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});
Object.defineProperty(F.prototype,"exclude",{get:function(){return this.getExclude()},set:function(a){this.setExclude(a)}});Object.defineProperty(F.prototype,"childSelector",{get:function(){return this.getChildSelector()},set:function(a){this.setChildSelector(a)}});Object.defineProperty(F.prototype,"interestLifetime",{get:function(){return this.getInterestLifetimeMilliseconds()},set:function(a){this.setInterestLifetimeMilliseconds(a)}});Object.defineProperty(F.prototype,"nonce",{get:function(){return this.getNonceAsBuffer()},
set:function(a){this.setNonce(a)}});Fa=function Re(a){"object"===typeof a&&a instanceof Re?(this.childInherit=a.childInherit,this.capture=a.capture):(this.childInherit=!0,this.capture=!1)};q.ForwardingFlags=Fa;Fa.NfdForwardingFlags_CHILD_INHERIT=1;Fa.NfdForwardingFlags_CAPTURE=2;Fa.prototype.getNfdForwardingFlags=function(){var a=0;this.childInherit&&(a|=Fa.NfdForwardingFlags_CHILD_INHERIT);this.capture&&(a|=Fa.NfdForwardingFlags_CAPTURE);return a};Fa.prototype.setNfdForwardingFlags=function(a){this.childInherit=
0!=(a&Fa.NfdForwardingFlags_CHILD_INHERIT);this.capture=0!=(a&Fa.NfdForwardingFlags_CAPTURE)};Fa.prototype.getChildInherit=function(){return this.childInherit};Fa.prototype.getCapture=function(){return this.capture};Fa.prototype.setChildInherit=function(a){this.childInherit=a};Fa.prototype.setCapture=function(a){this.capture=a};var Fa=a.ForwardingFlags,c=a.Name,s=a.WireFormat,p=a.Blob,Qa=function Se(a){"object"===typeof a&&a instanceof Se?(this.name=null==a.name?null:new c(a.name),this.faceId=a.faceId,
this.uri=a.uri,this.localControlFeature=a.localControlFeature,this.origin=a.origin,this.cost=a.cost,this.forwardingFlags=new Fa(a.forwardingFlags),this.strategy=new c(a.strategy),this.expirationPeriod=a.expirationPeriod):(this.faceId=this.name=null,this.uri="",this.cost=this.origin=this.localControlFeature=null,this.forwardingFlags=new Fa,this.strategy=new c,this.expirationPeriod=null)};q.ControlParameters=Qa;Qa.prototype.clear=function(){this.faceId=this.name=null;this.uri="";this.cost=this.origin=
this.localControlFeature=null;this.forwardingFlags=new Fa;this.strategy=new c;this.expirationPeriod=null};Qa.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();return a.encodeControlParameters(this)};Qa.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeControlParameters(this,a.buf(),!1):b.decodeControlParameters(this,a,!0)};Qa.prototype.getName=function(){return this.name};Qa.prototype.getFaceId=function(){return this.faceId};
Qa.prototype.getUri=function(){return this.uri};Qa.prototype.getLocalControlFeature=function(){return this.localControlFeature};Qa.prototype.getOrigin=function(){return this.origin};Qa.prototype.getCost=function(){return this.cost};Qa.prototype.getForwardingFlags=function(){return this.forwardingFlags};Qa.prototype.getStrategy=function(){return this.strategy};Qa.prototype.getExpirationPeriod=function(){return this.expirationPeriod};Qa.prototype.setName=function(a){this.name="object"===typeof a&&a instanceof
c?new c(a):null};Qa.prototype.setFaceId=function(a){this.faceId=a};Qa.prototype.setUri=function(a){this.uri=a||""};Qa.prototype.setLocalControlFeature=function(a){this.localControlFeature=a};Qa.prototype.setOrigin=function(a){this.origin=a};Qa.prototype.setCost=function(a){this.cost=a};Qa.prototype.setForwardingFlags=function(a){this.forwardingFlags="object"===typeof a&&a instanceof Fa?new Fa(a):new Fa};Qa.prototype.setStrategy=function(a){this.strategy="object"===typeof a&&a instanceof c?new c(a):
new c};Qa.prototype.setExpirationPeriod=function(a){this.expirationPeriod=a};var Qa=a.ControlParameters,s=a.WireFormat,p=a.Blob,nc=function Te(a){"object"===typeof a&&a instanceof Te?(this.statusCode_=a.statusCode_,this.statusText_=a.statusText_,this.bodyAsControlParameters_=null==a.bodyAsControlParameters_?null:new Qa(a.bodyAsControlParameters_)):(this.statusCode_=null,this.statusText_="",this.bodyAsControlParameters_=null)};q.ControlResponse=nc;nc.prototype.clear=function(){this.statusCode_=null;
this.statusText_="";this.bodyAsControlParameters_=null};nc.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();return a.encodeControlResponse(this)};nc.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeControlResponse(this,a.buf(),!1):b.decodeControlResponse(this,a,!0)};nc.prototype.getStatusCode=function(){return this.statusCode_};nc.prototype.getStatusText=function(){return this.statusText_};nc.prototype.getBodyAsControlParameters=
function(){return this.bodyAsControlParameters_};nc.prototype.setStatusCode=function(a){this.statusCode_=a;return this};nc.prototype.setStatusText=function(a){this.statusText_=a||"";return this};nc.prototype.setBodyAsControlParameters=function(a){this.bodyAsControlParameters_="object"===typeof a&&a instanceof Qa?new Qa(a):null;return this};c=a.Name;Ua=a.NdnRegexTopMatcher;uc=function Be(a,b){"object"===typeof a&&a instanceof Be?(this.prefix=new c(a.prefix),this.regexFilter=a.regexFilter,this.regexFilterPattern=
a.regexFilterPattern):(this.prefix=new c(a),b?(this.regexFilter=b,this.regexFilterPattern=Be.makePattern(b)):this.regexFilterPattern=this.regexFilter=null)};q.InterestFilter=uc;uc.prototype.doesMatch=function(a){return a.size()<this.prefix.size()?!1:this.hasRegexFilter()?this.prefix.match(a)?(new Ua(this.regexFilterPattern)).match(a.getSubName(this.prefix.size())):!1:this.prefix.match(a)};uc.prototype.getPrefix=function(){return this.prefix};uc.prototype.hasRegexFilter=function(){return null!=this.regexFilter};
uc.prototype.getRegexFilter=function(){return this.regexFilter};uc.makePattern=function(a){1<=a.length&&"^"==a[0]||(a="^"+a);1<=a.length&&"$"==a[-1]||(a+="$");return a};c=a.Name;p=a.Blob;s=a.WireFormat;$a=function Ye(a){this.delegations_="object"===typeof a&&a instanceof Ye?a.delegations_.slice(0):[];this.changeCount_=0};q.DelegationSet=$a;$a.Delegation=function(a,b){this.preference_=a;this.name_=new c(b)};$a.Delegation.prototype.getPreference=function(){return this.preference_};$a.Delegation.prototype.getName=
function(){return this.name_};$a.Delegation.prototype.compare=function(a){return this.preference_<a.preference_?-1:this.preference_>a.preference_?1:this.name_.compare(a.name_)};$a.prototype.add=function(a,b){this.remove(b);for(var c=new $a.Delegation(a,b),d=0;d<this.delegations_.length&&!(0<=this.delegations_[d].compare(c));)++d;this.delegations_.splice(d,0,c);++this.changeCount_};$a.prototype.addUnsorted=function(a,b){this.delegations_.push(new $a.Delegation(a,b));++this.changeCount_};$a.prototype.remove=
function(a){for(var b=!1,c=this.delegations_.length-1;0<=c;--c)this.delegations_[c].getName().equals(a)&&(b=!0,this.delegations_.splice(c,1));b&&++this.changeCount_;return b};$a.prototype.clear=function(){this.delegations_=[];++this.changeCount_};$a.prototype.size=function(){return this.delegations_.length};$a.prototype.get=function(a){return this.delegations_[a]};$a.prototype.find=function(a){for(var b=0;b<this.delegations_.length;++b)if(this.delegations_[b].getName().equals(a))return b;return-1};
$a.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();return a.encodeDelegationSet(this)};$a.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeDelegationSet(this,a.buf(),!1):b.decodeDelegationSet(this,a,!0)};$a.prototype.getChangeCount=function(){return this.changeCount_};$a=a.DelegationSet;ya=a.ContentType;s=a.WireFormat;Q=a.Data;wb=function(a){this.delegations_=new $a;if(a instanceof Q){if(Q.call(this,a),!this.getContent().isNull())try{this.delegations_.wireDecode(this.getContent()),
this.getMetaInfo().setType(ya.LINK)}catch(b){this.delegations_.clear()}}else void 0!=a?Q.call(this,a):Q.call(this),this.getMetaInfo().setType(ya.LINK)};wb.prototype=new Q;wb.prototype.name="Link";q.Link=wb;wb.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();Q.prototype.wireDecode.call(this,a,b);if(this.getMetaInfo().getType()!=ya.LINK)throw Error("Link.wireDecode: MetaInfo ContentType is not LINK.");this.delegations_.wireDecode(this.getContent())};wb.prototype.addDelegation=function(a,
b,c){c=c||s.getDefaultWireFormat();this.delegations_.add(a,b);this.encodeContent(c);return this};wb.prototype.removeDelegation=function(a,b){b=b||s.getDefaultWireFormat();var c=this.delegations_.remove(a);c&&this.encodeContent(b);return c};wb.prototype.getDelegations=function(){return this.delegations_};wb.prototype.encodeContent=function(a){this.setContent(this.delegations_.wireEncode(a));this.getMetaInfo().setType(ya.LINK)};var gb=function Nc(){this.reason_=Nc.Reason.NONE;this.otherReasonCode_=
-1};q.NetworkNack=gb;gb.Reason={NONE:0,CONGESTION:50,DUPLICATE:100,NO_ROUTE:150,OTHER_CODE:32767};gb.prototype.getReason=function(){return this.reason_};gb.prototype.getOtherReasonCode=function(){return this.otherReasonCode_};gb.prototype.setReason=function(a){this.reason_=a};gb.prototype.setOtherReasonCode=function(a){if(0>a)throw Error("NetworkNack other reason code must be non-negative");this.otherReasonCode_=a};gb.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var c=a.getHeaderField(b);
if(c instanceof gb)return c}return null};var ba=a,p=a.Blob,c=a.Name,bb=a.ComponentType,Fa=a.ForwardingFlags,n=a.Tlv,va=a.TlvEncoder,oa=a.TlvDecoder,s=a.WireFormat,Ra=a.Exclude,ya=a.ContentType,Ga=a.KeyLocatorType,Da=a.Sha256WithRsaSignature,Sa=a.Sha256WithEcdsaSignature,Tb=a.GenericSignature,jb=a.HmacWithSha256Signature,qb=a.DigestSha256Signature,Qa=a.ControlParameters,Fa=a.ForwardingFlags,gb=a.NetworkNack,ea=a.Schedule,wc=a.IncomingFaceId,$c=a.CongestionMark,R=a.DecodingException,G=function(){s.call(this)};
G.prototype=new s;G.prototype.name="Tlv0_2WireFormat";q.Tlv0_2WireFormat=G;G.instance=null;G.prototype.encodeName=function(a){var b=new va;G.encodeName(a,b);return new p(b.getOutput(),!1)};G.prototype.decodeName=function(a,b,c){null==c&&(c=!0);b=new oa(b);G.decodeName(a,b,c)};G.prototype.encodeInterest=function(a){var b=new va(256),c=b.getLength();if(0<a.getForwardingHint().size()){if(null!=a.getSelectedDelegationIndex())throw Error("An Interest may not have a selected delegation when encoding a forwarding hint");
if(a.hasLink())throw Error("An Interest may not have a link object when encoding a forwarding hint");var k=b.getLength();G.encodeDelegationSet_(a.getForwardingHint(),b);b.writeTypeAndLength(n.ForwardingHint,b.getLength()-k)}b.writeOptionalNonNegativeIntegerTlv(n.SelectedDelegation,a.getSelectedDelegationIndex());k=a.getLinkWireEncoding(this);k.isNull()||b.writeBuffer(k.buf());b.writeOptionalNonNegativeIntegerTlv(n.InterestLifetime,a.getInterestLifetimeMilliseconds());if(a.getNonce().isNull()||0==
a.getNonce().size())b.writeBlobTlv(n.Nonce,ba.randomBytes(4));else if(4>a.getNonce().size()){k=d(4);a.getNonce().buf().copy(k);for(var m=a.getNonce().size();4>m;++m)k[m]=ba.randomBytes(1)[0];b.writeBlobTlv(n.Nonce,k)}else 4==a.getNonce().size()?b.writeBlobTlv(n.Nonce,a.getNonce().buf()):b.writeBlobTlv(n.Nonce,a.getNonce().buf().slice(0,4));G.encodeSelectors(a,b);k=G.encodeName(a.getName(),b);a=b.getLength()-k.signedPortionBeginOffset;k=b.getLength()-k.signedPortionEndOffset;b.writeTypeAndLength(n.Interest,
b.getLength()-c);c=b.getLength()-a;a=b.getLength()-k;return{encoding:new p(b.getOutput(),!1),signedPortionBeginOffset:c,signedPortionEndOffset:a}};G.prototype.decodeInterest=function(a,b,c){try{return this.decodeInterestV02_(a,b,c)}catch(d){try{return G.decodeInterestV03_(a,b,c)}catch(k){throw d;}}};G.prototype.decodeInterestV02_=function(a,b,c){null==c&&(c=!0);b=new oa(b);var d=b.readNestedTlvsStart(n.Interest),k=G.decodeName(a.getName(),b,c);b.peekType(n.Selectors,d)?G.decodeSelectors(a,b,c):(a.setMinSuffixComponents(null),
a.setMaxSuffixComponents(null),a.getKeyLocator().clear(),a.getExclude().clear(),a.setChildSelector(null),a.setMustBeFresh(!1));var m=b.readBlobTlv(n.Nonce);a.setInterestLifetimeMilliseconds(b.readOptionalNonNegativeIntegerTlv(n.InterestLifetime,d));if(b.peekType(n.ForwardingHint,d)){var s=b.readNestedTlvsStart(n.ForwardingHint);G.decodeDelegationSet_(a.getForwardingHint(),s,b,c);b.finishNestedTlvs(s)}if(b.peekType(n.Data,d)){var s=b.getOffset(),q=b.readNestedTlvsStart(n.Data);b.seek(q);a.setLinkWireEncoding(new p(b.getSlice(s,
q),c),this)}else a.unsetLink();a.setSelectedDelegationIndex(b.readOptionalNonNegativeIntegerTlv(n.SelectedDelegation,d));if(null!=a.getSelectedDelegationIndex()&&0<=a.getSelectedDelegationIndex()&&!a.hasLink())throw Error("Interest has a selected delegation, but no link object");a.setNonce(new p(m,c));b.finishNestedTlvs(d);return k};G.prototype.encodeData=function(a){var b=new va(1500),c=b.getLength();b.writeBlobTlv(n.SignatureValue,a.getSignature().getSignature().buf());var d=b.getLength();G.encodeSignatureInfo_(a.getSignature(),
b);b.writeBlobTlv(n.Content,a.getContent().buf());G.encodeMetaInfo(a.getMetaInfo(),b);G.encodeName(a.getName(),b);a=b.getLength();b.writeTypeAndLength(n.Data,b.getLength()-c);c=b.getLength()-a;d=b.getLength()-d;return{encoding:new p(b.getOutput(),!1),signedPortionBeginOffset:c,signedPortionEndOffset:d}};G.prototype.decodeData=function(a,b,c){null==c&&(c=!0);b=new oa(b);var d=b.readNestedTlvsStart(n.Data),k=b.getOffset();G.decodeName(a.getName(),b,c);G.decodeMetaInfo(a.getMetaInfo(),b,c);a.setContent(new p(b.readBlobTlv(n.Content),
c));G.decodeSignatureInfo(a,b,c);var m=b.getOffset();a.getSignature().setSignature(new p(b.readBlobTlv(n.SignatureValue),c));b.finishNestedTlvs(d);return{signedPortionBeginOffset:k,signedPortionEndOffset:m}};G.prototype.encodeControlParameters=function(a){var b=new va(256);G.encodeControlParameters(a,b);return new p(b.getOutput(),!1)};G.prototype.decodeControlParameters=function(a,b,c){null==c&&(c=!0);b=new oa(b);G.decodeControlParameters(a,b,c)};G.prototype.encodeControlResponse=function(a){var b=
new va(256),c=b.getLength();null!=a.getBodyAsControlParameters()&&G.encodeControlParameters(a.getBodyAsControlParameters(),b);b.writeBlobTlv(n.NfdCommand_StatusText,(new p(a.getStatusText())).buf());b.writeNonNegativeIntegerTlv(n.NfdCommand_StatusCode,a.getStatusCode());b.writeTypeAndLength(n.NfdCommand_ControlResponse,b.getLength()-c);return new p(b.getOutput(),!1)};G.prototype.decodeControlResponse=function(a,b,c){null==c&&(c=!0);b=new oa(b);var d=b.readNestedTlvsStart(n.NfdCommand_ControlResponse);
a.setStatusCode(b.readNonNegativeIntegerTlv(n.NfdCommand_StatusCode));var k=new p(b.readBlobTlv(n.NfdCommand_StatusText),!1);a.setStatusText(k.toString());b.peekType(n.ControlParameters_ControlParameters,d)?(a.setBodyAsControlParameters(new Qa),G.decodeControlParameters(a.getBodyAsControlParameters(),b,c)):a.setBodyAsControlParameters(null);b.finishNestedTlvs(d)};G.prototype.encodeSignatureInfo=function(a){var b=new va(256);G.encodeSignatureInfo_(a,b);return new p(b.getOutput(),!1)};G.SignatureHolder=
function(){};G.SignatureHolder.prototype.setSignature=function(a){this.signature=a};G.SignatureHolder.prototype.getSignature=function(){return this.signature};G.prototype.decodeSignatureInfoAndValue=function(a,b,c){null==c&&(c=!0);var d=new G.SignatureHolder;a=new oa(a);G.decodeSignatureInfo(d,a,c);a=new oa(b);d.getSignature().setSignature(new p(a.readBlobTlv(n.SignatureValue),c));return d.getSignature()};G.prototype.encodeSignatureValue=function(a){var b=new va(256);b.writeBlobTlv(n.SignatureValue,
a.getSignature().buf());return new p(b.getOutput(),!1)};G.prototype.decodeLpPacket=function(a,b,c){null==c&&(c=!0);a.clear();for(var d=new oa(b),k=d.readNestedTlvsStart(n.LpPacket_LpPacket);d.getOffset()<k;){var m=d.readVarNumber(),s=d.readVarNumber(),q=d.getOffset()+s;if(q>b.length)throw new R(Error("TLV length exceeds the buffer length"));if(m==n.LpPacket_Fragment){a.setFragmentWireEncoding(new p(d.getSlice(d.getOffset(),q),c));d.seek(q);break}else if(m==n.LpPacket_Nack)s=new gb,m=d.readOptionalNonNegativeIntegerTlv(n.LpPacket_NackReason,
q),0>m||m==gb.Reason.NONE?s.setReason(gb.Reason.NONE):m==gb.Reason.CONGESTION||m==gb.Reason.DUPLICATE||m==gb.Reason.NO_ROUTE?s.setReason(m):(s.setReason(gb.Reason.OTHER_CODE),s.setOtherReasonCode(m)),a.addHeaderField(s);else if(m==n.LpPacket_IncomingFaceId)m=new wc,m.setFaceId(d.readNonNegativeInteger(s)),a.addHeaderField(m);else if(m==n.LpPacket_CongestionMark)m=new $c,m.setCongestionMark(d.readNonNegativeInteger(s)),a.addHeaderField(m);else{if(!(m>=n.LpPacket_IGNORE_MIN&&m<=n.LpPacket_IGNORE_MAX&&
0==(m&3)))throw new R(Error("Did not get the expected TLV type"));d.seek(q)}d.finishNestedTlvs(q)}d.finishNestedTlvs(k)};G.prototype.encodeDelegationSet=function(a){var b=new va(256);G.encodeDelegationSet_(a,b);return new p(b.getOutput(),!1)};G.prototype.decodeDelegationSet=function(a,b,c){null==c&&(c=!0);var d=new oa(b);G.decodeDelegationSet_(a,b.length,d,c)};G.prototype.encodeEncryptedContent=function(a){var b=new va(256),c=b.getLength();b.writeBlobTlv(n.Encrypt_EncryptedPayload,a.getPayload().buf());
b.writeOptionalBlobTlv(n.Encrypt_InitialVector,a.getInitialVector().buf());b.writeNonNegativeIntegerTlv(n.Encrypt_EncryptionAlgorithm,a.getAlgorithmType());G.encodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b);b.writeTypeAndLength(n.Encrypt_EncryptedContent,b.getLength()-c);return new p(b.getOutput(),!1)};G.prototype.decodeEncryptedContent=function(a,b,c){null==c&&(c=!0);b=new oa(b);var d=b.readNestedTlvsStart(n.Encrypt_EncryptedContent);G.decodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b,c);a.setAlgorithmType(b.readNonNegativeIntegerTlv(n.Encrypt_EncryptionAlgorithm));
a.setInitialVector(new p(b.readOptionalBlobTlv(n.Encrypt_InitialVector,d),c));a.setPayload(new p(b.readBlobTlv(n.Encrypt_EncryptedPayload),c));b.finishNestedTlvs(d)};G.get=function(){null===G.instance&&(G.instance=new G);return G.instance};G.encodeNameComponent=function(a,b){var c;c=a.getType()===bb.OTHER_CODE?a.getOtherTypeCode():a.getType();b.writeBlobTlv(c,a.getValue().buf())};G.decodeNameComponent=function(a,b){null==b&&(b=!0);var d=a.getOffset(),k=a.readVarNumber();a.seek(d);d=new p(a.readBlobTlv(k),
b);return k===n.ImplicitSha256DigestComponent?c.Component.fromImplicitSha256Digest(d):k===n.ParametersSha256DigestComponent?c.Component.fromParametersSha256Digest(d):k===n.NameComponent?new c.Component(d):new c.Component(d,bb.OTHER_CODE,k)};G.encodeName=function(a,b){for(var c=b.getLength(),d,k=a.size()-1;0<=k;--k)G.encodeNameComponent(a.get(k),b),k==a.size()-1&&(d=b.getLength());k=b.getLength();b.writeTypeAndLength(n.Name,b.getLength()-c);c=b.getLength()-k;d=0==a.size()?c:b.getLength()-d;return{signedPortionBeginOffset:c,
signedPortionEndOffset:d}};G.decodeName=function(a,b,c){a.clear();for(var d=b.readNestedTlvsStart(n.Name),k=b.getOffset(),m=k;b.getOffset()<d;)m=b.getOffset(),a.append(G.decodeNameComponent(b,c));b.finishNestedTlvs(d);return{signedPortionBeginOffset:k,signedPortionEndOffset:m}};G.encodeSelectors=function(a,b){var c=b.getLength();a.getMustBeFresh()&&b.writeTypeAndLength(n.MustBeFresh,0);b.writeOptionalNonNegativeIntegerTlv(n.ChildSelector,a.getChildSelector());0<a.getExclude().size()&&G.encodeExclude(a.getExclude(),
b);null!=a.getKeyLocator().getType()&&G.encodeKeyLocator(n.PublisherPublicKeyLocator,a.getKeyLocator(),b);b.writeOptionalNonNegativeIntegerTlv(n.MaxSuffixComponents,a.getMaxSuffixComponents());b.writeOptionalNonNegativeIntegerTlv(n.MinSuffixComponents,a.getMinSuffixComponents());b.getLength()!=c&&b.writeTypeAndLength(n.Selectors,b.getLength()-c)};G.decodeSelectors=function(a,b,c){null==c&&(c=!0);var d=b.readNestedTlvsStart(n.Selectors);a.setMinSuffixComponents(b.readOptionalNonNegativeIntegerTlv(n.MinSuffixComponents,
d));a.setMaxSuffixComponents(b.readOptionalNonNegativeIntegerTlv(n.MaxSuffixComponents,d));b.peekType(n.PublisherPublicKeyLocator,d)?G.decodeKeyLocator(n.PublisherPublicKeyLocator,a.getKeyLocator(),b,c):a.getKeyLocator().clear();b.peekType(n.Exclude,d)?G.decodeExclude(a.getExclude(),b,c):a.getExclude().clear();a.setChildSelector(b.readOptionalNonNegativeIntegerTlv(n.ChildSelector,d));a.setMustBeFresh(b.readBooleanTlv(n.MustBeFresh,d));b.finishNestedTlvs(d)};G.encodeExclude=function(a,b){for(var c=
b.getLength(),d=a.size()-1;0<=d;--d){var k=a.get(d);k==Ra.ANY?b.writeTypeAndLength(n.Any,0):G.encodeNameComponent(k,b)}b.writeTypeAndLength(n.Exclude,b.getLength()-c)};G.decodeExclude=function(a,b,c){null==c&&(c=!0);var d=b.readNestedTlvsStart(n.Exclude);for(a.clear();b.getOffset()<d;)b.peekType(n.Any,d)?(b.readBooleanTlv(n.Any,d),a.appendAny()):a.appendComponent(G.decodeNameComponent(b,c));b.finishNestedTlvs(d)};G.encodeKeyLocator=function(a,b,c){var d=c.getLength();if(null!=b.getType())if(b.getType()==
Ga.KEYNAME)G.encodeName(b.getKeyName(),c);else if(b.getType()==Ga.KEY_LOCATOR_DIGEST&&0<b.getKeyData().size())c.writeBlobTlv(n.KeyLocatorDigest,b.getKeyData().buf());else throw Error("Unrecognized KeyLocatorType "+b.getType());c.writeTypeAndLength(a,c.getLength()-d)};G.decodeKeyLocator=function(a,b,c,d){null==d&&(d=!0);a=c.readNestedTlvsStart(a);b.clear();if(c.getOffset()!=a){if(c.peekType(n.Name,a))b.setType(Ga.KEYNAME),G.decodeName(b.getKeyName(),c,d);else if(c.peekType(n.KeyLocatorDigest,a))b.setType(Ga.KEY_LOCATOR_DIGEST),
b.setKeyData(new p(c.readBlobTlv(n.KeyLocatorDigest),d));else throw new R(Error("decodeKeyLocator: Unrecognized key locator type"));c.finishNestedTlvs(a)}};G.encodeValidityPeriod_=function(a,b){var c=b.getLength();b.writeBlobTlv(n.ValidityPeriod_NotAfter,(new p(ea.toIsoString(a.getNotAfter()))).buf());b.writeBlobTlv(n.ValidityPeriod_NotBefore,(new p(ea.toIsoString(a.getNotBefore()))).buf());b.writeTypeAndLength(n.ValidityPeriod_ValidityPeriod,b.getLength()-c)};G.decodeValidityPeriod_=function(a,b){var c=
b.readNestedTlvsStart(n.ValidityPeriod_ValidityPeriod);a.clear();var d=new p(b.readBlobTlv(n.ValidityPeriod_NotBefore),!1),k=ea.fromIsoString(d.toString()),d=new p(b.readBlobTlv(n.ValidityPeriod_NotAfter),!1),d=ea.fromIsoString(d.toString());a.setPeriod(k,d);b.finishNestedTlvs(c)};G.encodeSignatureInfo_=function(a,b){if(a instanceof Tb){var c=a.getSignatureInfoEncoding();try{var d=new oa(c.buf()),k=d.readNestedTlvsStart(n.SignatureInfo);d.readNonNegativeIntegerTlv(n.SignatureType);d.finishNestedTlvs(k,
!0)}catch(m){throw Error("The GenericSignature encoding is not a valid NDN-TLV SignatureInfo: "+m.message);}b.writeBuffer(c.buf())}else{c=b.getLength();if(a instanceof Da)a.getValidityPeriod().hasPeriod()&&G.encodeValidityPeriod_(a.getValidityPeriod(),b),G.encodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b),b.writeNonNegativeIntegerTlv(n.SignatureType,n.SignatureType_SignatureSha256WithRsa);else if(a instanceof Sa)a.getValidityPeriod().hasPeriod()&&G.encodeValidityPeriod_(a.getValidityPeriod(),b),
G.encodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b),b.writeNonNegativeIntegerTlv(n.SignatureType,n.SignatureType_SignatureSha256WithEcdsa);else if(a instanceof jb)G.encodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b),b.writeNonNegativeIntegerTlv(n.SignatureType,n.SignatureType_SignatureHmacWithSha256);else if(a instanceof qb)b.writeNonNegativeIntegerTlv(n.SignatureType,n.SignatureType_DigestSha256);else throw Error("encodeSignatureInfo: Unrecognized Signature object type");b.writeTypeAndLength(n.SignatureInfo,
b.getLength()-c)}};G.decodeSignatureInfo=function(a,b,c){null==c&&(c=!0);var d=b.getOffset(),k=b.readNestedTlvsStart(n.SignatureInfo),m=b.readNonNegativeIntegerTlv(n.SignatureType);m==n.SignatureType_SignatureSha256WithRsa?(a.setSignature(new Da),a=a.getSignature(),G.decodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b,c),b.peekType(n.ValidityPeriod_ValidityPeriod,k)&&G.decodeValidityPeriod_(a.getValidityPeriod(),b)):m==n.SignatureType_SignatureSha256WithEcdsa?(a.setSignature(new Sa),a=a.getSignature(),
G.decodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b,c),b.peekType(n.ValidityPeriod_ValidityPeriod,k)&&G.decodeValidityPeriod_(a.getValidityPeriod(),b)):m==n.SignatureType_SignatureHmacWithSha256?(a.setSignature(new jb),a=a.getSignature(),G.decodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b,c)):m==n.SignatureType_DigestSha256?a.setSignature(new qb):(a.setSignature(new Tb),a=a.getSignature(),a.setSignatureInfoEncoding(new p(b.getSlice(d,k),c),m),b.finishNestedTlvs(k,!0));b.finishNestedTlvs(k)};G.encodeMetaInfo=
function(a,b){var c=b.getLength(),d=a.getFinalBlockId().getValue().buf();null!=d&&0<d.length&&(d=b.getLength(),G.encodeNameComponent(a.getFinalBlockId(),b),b.writeTypeAndLength(n.FinalBlockId,b.getLength()-d));b.writeOptionalNonNegativeIntegerTlv(n.FreshnessPeriod,a.getFreshnessPeriod());if(a.getType()!=ya.BLOB)if(a.getType()==ya.LINK||a.getType()==ya.KEY||a.getType()==ya.NACK)b.writeNonNegativeIntegerTlv(n.ContentType,a.getType());else if(a.getType()==ya.OTHER_CODE)b.writeNonNegativeIntegerTlv(n.ContentType,
a.getOtherTypeCode());else throw Error("unrecognized TLV ContentType");b.writeTypeAndLength(n.MetaInfo,b.getLength()-c)};G.decodeMetaInfo=function(a,b,c){null==c&&(c=!0);var d=b.readNestedTlvsStart(n.MetaInfo),k=b.readOptionalNonNegativeIntegerTlv(n.ContentType,d);null==k||0>k||k===ya.BLOB?a.setType(ya.BLOB):k===ya.LINK||k===ya.KEY||k===ya.NACK?a.setType(k):(a.setType(ya.OTHER_CODE),a.setOtherTypeCode(k));a.setFreshnessPeriod(b.readOptionalNonNegativeIntegerTlv(n.FreshnessPeriod,d));b.peekType(n.FinalBlockId,
d)?(k=b.readNestedTlvsStart(n.FinalBlockId),a.setFinalBlockId(G.decodeNameComponent(b,c)),b.finishNestedTlvs(k)):a.setFinalBlockId(null);b.finishNestedTlvs(d)};G.encodeControlParameters=function(a,b){var c=b.getLength();b.writeOptionalNonNegativeIntegerTlv(n.ControlParameters_ExpirationPeriod,a.getExpirationPeriod());if(0<a.getStrategy().size()){var d=b.getLength();G.encodeName(a.getStrategy(),b);b.writeTypeAndLength(n.ControlParameters_Strategy,b.getLength()-d)}d=a.getForwardingFlags().getNfdForwardingFlags();
d!=(new Fa).getNfdForwardingFlags()&&b.writeNonNegativeIntegerTlv(n.ControlParameters_Flags,d);b.writeOptionalNonNegativeIntegerTlv(n.ControlParameters_Cost,a.getCost());b.writeOptionalNonNegativeIntegerTlv(n.ControlParameters_Origin,a.getOrigin());b.writeOptionalNonNegativeIntegerTlv(n.ControlParameters_LocalControlFeature,a.getLocalControlFeature());0!=a.getUri().length&&b.writeBlobTlv(n.ControlParameters_Uri,(new p(a.getUri())).buf());b.writeOptionalNonNegativeIntegerTlv(n.ControlParameters_FaceId,
a.getFaceId());null!=a.getName()&&G.encodeName(a.getName(),b);b.writeTypeAndLength(n.ControlParameters_ControlParameters,b.getLength()-c)};G.decodeControlParameters=function(a,b,d){null==d&&(d=!0);a.clear();var k=b.readNestedTlvsStart(n.ControlParameters_ControlParameters);if(b.peekType(n.Name,k)){var m=new c;G.decodeName(m,b,d);a.setName(m)}a.setFaceId(b.readOptionalNonNegativeIntegerTlv(n.ControlParameters_FaceId,k));b.peekType(n.ControlParameters_Uri,k)&&(m=new p(b.readOptionalBlobTlv(n.ControlParameters_Uri,
k),!1),a.setUri(m.toString()));b.skipOptionalTlv(n.ControlParameters_LocalUri,k);a.setLocalControlFeature(b.readOptionalNonNegativeIntegerTlv(n.ControlParameters_LocalControlFeature,k));a.setOrigin(b.readOptionalNonNegativeIntegerTlv(n.ControlParameters_Origin,k));a.setCost(b.readOptionalNonNegativeIntegerTlv(n.ControlParameters_Cost,k));b.skipOptionalTlv(n.ControlParameters_Capacity,k);b.skipOptionalTlv(n.ControlParameters_Count,k);b.skipOptionalTlv(n.ControlParameters_BaseCongestionMarkingInterval,
k);b.skipOptionalTlv(n.ControlParameters_DefaultCongestionThreshold,k);b.skipOptionalTlv(n.ControlParameters_Mtu,k);b.peekType(n.ControlParameters_Flags,k)&&(m=new Fa,m.setNfdForwardingFlags(b.readNonNegativeIntegerTlv(n.ControlParameters_Flags,k)),a.setForwardingFlags(m));b.skipOptionalTlv(n.ControlParameters_Mask,k);b.peekType(n.ControlParameters_Strategy,k)&&(m=b.readNestedTlvsStart(n.ControlParameters_Strategy),G.decodeName(a.getStrategy(),b,d),b.finishNestedTlvs(m));a.setExpirationPeriod(b.readOptionalNonNegativeIntegerTlv(n.ControlParameters_ExpirationPeriod,
k));b.finishNestedTlvs(k)};G.encodeDelegationSet_=function(a,b){for(var c=a.size()-1;0<=c;--c){var d=b.getLength();G.encodeName(a.get(c).getName(),b);b.writeNonNegativeIntegerTlv(n.Link_Preference,a.get(c).getPreference());b.writeTypeAndLength(n.Link_Delegation,b.getLength()-d)}};G.decodeDelegationSet_=function(a,b,d,k){for(a.clear();d.getOffset()<b;){d.readTypeAndLength(n.Link_Delegation);var m=d.readNonNegativeIntegerTlv(n.Link_Preference),p=new c;G.decodeName(p,d,k);a.addUnsorted(m,p)}};G.decodeInterestV03_=
function(a,b,c){null==c&&(c=!0);b=new oa(b);var d=b.readNestedTlvsStart(n.Interest),k=G.decodeName(a.getName(),b,c);a.setCanBePrefix(b.readBooleanTlv(n.CanBePrefix,d));a.setMustBeFresh(b.readBooleanTlv(n.MustBeFresh,d));if(b.peekType(n.ForwardingHint,d)){var m=b.readNestedTlvsStart(n.ForwardingHint);G.decodeDelegationSet_(a.getForwardingHint(),m,b,c);b.finishNestedTlvs(m)}else a.getForwardingHint().clear();m=b.readOptionalBlobTlv(n.Nonce,d);a.setInterestLifetimeMilliseconds(b.readOptionalNonNegativeIntegerTlv(n.InterestLifetime,
d));a.setMinSuffixComponents(null);a.getKeyLocator().clear();a.getExclude().clear();a.setChildSelector(null);a.unsetLink();a.setSelectedDelegationIndex(null);b.readOptionalBlobTlv(n.HopLimit,d);b.readOptionalBlobTlv(n.Parameters,d);a.setNonce(null==m?new p:new p(m,c));b.finishNestedTlvs(d);return k};var G=a.Tlv0_2WireFormat,oc=function(){G.call(this)};oc.prototype=new G;oc.prototype.name="Tlv0_1_1WireFormat";q.Tlv0_1_1WireFormat=oc;oc.instance=null;oc.get=function(){null===oc.instance&&(oc.instance=
new oc);return oc.instance};var s=a.WireFormat,oc=a.Tlv0_1_1WireFormat,gd=function(){oc.call(this)};gd.prototype=new oc;gd.prototype.name="Tlv0_1WireFormat";q.Tlv0_1WireFormat=gd;gd.instance=null;gd.get=function(){null===gd.instance&&(gd.instance=new gd);return gd.instance};s=a.WireFormat;G=a.Tlv0_2WireFormat;hb=function(){G.call(this)};hb.prototype=new G;hb.prototype.name="TlvWireFormat";q.TlvWireFormat=hb;hb.instance=null;hb.get=function(){null===hb.instance&&(hb.instance=new hb);return hb.instance};
s.setDefaultWireFormat(hb.get());var M=a.DataUtils,Ga=a.KeyLocatorType,F=a.Interest,Q=a.Data,Da=a.Sha256WithRsaSignature,Sa=a.Sha256WithEcdsaSignature,jb=a.HmacWithSha256Signature,qb=a.DigestSha256Signature,ya=a.ContentType,s=a.WireFormat,Ed=function(){};q.EncodingUtils=Ed;Ed.encodeToHexInterest=function(a,b){b=b||s.getDefaultWireFormat();return M.toHex(a.wireEncode(b).buf())};Ed.encodeToHexData=function(a,b){b=b||s.getDefaultWireFormat();return M.toHex(a.wireEncode(b).buf())};Ed.decodeHexInterest=
function(a,b){b=b||s.getDefaultWireFormat();var c=new F;c.wireDecode(M.toNumbers(a),b);return c};Ed.decodeHexData=function(a,b){b=b||s.getDefaultWireFormat();var c=new Q;c.wireDecode(M.toNumbers(a),b);return c};Ed.decodeSubjectPublicKeyInfo=function(a){a=M.toHex(a).toLowerCase();a=_x509_getPublicKeyHexArrayFromCertHex(a,_x509_getSubjectPublicKeyPosFromCertHex(a,0));var b=new A;b.setPublic(a[0],a[1]);return b};Ed.dataToHtml=function(a){function b(a){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");
c+=a;c+="<br/>"}if(-1==a)return"NO CONTENT FOUND";if(-2==a)return"CONTENT NAME IS EMPTY";var c="";b("name: "+a.getName().toUri());0<a.getContent().size()?(b("content (raw): "+a.getContent().buf().toString("binary")),b("content (hex): "+a.getContent().toHex())):b("content: <empty>");a.getMetaInfo().getType()!=ya.BLOB&&(a.getMetaInfo().getType()==ya.KEY?b("metaInfo.type: KEY"):a.getMetaInfo().getType()==ya.LINK?b("metaInfo.type: LINK"):a.getMetaInfo().getType()==ya.NACK?b("metaInfo.type: NACK"):a.getMetaInfo().getType()==
ya.OTHER_CODE&&b("metaInfo.type: other code "+a.getMetaInfo().getOtherTypeCode()));b("metaInfo.freshnessPeriod (milliseconds): "+(0<=a.getMetaInfo().getFreshnessPeriod()?""+a.getMetaInfo().getFreshnessPeriod():"<none>"));b("metaInfo.finalBlockId: "+(0<a.getMetaInfo().getFinalBlockId().getValue().size()?a.getMetaInfo().getFinalBlockId().getValue().toHex():"<none>"));var d=null,k=a.getSignature();k instanceof Da?(k=a.getSignature(),b("Sha256WithRsa signature.signature: "+(0<k.getSignature().size()?
k.getSignature().toHex():"<none>")),d=k.getKeyLocator()):k instanceof Sa?(k=a.getSignature(),b("Sha256WithEcdsa signature.signature: "+(0<k.getSignature().size()?k.getSignature().toHex():"<none>")),d=k.getKeyLocator()):k instanceof jb?(k=a.getSignature(),b("HmacWithSha256 signature.signature: "+(0<k.getSignature().size()?k.getSignature().toHex():"<none>")),d=k.getKeyLocator()):k instanceof qb&&(k=a.getSignature(),b("DigestSha256 signature.signature: "+(0<k.getSignature().size()?k.getSignature().toHex():
"<none>")));null!==d&&(null==d.getType()?b("signature.keyLocator: <none>"):d.getType()==Ga.KEY_LOCATOR_DIGEST?b("signature.keyLocator: KeyLocatorDigest: "+d.getKeyData().toHex()):d.getType()==Ga.KEYNAME?b("signature.keyLocator: KeyName: "+d.getKeyName().toUri()):b("signature.keyLocator: <unrecognized ndn_KeyLocatorType>"));return c};var ba=a,p=a.Blob,Fd=a.DecryptKey,Od=a.EncryptKey,ia=a.EncryptAlgorithmType,Gb=a.UseSubtleCrypto,b=a.SyncPromise,Db=function(){};q.AesAlgorithm=Db;Db.generateKey=function(a){a=
ba.randomBytes(a.getKeySize()/8);return new Fd(new p(a,!1))};Db.deriveEncryptKey=function(a){return new Od(a)};Db.decryptPromise=function(a,c,k,m){if(Gb()&&!m&&k.getAlgorithmType()!=ia.AesEcb)return k.getAlgorithmType()==ia.AesCbc?crypto.subtle.importKey("raw",a.buf(),{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(a){return crypto.subtle.decrypt({name:"AES-CBC",iv:k.getInitialVector().buf()},a,c.buf())}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported encryption mode"));
if(k.getAlgorithmType()==ia.AesEcb)try{var n=ba.createDecipheriv(32==a.size()?"aes-256-ecb":"aes-128-ecb",a.buf(),"");return b.resolve(new p(d.concat([n.update(c.buf()),n.final()]),!1))}catch(s){return b.reject(s)}else if(k.getAlgorithmType()==ia.AesCbc)try{return n=ba.createDecipheriv(32==a.size()?"aes-256-cbc":"aes-128-cbc",a.buf(),k.getInitialVector().buf()),b.resolve(new p(d.concat([n.update(c.buf()),n.final()]),!1))}catch(q){return b.reject(q)}else return b.reject(Error("unsupported encryption mode"))};
Db.decrypt=function(a,c,d){return b.getValue(this.decryptPromise(a,c,d,!0))};Db.encryptPromise=function(a,c,k,m){return k.getAlgorithmType()==ia.AesCbc&&k.getInitialVector().size()!=Db.BLOCK_SIZE?b.reject(Error("incorrect initial vector size")):Gb()&&!m&&k.getAlgorithmType()!=ia.AesEcb?k.getAlgorithmType()==ia.AesCbc?crypto.subtle.importKey("raw",a.buf(),{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(a){return crypto.subtle.encrypt({name:"AES-CBC",iv:k.getInitialVector().buf()},a,c.buf())}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),
!1))}):Promise.reject(Error("unsupported encryption mode")):k.getAlgorithmType()==ia.AesEcb?(a=ba.createCipheriv(32==a.size()?"aes-256-ecb":"aes-128-ecb",a.buf(),""),b.resolve(new p(d.concat([a.update(c.buf()),a.final()]),!1))):k.getAlgorithmType()==ia.AesCbc?(a=ba.createCipheriv(32==a.size()?"aes-256-cbc":"aes-128-cbc",a.buf(),k.getInitialVector().buf()),b.resolve(new p(d.concat([a.update(c.buf()),a.final()]),!1))):b.reject(Error("unsupported encryption mode"))};Db.encrypt=function(a,c,d){return b.getValue(this.encryptPromise(a,
c,d,!0))};Db.BLOCK_SIZE=16;ba=a;p=a.Blob;ia=function(){};q.EncryptAlgorithmType=ia;ia.AesEcb=0;ia.AesCbc=1;ia.RsaPkcs=2;ia.RsaOaep=3;var Ob=function(a,b){this.algorithmType_=a;if(null!=b&&0<b){var c=ba.randomBytes(b);this.initialVector_=new p(c,!1)}else this.initialVector_=new p};q.EncryptParams=Ob;Ob.prototype.getAlgorithmType=function(){return this.algorithmType_};Ob.prototype.getInitialVector=function(){return this.initialVector_};Ob.prototype.setAlgorithmType=function(a){this.algorithmType_=a;
return this};Ob.prototype.setInitialVector=function(a){this.initialVector_="object"===typeof a&&a instanceof p?a:new p(a);return this};var ba=a,c=a.Name,U=a.KeyLocator,Ga=a.KeyLocatorType,hb=a.TlvWireFormat,p=a.Blob,Db=a.AesAlgorithm,kb=a.RsaAlgorithm,Ob=a.EncryptParams,ia=a.EncryptAlgorithmType,xb=a.EncryptedContent,b=a.SyncPromise,xa=function(a){};q.Encryptor=xa;xa.NAME_COMPONENT_FOR=new c.Component("FOR");xa.NAME_COMPONENT_READ=new c.Component("READ");xa.NAME_COMPONENT_SAMPLE=new c.Component("SAMPLE");
xa.NAME_COMPONENT_ACCESS=new c.Component("ACCESS");xa.NAME_COMPONENT_E_KEY=new c.Component("E-KEY");xa.NAME_COMPONENT_D_KEY=new c.Component("D-KEY");xa.NAME_COMPONENT_C_KEY=new c.Component("C-KEY");xa.encryptDataPromise=function(a,k,m,n,s,q){a.getName().append(xa.NAME_COMPONENT_FOR).append(m);var H=s.getAlgorithmType();return H==ia.AesCbc||H==ia.AesEcb?xa.encryptSymmetricPromise_(k,n,m,s,q).then(function(c){a.setContent(c.wireEncode(hb.get()));return b.resolve()}):H==ia.RsaPkcs||H==ia.RsaOaep?xa.encryptAsymmetricPromise_(k,
n,m,s,q).then(function(c){a.setContent(c.wireEncode(hb.get()));return b.resolve()},function(H){H=ba.randomBytes(16);var x=new p(H,!1),pe=new c(m);pe.append("nonce");var Bc=new Ob(ia.AesCbc,Db.BLOCK_SIZE),Fe;return xa.encryptAsymmetricPromise_(x,n,m,s,q).then(function(a){Fe=a;return xa.encryptSymmetricPromise_(k,x,pe,Bc,q)}).then(function(c){c=c.wireEncode();var k=Fe.wireEncode(),m=new d(c.size()+k.size());k.buf().copy(m,0);c.buf().copy(m,k.size());a.setContent(new p(m,!1));return b.resolve()})}):
b.reject(Error("Unsupported encryption method"))};xa.encryptData=function(a,c,d,k,m){return b.getValue(xa.encryptDataPromise(a,c,d,k,m,!0))};xa.encryptSymmetricPromise_=function(a,c,d,k,m){var n=k.getAlgorithmType(),p=k.getInitialVector(),s=new U;s.setType(Ga.KEYNAME);s.setKeyName(d);return n==ia.AesCbc||n==ia.AesEcb?n==ia.AesCbc&&p.size()!=Db.BLOCK_SIZE?b.reject(Error("incorrect initial vector size")):Db.encryptPromise(c,a,k,m).then(function(a){var c=new xb;c.setAlgorithmType(n);c.setKeyLocator(s);
c.setPayload(a);c.setInitialVector(p);return b.resolve(c)}):b.reject(Error("Unsupported encryption method"))};xa.encryptAsymmetricPromise_=function(a,c,d,k,m){var n=k.getAlgorithmType(),p=new U;p.setType(Ga.KEYNAME);p.setKeyName(d);return n==ia.RsaPkcs||n==ia.RsaOaep?kb.encryptPromise(c,a,k,m).then(function(a){var c=new xb;c.setAlgorithmType(n);c.setKeyLocator(p);c.setPayload(a);return b.resolve(c)}):b.reject(Error("Unsupported encryption method"))};ba=od=a;p=a.Blob;Fd=a.DecryptKey;Od=a.EncryptKey;
ia=a.EncryptAlgorithmType;m=a.DerNode;eb=a.OID;qa=a.PrivateKeyStorage;Gb=a.UseSubtleCrypto;b=a.SyncPromise;Ba=a.PublicKey;xc=null;try{xc=a}catch(bf){}kb=function(){};q.RsaAlgorithm=kb;kb.generateKeyPromise=function(a,c){if(Gb()&&!c)return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:a.getKeySize(),publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]).then(function(a){return crypto.subtle.exportKey("pkcs8",a.privateKey)}).then(function(a){return Promise.resolve(new Fd(new p(new Uint8Array(a),
!1)))});if(!xc)return b.reject(Error("Need to install rsa-keygen: sudo npm install rsa-keygen"));try{var k=xc.generate(a.getKeySize()).private_key.toString().replace("-----BEGIN RSA PRIVATE KEY-----","").replace("-----END RSA PRIVATE KEY-----",""),n=new d(k,"base64"),s=qa.encodePkcs8PrivateKey(n,new eb(qa.RSA_ENCRYPTION_OID),new m.DerNull).buf();return b.resolve(new Fd(s))}catch(q){return b.reject(q)}};kb.generateKey=function(a){return b.getValue(kb.generateKeyPromise(a,!0))};kb.deriveEncryptKey=
function(a){a=kb.getRsaPrivateKeyDer(a);var b=m.parse(a.buf(),0).getChildren();a=b[1];var b=b[2],c=new m.DerSequence;c.addChild(a);c.addChild(b);a=c.encode();b=new m.DerSequence;b.addChild(new m.DerOid(new eb(qa.RSA_ENCRYPTION_OID)));b.addChild(new m.DerNull);c=new m.DerSequence;c.addChild(b);c.addChild(new m.DerBitString(a.buf(),0));return new Od(c.encode())};kb.decryptPromise=function(a,c,d,k){if(Gb()&&!k&&d.getAlgorithmType()!=ia.RsaPkcs)return d.getAlgorithmType()==ia.RsaOaep?crypto.subtle.importKey("pkcs8",
a.buf(),{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["decrypt"]).then(function(a){return crypto.subtle.decrypt({name:"RSA-OAEP"},a,c.buf())}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported padding scheme"));k=kb.getRsaPrivateKeyDer(a).buf().toString("base64");a="-----BEGIN RSA PRIVATE KEY-----\n";for(var m=0;m<k.length;m+=64)a+=k.substr(m,64)+"\n";a+="-----END RSA PRIVATE KEY-----";if(d.getAlgorithmType()==ia.RsaPkcs)d=od.RSA_PKCS1_PADDING;else if(d.getAlgorithmType()==
ia.RsaOaep)d=od.RSA_PKCS1_OAEP_PADDING;else return b.reject(Error("unsupported padding scheme"));try{return b.resolve(new p(ba.privateDecrypt({key:a,padding:d},c.buf()),!1))}catch(n){return b.reject(n)}};kb.decrypt=function(a,c,d){return b.getValue(kb.decryptPromise(a,c,d,!0))};kb.encryptPromise=function(a,c,d,k){var m;try{m=new Ba(a)}catch(n){return b.reject(n)}return m.encryptPromise(c,d.getAlgorithmType(),k)};kb.encrypt=function(a,c,d){return b.getValue(kb.encryptPromise(a,c,d,!0))};kb.getRsaPrivateKeyDer=
function(a){a=m.parse(a.buf(),0).getChildren();if(m.getSequence(a,1).getChildren()[0].toVal()!=qa.RSA_ENCRYPTION_OID)throw Error("The PKCS #8 private key is not RSA_ENCRYPTION");return a[2].getPayload()};var b=a.SyncPromise,hd=function(){};q.ConsumerDb=hd;hd.Error=function(a){if(a)return a.__proto__=hd.Error.prototype,a};hd.Error.prototype=Error();hd.Error.prototype.name="ConsumerDbError";hd.prototype.getKeyPromise=function(a,c){return b.reject(Error("ConsumerDb.getKeyPromise is not implemented"))};
hd.prototype.addKeyPromise=function(a,c,d){return b.reject(Error("ConsumerDb.addKeyPromise is not implemented"))};hd.prototype.deleteKeyPromise=function(a,c){return b.reject(Error("ConsumerDb.addKeyPromise is not implemented"))};var p=a.Blob,c=a.Name,F=a.Interest,gb=a.NetworkNack,wb=a.Link,xb=a.EncryptedContent,pc=a.EncryptError,Ob=a.EncryptParams,ia=a.EncryptAlgorithmType,kb=a.RsaAlgorithm,Db=a.AesAlgorithm,xa=a.Encryptor,b=a.SyncPromise,O=a.NdnCommon,Ja=function tb(a,b,d,k,m,n,p){this.database_=
m;this.keyChain_=b;this.face_=a;this.groupName_=new c(d);this.consumerName_=new c(k);this.cKeyLink_=void 0==n?tb.NO_LINK:new wb(n);this.dKeyLink_=void 0==p?tb.NO_LINK:new wb(p);this.cKeyMap_={};this.dKeyMap_={}};q.Consumer=Ja;Ja.prototype.consume=function(a,b,c,d){void 0==d&&(d=Ja.NO_LINK);a=new F(a);var k=this;this.sendInterest_(a,1,new wb(d),function(a){k.decryptContent_(a,function(c){try{b(a,c)}catch(d){console.log("Error in onConsumeComplete: "+O.getErrorWithStackTrace(d))}},c)},c)};Ja.prototype.setGroup=
function(a){this.groupName_=new c(a)};Ja.prototype.addDecryptionKeyPromise=function(a,c,d){return this.consumerName_.match(a)?this.database_.addKeyPromise(a,c,d):b.reject(Error("addDecryptionKey: The consumer name must be a prefix of the key name"))};Ja.prototype.addDecryptionKey=function(a,c,d,k){return b.complete(d,k,this.addDecryptionKeyPromise(a,c,!d))};Ja.Error=function(a,b){this.errorCode=a;this.message=b};Ja.Error.callOnError=function(a,b,c){c||(c="");if(b instanceof Ja.Error)try{a(b.errorCode,
b.message)}catch(d){console.log("Error in onError: "+O.getErrorWithStackTrace(d))}else try{a(pc.ErrorCode.General,c+b)}catch(k){console.log("Error in onError: "+O.getErrorWithStackTrace(k))}};Ja.decryptPromise_=function(a,c){return b.resolve().then(function(){if("object"==typeof a&&a instanceof p){var d=a;a=new xb;a.wireDecode(d)}d=a.getPayload();if(a.getAlgorithmType()==ia.AesCbc){var k=new Ob(ia.AesCbc);k.setInitialVector(a.getInitialVector());return Db.decryptPromise(c,d,k)}return a.getAlgorithmType()==
ia.RsaOaep?(k=new Ob(ia.RsaOaep),kb.decryptPromise(c,d,k)):b.reject(new Ja.Error(pc.ErrorCode.UnsupportedEncryptionScheme,""+a.getAlgorithmType()))})};Ja.decrypt_=function(a,b,c,d){Ja.decryptPromise_(a,b).then(function(a){c(a)},function(a){Ja.Error.callOnError(d,a)})};Ja.prototype.decryptContent_=function(a,b,d){var k=new xb;try{k.wireDecode(a.getContent())}catch(m){Ja.Error.callOnError(d,m,"Error decoding EncryptedContent: ");return}var n=k.getKeyLocator().getKeyName();if(a=this.cKeyMap_[n.toUri()])this.decrypt_(k,
a,b,d);else{a=new c(n);a.append(xa.NAME_COMPONENT_FOR).append(this.groupName_);a=new F(a);var p=this;this.sendInterest_(a,1,this.cKeyLink_,function(a){p.decryptCKey_(a,function(a){p.cKeyMap_[n.toUri()]=a;Ja.decrypt_(k,a,b,d)},d)},d)}};Ja.prototype.decryptCKey_=function(a,b,d){a=a.getContent();var k=new xb;try{k.wireDecode(a)}catch(m){Ja.Error.callOnError(d,m,"Error decoding EncryptedContent: ");return}a=k.getKeyLocator().getKeyName();var n=a.getPrefix(-3);n.append(xa.NAME_COMPONENT_D_KEY).append(a.getSubName(-2));
if(a=this.dKeyMap_[n.toUri()])this.decrypt_(k,a,b,d);else{a=new c(n);a.append(xa.NAME_COMPONENT_FOR).append(this.consumerName_);a=new F(a);var p=this;this.sendInterest_(a,1,this.dKeyLink_,function(a){p.decryptDKeyPromise_(a).then(function(a){p.dKeyMap_[n.toUri()]=a;Ja.decrypt_(k,a,b,d)},function(a){Ja.Error.callOnError(d,a,"decryptDKey error: ")})},d)}};Ja.prototype.decryptDKeyPromise_=function(a){var c,d,k,m=this;return b.resolve().then(function(){c=a.getContent();d=new xb;d.wireDecode(c);var b=
d.getKeyLocator().getKeyName();return m.getDecryptionKeyPromise_(b)}).then(function(a){if(0==a.size())return b.reject(new Ja.Error(pc.ErrorCode.NoDecryptKey,"The desired consumer decryption key in not in the database"));var m=c.buf().slice(d.wireEncode().size());k=new p(m,!1);return 0==k.size()?b.reject(new Ja.Error(pc.ErrorCode.InvalidEncryptedFormat,"The data packet does not satisfy the D-KEY packet format")):Ja.decryptPromise_(d,a)}).then(function(a){return Ja.decryptPromise_(k,a)})};Ja.prototype.sendInterest_=
function(a,b,c,d,k){function m(a,b){try{k(pc.ErrorCode.DataRetrievalFailure,a.getName().toUri())}catch(c){console.log("Error in onError: "+O.getErrorWithStackTrace(c))}}var n=this,p=function(a,b){try{n.keyChain_.verifyData(b,d,function(a,b){try{k(pc.ErrorCode.Validation,"verifyData failed. Reason: "+b)}catch(c){console.log("Error in onError: "+O.getErrorWithStackTrace(c))}})}catch(c){Ja.Error.callOnError(k,c,"verifyData error: ")}},s=function(a){0<b?n.sendInterest_(a,b-1,c,d,k):m(a,new gb)};0!==c.getDelegations().size()&&
(a=new F(a),a.setLinkWireEncoding(c.wireEncode()));try{this.face_.expressInterest(a,p,s,m)}catch(Bc){Ja.Error.callOnError(k,Bc,"expressInterest error: ")}};Ja.prototype.getDecryptionKeyPromise_=function(a){return this.database_.getKeyPromise(a)};Ja.NO_LINK=new wb;p=a.Blob;Fd=function Ue(a){this.keyBits_="object"===typeof a&&a instanceof Ue?a.keyBits_:"object"===typeof a&&a instanceof p?a:new p(a)};q.DecryptKey=Fd;Fd.prototype.getKeyBits=function(){return this.keyBits_};pc=function(){};q.EncryptError=
pc;pc.ErrorCode={Timeout:1,Validation:2,UnsupportedEncryptionScheme:32,InvalidEncryptedFormat:33,NoDecryptKey:34,EncryptionFailure:35,DataRetrievalFailure:36,General:100};p=a.Blob;Od=function Ve(a){this.keyBits_="object"===typeof a&&a instanceof Ve?a.keyBits_:"object"===typeof a&&a instanceof p?a:new p(a)};q.EncryptKey=Od;Od.prototype.getKeyBits=function(){return this.keyBits_};U=a.KeyLocator;s=a.WireFormat;p=a.Blob;xb=function We(a){"object"===typeof a&&a instanceof We?(this.algorithmType_=a.algorithmType_,
this.keyLocator_=new U(a.keyLocator_),this.initialVector_=a.initialVector_,this.payload_=a.payload_):(this.algorithmType_=null,this.keyLocator_=new U,this.initialVector_=new p,this.payload_=new p)};q.EncryptedContent=xb;xb.prototype.getAlgorithmType=function(){return this.algorithmType_};xb.prototype.getKeyLocator=function(){return this.keyLocator_};xb.prototype.getInitialVector=function(){return this.initialVector_};xb.prototype.getPayload=function(){return this.payload_};xb.prototype.setAlgorithmType=
function(a){this.algorithmType_=a;return this};xb.prototype.setKeyLocator=function(a){this.keyLocator_="object"===typeof a&&a instanceof U?new U(a):new U;return this};xb.prototype.setInitialVector=function(a){this.initialVector_="object"===typeof a&&a instanceof p?a:new p(a);return this};xb.prototype.setPayload=function(a){this.payload_="object"===typeof a&&a instanceof p?a:new p(a);return this};xb.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();return a.encodeEncryptedContent(this)};
xb.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeEncryptedContent(this,a.buf(),!1):b.decodeEncryptedContent(this,a,!0)};var b=a.SyncPromise,ab=function(){};q.GroupManagerDb=ab;ab.Error=function(a){if(a)return a.__proto__=ab.Error.prototype,a};ab.Error.prototype=Error();ab.Error.prototype.name="GroupManagerDbError";ab.prototype.hasSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.hasSchedulePromise is not implemented"))};
ab.prototype.listAllScheduleNamesPromise=function(a){return b.reject(Error("GroupManagerDb.listAllScheduleNamesPromise is not implemented"))};ab.prototype.getSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.getSchedulePromise is not implemented"))};ab.prototype.getScheduleMembersPromise=function(a,c){return b.reject(Error("GroupManagerDb.getScheduleMembersPromise is not implemented"))};ab.prototype.addSchedulePromise=function(a,c,d){return b.reject(Error("GroupManagerDb.addSchedulePromise is not implemented"))};
ab.prototype.deleteSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.deleteSchedulePromise is not implemented"))};ab.prototype.renameSchedulePromise=function(a,c,d){return b.reject(Error("GroupManagerDb.renameSchedulePromise is not implemented"))};ab.prototype.updateSchedulePromise=function(a,c,d){return b.reject(Error("GroupManagerDb.updateSchedulePromise is not implemented"))};ab.prototype.hasMemberPromise=function(a,c){return b.reject(Error("GroupManagerDb.hasMemberPromise is not implemented"))};
ab.prototype.listAllMembersPromise=function(a){return b.reject(Error("GroupManagerDb.listAllMembersPromise is not implemented"))};ab.prototype.getMemberSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.getMemberSchedulePromise is not implemented"))};ab.prototype.addMemberPromise=function(a,c,d,k){return b.reject(Error("GroupManagerDb.addMemberPromise is not implemented"))};ab.prototype.updateMemberSchedulePromise=function(a,c,d){return b.reject(Error("GroupManagerDb.updateMemberSchedulePromise is not implemented"))};
ab.prototype.deleteMemberPromise=function(a,c){return b.reject(Error("GroupManagerDb.deleteMemberPromise is not implemented"))};ab.prototype.hasEKeyPromise=function(a,c){return b.reject(Error("GroupManagerDb.hasEKeyPromise is not implemented"))};ab.prototype.addEKeyPromise=function(a,c,d,k){return b.reject(Error("GroupManagerDb.addEKeyPromise is not implemented"))};ab.prototype.getEKeyPromise=function(a,c){return b.reject(Error("GroupManagerDb.getEKeyPromise is not implemented"))};ab.prototype.cleanEKeysPromise=
function(a){return b.reject(Error("GroupManagerDb.cleanEKeysPromise is not implemented"))};ab.prototype.deleteEKeyPromise=function(a,c){return b.reject(Error("GroupManagerDb.deleteEKeyPromise is not implemented"))};var c=a.Name,Q=a.Data,b=a.SyncPromise,Ia=a.IdentityCertificate,x=a.SecurityException,Ub=a.RsaKeyParams,Ob=a.EncryptParams,ia=a.EncryptAlgorithmType,xa=a.Encryptor,kb=a.RsaAlgorithm,lb=a.Interval,ea=a.Schedule,mb=function(a,b,d,k,m,n){this.namespace_=(new c(a)).append(xa.NAME_COMPONENT_READ).append(b);
this.database_=d;this.keySize_=k;this.freshnessHours_=m;this.keyChain_=n};q.GroupManager=mb;mb.prototype.getGroupKeyPromise=function(a,d,k){void 0==d&&(d=!0);var m=[],n=[],p=this,s,q,H,x;return this.calculateIntervalPromise_(a,m,k).then(function(a){if(!1==a.isValid())return b.resolve(n);H=ea.toIsoString(a.getStartTime());x=ea.toIsoString(a.getEndTime());var P=new c(p.namespace_);P.append(xa.NAME_COMPONENT_E_KEY).append(H).append(x);return b.resolve().then(function(){return d?b.resolve(!1):p.database_.hasEKeyPromise(P,
k)}).then(function(a){return!d&&a?p.getEKeyPromise_(P,k).then(function(a){s=a.privateKey;q=a.publicKey;return b.resolve()}):p.generateKeyPairPromise_(k).then(function(a){s=a.privateKeyBlob;q=a.publicKeyBlob;return p.deleteEKeyPromise_(P,k)}).then(function(){return p.addEKeyPromise_(P,q,s,k)})}).then(function(){return p.createEKeyDataPromise_(H,x,q,k)}).then(function(a){function c(a){return a>=m.length?b.resolve():p.createDKeyDataPromise_(H,x,m[a].keyName,s,m[a].publicKey,k).then(function(b){n.push(b);
return c(a+1)})}n.push(a);return c(0)}).then(function(){return b.resolve(n)})})};mb.prototype.addSchedulePromise=function(a,b,c){return this.database_.addSchedulePromise(a,b,c)};mb.prototype.deleteSchedulePromise=function(a,b){return this.database_.deleteSchedulePromise(a,b)};mb.prototype.updateSchedulePromise=function(a,b,c){return this.database_.updateSchedulePromise(a,b,c)};mb.prototype.addMemberPromise=function(a,b,c){b=new Ia(b);return this.database_.addMemberPromise(a,b.getPublicKeyName(),b.getPublicKeyInfo().getKeyDer(),
c)};mb.prototype.removeMemberPromise=function(a,b){return this.database_.deleteMemberPromise(a,b)};mb.prototype.updateMemberSchedulePromise=function(a,b,c){return this.database_.updateMemberSchedulePromise(a,b,c)};mb.prototype.cleanEKeysPromise=function(a){return this.database_.cleanEKeysPromise(a)};mb.prototype.calculateIntervalPromise_=function(a,c,d){var k=new lb,m=new lb;c.splice(0,c.length);var n=this;return this.database_.listAllScheduleNamesPromise(d).then(function(p){function s(q){if(q>=p.length)return b.resolve();
var H=p[q];return n.database_.getSchedulePromise(H,d).then(function(b){b=b.getCoveringInterval(a);var p=b.interval;if(b.isPositive)return k.isValid()||(k=p),k.intersectWith(p),n.database_.getScheduleMembersPromise(H,d).then(function(a){for(var b=0;b<a.length;++b)mb.memberKeysAdd_(c,a[b]);return s(q+1)});m.isValid()||(m=p);m.intersectWith(p);return s(q+1)})}return s(0)}).then(function(){if(!k.isValid())return b.resolve(new lb(!1));var a;a=m.isValid()?k.intersectWith(m):k;return b.resolve(a)})};mb.memberKeysAdd_=
function(a,b){for(var c=0;c<a.length;){var d=a[c].keyName.compare(b.keyName);if(0==d)return;if(0<d)break;c+=1}a.splice(c,0,b)};mb.prototype.generateKeyPairPromise_=function(a){a=new Ub(this.keySize_);return kb.generateKeyPromise(a).then(function(a){a=a.getKeyBits();var c=kb.deriveEncryptKey(a).getKeyBits();return b.resolve({privateKeyBlob:a,publicKeyBlob:c})})};mb.prototype.createEKeyDataPromise_=function(a,b,d,k){k=new c(this.namespace_);k.append(xa.NAME_COMPONENT_E_KEY).append(a).append(b);a=new Q(k);
a.getMetaInfo().setFreshnessPeriod(this.freshnessHours_*mb.MILLISECONDS_IN_HOUR);a.setContent(d);return this.keyChain_.signPromise(a)};mb.prototype.createDKeyDataPromise_=function(a,d,k,m,n,p){var s=new c(this.namespace_);s.append(xa.NAME_COMPONENT_D_KEY);s.append(a).append(d);var q=new Q(s);q.getMetaInfo().setFreshnessPeriod(this.freshnessHours_*mb.MILLISECONDS_IN_HOUR);a=new Ob(ia.RsaOaep);var H=this;return xa.encryptDataPromise(q,m,k,n,a,p).catch(function(a){return b.reject(x(Error("createDKeyData: Error in encryptData: "+
a)))}).then(function(){return H.keyChain_.signPromise(q)})};mb.prototype.addEKeyPromise_=function(a,b,c,d){return this.database_.addEKeyPromise(a,b,c,d)};mb.prototype.getEKeyPromise_=function(a,b){return this.database_.getEKeyPromise(a,b)};mb.prototype.deleteEKeyPromise_=function(a,b){return this.database_.deleteEKeyPromise(a,b)};mb.MILLISECONDS_IN_HOUR=36E5;lb=function Xe(a,b){if("object"===typeof a&&a instanceof Xe)this.startTime_=a.startTime_,this.endTime_=a.endTime_,this.isValid_=a.isValid_;else if("number"===
typeof a){if(!(a<b))throw Error("Interval start time must be less than the end time");this.startTime_=a;this.endTime_=b;this.isValid_=!0}else this.startTime_=-Number.MAX_VALUE,this.endTime_=-Number.MAX_VALUE,this.isValid_=a?!0:!1};q.Interval=lb;lb.prototype.set=function(a){this.startTime_=a.startTime_;this.endTime_=a.endTime_;this.isValid_=a.isValid_};lb.prototype.covers=function(a){if(!this.isValid_)throw Error("Interval.covers: This Interval is invalid");return this.isEmpty()?!1:this.startTime_<=
a&&a<this.endTime_};lb.prototype.intersectWith=function(a){if(!this.isValid_)throw Error("Interval.intersectWith: This Interval is invalid");if(!a.isValid_)throw Error("Interval.intersectWith: The other Interval is invalid");if(this.isEmpty()||a.isEmpty()||this.startTime_>=a.endTime_||this.endTime_<=a.startTime_)return this.startTime_=this.endTime_,this;this.startTime_<=a.startTime_&&(this.startTime_=a.startTime_);this.endTime_>a.endTime_&&(this.endTime_=a.endTime_);return this};lb.prototype.unionWith=
function(a){if(!this.isValid_)throw Error("Interval.intersectWith: This Interval is invalid");if(!a.isValid_)throw Error("Interval.intersectWith: The other Interval is invalid");if(this.isEmpty())return this.startTime_=a.startTime_,this.endTime_=a.endTime_,this;if(a.isEmpty())return this;if(this.startTime_>=a.endTime_||this.endTime_<=a.startTime_)throw Error("Interval.unionWith: The two intervals do not have an intersection");this.startTime_>a.startTime_&&(this.startTime_=a.startTime_);this.endTime_<
a.endTime_&&(this.endTime_=a.endTime_);return this};lb.prototype.getStartTime=function(){if(!this.isValid_)throw Error("Interval.getStartTime: This Interval is invalid");return this.startTime_};lb.prototype.getEndTime=function(){if(!this.isValid_)throw Error("Interval.getEndTime: This Interval is invalid");return this.endTime_};lb.prototype.isValid=function(){return this.isValid_};lb.prototype.isEmpty=function(){if(!this.isValid_)throw Error("Interval.isEmpty: This Interval is invalid");return this.startTime_==
this.endTime_};var b=a.SyncPromise,Cc=function(){};q.ProducerDb=Cc;Cc.Error=function(a){if(a)return a.__proto__=Cc.Error.prototype,a};Cc.Error.prototype=Error();Cc.Error.prototype.name="ProducerDbError";Cc.prototype.hasContentKeyPromise=function(a,c){return b.reject(Error("ProducerDb.hasContentKeyPromise is not implemented"))};Cc.prototype.getContentKeyPromise=function(a,c){return b.reject(Error("ProducerDb.getContentKeyPromise is not implemented"))};Cc.prototype.addContentKeyPromise=function(a,c,
d){return b.reject(Error("ProducerDb.addContentKeyPromise is not implemented"))};Cc.prototype.deleteContentKeyPromise=function(a,c){return b.reject(Error("ProducerDb.deleteContentKeyPromise is not implemented"))};Cc.getFixedTimeSlot=function(a){return Math.floor(Math.round(a)/36E5)};var c=a.Name,F=a.Interest,Q=a.Data,wb=a.Link,gb=a.NetworkNack,Ra=a.Exclude,xa=a.Encryptor,Ob=a.EncryptParams,ia=a.EncryptAlgorithmType,nd=a.AesKeyParams,Db=a.AesAlgorithm,ea=a.Schedule,pc=a.EncryptError,O=a.NdnCommon,
b=a.SyncPromise,ja=function Ee(a,b,d,k,m,n,p){this.face_=d;this.keyChain_=k;this.database_=m;this.maxRepeatAttempts_=void 0==n?3:n;this.keyRetrievalLink_=void 0==p?Ee.NO_LINK:new wb(p);this.eKeyInfo_={};this.keyRequests_={};d=new c(a);k=new c(b);for(d.append(xa.NAME_COMPONENT_READ);0<k.size();)m=new c(d),m.append(k),m.append(xa.NAME_COMPONENT_E_KEY),this.eKeyInfo_[m.toUri()]={keyName:m,keyInfo:new Ee.KeyInfo_},k=k.getPrefix(-1);d.append(b);this.namespace_=new c(a);this.namespace_.append(xa.NAME_COMPONENT_SAMPLE);
this.namespace_.append(b)};q.Producer=ja;ja.prototype.createContentKey=function(a,b,d,k){k||(k=ja.defaultOnError);var m=ja.getRoundedTimeSlot_(a),n=new c(this.namespace_);n.append(xa.NAME_COMPONENT_C_KEY);n.append(ea.toIsoString(m));var p,s=this;this.database_.hasContentKeyPromise(a).then(function(m){m?null!=d&&d(n):(m=new nd(128),p=Db.generateKey(m).getKeyBits(),s.database_.addContentKeyPromise(a,p).then(function(){var m=Math.round(a);s.keyRequests_[m]=new ja.KeyRequest_(s.getEKeyInfoSize_());var m=
s.keyRequests_[m],p=new Ra;ja.excludeAfter(p,new c.Component(ea.toIsoString(a)));for(var Bc in s.eKeyInfo_){var q=s.eKeyInfo_[Bc],H=q.keyInfo;a<H.beginTimeSlot||a>=H.endTimeSlot?(m.repeatAttempts[Bc]=0,s.sendKeyInterest_((new F(q.keyName)).setExclude(p).setChildSelector(1),a,b,k)):(q=new c(q.keyName),q.append(ea.toIsoString(H.beginTimeSlot)),q.append(ea.toIsoString(H.endTimeSlot)),s.encryptContentKeyPromise_(H.keyBits,q,a,b,k))}null!=d&&d(n)}))})};ja.prototype.produce=function(a,b,d,k,m){m||(m=ja.defaultOnError);
var n=this;this.createContentKey(b,null,function(p){n.database_.getContentKeyPromise(b).then(function(k){var m=new c(n.namespace_);m.append(ea.toIsoString(b));a.setName(m);m=new Ob(ia.AesCbc,16);return xa.encryptData(a,d,p,k,m)}).then(function(){return n.keyChain_.signPromise(a)}).then(function(){try{k()}catch(a){console.log("Error in onComplete: "+O.getErrorWithStackTrace(a))}},function(a){try{m(pc.ErrorCode.General,""+a)}catch(b){console.log("Error in onError: "+O.getErrorWithStackTrace(b))}})},
m)};ja.defaultOnError=function(a,b){};ja.KeyInfo_=function(){this.endTimeSlot=this.beginTimeSlot=0;this.keyBits=null};ja.KeyRequest_=function(a){this.interestCount=a;this.repeatAttempts={};this.encryptedKeys=[]};ja.getRoundedTimeSlot_=function(a){return Math.round(36E5*Math.floor(Math.round(a)/36E5))};ja.prototype.sendKeyInterest_=function(a,b,c,d){var k=this;0!==this.keyRetrievalLink_.getDelegations().size()&&(a=new F(a),a.setLinkWireEncoding(this.keyRetrievalLink_.wireEncode()));this.face_.expressInterest(a,
function(a,m){k.handleCoveringKey_(a,m,b,c,d)},function(a){k.handleTimeout_(a,b,c,d)},function(a,m){k.handleNetworkNack_(a,m,b,c,d)})};ja.prototype.handleTimeout_=function(a,b,c,d){var k=Math.round(b),k=this.keyRequests_[k],m=a.getName().toUri();k.repeatAttempts[m]<this.maxRepeatAttempts_?(++k.repeatAttempts[m],this.sendKeyInterest_(a,b,c,d)):this.handleNetworkNack_(a,new gb,b,c,d)};ja.prototype.handleNetworkNack_=function(a,b,c,d,k){a=Math.round(c);this.updateKeyRequest_(this.keyRequests_[a],a,d)};
ja.prototype.updateKeyRequest_=function(a,b,c){--a.interestCount;if(0==a.interestCount&&null!=c){try{c(a.encryptedKeys)}catch(d){console.log("Error in onEncryptedKeys: "+O.getErrorWithStackTrace(d))}delete this.keyRequests_[b]}};ja.prototype.handleCoveringKey_=function(a,b,c,d,k){var m=Math.round(c),m=this.keyRequests_[m],n=a.getName(),p=n.toUri(),s=b.getName(),q=ea.fromIsoString(s.get(ja.START_TIME_STAMP_INDEX).getValue().toString()),H=ea.fromIsoString(s.get(ja.END_TIME_STAMP_INDEX).getValue().toString());
if(c>=H)a=new Ra(a.getExclude()),ja.excludeBefore(a,s.get(ja.START_TIME_STAMP_INDEX)),m.repeatAttempts[p]=0,this.sendKeyInterest_((new F(n)).setExclude(a).setChildSelector(1),c,d,k);else{var x=b.getContent(),P=this;this.encryptContentKeyPromise_(x,s,c,d,k).then(function(a){a&&(a=P.eKeyInfo_[p].keyInfo,a.beginTimeSlot=q,a.endTimeSlot=H,a.keyBits=x)})}};ja.prototype.encryptContentKeyPromise_=function(a,d,k,m,n){var p=Math.round(k),s=this.keyRequests_[p],q=new c(this.namespace_);q.append(xa.NAME_COMPONENT_C_KEY);
q.append(ea.toIsoString(ja.getRoundedTimeSlot_(k)));var H,x=this;return this.database_.getContentKeyPromise(k).then(function(b){H=new Q;H.setName(q);var c=new Ob(ia.RsaOaep);return xa.encryptDataPromise(H,b,d,a,c)}).then(function(){return b.resolve(!0)},function(a){try{n(pc.ErrorCode.EncryptionFailure,"encryptData failed: "+a)}catch(c){console.log("Error in onError: "+O.getErrorWithStackTrace(c))}return b.resolve(!1)}).then(function(a){return a?x.keyChain_.signPromise(H).then(function(){s.encryptedKeys.push(H);
x.updateKeyRequest_(s,p,m);return b.resolve(!0)}):b.resolve(!1)})};ja.prototype.getEKeyInfoSize_=function(){var a=0;for(key in this.eKeyInfo_)this.eKeyInfo_.hasOwnProperty(key)&&++a;return a};ja.ExcludeEntry=function(a,b){this.component_=a;this.anyFollowsComponent_=b};ja.getExcludeEntries=function(a){for(var b=[],d=0;d<a.size();++d)a.get(d)==Ra.ANY?0==b.length?b.push(new ja.ExcludeEntry(new c.Component,!0)):b[b.length-1].anyFollowsComponent_=!0:b.push(new ja.ExcludeEntry(a.get(d),!1));return b};ja.setExcludeEntries=
function(a,b){a.clear();for(var c=0;c<b.length;++c){var d=b[c];0==c&&0==d.component_.getValue().size()&&d.anyFollowsComponent_?a.appendAny():(a.appendComponent(d.component_),d.anyFollowsComponent_&&a.appendAny())}};ja.findEntryBeforeOrAt=function(a,b){for(var c=a.length-1;0<=c&&!(0>=a[c].component_.compare(b));)--c;return c};ja.excludeAfter=function(a,b){var c=ja.getExcludeEntries(a),d;d=ja.findEntryBeforeOrAt(c,b);if(0>d)c.splice(0,0,new ja.ExcludeEntry(b,!0)),d=0;else{var k=c[d];k.anyFollowsComponent_||
(k.component_.equals(b)?k.anyFollowsComponent_=!0:(c.splice(d+1,0,new ja.ExcludeEntry(b,!0)),d+=1))}d+=1;c.splice(d,c.length-d);ja.setExcludeEntries(a,c)};ja.excludeBefore=function(a,b){ja.excludeRange(a,new c.Component,b)};ja.excludeRange=function(a,b,c){if(0<=b.compare(c)){if(0==b.compare(c))throw Error("excludeRange: from == to. To exclude a single component, sue excludeOne.");throw Error("excludeRange: from must be less than to. Invalid range: ["+b.toEscapedString()+", "+c.toEscapedString()+"]");
}var d=ja.getExcludeEntries(a),k=ja.findEntryBeforeOrAt(d,b);if(0>k)d.splice(0,0,new ja.ExcludeEntry(b,!0)),b=0;else{var m=d[k];m.anyFollowsComponent_?b=k:m.component_.equals(b)?(m.anyFollowsComponent_=!0,b=k):(d.splice(k+1,0,new ja.ExcludeEntry(b,!0)),b=k+1)}k=ja.findEntryBeforeOrAt(d,c);m=d[k];k==b?d.splice(b+1,0,new ja.ExcludeEntry(c,!1)):(m.anyFollowsComponent_?c=k+1:m.component_.equals(c)?c=k:(d.splice(k+1,0,new ja.ExcludeEntry(c,!1)),c=k+1),b+=1,d.splice(b,c-b));ja.setExcludeEntries(a,d)};ja.START_TIME_STAMP_INDEX=
-2;ja.END_TIME_STAMP_INDEX=-1;ja.NO_LINK=new wb;var lb=a.Interval,Ca=function Nd(a,b,c,d,k,m){if("object"===typeof a&&a instanceof Nd)repetitiveInterval=a,this.startDate_=repetitiveInterval.startDate_,this.endDate_=repetitiveInterval.endDate_,this.intervalStartHour_=repetitiveInterval.intervalStartHour_,this.intervalEndHour_=repetitiveInterval.intervalEndHour_,this.nRepeats_=repetitiveInterval.nRepeats_,this.repeatUnit_=repetitiveInterval.repeatUnit_;else if("number"===typeof a){void 0==k&&(k=0);
void 0==m&&(m=Nd.RepeatUnit.NONE);this.startDate_=Nd.toDateOnlyMilliseconds_(a);this.endDate_=Nd.toDateOnlyMilliseconds_(b);this.intervalStartHour_=Math.round(c);this.intervalEndHour_=Math.round(d);this.nRepeats_=Math.round(k);this.repeatUnit_=m;if(!(this.intervalStartHour_<this.intervalEndHour_))throw Error("ReptitiveInterval: startHour must be less than endHour");if(!(this.startDate_<=this.endDate_))throw Error("ReptitiveInterval: startDate must be earlier than or same as endDate");if(!(0<=this.intervalStartHour_))throw Error("ReptitiveInterval: intervalStartHour must be non-negative");
if(!(1<=this.intervalEndHour_&&24>=this.intervalEndHour_))throw Error("ReptitiveInterval: intervalEndHour must be from 1 to 24");if(this.repeatUnit_==Nd.RepeatUnit.NONE&&this.startDate_!=this.endDate_)throw Error("ReptitiveInterval: With RepeatUnit.NONE, startDate must equal endDate");}else this.startDate_=-Number.MAX_VALUE,this.endDate_=-Number.MAX_VALUE,this.intervalStartHour_=0,this.intervalEndHour_=24,this.nRepeats_=0,this.repeatUnit_=Nd.RepeatUnit.NONE};q.RepetitiveInterval=Ca;Ca.RepeatUnit=
{NONE:0,DAY:1,MONTH:2,YEAR:3};Ca.prototype.getInterval=function(a){var b,c;this.hasIntervalOnDate_(a)?(b=Ca.toDateOnlyMilliseconds_(a)+this.intervalStartHour_*Ca.MILLISECONDS_IN_HOUR,c=Ca.toDateOnlyMilliseconds_(a)+this.intervalEndHour_*Ca.MILLISECONDS_IN_HOUR,a<b?(c=b,b=Ca.toDateOnlyMilliseconds_(a),a=!1):a>c?(b=c,c=Ca.toDateOnlyMilliseconds_(a)+Ca.MILLISECONDS_IN_DAY,a=!1):a=!0):(b=Ca.toDateOnlyMilliseconds_(a),c=Ca.toDateOnlyMilliseconds_(a)+24*Ca.MILLISECONDS_IN_HOUR,a=!1);return{isPositive:a,
interval:new lb(b,c)}};Ca.prototype.compare=function(a){return this.startDate_<a.startDate_?-1:this.startDate_>a.startDate_?1:this.endDate_<a.endDate_?-1:this.endDate_>a.endDate_?1:this.intervalStartHour_<a.intervalStartHour_?-1:this.intervalStartHour_>a.intervalStartHour_?1:this.intervalEndHour_<a.intervalEndHour_?-1:this.intervalEndHour_>a.intervalEndHour_?1:this.nRepeats_<a.nRepeats_?-1:this.nRepeats_>a.nRepeats_?1:this.repeatUnit_<a.repeatUnit_?-1:this.repeatUnit_>a.repeatUnit_?1:0};Ca.prototype.getStartDate=
function(){return this.startDate_};Ca.prototype.getEndDate=function(){return this.endDate_};Ca.prototype.getIntervalStartHour=function(){return this.intervalStartHour_};Ca.prototype.getIntervalEndHour=function(){return this.intervalEndHour_};Ca.prototype.getNRepeats=function(){return this.nRepeats_};Ca.prototype.getRepeatUnit=function(){return this.repeatUnit_};Ca.prototype.hasIntervalOnDate_=function(a){a=Ca.toDateOnlyMilliseconds_(a);if(a<this.startDate_||a>this.endDate_)return!1;if(this.repeatUnit_==
Ca.RepeatUnit.NONE)return!0;if(this.repeatUnit_==Ca.RepeatUnit.DAY){if(0==(a-this.startDate_)/Ca.MILLISECONDS_IN_DAY%this.nRepeats_)return!0}else{a=new Date(a);var b=new Date(this.startDate_);if(this.repeatUnit_==Ca.RepeatUnit.MONTH&&a.getUTCDate()==b.getUTCDate()){if(0==(12*(a.getUTCFullYear()-b.getUTCFullYear())+a.getUTCMonth()-b.getUTCMonth())%this.nRepeats_)return!0}else if(this.repeatUnit_==Ca.RepeatUnit.YEAR&&a.getUTCDate()==b.getUTCDate()&&a.getUTCMonth()==b.getUTCMonth()&&0==(a.getUTCFullYear()-
b.getUTCFullYear())%this.nRepeats_)return!0}return!1};Ca.toDateOnlyMilliseconds_=function(a){a=Math.round(a);return a-=a%Ca.MILLISECONDS_IN_DAY};Ca.MILLISECONDS_IN_HOUR=36E5;Ca.MILLISECONDS_IN_DAY=864E5;lb=a.Interval;Ca=a.RepetitiveInterval;n=a.Tlv;va=a.TlvEncoder;oa=a.TlvDecoder;p=a.Blob;ea=function Ze(a){"object"===typeof a&&a instanceof Ze?(this.whiteIntervalList_=a.whiteIntervalList_.slice(0),this.blackIntervalList_=a.blackIntervalList_.slice(0)):(this.whiteIntervalList_=[],this.blackIntervalList_=
[])};q.Schedule=ea;ea.prototype.addWhiteInterval=function(a){ea.sortedSetAdd_(this.whiteIntervalList_,a);return this};ea.prototype.addBlackInterval=function(a){ea.sortedSetAdd_(this.blackIntervalList_,a);return this};ea.prototype.getCoveringInterval=function(a){var b=new lb(!0),c=new lb(!0),d=new lb,k=new lb;ea.calculateIntervalResult_(this.blackIntervalList_,a,b,d);if(!b.isEmpty())return{isPositive:!1,interval:b};ea.calculateIntervalResult_(this.whiteIntervalList_,a,c,k);return c.isEmpty()&&!k.isValid()?
(a=Ca.toDateOnlyMilliseconds_(a),{isPositive:!1,interval:new lb(a,a+Ca.MILLISECONDS_IN_DAY)}):c.isEmpty()?{isPositive:!1,interval:k}:d.isValid()?{isPositive:!0,interval:c.intersectWith(d)}:{isPositive:!0,interval:c}};ea.prototype.wireEncode=function(){for(var a=new va(256),b=a.getLength(),c=a.getLength(),d=this.blackIntervalList_.length-1;0<=d;d--)ea.encodeRepetitiveInterval_(this.blackIntervalList_[d],a);a.writeTypeAndLength(n.Encrypt_BlackIntervalList,a.getLength()-c);c=a.getLength();for(d=this.whiteIntervalList_.length-
1;0<=d;d--)ea.encodeRepetitiveInterval_(this.whiteIntervalList_[d],a);a.writeTypeAndLength(n.Encrypt_WhiteIntervalList,a.getLength()-c);a.writeTypeAndLength(n.Encrypt_Schedule,a.getLength()-b);return new p(a.getOutput(),!1)};ea.prototype.wireDecode=function(a){a="object"===typeof a&&a instanceof p?a.buf():a;a=new oa(a);var b=a.readNestedTlvsStart(n.Encrypt_Schedule);this.whiteIntervalList_=[];for(var c=a.readNestedTlvsStart(n.Encrypt_WhiteIntervalList);a.getOffset()<c;)ea.sortedSetAdd_(this.whiteIntervalList_,
ea.decodeRepetitiveInterval_(a));a.finishNestedTlvs(c);this.blackIntervalList_=[];for(c=a.readNestedTlvsStart(n.Encrypt_BlackIntervalList);a.getOffset()<c;)ea.sortedSetAdd_(this.blackIntervalList_,ea.decodeRepetitiveInterval_(a));a.finishNestedTlvs(c);a.finishNestedTlvs(b)};ea.sortedSetAdd_=function(a,b){for(var c=0;c<a.length;){var d=a[c].compare(b);if(0==d)return;if(!(0>d))break;++c}a.splice(c,0,b)};ea.encodeRepetitiveInterval_=function(a,b){var c=b.getLength();b.writeNonNegativeIntegerTlv(n.Encrypt_RepeatUnit,
a.getRepeatUnit());b.writeNonNegativeIntegerTlv(n.Encrypt_NRepeats,a.getNRepeats());b.writeNonNegativeIntegerTlv(n.Encrypt_IntervalEndHour,a.getIntervalEndHour());b.writeNonNegativeIntegerTlv(n.Encrypt_IntervalStartHour,a.getIntervalStartHour());b.writeBlobTlv(n.Encrypt_EndDate,(new p(ea.toIsoString(a.getEndDate()))).buf());b.writeBlobTlv(n.Encrypt_StartDate,(new p(ea.toIsoString(a.getStartDate()))).buf());b.writeTypeAndLength(n.Encrypt_RepetitiveInterval,b.getLength()-c)};ea.decodeRepetitiveInterval_=
function(a){var b=a.readNestedTlvsStart(n.Encrypt_RepetitiveInterval),c=ea.fromIsoString((new p(a.readBlobTlv(n.Encrypt_StartDate),!0)).toString()),d=ea.fromIsoString((new p(a.readBlobTlv(n.Encrypt_EndDate),!0)).toString()),k=a.readNonNegativeIntegerTlv(n.Encrypt_IntervalStartHour),m=a.readNonNegativeIntegerTlv(n.Encrypt_IntervalEndHour),s=a.readNonNegativeIntegerTlv(n.Encrypt_NRepeats),q=a.readNonNegativeIntegerTlv(n.Encrypt_RepeatUnit);a.finishNestedTlvs(b);return new Ca(c,d,k,m,s,q)};ea.calculateIntervalResult_=
function(a,b,c,d){for(var k=0;k<a.length;++k){var m=a[k].getInterval(b),n=m.interval;!0==m.isPositive?c.unionWith(n):d.isValid()?d.intersectWith(n):d.set(n)}};ea.toIsoString=function(a){a=new Date(Math.round(a));return a.getUTCFullYear()+ea.to2DigitString(a.getUTCMonth()+1)+ea.to2DigitString(a.getUTCDate())+"T"+ea.to2DigitString(a.getUTCHours())+ea.to2DigitString(a.getUTCMinutes())+ea.to2DigitString(a.getUTCSeconds())};ea.to2DigitString=function(a){a=a.toString();return 1===a.length?"0"+a:a};ea.fromIsoString=
function(a){if(15!=a.length||"T"!=a.substr(8,1))throw Error("fromIsoString: Format is not the expected yyyymmddThhmmss");return Date.UTC(parseInt(a.substr(0,4)),parseInt(a.substr(4,2)-1),parseInt(a.substr(6,2)),parseInt(a.substr(9,2)),parseInt(a.substr(11,2)),parseInt(a.substr(13,2)))};new hd;new ab;new Cc;var nb=a.DigestTree,F=a.Interest,Q=a.Data,c=a.Name,p=a.Blob,Ma=a.MemoryContentCache,qe=a.SyncStateProto,O=a.NdnCommon,Ea=function pe(b,c,d,k,m,n,p,s,q,H){this.onReceivedSyncState=b;this.onInitialized=
c;this.applicationDataPrefixUri=d.toUri();this.applicationBroadcastPrefix=k;this.session=m;this.face=n;this.keyChain=p;this.certificateName=s;this.sync_lifetime=q;this.usrseq=-1;this.digest_tree=new nb;this.contentCache=new Ma(n);this.digest_log=[];this.digest_log.push(new pe.DigestLogEntry("00",[]));this.contentCache.registerPrefix(this.applicationBroadcastPrefix,H,this.onInterest.bind(this));this.enabled=!0;b=new F(this.applicationBroadcastPrefix);b.getName().append("00");b.setInterestLifetimeMilliseconds(1E3);
var x;try{x=dcodeIO.ProtoBuf.newBuilder().import(qe).build("Sync")}catch(P){x=a.newBuilder().import(qe).build("Sync")}this.SyncStateMsg=x.SyncStateMsg;this.SyncState=x.SyncState;this.face.expressInterest(b,this.onData.bind(this),this.initialTimeOut.bind(this))};q.ChronoSync2013=Ea;Ea.prototype.getProducerPrefixes=function(){for(var a=[],b=0;b<this.digest_tree.digestnode.length;++b){var c=this.digest_tree.get(b);a.push(new Ea.PrefixAndSessionNo(c.getDataPrefix(),c.getSessionNo()))}return a};Ea.prototype.getProducerSequenceNo=
function(a,b){var c=this.digest_tree.find(a,b);return 0>c?-1:this.digest_tree.get(c).getSequenceNo()};Ea.prototype.publishNextSequenceNo=function(a){a=a instanceof p?a:new p(a,!0);this.usrseq++;var b={name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}};!a.isNull()&&0<a.size()&&(b.application_info=a.buf());a=[new this.SyncState(b)];b=new this.SyncStateMsg({ss:a});this.broadcastSyncState(this.digest_tree.getRoot(),b);this.update(a)||console.log("Warning: ChronoSync: update did not create a new digest log entry");
a=new F(this.applicationBroadcastPrefix);a.getName().append(this.digest_tree.getRoot());a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))};Ea.prototype.getSequenceNo=function(){return this.usrseq};Ea.DigestLogEntry=function(a,b){this.digest=a;this.data=b};Ea.DigestLogEntry.prototype.getDigest=function(){return this.digest};Ea.DigestLogEntry.prototype.getData=function(){return this.data};Ea.prototype.shutdown=function(){this.enabled=
!1;this.contentCache.unregisterAll()};Ea.SyncState=function(a,b,c,d){this.dataPrefixUri_=a;this.sessionNo_=b;this.sequenceNo_=c;this.applicationInfo_=d};Ea.SyncState.prototype.getDataPrefix=function(){return this.dataPrefixUri_};Ea.SyncState.prototype.getSessionNo=function(){return this.sessionNo_};Ea.SyncState.prototype.getSequenceNo=function(){return this.sequenceNo_};Ea.SyncState.prototype.getApplicationInfo=function(){return this.applicationInfo_};Ea.PrefixAndSessionNo=function(a,b){this.dataPrefixUri_=
a;this.sessionNo_=b};Ea.PrefixAndSessionNo.prototype.getDataPrefix=function(){return this.dataPrefixUri_};Ea.PrefixAndSessionNo.prototype.getSessionNo=function(){return this.sessionNo_};Ea.prototype.broadcastSyncState=function(a,b){var c=new Uint8Array(b.toArrayBuffer()),d=new Q(this.applicationBroadcastPrefix);d.getName().append(a);d.setContent(new p(c,!1));var k=this;this.keyChain.sign(d,this.certificateName,function(){k.contentCache.add(d)})};Ea.prototype.update=function(a){for(var b=0;b<a.length;b++)0==
a[b].type&&this.digest_tree.update(a[b].name,a[b].seqno.session,a[b].seqno.seq)&&this.applicationDataPrefixUri==a[b].name&&(this.usrseq=a[b].seqno.seq);return-1==this.logfind(this.digest_tree.getRoot())?(a=new Ea.DigestLogEntry(this.digest_tree.getRoot(),a),this.digest_log.push(a),!0):!1};Ea.prototype.logfind=function(a){for(var b=0;b<this.digest_log.length;b++)if(a==this.digest_log[b].digest)return b;return-1};Ea.prototype.onInterest=function(a,b,d,k,m){this.enabled&&(a=b.getName().get(this.applicationBroadcastPrefix.size()).toEscapedString(),
b.getName().size()==this.applicationBroadcastPrefix.size()+2&&(a=b.getName().get(this.applicationBroadcastPrefix.size()+1).toEscapedString()),b.getName().size()==this.applicationBroadcastPrefix.size()+2||"00"==a?this.processRecoveryInst(b,a,d):(this.contentCache.storePendingInterest(b,d),a!=this.digest_tree.getRoot()&&(b=this.logfind(a),-1==b?(b=new F(new c("/local/timeout")),b.setInterestLifetimeMilliseconds(2E3),this.face.expressInterest(b,this.dummyOnData,this.judgeRecovery.bind(this,b,a,d))):
this.processSyncInst(b,a,d))))};Ea.prototype.onData=function(a,b){if(this.enabled){var k=new Uint8Array(b.getContent().size());k.set(b.getContent().buf());var k=this.SyncStateMsg.decode(k.buffer).ss,m=!1;"00"==this.digest_tree.getRoot()?(m=!0,this.initialOndata(k)):(this.update(k),m=a.getName().size()==this.applicationBroadcastPrefix.size()+2?!0:!1);for(var n=[],s=0;s<k.length;s++)if(0==k[s].type){var q;k[s].application_info?(q=k[s].application_info.toBinary(),q=0<q.length?new p(new d(q,"binary"),
!1):new p):q=new p;n.push(new Ea.SyncState(k[s].name,k[s].seqno.session,k[s].seqno.seq,q))}try{this.onReceivedSyncState(n,m)}catch(H){console.log("Error in onReceivedSyncState: "+O.getErrorWithStackTrace(H))}k=new c(this.applicationBroadcastPrefix);k.append(this.digest_tree.getRoot());a=new F(k);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))}};Ea.prototype.initialTimeOut=function(a){if(this.enabled){console.log("no other people");
this.usrseq++;try{this.onInitialized()}catch(b){console.log("Error in onInitialized: "+O.getErrorWithStackTrace(b))}a=[new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}})];this.update(a);a=new c(this.applicationBroadcastPrefix);a.append(this.digest_tree.getRoot());a=new F(a);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))}};Ea.prototype.processRecoveryInst=
function(a,b,c){if(-1!=this.logfind(b)){b=[];for(var d=0;d<this.digest_tree.digestnode.length;d++)b[d]=new this.SyncState({name:this.digest_tree.digestnode[d].getDataPrefix(),type:"UPDATE",seqno:{seq:this.digest_tree.digestnode[d].getSequenceNo(),session:this.digest_tree.digestnode[d].getSessionNo()}});if(0!=b.length){b=new this.SyncStateMsg({ss:b});b=new Uint8Array(b.toArrayBuffer());var k=new Q(a.getName());k.setContent(new p(b,!1));"00"==a.getName().get(-1).toEscapedString()&&k.getMetaInfo().setFreshnessPeriod(1E3);
this.keyChain.sign(k,this.certificateName,function(){try{c.putData(k)}catch(a){console.log(a.toString())}})}}};Ea.prototype.processSyncInst=function(a,b,d){for(var k=[],m=[],n=[],s=[],q=a+1;q<this.digest_log.length;q++)for(var H=this.digest_log[q].getData(),x=0;x<H.length;x++)0==H[x].type&&-1!=this.digest_tree.find(H[x].name,H[x].seqno.session)&&(a=m.indexOf(H[x].name),-1==a?(m.push(H[x].name),n.push(H[x].seqno.seq),s.push(H[x].seqno.session)):(n[a]=H[x].seqno.seq,s[a]=H[x].seqno.session));for(x=
0;x<m.length;x++)k[x]=new this.SyncState({name:m[x],type:"UPDATE",seqno:{seq:n[x],session:s[x]}});if(0!=k.length){k=new this.SyncStateMsg({ss:k});k=new Uint8Array(k.toArrayBuffer());a=new c(this.prefix);a.append(this.chatroom).append(b);var P=new Q(a);P.setContent(new p(k,!1));this.keyChain.sign(P,this.certificateName,function(){try{d.putData(P)}catch(a){console.log(a.toString())}})}};Ea.prototype.sendRecovery=function(a){var b=new c(this.applicationBroadcastPrefix);b.append("recovery").append(a);
a=new F(b);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))};Ea.prototype.judgeRecovery=function(a,b,c){a=this.logfind(b);-1!=a?b!=this.digest_tree.root&&this.processSyncInst(a,b,c):this.sendRecovery(b)};Ea.prototype.syncTimeout=function(a){if(this.enabled&&a.getName().get(this.applicationBroadcastPrefix.size()).toEscapedString()==this.digest_tree.root){var b=new c(a.getName()),b=new F(b);a.setInterestLifetimeMilliseconds(this.sync_lifetime);
this.face.expressInterest(b,this.onData.bind(this),this.syncTimeout.bind(this))}};Ea.prototype.initialOndata=function(a){this.update(a);for(var b=this.digest_tree.getRoot(),c=0;c<a.length;c++)if(a[c].name==this.applicationDataPrefixUri&&a[c].seqno.session==this.session){var d=[new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:a[c].seqno.seq+1,session:this.session}})];if(this.update(d)){d=new Ea.DigestLogEntry(this.digest_tree.getRoot(),d);this.digest_log.push(d);try{this.onInitialized()}catch(k){console.log("Error in onInitialized: "+
O.getErrorWithStackTrace(k))}}}d=0<=this.usrseq?new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}}):new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:0,session:this.session}});a=new this.SyncStateMsg({ss:d});this.broadcastSyncState(b,a);if(-1==this.digest_tree.find(this.applicationDataPrefixUri,this.session)&&(this.usrseq++,a=[new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,
session:this.session}})],this.update(a)))try{this.onInitialized()}catch(m){console.log("Error in onInitialized: "+O.getErrorWithStackTrace(m))}};Ea.prototype.dummyOnData=function(a,b){console.log("*** dummyOnData called. ***")};ba=a;nb=function(){this.root="00";this.digestnode=[]};q.DigestTree=nb;nb.Node=function(a,b,c){this.dataPrefix=a;this.seqno_session=b;this.seqno_seq=c;this.recomputeDigest()};nb.Node.prototype.getDataPrefix=function(){return this.dataPrefix};nb.Node.prototype.getSessionNo=function(){return this.seqno_session};
nb.Node.prototype.getSequenceNo=function(){return this.seqno_seq};nb.Node.prototype.getDigest=function(){return this.digest};nb.Node.prototype.setSequenceNo=function(a){this.seqno_seq=a;this.recomputeDigest()};nb.Node.prototype.Int32ToBuffer=function(a){for(var b=new d(4),c=0;4>c;c++)b[c]=a%256,a=Math.floor(a/256);return b};nb.Node.prototype.recomputeDigest=function(){var a=ba.createHash("sha256");a.update(this.Int32ToBuffer(this.seqno_session));a.update(this.Int32ToBuffer(this.seqno_seq));var a=
a.digest(),b=ba.createHash("sha256");b.update(this.dataPrefix);var b=b.digest(),c=ba.createHash("sha256");c.update(b);c.update(a);this.digest=c.digest("hex")};nb.Node.Compare=function(a,b){return a.dataPrefix!=b.dataPrefix?a.dataPrefix<b.dataPrefix:a.seqno_session<b.seqno_session};nb.prototype.update=function(a,b,c){var d=this.find(a,b);if(0<=d)if(this.digestnode[d].getSequenceNo()<c)this.digestnode[d].setSequenceNo(c);else return!1;else a=new nb.Node(a,b,c),this.digestnode.push(a),this.digestnode.sort(this.sortNodes);
this.recomputeRoot();return!0};nb.prototype.sortNodes=function(){for(var a,b=this.digestnode.length;0<b;b--)for(var c=0;c<b-1;c++)this.digestnode[c].getDataPrefix()>this.digestnode[c+1].getDataPrefix()&&(a=this.digestnode[c],this.digestnode[c]=this.digestnode[c+1],this.digestnode[c+1]=a)};nb.prototype.sortNodes=function(a,b){return a.getDataPrefix()==b.getDataPrefix()&&a.getSessionNo()==b.getSessionNo()?0:a.getDataPrefix()>b.getDataPrefix()||a.getDataPrefix()==b.getDataPrefix()&&a.getSessionNo()>
b.getSessionNo()?1:-1};nb.prototype.find=function(a,b){for(var c=0;c<this.digestnode.length;++c)if(this.digestnode[c].getDataPrefix()==a&&this.digestnode[c].getSessionNo()==b)return c;return-1};nb.prototype.size=function(){return this.digestnode.size()};nb.prototype.get=function(a){return this.digestnode[a]};nb.prototype.getRoot=function(){return this.root};nb.prototype.recomputeRoot=function(){for(var a=ba.createHash("sha256"),b=0;b<this.digestnode.length;b++)a.update(new d(this.digestnode[b].digest,
"hex"));this.root=a.digest("hex")};qe={"package":"Sync",messages:[{name:"SyncState",fields:[{rule:"required",type:"string",name:"name",id:1,options:{}},{rule:"required",type:"ActionType",name:"type",id:2,options:{}},{rule:"optional",type:"SeqNo",name:"seqno",id:3,options:{}},{rule:"optional",type:"bytes",name:"application_info",id:4,options:{}}],enums:[{name:"ActionType",values:[{name:"UPDATE",id:0},{name:"DELETE",id:1},{name:"OTHER",id:2}],options:{}}],messages:[{name:"SeqNo",fields:[{rule:"required",
type:"uint32",name:"seq",id:1,options:{}},{rule:"required",type:"uint32",name:"session",id:2,options:{}}],enums:[],messages:[],options:{}}],options:{}},{name:"SyncStateMsg",fields:[{rule:"repeated",type:"SyncState",name:"ss",id:1,options:{}}],enums:[],messages:[],options:{}}],enums:[],imports:[],options:{}};q.SyncStateProto=qe;var s=a.WireFormat,bd=a.CommandInterestPreparer,Pd=function(){bd.call(this)};Pd.prototype=new bd;Pd.prototype.name="CommandInterestGenerator";q.CommandInterestGenerator=Pd;
Pd.prototype.generate=function(a,b,c,d,k){k="function"===typeof d?d:k;d="function"!==typeof d&&d?d:s.getDefaultWireFormat();this.prepareCommandInterestName(a,d);b.sign(a,c,d,function(){(null==a.getInterestLifetimeMilliseconds()||0>a.getInterestLifetimeMilliseconds())&&a.setInterestLifetimeMilliseconds(1E3);k&&k()})};var k=a.Log.LOG,qc=function(){this.table_=[]};q.InterestFilterTable=qc;qc.Entry=function(a,b,c,d){this.interestFilterId_=a;this.filter_=b;this.onInterest_=c;this.face_=d};qc.Entry.prototype.getInterestFilterId=
function(){return this.interestFilterId_};qc.Entry.prototype.getFilter=function(){return this.filter_};qc.Entry.prototype.getOnInterest=function(){return this.onInterest_};qc.Entry.prototype.getFace=function(){return this.face_};qc.prototype.setInterestFilter=function(a,b,c,d){this.table_.push(new qc.Entry(a,b,c,d))};qc.prototype.getMatchedFilters=function(a,b){for(var c=0;c<this.table_.length;++c){var d=this.table_[c];d.getFilter().doesMatch(a.getName())&&b.push(d)}};qc.prototype.unsetInterestFilter=
function(a){for(var b=0,c=this.table_.length-1;0<=c;--c)this.table_[c].getInterestFilterId()==a&&(++b,this.table_.splice(c,1));0===b&&0<k&&console.log("unsetInterestFilter: Didn't find interestFilterId "+a)};var O=a.NdnCommon,k=a.Log.LOG,Kb=function(){this.table_=[];this.removeRequests_=[]};q.PendingInterestTable=Kb;Kb.Entry=function(a,b,c,d,k){this.pendingInterestId_=a;this.interest_=b;this.onData_=c;this.onTimeout_=d;this.onNetworkNack_=k;this.timerId_=-1};Kb.Entry.prototype.getPendingInterestId=
function(){return this.pendingInterestId_};Kb.Entry.prototype.getInterest=function(){return this.interest_};Kb.Entry.prototype.getOnData=function(){return this.onData_};Kb.Entry.prototype.getOnNetworkNack=function(){return this.onNetworkNack_};Kb.Entry.prototype.callTimeout=function(){if(this.onTimeout_)try{this.onTimeout_(this.interest_)}catch(a){console.log("Error in onTimeout: "+O.getErrorWithStackTrace(a))}};Kb.Entry.prototype.setTimeout=function(a,b){-1===this.timerId_&&(this.timerId_=setTimeout(a,
b))};Kb.Entry.prototype.clearTimeout=function(){-1!==this.timerId_&&(clearTimeout(this.timerId_),this.timerId_=-1)};Kb.prototype.add=function(a,b,c,d,m){var n=this.removeRequests_.indexOf(a);if(0<=n)return this.removeRequests_.splice(n,1),null;var p=new Kb.Entry(a,b,c,d,m);this.table_.push(p);a=b.getInterestLifetimeMilliseconds()||4E3;var s=this;p.setTimeout(function(){1<k&&console.log("Interest time out: "+b.getName().toUri());var a=s.table_.indexOf(p);0<=a&&s.table_.splice(a,1);p.callTimeout()},
a);return p};Kb.prototype.extractEntriesForExpressedInterest=function(a,b){for(var c=this.table_.length-1;0<=c;--c){var d=this.table_[c];d.getInterest().matchesData(a)&&(d.clearTimeout(),b.push(d),this.table_.splice(c,1))}};Kb.prototype.extractEntriesForNackInterest=function(a,b){for(var c=a.wireEncode(),d=this.table_.length-1;0<=d;--d){var k=this.table_[d];null!=k.getOnNetworkNack()&&k.getInterest().wireEncode().equals(c)&&(k.clearTimeout(),b.push(k),this.table_.splice(d,1))}};Kb.prototype.removePendingInterest=
function(a){if(null!=a){for(var b=0,c=this.table_.length-1;0<=c;--c){var d=this.table_[c];d.getPendingInterestId()==a&&(d.clearTimeout(),this.table_.splice(c,1),++b)}0===b&&0<k&&console.log("removePendingInterest: Didn't find pendingInterestId "+a);0===b&&0>this.removeRequests_.indexOf(a)&&this.removeRequests_.push(a)}};var k=a.Log.LOG,Rc=function(a){this.interestFilterTable_=a;this.table_=[];this.removeRequests_=[]};q.RegisteredPrefixTable=Rc;Rc.prototype.add=function(a,b,c){var d=this.removeRequests_.indexOf(a);
if(0<=d)return this.removeRequests_.splice(d,1),!1;this.table_.push(new Rc._Entry(a,b,c));return!0};Rc.prototype.removeRegisteredPrefix=function(a){for(var b=0,c=this.table_.length-1;0<=c;--c){var d=this.table_[c];d.getRegisteredPrefixId()==a&&(++b,0<d.getRelatedInterestFilterId()&&this.interestFilterTable_.unsetInterestFilter(d.getRelatedInterestFilterId()),this.table_.splice(c,1))}0===b&&0<k&&console.log("removeRegisteredPrefix: Didn't find registeredPrefixId "+a);0===b&&0>this.removeRequests_.indexOf(a)&&
this.removeRequests_.push(a)};Rc._Entry=function(a,b,c){this.registeredPrefixId_=a;this.prefix_=b;this.relatedInterestFilterId_=c};Rc._Entry.prototype.getRegisteredPrefixId=function(){return this.registeredPrefixId};Rc._Entry.prototype.getPrefix=function(){return this.prefix};Rc._Entry.prototype.getRelatedInterestFilterId=function(){return this.relatedInterestFilterId};$c=function(){this.congestionMark_=0};q.CongestionMark=$c;$c.prototype.getCongestionMark=function(){return this.congestionMark_};
$c.prototype.setCongestionMark=function(a){this.congestionMark_=a};$c.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var c=a.getHeaderField(b);if(c instanceof $c)return c}return null};wc=function(){this.faceId_=null};q.IncomingFaceId=wc;wc.prototype.getFaceId=function(){return this.faceId_};wc.prototype.setFaceId=function(a){this.faceId_=a};wc.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var c=a.getHeaderField(b);if(c instanceof wc)return c}return null};
var p=a.Blob,id=function(){this.headerFields_=[];this.fragmentWireEncoding_=new p};q.LpPacket=id;id.prototype.getFragmentWireEncoding=function(){return this.fragmentWireEncoding_};id.prototype.countHeaderFields=function(){return this.headerFields_.length};id.prototype.getHeaderField=function(a){return this.headerFields_[a]};id.prototype.clear=function(){this.headerFields_=[];this.fragmentWireEncoding_=new p};id.prototype.setFragmentWireEncoding=function(a){this.fragmentWireEncoding_="object"===typeof a&&
a instanceof p?a:new p(a)};id.prototype.addHeaderField=function(a){this.headerFields_.push(a)};var M=a.DataUtils,c=a.Name,F=a.Interest,Q=a.Data,Qa=a.ControlParameters,nc=a.ControlResponse,uc=a.InterestFilter,s=a.WireFormat,hb=a.TlvWireFormat,n=a.Tlv,oa=a.TlvDecoder,Fa=a.ForwardingFlags,pb=a.Transport,re=a.TcpTransport,ye=a.UnixTransport,Pd=a.CommandInterestGenerator,p=a.Blob,O=a.NdnCommon,gb=a.NetworkNack,id=a.LpPacket,qc=a.InterestFilterTable,Kb=a.PendingInterestTable,Rc=a.RegisteredPrefixTable,
Ib=a,k=a.Log.LOG;ca=function Bc(a,b){if(!Bc.supported)throw Error("The necessary JavaScript support is not available on this platform.");var d;if("object"==typeof a&&a instanceof pb){if(this.getConnectionInfo=null,this.transport=a,this.connectionInfo=b||null,d={},null==this.connectionInfo&&this.transport&&this.transport.__proto__&&"UnixTransport"==this.transport.__proto__.name){var m=Bc.getUnixSocketFilePathForLocalhost();null!=m?this.connectionInfo=new ye.ConnectionInfo(m):console.log("Face constructor: Cannot determine the default Unix socket file path for UnixTransport");
0<k&&console.log("Using "+this.connectionInfo.toString())}}else d=a||{},this.transport=(d.getTransport||function(){return new re})(),this.getConnectionInfo=d.getConnectionInfo||this.transport.defaultGetConnectionInfo,this.connectionInfo=d.connectionInfo||null,null==this.connectionInfo&&(m=void 0!==d.host?d.host:null,this.transport&&this.transport.__proto__&&"UnixTransport"==this.transport.__proto__.name?null!=m?this.connectionInfo=new ye.ConnectionInfo(m):null==this.getConnectionInfo&&(m=Bc.getUnixSocketFilePathForLocalhost(),
null!=m?this.connectionInfo=new ye.ConnectionInfo(m):console.log("Face constructor: Cannot determine the default Unix socket file path for UnixTransport")):null!=m&&(this.connectionInfo="undefined"!=typeof Ab?new Ab.ConnectionInfo(m,d.port||9696):new re.ConnectionInfo(m,d.port||6363)));null==this.connectionInfo?this.host=this.host=null:(this.host=this.connectionInfo.host,this.host=this.connectionInfo.port);this.readyStatus=Bc.UNOPEN;this.onopen=d.onopen||function(){3<k&&console.log("Face connection established.")};
this.onclose=d.onclose||function(){3<k&&console.log("Face connection closed.")};this.onConnectedCallbacks=[];this.commandKeyChain=null;this.commandCertificateName=new c;this.commandInterestGenerator=new Pd;this.timeoutPrefix=new c("/local/timeout");this.pendingInterestTable_=new Kb;this.interestFilterTable_=new qc;this.registeredPrefixTable_=new Rc(this.interestFilterTable_);this.lastEntryId=0};q.Face=ca;ca.UNOPEN=0;ca.OPEN_REQUESTED=1;ca.OPENED=2;ca.CLOSED=3;re.importFace(ca);ca.getUnixSocketFilePathForLocalhost=
function(){var a="/var/run/nfd.sock";if(Ib.existsSync(a))return a;a="/tmp/.ndnd.sock";return Ib.existsSync(a)?a:""};ca.getSupported=function(){try{(new d(1)).slice(0,1)}catch(a){return console.log("NDN not available: Buffer not supported. "+a),!1}return!0};ca.supported=ca.getSupported();ca.prototype.createRoute=function(a,b){this.connectionInfo=a instanceof pb.ConnectionInfo?a:new re.ConnectionInfo(a,b);this.host=this.connectionInfo.host;this.host=this.connectionInfo.port};ca.prototype.close=function(){this.readyStatus==
ca.OPENED&&(this.readyStatus=ca.CLOSED,this.transport.close())};ca.prototype.getNextEntryId=function(){return++this.lastEntryId};ca.makeShuffledHostGetConnectionInfo=function(a,b,c){a=a.slice(0,a.length);M.shuffle(a);return function(){return 0==a.length?null:c(a.splice(0,1)[0],b)}};ca.prototype.expressInterest=function(a,b,c,d,k,m){var n;"object"===typeof a&&a instanceof F?n=new F(a):b&&"object"===typeof b&&b instanceof F?(n=new F(b),n.setName(a),b=c,c=d,d=k,k=m):(n=new F(a),n.setInterestLifetimeMilliseconds(4E3));
var p=b,q,H,x;q="function"===typeof c?c:function(){};H="function"===typeof d?d:null;x=c instanceof s?c:d instanceof s?d:k instanceof s?k:s.getDefaultWireFormat();var P=this.getNextEntryId();n.setNonce(ca.nonceTemplate_);n.refreshNonce();if(null==this.connectionInfo)if(null==this.getConnectionInfo)console.log("ERROR: connectionInfo is NOT SET");else{var z=this;this.connectAndExecute(function(){z.reconnectAndExpressInterest(P,n,p,q,H,x)})}else this.reconnectAndExpressInterest(P,n,p,q,H,x);return P};
ca.prototype.reconnectAndExpressInterest=function(a,b,c,d,k,m){var n=this;if(this.connectionInfo.equals(this.transport.connectionInfo)&&this.readyStatus!==ca.UNOPEN)if(this.readyStatus===ca.OPEN_REQUESTED)this.onConnectedCallbacks.push(function(){n.expressInterestHelper(a,b,c,d,k,m)});else if(this.readyStatus===ca.OPENED)this.expressInterestHelper(a,b,c,d,k,m);else throw Error("reconnectAndExpressInterest: unexpected connection is not opened");else this.readyStatus=ca.OPEN_REQUESTED,this.onConnectedCallbacks.push(function(){n.expressInterestHelper(a,
b,c,d,k,m)}),this.transport.connect(this.connectionInfo,this,function(){for(n.readyStatus=ca.OPENED;0<n.onConnectedCallbacks.length;)try{n.onConnectedCallbacks.shift()()}catch(a){console.log("Face.reconnectAndExpressInterest: ignoring exception from onConnectedCallbacks: "+a)}if(n.onopen)n.onopen()},function(){n.closeByTransport()})};ca.prototype.expressInterestHelper=function(a,b,c,d,k,m){if(null!=this.pendingInterestTable_.add(a,b,c,d,k)&&!this.timeoutPrefix.match(b.getName())){a=b.wireEncode(m);
if(a.size()>ca.getMaxNdnPacketSize())throw Error("The encoded interest size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(a.buf())}};ca.prototype.removePendingInterest=function(a){this.pendingInterestTable_.removePendingInterest(a)};ca.prototype.setCommandSigningInfo=function(a,b){this.commandKeyChain=a;this.commandCertificateName=new c(b)};ca.prototype.setCommandCertificateName=function(a){this.commandCertificateName=new c(a)};ca.prototype.makeCommandInterest=function(a,b,
c){c="function"===typeof b?b:c;b="function"!==typeof b&&b?b:s.getDefaultWireFormat();this.nodeMakeCommandInterest(a,this.commandKeyChain,this.commandCertificateName,b,c)};ca.prototype.nodeMakeCommandInterest=function(a,b,c,d,k){this.commandInterestGenerator.generate(a,b,c,d,k)};ca.prototype.registerPrefix=function(a,b,c,d,k,m){var n=d,p=k,q=m;d="function"===typeof n?n:null;k=n instanceof Fa?n:p instanceof Fa?p:new Fa;m=n instanceof s?n:p instanceof s?p:q instanceof s?q:s.getDefaultWireFormat();c||
(c=function(){});var H=this.getNextEntryId(),x=this,n=function(){x.nfdRegisterPrefix(H,a,b,k,c,d,x.commandKeyChain,x.commandCertificateName,m)};null==this.connectionInfo?null==this.getConnectionInfo?console.log("ERROR: connectionInfo is NOT SET"):this.connectAndExecute(n):n();return H};ca.getMaxNdnPacketSize=function(){return O.MAX_NDN_PACKET_SIZE};ca.RegisterResponse=function(a,b,c,d,k,m){this.prefix=a;this.onRegisterFailed=b;this.onRegisterSuccess=c;this.registeredPrefixId=d;this.parent=k;this.onInterest=
m};ca.RegisterResponse.prototype.onData=function(a,b){var c=new nc;try{c.wireDecode(b.getContent(),hb.get())}catch(d){0<k&&console.log("Register prefix failed: Error decoding the NFD response: "+d);if(this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(m){console.log("Error in onRegisterFailed: "+O.getErrorWithStackTrace(m))}return}if(200!=c.getStatusCode()){if(0<k&&console.log("Register prefix failed: Expected NFD status code 200, got: "+c.getStatusCode()),this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(n){console.log("Error in onRegisterFailed: "+
O.getErrorWithStackTrace(n))}}else{if(0!=this.registeredPrefixId&&(c=0,null!=this.onInterest&&(c=this.parent.setInterestFilter(new uc(this.prefix),this.onInterest)),!this.parent.registeredPrefixTable_.add(this.registeredPrefixId,this.prefix,c))){0<c&&this.parent.unsetInterestFilter(c);return}2<k&&console.log("Register prefix succeeded with the NFD forwarder for prefix "+this.prefix.toUri());if(null!=this.onRegisterSuccess)try{this.onRegisterSuccess(this.prefix,this.registeredPrefixId)}catch(p){console.log("Error in onRegisterSuccess: "+
O.getErrorWithStackTrace(p))}}};ca.RegisterResponse.prototype.onTimeout=function(a){2<k&&console.log("Timeout for NFD register prefix command.");if(this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(b){console.log("Error in onRegisterFailed: "+O.getErrorWithStackTrace(b))}};ca.prototype.nfdRegisterPrefix=function(a,b,d,m,n,p,s,q,H){if(null==s)throw Error("registerPrefix: The command KeyChain has not been set. You must call setCommandSigningInfo.");if(0==q.size())throw Error("registerPrefix: The command certificate name has not been set. You must call setCommandSigningInfo.");
var x=new Qa;x.setName(b);x.setForwardingFlags(m);var P=this;this.isLocal(function(k){var m=new F;k?(m.setName(new c("/localhost/nfd/rib/register")),m.setInterestLifetimeMilliseconds(2E3)):(m.setName(new c("/localhop/nfd/rib/register")),m.setInterestLifetimeMilliseconds(4E3));m.getName().append(x.wireEncode(hb.get()));P.nodeMakeCommandInterest(m,s,q,hb.get(),function(){var c=new ca.RegisterResponse(b,n,p,a,P,d);P.reconnectAndExpressInterest(null,m,c.onData.bind(c),c.onTimeout.bind(c),null,H)})},function(a){0<
k&&console.log("Error in Transport.isLocal: "+a);if(n)try{n(b)}catch(c){console.log("Error in onRegisterFailed: "+O.getErrorWithStackTrace(c))}})};ca.prototype.removeRegisteredPrefix=function(a){this.registeredPrefixTable_.removeRegisteredPrefix(a)};ca.prototype.setInterestFilter=function(a,b){var c=this.getNextEntryId();this.interestFilterTable_.setInterestFilter(c,new uc(a),b,this);return c};ca.prototype.unsetInterestFilter=function(a){this.interestFilterTable_.unsetInterestFilter(a)};ca.prototype.putData=
function(a,b){b=b||s.getDefaultWireFormat();var c=a.wireEncode(b);if(c.size()>ca.getMaxNdnPacketSize())throw Error("The encoded Data packet size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(c.buf())};ca.prototype.send=function(a){if(a.length>ca.getMaxNdnPacketSize())throw Error("The encoded packet size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(a)};ca.prototype.isLocal=function(a,b){null==this.connectionInfo?a(!1):this.transport.isLocal(this.connectionInfo,
a,b)};ca.prototype.onReceivedElement=function(a){3<k&&console.log("Complete element received. Length "+a.length+". Start decoding.");var b=null;a[0]==n.LpPacket_LpPacket&&(b=new id,hb.get().decodeLpPacket(b,a,!1),a=b.getFragmentWireEncoding().buf());var c=null,d=null;if(a[0]==n.Interest||a[0]==n.Data){var m=new oa(a);m.peekType(n.Interest,a.length)?(c=new F,c.wireDecode(a,hb.get()),null!=b&&c.setLpPacket(b)):m.peekType(n.Data,a.length)&&(d=new Q,d.wireDecode(a,hb.get()),null!=b&&d.setLpPacket(b))}if(null!==
b&&(b.setFragmentWireEncoding(new p),b=gb.getFirstHeader(b),null!=b)){if(null==c)return;d=[];this.pendingInterestTable_.extractEntriesForNackInterest(c,d);for(a=0;a<d.length;++a){c=d[a];try{c.getOnNetworkNack()(c.getInterest(),b)}catch(s){console.log("Error in onNetworkNack: "+O.getErrorWithStackTrace(s))}}return}if(null!==c)for(3<k&&console.log("Interest packet received."),d=[],this.interestFilterTable_.getMatchedFilters(c,d),a=0;a<d.length;++a){b=d[a];3<k&&console.log("Found interest filter for "+
c.getName().toUri());try{b.getOnInterest()(b.getFilter().getPrefix(),c,this,b.getInterestFilterId(),b.getFilter())}catch(q){console.log("Error in onInterest: "+O.getErrorWithStackTrace(q))}}else if(null!==d)for(3<k&&console.log("Data packet received."),b=[],this.pendingInterestTable_.extractEntriesForExpressedInterest(d,b),a=0;a<b.length;++a){c=b[a];try{c.getOnData()(c.getInterest(),d)}catch(H){console.log("Error in onData: "+O.getErrorWithStackTrace(H))}}};ca.prototype.connectAndExecute=function(a){var b=
this.getConnectionInfo();if(null==b)console.log("ERROR: No more connectionInfo from getConnectionInfo"),this.host=this.host=this.connectionInfo=null;else if(b.equals(this.connectionInfo))console.log("ERROR: The host returned by getConnectionInfo is not alive: "+this.connectionInfo.toString());else{this.connectionInfo=b;0<k&&console.log("connectAndExecute: trying host from getConnectionInfo: "+this.connectionInfo.toString());this.host=this.connectionInfo.host;this.host=this.connectionInfo.port;b=new F(new c("/"));
b.setInterestLifetimeMilliseconds(4E3);var d=this,m=setTimeout(function(){0<k&&console.log("connectAndExecute: timeout waiting for host "+d.host);d.connectAndExecute(a)},3E3);this.reconnectAndExpressInterest(null,b,function(b,c){clearTimeout(m);0<k&&console.log("connectAndExecute: connected to host "+d.host);a()},function(a){},null,s.getDefaultWireFormat())}};ca.prototype.closeByTransport=function(){this.readyStatus=ca.CLOSED;this.onclose()};ca.nonceTemplate_=new p(new d(4),!1);new ca(new pb,{equals:function(){return!0}});
var se={};Object.keys(a).forEach(function(b){se[b]=ka[b];ka[b]=a[b]});a.noConflict=function(){Object.keys(se).forEach(function(b){ka[b]===a[b]&&("undefined"==typeof se[b]?delete ka[b]:ka[b]=se[b])});return a};ka.ndn=a})(this);
(function(ka,t,J){function S(d,t){"object"!==typeof t&&(t=t());Object.keys(t).forEach(function(D){d[D]=t[D]});return d}function T(d){return{from:function(t){d.prototype=Object.create(t.prototype);d.prototype.constructor=d;return{extend:function(D){S(d.prototype,"object"!==typeof D?D(t.prototype):D)}}}}}function V(d,t){return t(d)}function K(x,t){function D(a){this._cfg={version:a,storesSource:null,dbschema:{},tables:{},contentUpgrade:null};this.stores({})}function Xb(d,c,n,p){if(0===d){Object.keys($).forEach(function(a){q(c,
a,$[a].primKey,$[a].indexes)});var s=M._createTransaction(b,Xc,$);s.idbtrans=c;s.idbtrans.onerror=La(n,["populating database"]);s.on("error").subscribe(n);R.newPSD(function(){R.PSD.trans=s;try{M.on("populate").fire(s)}catch(a){p.onerror=c.onerror=function(a){a.preventDefault()};try{c.abort()}catch(b){}c.db.close();n(a)}})}else{var x=[],k=Hc.filter(function(a){return a._cfg.version===d})[0];if(!k)throw new Ha("Dexie specification of currently installed DB version is missing");$=M._dbSchema=k._cfg.dbschema;
var z=!1;Hc.filter(function(a){return a._cfg.version>d}).forEach(function(d){var k=$,p=d._cfg.dbschema;Gc(k,c);Gc(p,c);$=M._dbSchema=p;k=a(k,p);k.add.forEach(function(a){x.push(function(b,c){q(b,a[0],a[1].primKey,a[1].indexes);c()})});k.change.forEach(function(a){if(a.recreate)throw new Ha("Not yet support for changing primary key");x.push(function(b,c){var d=b.objectStore(a.name);a.add.forEach(function(a){Rb(d,a)});a.change.forEach(function(a){d.deleteIndex(a.name);Rb(d,a)});a.del.forEach(function(a){d.deleteIndex(a)});
c()})});d._cfg.contentUpgrade&&x.push(function(a,c){z=!0;var k=M._createTransaction(b,[].slice.call(a.db.objectStoreNames,0),p);k.idbtrans=a;var s=0;k._promise=V(k._promise,function(a){return function(b,d,k){function m(a){return function(){a.apply(this,arguments);0===--s&&c()}}++s;return a.call(this,b,function(a,b,c){arguments[0]=m(a);arguments[1]=m(b);d.apply(this,arguments)},k)}});a.onerror=La(n,["running upgrader function for version",d._cfg.version]);k.on("error").subscribe(n);d._cfg.contentUpgrade(k);
0===s&&c()});z&&(0<=navigator.userAgent.indexOf("Trident")||0<=navigator.userAgent.indexOf("MSIE"))||x.push(function(a,b){for(var c=0;c<a.db.objectStoreNames.length;++c){var d=a.db.objectStoreNames[c];null!==p[d]&&p[d]!==J||a.db.deleteObjectStore(d)}b()})});var P=function(){try{x.length?x.shift()(c,P):ka($,c)}catch(a){p.onerror=c.onerror=function(a){a.preventDefault()};try{c.abort()}catch(b){}c.db.close();n(a)}};P()}}function a(a,b){var d={del:[],add:[],change:[]},n;for(n in a)b[n]||d.del.push(n);
for(n in b){var p=a[n],q=b[n];if(p){var k={name:n,def:b[n],recreate:!1,del:[],add:[],change:[]};if(p.primKey.src!==q.primKey.src)k.recreate=!0,d.change.push(k);else{var p=p.indexes.reduce(function(a,b){a[b.name]=b;return a},{}),q=q.indexes.reduce(function(a,b){a[b.name]=b;return a},{}),x;for(x in p)q[x]||k.del.push(x);for(x in q){var P=p[x],m=q[x];P?P.src!==m.src&&k.change.push(m):k.add.push(m)}(k.recreate||0<k.del.length||0<k.add.length||0<k.change.length)&&d.change.push(k)}}else d.add.push([n,q])}return d}
function q(a,b,d,n){var p=a.db.createObjectStore(b,d.keyPath?{keyPath:d.keyPath,autoIncrement:d.auto}:{autoIncrement:d.auto});n.forEach(function(a){Rb(p,a)});return p}function ka(a,b){Object.keys(a).forEach(function(d){b.db.objectStoreNames.contains(d)||q(b,d,a[d].primKey,a[d].indexes)})}function Rb(a,b){a.createIndex(b.name,b.keyPath,{unique:b.unique,multiEntry:b.multi})}function Ad(a,b){throw new Ha("Table "+b[0]+" not part of transaction. Original Scope Function Source: "+K.Promise.PSD.trans.scopeFunc.toString());
}function Pb(a,b,d,n){this.name=a;this.schema=d;this.hook=O[a]?O[a].hook:kd(null,{creating:[Hd,A],reading:[jd,Gd],updating:[fe,A],deleting:[ie,A]});this._tpf=b;this._collClass=n||vb}function vd(a,b,d,n){Pb.call(this,a,b,d,n||Ka)}function wd(a,b,d,n){function p(a,b,c,d){return q._promise(a,c,d)}var q=this;this.db=M;this.mode=a;this.storeNames=b;this.idbtrans=null;this.on=kd(this,["complete","error"],"abort");this._reculock=0;this._blockedFuncs=[];this._psd=null;this.active=!0;this._dbschema=d;n&&(this.parent=
n);this._tpf=p;this.tables=Object.create(ld);for(n=b.length-1;-1!==n;--n){var k=b[n],x=M._tableFactory(a,d[k],p);this.tables[k]=x;this[k]||(this[k]=x)}}function sc(a,b,d){this._ctx={table:a,index:":id"===b?null:b,collClass:a._collClass,or:d}}function vb(a,b){var d=null,n=null;if(b)try{d=b()}catch(p){n=p}var q=a._ctx;this._ctx={table:q.table,index:q.index,isPrimKey:!q.index||q.table.schema.primKey.keyPath&&q.index===q.table.schema.primKey.name,range:d,op:"openCursor",dir:"next",unique:"",algorithm:null,
filter:null,isMatch:null,offset:0,limit:Infinity,error:n,or:q.or}}function Ka(){vb.apply(this,arguments)}function Vc(a,b){return a._cfg.version-b._cfg.version}function bc(a,b,d,n,p,q){d.forEach(function(d){var x=M._tableFactory(n,p[d],b);a.forEach(function(a){a[d]||(q?Object.defineProperty(a,d,{configurable:!0,enumerable:!0,get:function(){var a=R.PSD&&R.PSD.trans;return a&&a.db===M?a.tables[d]:x}}):a[d]=x)})})}function cc(a){a.forEach(function(a){for(var b in a)a[b]instanceof Pb&&delete a[b]})}function Hb(a,
b,d,n,p,q){var k=R.PSD;q=q||Gd;a.onerror||(a.onerror=La(p));a.onsuccess=b?aa(function(k){var x=a.result;if(x){var m=function(){x.continue()};b(x,function(a){m=a},n,p)&&d(q(x.value),x,function(a){m=a});m()}else n()},p,k):aa(function(b){var c=a.result;if(c){var k=function(){c.continue()};d(q(c.value),c,function(a){k=a});k()}else n()},p,k)}function z(a){var b=[];a.split(",").forEach(function(a){a=a.trim();var d=a.replace("&","").replace("++","").replace("*",""),n=0!==d.indexOf("[")?d:a.substring(a.indexOf("[")+
1,a.indexOf("]")).split("+");b.push(new Tc(d,n||null,-1!==a.indexOf("&"),-1!==a.indexOf("*"),-1!==a.indexOf("++"),Array.isArray(n),-1!==n.indexOf(".")))});return b}function E(a,b){return a<b?-1:a>b?1:0}function Id(a,b){return a<b?1:a>b?-1:0}function tc(a){return function(b,d){for(var n=0;;){var p=a(b[n],d[n]);if(0!==p)return p;++n;if(n===b.length||n===d.length)return a(b.length,d.length)}}}function Qb(a,b){return a?b?function(){return a.apply(this,arguments)&&b.apply(this,arguments)}:a:b}function Fb(){M.verno=
p.version/10;M._dbSchema=$={};Xc=[].slice.call(p.objectStoreNames,0);if(0!==Xc.length){var a=p.transaction(Ec(Xc),"readonly");Xc.forEach(function(b){for(var d=a.objectStore(b),n=d.keyPath,p=n&&"string"===typeof n&&-1!==n.indexOf("."),q=new Tc(n,n||"",!1,!1,!!d.autoIncrement,n&&"string"!==typeof n,p),k=[],x=0;x<d.indexNames.length;++x){var P=d.index(d.indexNames[x]),p=(n=P.keyPath)&&"string"===typeof n&&-1!==n.indexOf("."),n=new Tc(P.name,n,!!P.unique,!!P.multiEntry,!1,n&&"string"!==typeof n,p);k.push(n)}$[b]=
new Uc(b,q,k,{})});bc([O],M._transPromiseFactory,Object.keys($),b,$)}}function Gc(a,b){for(var d=b.db.objectStoreNames,n=0;n<d.length;++n)for(var p=d[n],q=b.objectStore(p),k=0;k<q.indexNames.length;++k){var x=q.indexNames[k],P=q.index(x).keyPath,P="string"===typeof P?P:"["+[].slice.call(P).join("+")+"]";a[p]&&(P=a[p].idxByName[P])&&(P.name=x)}}var Sb=t&&t.addons||K.addons,ob=K.dependencies,zb=ob.indexedDB,N=ob.IDBKeyRange,Wc=ob.TypeError,Ha=ob.Error,$=this._dbSchema={},Hc=[],Xc=[],O={},ld={},p=null,
Wa=!0,Xa=null,ma=!1,b="readwrite",M=this,n=[],va=!1,oa=!!d();this.version=function(a){if(p)throw new Ha("Cannot add version when database is open");this.verno=Math.max(this.verno,a);var b=Hc.filter(function(b){return b._cfg.version===a})[0];if(b)return b;b=new D(a);Hc.push(b);Hc.sort(Vc);return b};S(D.prototype,{stores:function(a){this._cfg.storesSource=this._cfg.storesSource?S(this._cfg.storesSource,a):a;var c={};Hc.forEach(function(a){S(c,a._cfg.storesSource)});a=this._cfg.dbschema={};this._parseStoresSpec(c,
a);$=M._dbSchema=a;cc([O,M,ld]);bc([ld],Ad,Object.keys(a),b,a);bc([O,M,this._cfg.tables],M._transPromiseFactory,Object.keys(a),b,a,!0);Xc=Object.keys(a);return this},upgrade:function(a){var c=this;sa(function(){a(M._createTransaction(b,Object.keys(c._cfg.dbschema),c._cfg.dbschema))});this._cfg.contentUpgrade=a;return this},_parseStoresSpec:function(a,b){Object.keys(a).forEach(function(d){if(null!==a[d]){var n={},p=z(a[d]),q=p.shift();if(q.multi)throw new Ha("Primary key cannot be multi-valued");q.keyPath&&
q.auto&&Eb(n,q.keyPath,0);p.forEach(function(a){if(a.auto)throw new Ha("Only primary key can be marked as autoIncrement (++)");if(!a.keyPath)throw new Ha("Index must have a name and cannot be an empty string");Eb(n,a.keyPath,a.compound?a.keyPath.map(function(){return""}):"")});b[d]=new Uc(d,q,p,n)}})}});this._allTables=O;this._tableFactory=function(a,b,d){return"readonly"===a?new Pb(b.name,d,b,vb):new vd(b.name,d,b)};this._createTransaction=function(a,b,d,n){return new wd(a,b,d,n)};this._transPromiseFactory=
function(a,b,d){if(!Wa||R.PSD&&R.PSD.letThrough){var p=M._createTransaction(a,b,$);return p._promise(a,function(a,b){p.error(function(a){M.on("error").fire(a)});d(function(b){p.complete(function(){a(b)})},b,p)})}var q=new R(function(p,k){n.push({resume:function(){var n=M._transPromiseFactory(a,b,d);q.onuncatched=n.onuncatched;n.then(p,k)}})});return q};this._whenReady=function(a){return!Wa||R.PSD&&R.PSD.letThrough?new R(a):new R(function(b,d){sa(function(){new R(function(){a(b,d)})});n.push({resume:function(){a(b,
d)}})})};this.verno=0;this.open=function(){return new R(function(a,b){function d(a){try{q.transaction.abort()}catch(k){}ma=!1;Xa=a;Wa=!1;b(Xa);n.forEach(function(a){a.resume()});n=[]}if(p||ma)throw new Ha("Database already opened or being opened");var q;try{Xa=null;ma=!0;0===Hc.length&&(va=!0);if(!zb)throw new Ha("indexedDB API not found. If using IE10+, make sure to run your code on a server URL (not locally). If using Safari, make sure to include indexedDB polyfill.");q=va?zb.open(x):zb.open(x,
Math.round(10*M.verno));q.onerror=La(d,["opening database",x]);q.onblocked=function(a){M.on("blocked").fire(a)};q.onupgradeneeded=aa(function(a){va&&!M._allowEmptyDB?(q.onerror=function(a){a.preventDefault()},q.transaction.abort(),q.result.close(),a=zb.deleteDatabase(x),a.onsuccess=a.onerror=function(){d(new Ha("Database '"+x+"' doesnt exist"))}):(q.transaction.onerror=La(d),a=a.oldVersion>Math.pow(2,62)?0:a.oldVersion,Xb(a/10,q.transaction,d,q))},d);q.onsuccess=aa(function(b){ma=!1;p=q.result;va?
Fb():0<p.objectStoreNames.length&&Gc($,p.transaction(Ec(p.objectStoreNames),"readonly"));p.onversionchange=M.on("versionchange").fire;oa||Kd(function(a){if(-1===a.indexOf(x))return a.push(x)});R.newPSD(function(){function b(){Wa=!1;n.forEach(function(a){a.resume()});n=[];a()}R.PSD.letThrough=!0;try{var c=M.on.ready.fire();c&&"function"===typeof c.then?c.then(b,function(a){p.close();p=null;d(a)}):xd(b)}catch(q){d(q)}})},d)}catch(s){d(s)}})};this.close=function(){p&&(p.close(),p=null,Wa=!0,Xa=null)};
this.delete=function(){var a=arguments;return new R(function(b,d){function p(){M.close();var a=zb.deleteDatabase(x);a.onsuccess=function(){oa||Kd(function(a){var b=a.indexOf(x);if(0<=b)return a.splice(b,1)});b()};a.onerror=La(d,["deleting",x]);a.onblocked=function(){M.on("blocked").fire()}}if(0<a.length)throw new Ha("Arguments not allowed in db.delete()");ma?n.push({resume:p}):p()})};this.backendDB=function(){return p};this.isOpen=function(){return null!==p};this.hasFailed=function(){return null!==
Xa};this.dynamicallyOpened=function(){return va};this.name=x;Object.defineProperty(this,"tables",{get:function(){return Object.keys(O).map(function(a){return O[a]})}});this.on=kd(this,"error","populate","blocked",{ready:[Qd,A],versionchange:[he,A]});this.on.ready.subscribe=V(this.on.ready.subscribe,function(a){return function(b,d){function p(){d||M.on.ready.unsubscribe(p);return b.apply(this,arguments)}a.call(this,p);M.isOpen()&&(Wa?n.push({resume:p}):p())}});sa(function(){M.on("populate").fire(M._createTransaction(b,
Xc,$));M.on("error").fire(new Ha)});this.transaction=function(a,c,d){function n(b,c){var q=null;try{if(k)throw k;var q=M._createTransaction(a,x,$,p),z=x.map(function(a){return q.tables[a]});z.push(q);var t,D=0;R.newPSD(function(){R.PSD.trans=q;q.scopeFunc=d;p&&(q.idbtrans=p.idbtrans,q._promise=V(q._promise,function(a){return function(b,c,d){function k(a){return function(b){var c;R._rootExec(function(){c=a(b);R._tickFinalize(function(){0===--D&&q.active&&(q.active=!1,q.on.complete.fire())})});return c}}
++D;return a.call(this,b,function(a,b,d){return c(k(a),k(b),d)},d)}}));q.complete(function(){b(t)});q.error(function(a){q.idbtrans&&(q.idbtrans.onerror=Jd);try{q.abort()}catch(b){}p&&(p.active=!1,p.on.error.fire(a));var d=c(a);p||d||M.on.error.fire(a)});R._rootExec(function(){t=d.apply(q,z)})});(!q.idbtrans||p&&0===D)&&q._nop()}catch(E){q&&q.idbtrans&&(q.idbtrans.onerror=Jd),q&&q.abort(),p&&p.on.error.fire(E),xd(function(){c(E)||M.on("error").fire(E)})}}c=[].slice.call(arguments,1,arguments.length-
1);d=arguments[arguments.length-1];var p=R.PSD&&R.PSD.trans;p&&p.db===M&&-1===a.indexOf("!")||(p=null);var q=-1!==a.indexOf("?");a=a.replace("!","").replace("?","");var k=null,x=(Array.isArray(c[0])?c.reduce(function(a,b){return a.concat(b)}):c).map(function(a){if("string"===typeof a)return a;a instanceof Pb||(k=k||new Wc("Invalid type. Arguments following mode must be instances of Table or String"));return a.name});"r"==a||"readonly"==a?a="readonly":"rw"==a||a==b?a=b:k=new Ha("Invalid transaction mode: "+
a);p&&!k&&(p&&"readonly"===p.mode&&a===b&&(q?p=null:k=k||new Ha("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY")),p&&x.forEach(function(a){p.tables.hasOwnProperty(a)||(q?p=null:k=k||new Ha("Table "+a+" not included in parent transaction. Parent Transaction function: "+p.scopeFunc.toString()))}));return p?p._promise(a,n,"lock"):M._whenReady(n)};this.table=function(a){if(!va&&!O.hasOwnProperty(a))throw new Ha("Table does not exist");return O[a]};S(Pb.prototype,
function(){function a(){throw new Ha("Current Transaction is READONLY");}return{_trans:function(a,b,d){return this._tpf(a,[this.name],b,d)},_idbstore:function(a,b,d){var n=this;return this._tpf(a,[this.name],function(a,c,d){b(a,c,d.idbtrans.objectStore(n.name),d)},d)},get:function(a,b){var d=this;sa(function(){b(d.schema.instanceTemplate)});return this._idbstore("readonly",function(b,n,k){var p=k.get(a);p.onerror=La(n,["getting",a,"from",d.name]);p.onsuccess=function(){b(d.hook.reading.fire(p.result))}}).then(b)},
where:function(a){return new sc(this,a)},count:function(a){return this.toCollection().count(a)},offset:function(a){return this.toCollection().offset(a)},limit:function(a){return this.toCollection().limit(a)},reverse:function(){return this.toCollection().reverse()},filter:function(a){return this.toCollection().and(a)},each:function(a){var b=this;sa(function(){a(b.schema.instanceTemplate)});return this._idbstore("readonly",function(d,n,p){p=p.openCursor();p.onerror=La(n,["calling","Table.each()","on",
b.name]);Hb(p,null,a,d,n,b.hook.reading.fire)})},toArray:function(a){var b=this;sa(function(){a([b.schema.instanceTemplate])});return this._idbstore("readonly",function(a,c,d){var k=[];d=d.openCursor();d.onerror=La(c,["calling","Table.toArray()","on",b.name]);Hb(d,null,function(a){k.push(a)},function(){a(k)},c,b.hook.reading.fire)}).then(a)},orderBy:function(a){return new this._collClass(new sc(this,a))},toCollection:function(){return new this._collClass(new sc(this))},mapToClass:function(a,b){this.schema.mappedClass=
a;var d=Object.create(a.prototype);this.schema.primKey.keyPath&&(Eb(d,this.schema.primKey.keyPath,this.schema.primKey.auto?0:""),je(a.prototype,this.schema.primKey.keyPath));b&&rc(d,b);this.schema.instanceTemplate=d;d=Object.setPrototypeOf?function(b){if(!b)return b;Object.setPrototypeOf(b,a.prototype);return b}:function(b){if(!b)return b;var d=Object.create(a.prototype),k;for(k in b)b.hasOwnProperty(k)&&(d[k]=b[k]);return d};this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook);
this.schema.readHook=d;this.hook("reading",d);return a},defineClass:function(a){return this.mapToClass(K.defineClass(a),a)},add:a,put:a,"delete":a,clear:a,update:a}});T(vd).from(Pb).extend(function(){return{add:function(a,c){var d=this,n=this.hook.creating.fire;return this._idbstore(b,function(b,p,k,q){var x={};if(n!==A){var m=c||(k.keyPath?ga(a,k.keyPath):J);q=n.call(x,m,a,q);m===J&&q!==J&&(k.keyPath?Eb(a,k.keyPath,q):c=q)}var z=c?k.add(a,c):k.add(a);z.onerror=La(function(a){if(x.onerror)x.onerror(a);
return p(a)},["adding",a,"into",d.name]);z.onsuccess=function(c){var d=k.keyPath;d&&Eb(a,d,c.target.result);if(x.onsuccess)x.onsuccess(c.target.result);b(z.result)}})},put:function(a,c){var d=this,n=this.hook.updating.fire;return this.hook.creating.fire!==A||n!==A?this._trans(b,function(b,n,k){var p=c||d.schema.primKey.keyPath&&ga(a,d.schema.primKey.keyPath);p===J?k.tables[d.name].add(a).then(b,n):(k._lock(),a=Sc(a),k.tables[d.name].where(":id").equals(p).modify(function(b){this.value=a}).then(function(b){return 0===
b?k.tables[d.name].add(a,c):p}).finally(function(){k._unlock()}).then(b,n))}):this._idbstore(b,function(b,n,k){var p=c?k.put(a,c):k.put(a);p.onerror=La(n,["putting",a,"into",d.name]);p.onsuccess=function(c){var d=k.keyPath;d&&Eb(a,d,c.target.result);b(p.result)}})},"delete":function(a){return this.hook.deleting.subscribers.length?this.where(":id").equals(a).delete():this._idbstore(b,function(b,d,n){var p=n.delete(a);p.onerror=La(d,["deleting",a,"from",n.name]);p.onsuccess=function(a){b(p.result)}})},
clear:function(){return this.hook.deleting.subscribers.length?this.toCollection().delete():this._idbstore(b,function(a,b,d){var n=d.clear();n.onerror=La(b,["clearing",d.name]);n.onsuccess=function(b){a(n.result)}})},update:function(a,b){if("object"!==typeof b||Array.isArray(b))throw new Ha("db.update(keyOrObject, modifications). modifications must be an object.");if("object"!==typeof a||Array.isArray(a))return this.where(":id").equals(a).modify(b);Object.keys(b).forEach(function(d){Eb(a,d,b[d])});
var d=ga(a,this.schema.primKey.keyPath);d===J&&R.reject(new Ha("Object does not contain its primary key"));return this.where(":id").equals(d).modify(b)}}});S(wd.prototype,{_lock:function(){++this._reculock;1===this._reculock&&R.PSD&&(R.PSD.lockOwnerFor=this);return this},_unlock:function(){if(0===--this._reculock)for(R.PSD&&(R.PSD.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var a=this._blockedFuncs.shift();try{a()}catch(b){}}return this},_locked:function(){return this._reculock&&
(!R.PSD||R.PSD.lockOwnerFor!==this)},_nop:function(a){this.tables[this.storeNames[0]].get(0).then(a)},_promise:function(a,b,d){var n=this;return R.newPSD(function(){var q;n._locked()?q=new R(function(p,k){n._blockedFuncs.push(function(){n._promise(a,b,d).then(p,k)})}):(q=n.active?new R(function(q,k){if(!n.idbtrans&&a){if(!p)throw Xa?new Ha("Database not open. Following error in populate, ready or upgrade function made Dexie.open() fail: "+Xa):new Ha("Database not open");var s=n.idbtrans=p.transaction(Ec(n.storeNames),
n.mode);s.onerror=function(a){n.on("error").fire(a&&a.target.error);a.preventDefault();n.abort()};s.onabort=function(a){n.active=!1;n.on("abort").fire(a)};s.oncomplete=function(a){n.active=!1;n.on("complete").fire(a)}}d&&n._lock();try{b(q,k,n)}catch(x){K.ignoreTransaction(function(){n.on("error").fire(x)}),n.abort(),k(x)}}):R.reject(te(new Ha("Transaction is inactive. Original Scope Function Source: "+n.scopeFunc.toString()))),n.active&&d&&q.finally(function(){n._unlock()}));q.onuncatched=function(a){K.ignoreTransaction(function(){n.on("error").fire(a)});
n.abort()};return q})},complete:function(a){return this.on("complete",a)},error:function(a){return this.on("error",a)},abort:function(){if(this.idbtrans&&this.active)try{this.active=!1,this.idbtrans.abort(),this.on.error.fire(new Ha("Transaction Aborted"))}catch(a){}},table:function(a){if(!this.tables.hasOwnProperty(a))throw new Ha("Table "+a+" not in transaction");return this.tables[a]}});S(sc.prototype,function(){function a(b,c){try{throw c;}catch(d){b._ctx.error=d}return b}function b(a){return Array.prototype.slice.call(1===
a.length&&Array.isArray(a[0])?a[0]:a)}function d(a){return"next"===a?function(a){return a.toUpperCase()}:function(a){return a.toLowerCase()}}function n(a){return"next"===a?function(a){return a.toLowerCase()}:function(a){return a.toUpperCase()}}function p(a,b,c,d,n,q){for(var s=Math.min(a.length,d.length),x=-1,z=0;z<s;++z){var t=b[z];if(t!==d[z])return 0>n(a[z],c[z])?a.substr(0,z)+c[z]+c.substr(z+1):0>n(a[z],d[z])?a.substr(0,z)+d[z]+c.substr(z+1):0<=x?a.substr(0,x)+b[x]+c.substr(x+1):null;0>n(a[z],
t)&&(x=z)}return s<d.length&&"next"===q?a+c.substr(a.length):s<a.length&&"prev"===q?a.substr(0,c.length):0>x?null:a.substr(0,x)+d[x]+c.substr(x+1)}function q(a,b,c){function m(a){x=d(a);z=n(a);t="next"===a?E:Id;D=x(c);H=z(c);Fc=a}var x,z,t,D,H,Fc;m("next");a._ondirectionchange=function(a){m(a)};a._addAlgorithm(function(a,c,d){var k=a.key;if("string"!==typeof k)return!1;var m=z(k);if(b(m,H))return c(function(){a.continue()}),!0;var n=p(k,m,D,H,t,Fc);n?c(function(){a.continue(n)}):c(d);return!1})}return{between:function(a,
b,c,d){c=!1!==c;d=!0===d;return a>b||a===b&&!(!c&&!d||c&&d)?(new this._ctx.collClass(this,function(){return N.only(a)})).limit(0):new this._ctx.collClass(this,function(){return N.bound(a,b,!c,!d)})},equals:function(a){return new this._ctx.collClass(this,function(){return N.only(a)})},above:function(a){return new this._ctx.collClass(this,function(){return N.lowerBound(a,!0)})},aboveOrEqual:function(a){return new this._ctx.collClass(this,function(){return N.lowerBound(a)})},below:function(a){return new this._ctx.collClass(this,
function(){return N.upperBound(a,!0)})},belowOrEqual:function(a){return new this._ctx.collClass(this,function(){return N.upperBound(a)})},startsWith:function(b){return"string"!==typeof b?a(new this._ctx.collClass(this),new Wc("String expected")):this.between(b,b+String.fromCharCode(65535),!0,!0)},startsWithIgnoreCase:function(b){if("string"!==typeof b)return a(new this._ctx.collClass(this),new Wc("String expected"));if(""===b)return this.startsWith(b);var c=new this._ctx.collClass(this,function(){return N.bound(b.toUpperCase(),
b.toLowerCase()+String.fromCharCode(65535))});q(c,function(a,b){return 0===a.indexOf(b)},b);c._ondirectionchange=function(){a(c,new Ha("reverse() not supported with WhereClause.startsWithIgnoreCase()"))};return c},equalsIgnoreCase:function(b){if("string"!==typeof b)return a(new this._ctx.collClass(this),new Wc("String expected"));var c=new this._ctx.collClass(this,function(){return N.bound(b.toUpperCase(),b.toLowerCase())});q(c,function(a,b){return a===b},b);return c},anyOf:function(a){var d=this._ctx,
n=d.table.schema,m=(d=d.index?n.idxByName[d.index]:n.primKey)&&d.compound,p=b(arguments),q=m?tc(E):E;p.sort(q);if(0===p.length)return(new this._ctx.collClass(this,function(){return N.only("")})).limit(0);d=new this._ctx.collClass(this,function(){return N.bound(p[0],p[p.length-1])});d._ondirectionchange=function(a){q="next"===a?E:Id;m&&(q=tc(q));p.sort(q)};var x=0;d._addAlgorithm(function(a,b,c){for(var d=a.key;0<q(d,p[x]);)if(++x,x===p.length)return b(c),!1;if(0===q(d,p[x]))return b(function(){a.continue()}),
!0;b(function(){a.continue(p[x])});return!1});return d}}});S(vb.prototype,function(){function a(b,c){b.filter=Qb(b.filter,c)}function c(a,b){a.isMatch=Qb(a.isMatch,b)}function d(a,b){if(a.isPrimKey)return b;var c=a.table.schema.idxByName[a.index];if(!c)throw new Ha("KeyPath "+a.index+" on object store "+b.name+" is not indexed");return a.isPrimKey?b:b.index(c.name)}function n(a,b){return d(a,b)[a.op](a.range||null,a.dir+a.unique)}function p(a,b,c,d,q){a.or?function(){function p(){2===++t&&c()}function x(a,
c,k){if(!s||s(c,k,p,d)){var n=c.primaryKey.toString();z.hasOwnProperty(n)||(z[n]=!0,b(a,c,k))}}var s=a.filter,z={},t=0;a.or._iterate(x,p,d,q);Hb(n(a,q),a.algorithm,x,p,d,a.table.hook.reading.fire)}():Hb(n(a,q),Qb(a.algorithm,a.filter),b,c,d,a.table.hook.reading.fire)}function q(a){return a.table.schema.instanceTemplate}return{_read:function(a,b){var c=this._ctx;return c.error?c.table._trans(null,function(a,b){b(c.error)}):c.table._idbstore("readonly",a).then(b)},_write:function(a){var c=this._ctx;
return c.error?c.table._trans(null,function(a,b){b(c.error)}):c.table._idbstore(b,a,"locked")},_addAlgorithm:function(a){var b=this._ctx;b.algorithm=Qb(b.algorithm,a)},_iterate:function(a,b,c,d){return p(this._ctx,a,b,c,d)},each:function(a){var b=this._ctx;sa(function(){a(q(b))});return this._read(function(c,d,n){p(b,a,c,d,n)})},count:function(a){sa(function(){a(0)});var b=this,c=this._ctx;if(c.filter||c.algorithm||c.or){var m=0;return this._read(function(a,b,d){p(c,function(){++m;return!1},function(){a(m)},
b,d)},a)}return this._read(function(a,k,m){m=d(c,m);m=c.range?m.count(c.range):m.count();m.onerror=La(k,["calling","count()","on",b.name]);m.onsuccess=function(b){a(Math.min(b.target.result,Math.max(0,c.limit-c.offset)))}},a)},sortBy:function(a,b){function c(a,b){return b?c(a[p[b]],b-1):a[x]}function d(a,b){var k=c(a,s),m=c(b,s);return k<m?-z:k>m?z:0}var n=this._ctx;sa(function(){b([q(n)])});var p=a.split(".").reverse(),x=p[0],s=p.length-1,z="next"===this._ctx.dir?1:-1;return this.toArray(function(a){return a.sort(d)}).then(b)},
toArray:function(a){var b=this._ctx;sa(function(){a([q(b)])});return this._read(function(a,c,d){var k=[];p(b,function(a){k.push(a)},function(){a(k)},c,d)},a)},offset:function(b){var c=this._ctx;if(0>=b)return this;c.offset+=b;c.or||c.algorithm||c.filter?a(c,function(a,c,d){return 0>--b}):a(c,function(a,c,d){if(0===b)return!0;if(1===b)return--b,!1;c(function(){a.advance(b);b=0});return!1});return this},limit:function(b){this._ctx.limit=Math.min(this._ctx.limit,b);a(this._ctx,function(a,c,d){0>=--b&&
c(d);return 0<=b});return this},until:function(b,c){var d=this._ctx;sa(function(){b(q(d))});a(this._ctx,function(a,d,n){return b(a.value)?(d(n),c):!0});return this},first:function(a){var b=this;sa(function(){a(q(b._ctx))});return this.limit(1).toArray(function(a){return a[0]}).then(a)},last:function(a){return this.reverse().first(a)},and:function(b){var d=this;sa(function(){b(q(d._ctx))});a(this._ctx,function(a){return b(a.value)});c(this._ctx,b);return this},or:function(a){return new sc(this._ctx.table,
a,this)},reverse:function(){this._ctx.dir="prev"===this._ctx.dir?"next":"prev";this._ondirectionchange&&this._ondirectionchange(this._ctx.dir);return this},desc:function(){return this.reverse()},eachKey:function(a){var b=this,c=this._ctx;sa(function(){a(q(b._ctx)[b._ctx.index])});c.isPrimKey||(c.op="openKeyCursor");return this.each(function(b,c){a(c.key,c)})},eachUniqueKey:function(a){this._ctx.unique="unique";return this.eachKey(a)},keys:function(a){sa(function(){a([q(c)[b._ctx.index]])});var b=
this,c=this._ctx;c.isPrimKey||(c.op="openKeyCursor");var d=[];return this.each(function(a,b){d.push(b.key)}).then(function(){return d}).then(a)},uniqueKeys:function(a){this._ctx.unique="unique";return this.keys(a)},firstKey:function(a){return this.limit(1).keys(function(a){return a[0]}).then(a)},lastKey:function(a){return this.reverse().firstKey(a)},distinct:function(){var b={};a(this._ctx,function(a){a=a.primaryKey.toString();var c=b.hasOwnProperty(a);b[a]=!0;return!c});return this}}});T(Ka).from(vb).extend({modify:function(a){var b=
this,d=this._ctx,n=d.table.hook,p=n.updating.fire,q=n.deleting.fire;sa(function(){"function"===typeof a&&a.call({value:d.table.schema.instanceTemplate},d.table.schema.instanceTemplate)});return this._write(function(k,n,x,m){function z(a){a&&(bc.push(a),O.push(Xb));return n(new zd("Error modifying one or more objects",bc,C,O))}function t(){N&&C+bc.length===F&&(0<bc.length?z():k(C))}var D;if("function"===typeof a)D=p===A&&q===A?a:function(b){var c=Sc(b);if(!1===a.call(this,b))return!1;if(this.hasOwnProperty("value")){var d=
Dc(c,this.value),k=p.call(this,d,this.primKey,c,m);k&&(b=this.value,Object.keys(k).forEach(function(a){Eb(b,a,k[a])}))}else q.call(this,this.primKey,b,m)};else if(p===A){var E=Object.keys(a),Fc=E.length;D=function(b){for(var c=!1,d=0;d<Fc;++d){var k=E[d],m=a[k];ga(b,k)!==m&&(Eb(b,k,m),c=!0)}return c}}else{var M=a;a=Sd(M);D=function(b){var c=!1,d=p.call(this,a,this.primKey,Sc(b),m);d&&S(a,d);Object.keys(a).forEach(function(d){var k=a[d];ga(b,d)!==k&&(Eb(b,d,k),c=!0)});d&&(a=Sd(M));return c}}var F=
0,C=0,N=!1,bc=[],O=[],Xb=null;b._iterate(function(a,b,c){Xb=b.primaryKey;var k={primKey:b.primaryKey,value:a};if(!1!==D.call(k,a))b=(c=!k.hasOwnProperty("value"))?b.delete():b.update(k.value),++F,b.onerror=La(function(a){bc.push(a);O.push(k.primKey);if(k.onerror)k.onerror(a);t();return!0},c?["deleting",a,"from",d.table.name]:["modifying",a,"on",d.table.name]),b.onsuccess=function(a){if(k.onsuccess)k.onsuccess(k.value);++C;t()};else if(k.onsuccess)k.onsuccess(k.value)},function(){N=!0;t()},z,x)})},
"delete":function(){return this.modify(function(){delete this.value})}});S(this,{Collection:vb,Table:Pb,Transaction:wd,Version:D,WhereClause:sc,WriteableCollection:Ka,WriteableTable:vd});(function(){M.on("versionchange",function(a){M.close();M.on("error").fire(new Ha("Database version changed by other database connection."))})})();Sb.forEach(function(a){a(M)})}function A(){}function Gd(d){return d}function jd(d,t){return d===Gd?t:function(D){return t(d(D))}}function zb(d,t){return function(){d.apply(this,
arguments);t.apply(this,arguments)}}function Hd(d,t){return d===A?t:function(){var D=d.apply(this,arguments);D!==J&&(arguments[0]=D);var A=this.onsuccess,a=this.onerror;delete this.onsuccess;delete this.onerror;var q=t.apply(this,arguments);A&&(this.onsuccess=this.onsuccess?zb(A,this.onsuccess):A);a&&(this.onerror=this.onerror?zb(a,this.onerror):a);return q!==J?q:D}}function fe(d,t){return d===A?t:function(){var D=d.apply(this,arguments);D!==J&&S(arguments[0],D);var A=this.onsuccess,a=this.onerror;
delete this.onsuccess;delete this.onerror;var q=t.apply(this,arguments);A&&(this.onsuccess=this.onsuccess?zb(A,this.onsuccess):A);a&&(this.onerror=this.onerror?zb(a,this.onerror):a);return D===J?q===J?J:q:q===J?D:S(D,q)}}function ge(d,t){return d===A?t:function(){return!1===d.apply(this,arguments)?!1:t.apply(this,arguments)}}function he(d,t){return d===A?t:function(){return!1===t.apply(this,arguments)?!1:d.apply(this,arguments)}}function ie(d,t){return d===A?t:function(){d.apply(this,arguments);t.apply(this,
arguments)}}function Qd(d,t){return d===A?t:function(){var D=d.apply(this,arguments);if(D&&"function"===typeof D.then){var A=this,a=arguments;return D.then(function(){return t.apply(A,a)})}return t.apply(this,arguments)}}function kd(d,t){function D(d,q,x){if(Array.isArray(d))return a(d);if("object"===typeof d)return K(d);q||(q=ge);x||(x=A);var t={subscribers:[],fire:x,subscribe:function(a){t.subscribers.push(a);t.fire=q(t.fire,a)},unsubscribe:function(a){t.subscribers=t.subscribers.filter(function(d){return d!==
a});t.fire=t.subscribers.reduce(q,x)}};return J[d]=R[d]=t}function K(a){Object.keys(a).forEach(function(d){var q=a[d];if(Array.isArray(q))D(d,a[d][0],a[d][1]);else if("asap"===q){var x=D(d,null,function(){var a=arguments;x.subscribers.forEach(function(d){xd(function(){d.apply(ka,a)})})});x.subscribe=function(a){-1===x.subscribers.indexOf(a)&&x.subscribers.push(a)};x.unsubscribe=function(a){a=x.subscribers.indexOf(a);-1!==a&&x.subscribers.splice(a,1)}}else throw Error("Invalid event config");})}function a(a){function d(){if(q)return!1;
q=!0}var q=!1;a.forEach(function(a){D(a).subscribe(d)})}var q=arguments,J={},R=function(a,q){if(q){var t=[].slice.call(arguments,1),D=J[a];D.subscribe.apply(D,t);return d}if("string"===typeof a)return J[a]};R.addEventType=D;for(var S=1,T=q.length;S<T;++S)D(q[S]);return R}function xd(d){ka.setImmediate?setImmediate(d):setTimeout(d,0)}function Rd(d){d=setTimeout(d,1E3);clearTimeout(d)}function aa(d,t,D){return function(){var A=R.PSD;R.PSD=D;try{d.apply(this,arguments)}catch(a){t(a)}finally{R.PSD=A}}}
function ga(d,t){if(d.hasOwnProperty(t))return d[t];if(!t)return d;if("string"!==typeof t){for(var D=[],A=0,a=t.length;A<a;++A){var q=ga(d,t[A]);D.push(q)}return D}D=t.indexOf(".");return-1!==D?(A=d[t.substr(0,D)],A===J?J:ga(A,t.substr(D+1))):J}function Eb(d,t,D){if(d&&t!==J)if("string"!==typeof t&&"length"in t){if(!("string"!==typeof D&&"length"in D))throw Error("Assertion failed");for(var A=0,a=t.length;A<a;++A)Eb(d,t[A],D[A])}else a=t.indexOf("."),-1!==a?(A=t.substr(0,a),t=t.substr(a+1),""===t?
D===J?delete d[A]:d[A]=D:((a=d[A])||(a=d[A]={}),Eb(a,t,D))):D===J?delete d[t]:d[t]=D}function je(d,t){Eb(d,t,J)}function Sd(d){var t={},D;for(D in d)d.hasOwnProperty(D)&&(t[D]=d[D]);return t}function Sc(d){if(!d||"object"!==typeof d)return d;var t;if(Array.isArray(d)){t=[];for(var D=0,A=d.length;D<A;++D)t.push(Sc(d[D]))}else if(d instanceof Date)t=new Date,t.setTime(d.getTime());else for(D in t=d.constructor?Object.create(d.constructor.prototype):{},d)d.hasOwnProperty(D)&&(t[D]=Sc(d[D]));return t}
function Dc(d,t){var D={},A;for(A in d)d.hasOwnProperty(A)&&(t.hasOwnProperty(A)?d[A]!==t[A]&&JSON.stringify(d[A])!=JSON.stringify(t[A])&&(D[A]=t[A]):D[A]=J);for(A in t)t.hasOwnProperty(A)&&!d.hasOwnProperty(A)&&(D[A]=t[A]);return D}function yd(d){if("function"===typeof d)return new d;if(Array.isArray(d))return[yd(d[0])];if(d&&"object"===typeof d){var t={};rc(t,d);return t}return d}function rc(d,t){Object.keys(t).forEach(function(D){var A=yd(t[D]);d[D]=A})}function La(d,t){return function(D){var A=
D&&D.target.error||Error();if(t){var a=" occurred when "+t.map(function(a){switch(typeof a){case "function":return a();case "string":return a;default:return JSON.stringify(a)}}).join(" ");A.name?A.toString=function(){return A.name+a+(A.message?". "+A.message:"")}:A+=a}d(A);D&&(D.stopPropagation&&D.stopPropagation(),D.preventDefault&&D.preventDefault());return!1}}function te(d){try{throw d;}catch(t){return t}}function Jd(d){d.preventDefault()}function Kd(d){var t,A=K.dependencies.localStorage;if(!A)return d([]);
try{t=JSON.parse(A.getItem("Dexie.DatabaseNames")||"[]")}catch(J){t=[]}d(t)&&A.setItem("Dexie.DatabaseNames",JSON.stringify(t))}function Tc(d,t,A,J,a,q,K){this.name=d;this.keyPath=t;this.unique=A;this.multi=J;this.auto=a;this.compound=q;this.dotted=K;d="string"===typeof t?t:t&&"["+[].join.call(t,"+")+"]";this.src=(A?"&":"")+(J?"*":"")+(a?"++":"")+d}function Uc(d,t,A,J){this.name=d;this.primKey=t||new Tc;this.indexes=A||[new Tc];this.instanceTemplate=J;this.mappedClass=null;this.idxByName=A.reduce(function(a,
d){a[d.name]=d;return a},{})}function zd(d,t,A,J){this.name="ModifyError";this.failures=t;this.failedKeys=J;this.successCount=A;this.message=t.join("\n")}function Ec(d){return 1===d.length?d[0]:d}function d(){var d=K.dependencies.indexedDB,t=d&&(d.getDatabaseNames||d.webkitGetDatabaseNames);return t&&t.bind(d)}var R=function(){function d(a,q){Ka.push([a,V.call(arguments,1)])}function t(){var a=Ka;Ka=[];for(var d=0,q=a.length;d<q;++d){var x=a[d];x[0].apply(ka,x[1])}}function D(a){if("object"!==typeof this)throw new TypeError("Promises must be constructed via new");
if("function"!==typeof a)throw new TypeError("not a function");this._value=this._state=null;this._deferreds=[];this._catched=!1;var d=this,t=!0;this._PSD=D.PSD;try{T(this,a,function(a){t?ga(q,d,a):q(d,a)},function(a){return t?(ga(K,d,a),!1):K(d,a)})}finally{t=!1}}function J(q,A){if(null===q._state)q._deferreds.push(A);else{var K=q._state?A.onFulfilled:A.onRejected;if(null===K)return(q._state?A.resolve:A.reject)(q._value);var z,E=sa;sa=!1;ga=d;try{var R=D.PSD;D.PSD=q._PSD;z=K(q._value);q._state||z&&
"function"===typeof z.then&&!1===z._state||a(q);A.resolve(z)}catch(S){if(!A.reject(S)&&q.onuncatched)try{q.onuncatched(S)}catch(T){}}finally{if(D.PSD=R,E){do{for(;0<Ka.length;)t();if(K=La.pop())try{K()}catch(V){}}while(0<La.length||0<Ka.length);ga=aa;sa=!0}}}}function a(d){d._catched=!0;d._parent&&a(d._parent)}function q(a,d){var t=D.PSD;D.PSD=a._PSD;try{if(d===a)throw new TypeError("A promise cannot be resolved with itself.");!d||"object"!==typeof d&&"function"!==typeof d||"function"!==typeof d.then?
(a._state=!0,a._value=d,R.call(a)):T(a,function(a,q){d.then(a,q)},function(d){q(a,d)},function(d){K(a,d)})}catch(x){K(x)}finally{D.PSD=t}}function K(a,d){var q=D.PSD;D.PSD=a._PSD;a._state=!1;a._value=d;R.call(a);if(!a._catched)try{if(a.onuncatched)a.onuncatched(a._value);D.on.error.fire(a._value)}catch(t){}D.PSD=q;return a._catched}function R(){for(var a=0,d=this._deferreds.length;a<d;a++)J(this,this._deferreds[a]);this._deferreds=[]}function S(a,d,q,t){this.onFulfilled="function"===typeof a?a:null;
this.onRejected="function"===typeof d?d:null;this.resolve=q;this.reject=t}function T(a,d,q,t){var x=!1;try{d(function(a){x||(x=!0,q(a))},function(d){if(x)return a._catched;x=!0;return t(d)})}catch(A){if(!x)return t(A)}}var V=[].slice,aa="undefined"===typeof setImmediate?function(a,d,q,t){var x=arguments;setTimeout(function(){a.apply(ka,V.call(x,1))},0)}:setImmediate,ga=aa,sa=!0,Ka=[],La=[];D.on=kd(null,"error");D.all=function(){var a=Array.prototype.slice.call(1===arguments.length&&Array.isArray(arguments[0])?
arguments[0]:arguments);return new D(function(d,q){function t(A,D){try{if(D&&("object"===typeof D||"function"===typeof D)){var J=D.then;if("function"===typeof J){J.call(D,function(a){t(A,a)},q);return}}a[A]=D;0===--x&&d(a)}catch(K){q(K)}}if(0===a.length)return d([]);for(var x=a.length,A=0;A<a.length;A++)t(A,a[A])})};D.prototype.then=function(a,d){var q=this,t=new D(function(t,x){null===q._state?J(q,new S(a,d,t,x)):ga(J,q,new S(a,d,t,x))});t._PSD=this._PSD;t.onuncatched=this.onuncatched;t._parent=
this;return t};D.prototype._then=function(a,d){J(this,new S(a,d,A,A))};D.prototype["catch"]=function(a){if(1===arguments.length)return this.then(null,a);var d=arguments[0],q=arguments[1];return"function"===typeof d?this.then(null,function(a){return a instanceof d?q(a):D.reject(a)}):this.then(null,function(a){return a&&a.name===d?q(a):D.reject(a)})};D.prototype["finally"]=function(a){return this.then(function(d){a();return d},function(d){a();return D.reject(d)})};D.prototype.onuncatched=null;D.resolve=
function(a){var d=new D(function(){});d._state=!0;d._value=a;return d};D.reject=function(a){var d=new D(function(){});d._state=!1;d._value=a;return d};D.race=function(a){return new D(function(d,q){a.map(function(a){a.then(d,q)})})};D.PSD=null;D.newPSD=function(a){var d=D.PSD;D.PSD=d?Object.create(d):{};try{return a()}finally{D.PSD=d}};D._rootExec=function(a){var q=sa;sa=!1;ga=d;try{a()}finally{if(q){do{for(;0<Ka.length;)t();if(a=La.pop())try{a()}catch(A){}}while(0<La.length||0<Ka.length);ga=aa;sa=
!0}}};D._tickFinalize=function(a){if(sa)throw Error("Not in a virtual tick");La.push(a)};return D}(),sa=function(){};T(zd).from(Error);K.delete=function(d){var t=new K(d);d=t.delete();d.onblocked=function(d){t.on("blocked",d);return this};return d};K.getDatabaseNames=function(t){return(new R(function(t,x){var A=d();A?(A=A(),A.onsuccess=function(a){t([].slice.call(a.target.result,0))},A.onerror=La(x)):Kd(function(a){t(a);return!1})})).then(t)};K.defineClass=function(d){function t(d){d&&S(this,d)}rc(t.prototype,
d);return t};K.ignoreTransaction=function(d){return R.newPSD(function(){R.PSD.trans=null;return d()})};K.spawn=function(){ka.console&&console.warn("Dexie.spawn() is deprecated. Use Dexie.ignoreTransaction() instead.");return K.ignoreTransaction.apply(this,arguments)};K.vip=function(d){return R.newPSD(function(){R.PSD.letThrough=!0;return d()})};Object.defineProperty(K,"currentTransaction",{get:function(){return R.PSD&&R.PSD.trans||null}});K.Promise=R;K.derive=T;K.extend=S;K.override=V;K.events=kd;
K.getByKeyPath=ga;K.setByKeyPath=Eb;K.delByKeyPath=je;K.shallowClone=Sd;K.deepClone=Sc;K.addons=[];K.fakeAutoComplete=sa;K.asap=xd;K.ModifyError=zd;K.MultiModifyError=zd;K.IndexSpec=Tc;K.TableSchema=Uc;var Fb=ka.idbModules&&ka.idbModules.shimIndexedDB?ka.idbModules:{};K.dependencies={indexedDB:Fb.shimIndexedDB||ka.indexedDB||ka.mozIndexedDB||ka.webkitIndexedDB||ka.msIndexedDB,IDBKeyRange:Fb.IDBKeyRange||ka.IDBKeyRange||ka.webkitIDBKeyRange,IDBTransaction:Fb.IDBTransaction||ka.IDBTransaction||ka.webkitIDBTransaction,
Error:ka.Error||String,SyntaxError:ka.SyntaxError||String,TypeError:ka.TypeError||String,DOMError:ka.DOMError||String,localStorage:null!=("undefined"!==typeof chrome&&null!==chrome?chrome.storage:void 0)?null:ka.localStorage};K.version=1.1;t("Dexie",K);Rd(function(){sa=Rd})}).apply(null,"function"===typeof define&&define.amd?[self||window,function(ka,t){define(ka,function(){return t})}]:"undefined"!==typeof global&&"undefined"!==typeof module&&module.exports?[global,function(ka,t){module.exports=
t}]:[self||window,function(ka,t){(self||window)[ka]=t}]);
